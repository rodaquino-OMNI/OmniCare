"use strict";var K=Object.create;var g=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var Q=(n,e)=>{for(var t in e)g(n,t,{get:e[t],enumerable:!0})},A=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of J(e))!q.call(n,o)&&o!==t&&g(n,o,{get:()=>e[o],enumerable:!(r=$(e,o))||r.enumerable});return n};var O=(n,e,t)=>(t=n!=null?K(X(n)):{},A(e||!n||!n.__esModule?g(t,"default",{value:n,enumerable:!0}):t,n)),Y=n=>A(g({},"__esModule",{value:!0}),n);var ie={};Q(ie,{ExpoClientStorage:()=>b,cleanupMedplumWebAPIs:()=>re,initWebSocketManager:()=>U,polyfillMedplumWebAPIs:()=>oe});module.exports=Y(ie);var M=require("@medplum/core"),h=require("base-64"),R=require("expo-crypto"),d=O(require("expo-standard-web-crypto")),x=require("react-native"),V=require("react-native-url-polyfill"),v=require("text-encoding");var p=typeof window<"u"?window:typeof self<"u"?self:typeof global<"u"?global:typeof globalThis<"u"?globalThis:void 0;function w(n,e,...t){if(!n)throw new TypeError(Z(e,t))}function Z(n,e){let t=0;return n.replace(/%[os]/gu,()=>ee(e[t++]))}function ee(n){return typeof n!="object"||n===null?String(n):Object.prototype.toString.call(n)}var W;var a=class{constructor(e,t){this.code=e,this.message=t}warn(...e){try{if(W){W({...this,args:e});return}let t=(new Error().stack??"").replace(/^(?:.+?\n){2}/gu,`
`);console.warn(this.message,...e,t)}catch{}}};var C=new a("W01","Unable to initialize event under dispatching."),F=new a("W02","Assigning any falsy value to 'cancelBubble' property has no effect."),j=new a("W03","Assigning any truthy value to 'returnValue' property has no effect."),k=new a("W04","Unable to preventDefault on non-cancelable events."),N=new a("W05","Unable to preventDefault inside passive event listener invocation."),ge=new a("W06","An event listener wasn't added because it has been added already: %o, %o"),pe=new a("W07","The %o option value was abandoned because the event listener wasn't added as duplicated."),fe=new a("W08","The 'callback' argument must be a function or an object that has 'handleEvent' method: %o"),be=new a("W09","Event attribute handler must be a function: %o");var s=class{static get NONE(){return B}static get CAPTURING_PHASE(){return D}static get AT_TARGET(){return L}static get BUBBLING_PHASE(){return H}constructor(e,t){Object.defineProperty(this,"isTrusted",{value:!1,enumerable:!0});let r=t??{};P.set(this,{type:String(e),bubbles:!!r.bubbles,cancelable:!!r.cancelable,composed:!!r.composed,target:null,currentTarget:null,stopPropagationFlag:!1,stopImmediatePropagationFlag:!1,canceledFlag:!1,inPassiveListenerFlag:!1,dispatchFlag:!1,timeStamp:Date.now()})}get type(){return i(this).type}get target(){return i(this).target}get srcElement(){return i(this).target}get currentTarget(){return i(this).currentTarget}composedPath(){let e=i(this).currentTarget;return e?[e]:[]}get NONE(){return B}get CAPTURING_PHASE(){return D}get AT_TARGET(){return L}get BUBBLING_PHASE(){return H}get eventPhase(){return i(this).dispatchFlag?2:0}stopPropagation(){i(this).stopPropagationFlag=!0}get cancelBubble(){return i(this).stopPropagationFlag}set cancelBubble(e){e?i(this).stopPropagationFlag=!0:F.warn()}stopImmediatePropagation(){let e=i(this);e.stopPropagationFlag=e.stopImmediatePropagationFlag=!0}get bubbles(){return i(this).bubbles}get cancelable(){return i(this).cancelable}get returnValue(){return!i(this).canceledFlag}set returnValue(e){e?j.warn():z(i(this))}preventDefault(){z(i(this))}get defaultPrevented(){return i(this).canceledFlag}get composed(){return i(this).composed}get isTrusted(){return!1}get timeStamp(){return i(this).timeStamp}initEvent(e,t=!1,r=!1){let o=i(this);if(o.dispatchFlag){C.warn();return}P.set(this,{...o,type:String(e),bubbles:!!t,cancelable:!!r,target:null,currentTarget:null,stopPropagationFlag:!1,stopImmediatePropagationFlag:!1,canceledFlag:!1})}};var B=0,D=1,L=2,H=3,P=new WeakMap;function i(n,e="this"){let t=P.get(n);return w(t!=null,"'%s' must be an object that Event constructor created, but got another one: %o",e,n),t}function z(n){if(n.inPassiveListenerFlag){N.warn();return}if(!n.cancelable){k.warn();return}n.canceledFlag=!0}Object.defineProperty(s,"NONE",{enumerable:!0});Object.defineProperty(s,"CAPTURING_PHASE",{enumerable:!0});Object.defineProperty(s,"AT_TARGET",{enumerable:!0});Object.defineProperty(s,"BUBBLING_PHASE",{enumerable:!0});var S=Object.getOwnPropertyNames(s.prototype);for(let n=0;n<S.length;++n)S[n]!=="constructor"&&Object.defineProperty(s.prototype,S[n],{enumerable:!0});typeof p<"u"&&typeof p.Event<"u"&&Object.setPrototypeOf(s.prototype,p.Event.prototype);function G(){let n=typeof globalThis<"u"&&globalThis||typeof self<"u"&&self||typeof global<"u"&&global;(()=>{if(typeof n.Event>"u")return!0;try{new n.Event("")}catch{return!0}return!1})()&&(n.Event=s)}var c=require("@medplum/core"),l=O(require("expo-secure-store")),f=require("react-native"),te=2e3,b=class extends c.ClientStorage{constructor(){if(f.Platform.OS==="web")super(globalThis.localStorage);else{let e=new E;super(e),this.secureStorage=e}}getInitPromise(){return f.Platform.OS==="web"?Promise.resolve():this.secureStorage.getInitPromise()}get length(){return f.Platform.OS==="web"?globalThis.localStorage.length:this.secureStorage.length}},E=class{constructor(){this.initialized=!1;this.storage=new Map,this.initPromise=this.initStorage()}async initStorage(){let e;try{e=await l.getItemAsync("___keys___")}catch(r){console.error(r),await l.deleteItemAsync("___keys___"),this.initialized=!0;return}if(!e){this.initialized=!0;return}let t=JSON.parse(e);await this.buildMapFromStoredKeys(t),this.initialized=!0}async buildMapFromStoredKeys(e){let t=e.map(o=>this.getValueForKey(o)),r=await Promise.all(t);for(let o=0;o<e.length;o++){let u=r[o];u&&this.storage.set(e[o],u)}}getInitPromise(){return this.initPromise}assertInitialized(){if(!this.initialized)throw new c.OperationOutcomeError({id:"not-initialized",resourceType:"OperationOutcome",issue:[{severity:"error",code:"exception",details:{text:"Not initialized"},diagnostics:"Storage not initialized"}]})}get length(){return this.assertInitialized(),this.storage.size}clear(){this.assertInitialized();for(let e of this.storage.keys())this.removeItem(e,!1);this.storage.clear(),this.setKeys()}async getValueForKey(e){let t=await l.getItemAsync(e);if(!t)return t;let r=0;for(;t.endsWith("___continued___");){r++,t=t.replace("___continued___","");let o=await l.getItemAsync(`${e}___chunk${r}___`);if(!o)throw this.removeItem(e),new c.OperationOutcomeError({id:"key-chunk-missing",resourceType:"OperationOutcome",issue:[{severity:"error",code:"exception",details:{text:"Chunk missing for key"},diagnostics:`Chunk ${r} of key's value is missing for key '${e}'`}]});t+=o}return t}async setValueForKey(e,t){let r=ne(t,te),o=[];o.push(l.setItemAsync(e,r.length===1?r[0]:`${r[0]}___continued___`));for(let u=1;u<r.length;u++)o.push(l.setItemAsync(`${e}___chunk${u}___`,u===r.length-1?r[u]:`${r[u]}___continued___`));await Promise.all(o)}setKeys(){l.setItemAsync("___keys___",JSON.stringify(Array.from(this.storage.keys()))).catch(console.error)}getItem(e){return this.assertInitialized(),this.storage.get(e)??null}setItem(e,t){this.assertInitialized(),t?(this.setValueForKey(e,t).catch(console.error),this.storage.set(e,t)):this.removeItem(e),this.setKeys()}removeItem(e,t=!0){this.assertInitialized(),l.deleteItemAsync(e).catch(console.error),this.storage.delete(e),t&&this.setKeys()}key(e){return this.assertInitialized(),null}};function ne(n,e){let t=[];for(let r=0;r<n.length;r+=e)t.push(n.slice(r,r+e));return t}var T=require("react-native"),m="unknown";function U(n){m=T.AppState.currentState,T.AppState.addEventListener("change",e=>{let t=n.getSubscriptionManager().getWebSocket();m==="active"&&e!=="active"?t.close():m!=="active"&&e==="active"&&t.readyState!==WebSocket.OPEN&&t.readyState!==WebSocket.CONNECTING&&t.reconnect(),m=e})}var y=!1,_=!1,I;function re(){x.Platform.OS==="web"||!y||(typeof window.crypto<"u"&&(Object.defineProperty(window,"crypto",{configurable:!0,enumerable:!0,value:I}),Object.defineProperty(d.default,"subtle",{configurable:!0,enumerable:!1,value:void 0}),I=void 0,_=!1),typeof window.location<"u"&&Object.defineProperty(window,"location",{configurable:!0,enumerable:!0,value:void 0}),typeof window.sessionStorage<"u"&&Object.defineProperty(window,"sessionStorage",{configurable:!0,enumerable:!0,value:void 0}),typeof window.TextEncoder<"u"&&Object.defineProperty(window,"TextEncoder",{configurable:!0,enumerable:!0,value:void 0}),typeof window.TextDecoder<"u"&&Object.defineProperty(window,"TextDecoder",{configurable:!0,enumerable:!0,value:void 0}),typeof window.btoa<"u"&&Object.defineProperty(window,"btoa",{configurable:!0,enumerable:!0,value:void 0}),typeof window.atob<"u"&&Object.defineProperty(window,"atob",{configurable:!0,enumerable:!0,value:void 0}),typeof window.Event<"u"&&Object.defineProperty(window,"Event",{configurable:!0,enumerable:!0,value:void 0}),y=!1)}function oe(n){if(x.Platform.OS==="web"||y)return;if(n?.crypto!==!1&&(typeof window.crypto?.subtle?.digest>"u"||typeof window.crypto.getRandomValues>"u")){async function t(r,o){return(0,R.digest)(r,o)}if(_||(I=window.crypto,_=!0),d.default.subtle===void 0){let r={digest:t};Object.defineProperty(d.default,"subtle",{configurable:!0,get:()=>r})}Object.defineProperty(window,"crypto",{configurable:!0,enumerable:!0,get:()=>d.default})}if(n?.location!==!1&&typeof window.location>"u"){(0,V.setupURLPolyfill)();let t=new URL("/","http://localhost");t.assign=()=>{},Object.defineProperty(window,"location",{value:t,configurable:!0})}let e;n?.sessionStorage!==!1&&typeof window.sessionStorage>"u"&&Object.defineProperty(window,"sessionStorage",{configurable:!0,enumerable:!0,get:()=>e??=new M.MemoryStorage}),n?.textEncoder!==!1&&typeof window.TextEncoder>"u"&&Object.defineProperty(window,"TextEncoder",{configurable:!0,enumerable:!0,get:()=>v.TextEncoder}),n?.textEncoder!==!1&&typeof window.TextDecoder>"u"&&Object.defineProperty(window,"TextDecoder",{configurable:!0,enumerable:!0,get:()=>v.TextDecoder}),n?.btoa!==!1&&Object.defineProperty(window,"btoa",{configurable:!0,enumerable:!0,get:()=>h.encode}),n?.btoa!==!1&&Object.defineProperty(window,"atob",{configurable:!0,enumerable:!0,get:()=>h.decode}),n?.event!==!1&&typeof window.Event>"u"&&G(),y=!0}
//# sourceMappingURL=index.cjs.map
