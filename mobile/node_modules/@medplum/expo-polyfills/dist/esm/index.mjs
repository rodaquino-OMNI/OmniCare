import{MemoryStorage as M}from"@medplum/core";import{decode as R,encode as V}from"base-64";import{digest as K}from"expo-crypto";import g from"expo-standard-web-crypto";import{Platform as B}from"react-native";import{setupURLPolyfill as $}from"react-native-url-polyfill";import{TextDecoder as J,TextEncoder as X}from"text-encoding";var c=typeof window<"u"?window:typeof self<"u"?self:typeof global<"u"?global:typeof globalThis<"u"?globalThis:void 0;function f(n,e,...t){if(!n)throw new TypeError(D(e,t))}function D(n,e){let t=0;return n.replace(/%[os]/gu,()=>L(e[t++]))}function L(n){return typeof n!="object"||n===null?String(n):Object.prototype.toString.call(n)}var P;var a=class{constructor(e,t){this.code=e,this.message=t}warn(...e){try{if(P){P({...this,args:e});return}let t=(new Error().stack??"").replace(/^(?:.+?\n){2}/gu,`
`);console.warn(this.message,...e,t)}catch{}}};var E=new a("W01","Unable to initialize event under dispatching."),T=new a("W02","Assigning any falsy value to 'cancelBubble' property has no effect."),_=new a("W03","Assigning any truthy value to 'returnValue' property has no effect."),I=new a("W04","Unable to preventDefault on non-cancelable events."),x=new a("W05","Unable to preventDefault inside passive event listener invocation."),te=new a("W06","An event listener wasn't added because it has been added already: %o, %o"),ne=new a("W07","The %o option value was abandoned because the event listener wasn't added as duplicated."),re=new a("W08","The 'callback' argument must be a function or an object that has 'handleEvent' method: %o"),oe=new a("W09","Event attribute handler must be a function: %o");var s=class{static get NONE(){return A}static get CAPTURING_PHASE(){return O}static get AT_TARGET(){return W}static get BUBBLING_PHASE(){return C}constructor(e,t){Object.defineProperty(this,"isTrusted",{value:!1,enumerable:!0});let r=t??{};m.set(this,{type:String(e),bubbles:!!r.bubbles,cancelable:!!r.cancelable,composed:!!r.composed,target:null,currentTarget:null,stopPropagationFlag:!1,stopImmediatePropagationFlag:!1,canceledFlag:!1,inPassiveListenerFlag:!1,dispatchFlag:!1,timeStamp:Date.now()})}get type(){return o(this).type}get target(){return o(this).target}get srcElement(){return o(this).target}get currentTarget(){return o(this).currentTarget}composedPath(){let e=o(this).currentTarget;return e?[e]:[]}get NONE(){return A}get CAPTURING_PHASE(){return O}get AT_TARGET(){return W}get BUBBLING_PHASE(){return C}get eventPhase(){return o(this).dispatchFlag?2:0}stopPropagation(){o(this).stopPropagationFlag=!0}get cancelBubble(){return o(this).stopPropagationFlag}set cancelBubble(e){e?o(this).stopPropagationFlag=!0:T.warn()}stopImmediatePropagation(){let e=o(this);e.stopPropagationFlag=e.stopImmediatePropagationFlag=!0}get bubbles(){return o(this).bubbles}get cancelable(){return o(this).cancelable}get returnValue(){return!o(this).canceledFlag}set returnValue(e){e?_.warn():F(o(this))}preventDefault(){F(o(this))}get defaultPrevented(){return o(this).canceledFlag}get composed(){return o(this).composed}get isTrusted(){return!1}get timeStamp(){return o(this).timeStamp}initEvent(e,t=!1,r=!1){let i=o(this);if(i.dispatchFlag){E.warn();return}m.set(this,{...i,type:String(e),bubbles:!!t,cancelable:!!r,target:null,currentTarget:null,stopPropagationFlag:!1,stopImmediatePropagationFlag:!1,canceledFlag:!1})}};var A=0,O=1,W=2,C=3,m=new WeakMap;function o(n,e="this"){let t=m.get(n);return f(t!=null,"'%s' must be an object that Event constructor created, but got another one: %o",e,n),t}function F(n){if(n.inPassiveListenerFlag){x.warn();return}if(!n.cancelable){I.warn();return}n.canceledFlag=!0}Object.defineProperty(s,"NONE",{enumerable:!0});Object.defineProperty(s,"CAPTURING_PHASE",{enumerable:!0});Object.defineProperty(s,"AT_TARGET",{enumerable:!0});Object.defineProperty(s,"BUBBLING_PHASE",{enumerable:!0});var b=Object.getOwnPropertyNames(s.prototype);for(let n=0;n<b.length;++n)b[n]!=="constructor"&&Object.defineProperty(s.prototype,b[n],{enumerable:!0});typeof c<"u"&&typeof c.Event<"u"&&Object.setPrototypeOf(s.prototype,c.Event.prototype);function j(){let n=typeof globalThis<"u"&&globalThis||typeof self<"u"&&self||typeof global<"u"&&global;(()=>{if(typeof n.Event>"u")return!0;try{new n.Event("")}catch{return!0}return!1})()&&(n.Event=s)}import{ClientStorage as H,OperationOutcomeError as k}from"@medplum/core";import*as l from"expo-secure-store";import{Platform as y}from"react-native";var z=2e3,h=class extends H{constructor(){if(y.OS==="web")super(globalThis.localStorage);else{let e=new v;super(e),this.secureStorage=e}}getInitPromise(){return y.OS==="web"?Promise.resolve():this.secureStorage.getInitPromise()}get length(){return y.OS==="web"?globalThis.localStorage.length:this.secureStorage.length}},v=class{constructor(){this.initialized=!1;this.storage=new Map,this.initPromise=this.initStorage()}async initStorage(){let e;try{e=await l.getItemAsync("___keys___")}catch(r){console.error(r),await l.deleteItemAsync("___keys___"),this.initialized=!0;return}if(!e){this.initialized=!0;return}let t=JSON.parse(e);await this.buildMapFromStoredKeys(t),this.initialized=!0}async buildMapFromStoredKeys(e){let t=e.map(i=>this.getValueForKey(i)),r=await Promise.all(t);for(let i=0;i<e.length;i++){let u=r[i];u&&this.storage.set(e[i],u)}}getInitPromise(){return this.initPromise}assertInitialized(){if(!this.initialized)throw new k({id:"not-initialized",resourceType:"OperationOutcome",issue:[{severity:"error",code:"exception",details:{text:"Not initialized"},diagnostics:"Storage not initialized"}]})}get length(){return this.assertInitialized(),this.storage.size}clear(){this.assertInitialized();for(let e of this.storage.keys())this.removeItem(e,!1);this.storage.clear(),this.setKeys()}async getValueForKey(e){let t=await l.getItemAsync(e);if(!t)return t;let r=0;for(;t.endsWith("___continued___");){r++,t=t.replace("___continued___","");let i=await l.getItemAsync(`${e}___chunk${r}___`);if(!i)throw this.removeItem(e),new k({id:"key-chunk-missing",resourceType:"OperationOutcome",issue:[{severity:"error",code:"exception",details:{text:"Chunk missing for key"},diagnostics:`Chunk ${r} of key's value is missing for key '${e}'`}]});t+=i}return t}async setValueForKey(e,t){let r=G(t,z),i=[];i.push(l.setItemAsync(e,r.length===1?r[0]:`${r[0]}___continued___`));for(let u=1;u<r.length;u++)i.push(l.setItemAsync(`${e}___chunk${u}___`,u===r.length-1?r[u]:`${r[u]}___continued___`));await Promise.all(i)}setKeys(){l.setItemAsync("___keys___",JSON.stringify(Array.from(this.storage.keys()))).catch(console.error)}getItem(e){return this.assertInitialized(),this.storage.get(e)??null}setItem(e,t){this.assertInitialized(),t?(this.setValueForKey(e,t).catch(console.error),this.storage.set(e,t)):this.removeItem(e),this.setKeys()}removeItem(e,t=!0){this.assertInitialized(),l.deleteItemAsync(e).catch(console.error),this.storage.delete(e),t&&this.setKeys()}key(e){return this.assertInitialized(),null}};function G(n,e){let t=[];for(let r=0;r<n.length;r+=e)t.push(n.slice(r,r+e));return t}import{AppState as N}from"react-native";var d="unknown";function U(n){d=N.currentState,N.addEventListener("change",e=>{let t=n.getSubscriptionManager().getWebSocket();d==="active"&&e!=="active"?t.close():d!=="active"&&e==="active"&&t.readyState!==WebSocket.OPEN&&t.readyState!==WebSocket.CONNECTING&&t.reconnect(),d=e})}var p=!1,w=!1,S;function Ae(){B.OS==="web"||!p||(typeof window.crypto<"u"&&(Object.defineProperty(window,"crypto",{configurable:!0,enumerable:!0,value:S}),Object.defineProperty(g,"subtle",{configurable:!0,enumerable:!1,value:void 0}),S=void 0,w=!1),typeof window.location<"u"&&Object.defineProperty(window,"location",{configurable:!0,enumerable:!0,value:void 0}),typeof window.sessionStorage<"u"&&Object.defineProperty(window,"sessionStorage",{configurable:!0,enumerable:!0,value:void 0}),typeof window.TextEncoder<"u"&&Object.defineProperty(window,"TextEncoder",{configurable:!0,enumerable:!0,value:void 0}),typeof window.TextDecoder<"u"&&Object.defineProperty(window,"TextDecoder",{configurable:!0,enumerable:!0,value:void 0}),typeof window.btoa<"u"&&Object.defineProperty(window,"btoa",{configurable:!0,enumerable:!0,value:void 0}),typeof window.atob<"u"&&Object.defineProperty(window,"atob",{configurable:!0,enumerable:!0,value:void 0}),typeof window.Event<"u"&&Object.defineProperty(window,"Event",{configurable:!0,enumerable:!0,value:void 0}),p=!1)}function Oe(n){if(B.OS==="web"||p)return;if(n?.crypto!==!1&&(typeof window.crypto?.subtle?.digest>"u"||typeof window.crypto.getRandomValues>"u")){async function t(r,i){return K(r,i)}if(w||(S=window.crypto,w=!0),g.subtle===void 0){let r={digest:t};Object.defineProperty(g,"subtle",{configurable:!0,get:()=>r})}Object.defineProperty(window,"crypto",{configurable:!0,enumerable:!0,get:()=>g})}if(n?.location!==!1&&typeof window.location>"u"){$();let t=new URL("/","http://localhost");t.assign=()=>{},Object.defineProperty(window,"location",{value:t,configurable:!0})}let e;n?.sessionStorage!==!1&&typeof window.sessionStorage>"u"&&Object.defineProperty(window,"sessionStorage",{configurable:!0,enumerable:!0,get:()=>e??=new M}),n?.textEncoder!==!1&&typeof window.TextEncoder>"u"&&Object.defineProperty(window,"TextEncoder",{configurable:!0,enumerable:!0,get:()=>X}),n?.textEncoder!==!1&&typeof window.TextDecoder>"u"&&Object.defineProperty(window,"TextDecoder",{configurable:!0,enumerable:!0,get:()=>J}),n?.btoa!==!1&&Object.defineProperty(window,"btoa",{configurable:!0,enumerable:!0,get:()=>V}),n?.btoa!==!1&&Object.defineProperty(window,"atob",{configurable:!0,enumerable:!0,get:()=>R}),n?.event!==!1&&typeof window.Event>"u"&&j(),p=!0}export{h as ExpoClientStorage,Ae as cleanupMedplumWebAPIs,U as initWebSocketManager,Oe as polyfillMedplumWebAPIs};
//# sourceMappingURL=index.mjs.map
