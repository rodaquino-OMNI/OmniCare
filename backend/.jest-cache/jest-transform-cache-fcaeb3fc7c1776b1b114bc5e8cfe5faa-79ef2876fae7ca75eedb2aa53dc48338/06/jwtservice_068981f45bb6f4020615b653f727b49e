31e0101e9912dcf422e80463ebe5fddf
"use strict";
/**
 * OmniCare EMR Backend - JWT Authentication Service
 * HIPAA-Compliant Token Management
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.JWTAuthService = void 0;
const crypto_1 = __importDefault(require("crypto"));
const bcrypt_1 = __importDefault(require("bcrypt"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const otplib_1 = require("otplib");
const uuid_1 = require("uuid");
const auth_types_1 = require("@/types/auth.types");
const AUTH_CONFIG = {
    jwt: {
        accessTokenSecret: process.env.JWT_ACCESS_SECRET || 'access-secret-change-in-production',
        refreshTokenSecret: process.env.JWT_REFRESH_SECRET || 'refresh-secret-change-in-production',
        accessTokenExpiry: '15m',
        refreshTokenExpiry: '7d',
        issuer: 'omnicare-emr',
        audience: 'omnicare-app',
        algorithm: 'HS256'
    },
    security: {
        saltRounds: 12,
        sessionTimeout: 15 * 60 * 1000 // 15 minutes
    },
    mfa: {
        window: 1,
        digits: 6,
        period: 30,
        issuer: 'OmniCare EMR',
        backupCodesCount: 10
    },
    encryption: {
        ivLength: 16,
        encoding: 'hex'
    }
};
const PASSWORD_POLICY = {
    minLength: 8,
    requireUppercase: true,
    requireLowercase: true,
    requireNumbers: true,
    requireSpecialChars: true
};
const MFA_REQUIRED_ROLES = [auth_types_1.UserRoles.PHYSICIAN, auth_types_1.UserRoles.SYSTEM_ADMINISTRATOR];
class JWTAuthService {
    accessTokenSecret;
    refreshTokenSecret;
    constructor() {
        this.accessTokenSecret = AUTH_CONFIG.jwt.accessTokenSecret;
        this.refreshTokenSecret = AUTH_CONFIG.jwt.refreshTokenSecret;
        // Configure OTP library  
        otplib_1.authenticator.options = {
            window: AUTH_CONFIG.mfa.window,
            digits: AUTH_CONFIG.mfa.digits,
            step: AUTH_CONFIG.mfa.period
        };
    }
    /**
     * Generate JWT access and refresh tokens
     */
    generateTokens(user) {
        const sessionId = (0, uuid_1.v4)();
        const permissions = this.getRolePermissions(user.role);
        const payload = {
            userId: user.id,
            username: user.username,
            role: user.role,
            permissions,
            sessionId
        };
        const accessToken = jsonwebtoken_1.default.sign(payload, this.accessTokenSecret, {
            expiresIn: AUTH_CONFIG.jwt.accessTokenExpiry,
            issuer: AUTH_CONFIG.jwt.issuer,
            audience: AUTH_CONFIG.jwt.audience,
            algorithm: AUTH_CONFIG.jwt.algorithm
        });
        const refreshToken = jsonwebtoken_1.default.sign({ userId: user.id, sessionId }, this.refreshTokenSecret, {
            expiresIn: AUTH_CONFIG.jwt.refreshTokenExpiry,
            issuer: AUTH_CONFIG.jwt.issuer,
            audience: AUTH_CONFIG.jwt.audience,
            algorithm: AUTH_CONFIG.jwt.algorithm
        });
        return {
            accessToken,
            refreshToken,
            expiresIn: this.getTokenExpiryTime(AUTH_CONFIG.jwt.accessTokenExpiry),
            tokenType: 'Bearer'
        };
    }
    /**
     * Verify and decode JWT access token
     */
    verifyAccessToken(token) {
        try {
            const decoded = jsonwebtoken_1.default.verify(token, this.accessTokenSecret, {
                issuer: AUTH_CONFIG.jwt.issuer,
                audience: AUTH_CONFIG.jwt.audience,
                algorithms: [AUTH_CONFIG.jwt.algorithm]
            });
            return decoded;
        }
        catch {
            throw new Error('Invalid or expired access token');
        }
    }
    /**
     * Verify and decode JWT refresh token
     */
    verifyRefreshToken(token) {
        try {
            const decoded = jsonwebtoken_1.default.verify(token, this.refreshTokenSecret, {
                issuer: AUTH_CONFIG.jwt.issuer,
                audience: AUTH_CONFIG.jwt.audience,
                algorithms: [AUTH_CONFIG.jwt.algorithm]
            });
            return decoded;
        }
        catch {
            throw new Error('Invalid or expired refresh token');
        }
    }
    /**
     * Refresh access token using valid refresh token
     */
    refreshAccessToken(refreshToken, user) {
        const decoded = this.verifyRefreshToken(refreshToken);
        if (decoded.userId !== user.id) {
            throw new Error('Token user mismatch');
        }
        return this.generateTokens(user);
    }
    /**
     * Hash password using bcrypt
     */
    async hashPassword(password) {
        return bcrypt_1.default.hash(password, AUTH_CONFIG.security.saltRounds);
    }
    /**
     * Verify password against hash
     */
    async verifyPassword(password, hashedPassword) {
        return bcrypt_1.default.compare(password, hashedPassword);
    }
    /**
     * Validate password against policy
     */
    validatePassword(password) {
        const errors = [];
        if (password.length < PASSWORD_POLICY.minLength) {
            errors.push(`Password must be at least ${PASSWORD_POLICY.minLength} characters long`);
        }
        if (PASSWORD_POLICY.requireUppercase && !/[A-Z]/.test(password)) {
            errors.push('Password must contain at least one uppercase letter');
        }
        if (PASSWORD_POLICY.requireLowercase && !/[a-z]/.test(password)) {
            errors.push('Password must contain at least one lowercase letter');
        }
        if (PASSWORD_POLICY.requireNumbers && !/\d/.test(password)) {
            errors.push('Password must contain at least one number');
        }
        if (PASSWORD_POLICY.requireSpecialChars && !/[!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]/.test(password)) {
            errors.push('Password must contain at least one special character');
        }
        return {
            isValid: errors.length === 0,
            errors
        };
    }
    /**
     * Generate MFA secret for user
     */
    async generateMfaSecret(user) {
        const secret = otplib_1.authenticator.generateSecret();
        const keyuri = otplib_1.authenticator.keyuri(user.username, AUTH_CONFIG.mfa.issuer, secret);
        // Simplified QR code generation (would use proper library in production)
        const qrCode = `data:image/svg+xml;base64,${Buffer.from(keyuri).toString('base64')}`;
        const backupCodes = this.generateBackupCodes();
        return {
            secret,
            qrCode,
            backupCodes
        };
    }
    /**
     * Verify MFA token
     */
    verifyMfaToken(token, secret) {
        return otplib_1.authenticator.check(token, secret);
    }
    /**
     * Check if MFA is required for user role
     */
    isMfaRequired(role) {
        return MFA_REQUIRED_ROLES.includes(role);
    }
    /**
     * Extract token from Authorization header
     */
    extractTokenFromHeader(authHeader) {
        if (!authHeader || !authHeader.startsWith('Bearer ')) {
            return null;
        }
        return authHeader.substring(7);
    }
    /**
     * Get role permissions (simplified)
     */
    getRolePermissions(role) {
        // Simplified permission mapping using role strings
        const rolePermissions = {
            [auth_types_1.UserRoles.PHYSICIAN]: [auth_types_1.Permission.CREATE_CLINICAL_NOTES, auth_types_1.Permission.VIEW_PATIENT_RECORDS, auth_types_1.Permission.CREATE_PRESCRIPTIONS],
            [auth_types_1.UserRoles.NURSING_STAFF]: [auth_types_1.Permission.CREATE_CLINICAL_NOTES, auth_types_1.Permission.VIEW_PATIENT_RECORDS, auth_types_1.Permission.DOCUMENT_VITAL_SIGNS],
            [auth_types_1.UserRoles.ADMINISTRATIVE_STAFF]: [auth_types_1.Permission.SCHEDULE_APPOINTMENTS, auth_types_1.Permission.MANAGE_BILLING, auth_types_1.Permission.VIEW_PATIENT_DEMOGRAPHICS],
            [auth_types_1.UserRoles.SYSTEM_ADMINISTRATOR]: [auth_types_1.Permission.MANAGE_USERS, auth_types_1.Permission.CONFIGURE_SYSTEM, auth_types_1.Permission.VIEW_AUDIT_LOGS],
            [auth_types_1.UserRoles.PHARMACIST]: [auth_types_1.Permission.VIEW_PRESCRIPTIONS, auth_types_1.Permission.VERIFY_PRESCRIPTIONS, auth_types_1.Permission.DISPENSE_MEDICATIONS],
            [auth_types_1.UserRoles.LABORATORY_TECHNICIAN]: [auth_types_1.Permission.VIEW_LAB_RESULTS, auth_types_1.Permission.ENTER_LAB_RESULTS],
            [auth_types_1.UserRoles.RADIOLOGY_TECHNICIAN]: [auth_types_1.Permission.PERFORM_IMAGING_STUDIES, auth_types_1.Permission.VIEW_IMAGING_RESULTS],
            [auth_types_1.UserRoles.PATIENT]: [auth_types_1.Permission.VIEW_OWN_RECORDS, auth_types_1.Permission.REQUEST_APPOINTMENTS]
        };
        return rolePermissions[role] || [];
    }
    /**
     * Generate backup codes for MFA
     */
    generateBackupCodes() {
        const codes = [];
        for (let i = 0; i < AUTH_CONFIG.mfa.backupCodesCount; i++) {
            const code = crypto_1.default.randomBytes(4).toString('hex').toUpperCase();
            codes.push(code);
        }
        return codes;
    }
    /**
     * Convert JWT expiry string to seconds
     */
    getTokenExpiryTime(expiry) {
        const unit = expiry.slice(-1);
        const value = parseInt(expiry.slice(0, -1));
        switch (unit) {
            case 's': return value;
            case 'm': return value * 60;
            case 'h': return value * 60 * 60;
            case 'd': return value * 24 * 60 * 60;
            default: return 15 * 60; // Default 15 minutes
        }
    }
    /**
     * Generate secure random token for password reset
     */
    generateSecureToken() {
        return crypto_1.default.randomBytes(32).toString('hex');
    }
}
exports.JWTAuthService = JWTAuthService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3JvZHJpZ28vY2xhdWRlLXByb2plY3RzL09tbmlDYXJlL2JhY2tlbmQvc3JjL2F1dGgvand0LnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7Ozs7O0FBRUgsb0RBQTRCO0FBQzVCLG9EQUE0QjtBQUM1QixnRUFBK0I7QUFDL0IsbUNBQXVDO0FBQ3ZDLCtCQUFvQztBQUVwQyxtREFRNEI7QUFjNUIsTUFBTSxXQUFXLEdBQUc7SUFDbEIsR0FBRyxFQUFFO1FBQ0gsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxvQ0FBb0M7UUFDeEYsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSxxQ0FBcUM7UUFDM0YsaUJBQWlCLEVBQUUsS0FBSztRQUN4QixrQkFBa0IsRUFBRSxJQUFJO1FBQ3hCLE1BQU0sRUFBRSxjQUFjO1FBQ3RCLFFBQVEsRUFBRSxjQUFjO1FBQ3hCLFNBQVMsRUFBRSxPQUFnQjtLQUM1QjtJQUNELFFBQVEsRUFBRTtRQUNSLFVBQVUsRUFBRSxFQUFFO1FBQ2QsY0FBYyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWE7S0FDN0M7SUFDRCxHQUFHLEVBQUU7UUFDSCxNQUFNLEVBQUUsQ0FBQztRQUNULE1BQU0sRUFBRSxDQUFDO1FBQ1QsTUFBTSxFQUFFLEVBQUU7UUFDVixNQUFNLEVBQUUsY0FBYztRQUN0QixnQkFBZ0IsRUFBRSxFQUFFO0tBQ3JCO0lBQ0QsVUFBVSxFQUFFO1FBQ1YsUUFBUSxFQUFFLEVBQUU7UUFDWixRQUFRLEVBQUUsS0FBYztLQUN6QjtDQUNGLENBQUM7QUFFRixNQUFNLGVBQWUsR0FBRztJQUN0QixTQUFTLEVBQUUsQ0FBQztJQUNaLGdCQUFnQixFQUFFLElBQUk7SUFDdEIsZ0JBQWdCLEVBQUUsSUFBSTtJQUN0QixjQUFjLEVBQUUsSUFBSTtJQUNwQixtQkFBbUIsRUFBRSxJQUFJO0NBQzFCLENBQUM7QUFFRixNQUFNLGtCQUFrQixH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O1lBQzFELE1BQU0sSUFBSSxHQUFHLGdCQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNqRSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25CLENBQUM7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRDs7T0FFRztJQUNLLGtCQUFrQixDQUFDLE1BQWM7UUFDdkMsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFNUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztZQUNiLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBTyxLQUFLLENBQUM7WUFDdkIsS0FBSyxHQUFHLENBQUMsQ0FBQyxPQUFPLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDNUIsS0FBSyxHQUFHLENBQUMsQ0FBQyxPQUFPLEtBQUssR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDO1lBQ2pDLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBTyxLQUFLLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUM7WUFDdEMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMscUJBQXFCO1FBQ2hELENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxtQkFBbUI7UUFDakIsT0FBTyxnQkFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEQsQ0FBQztDQUNGO0FBNVBELHdDQTRQQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvcm9kcmlnby9jbGF1ZGUtcHJvamVjdHMvT21uaUNhcmUvYmFja2VuZC9zcmMvYXV0aC9qd3Quc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIE9tbmlDYXJlIEVNUiBCYWNrZW5kIC0gSldUIEF1dGhlbnRpY2F0aW9uIFNlcnZpY2VcbiAqIEhJUEFBLUNvbXBsaWFudCBUb2tlbiBNYW5hZ2VtZW50XG4gKi9cblxuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IGJjcnlwdCBmcm9tICdiY3J5cHQnO1xuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xuaW1wb3J0IHsgYXV0aGVudGljYXRvciB9IGZyb20gJ290cGxpYic7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcblxuaW1wb3J0IHsgXG4gIFVzZXIsIFxuICBVc2VyUm9sZSwgXG4gIFVzZXJSb2xlcyxcbiAgQXV0aFRva2VuLCBcbiAgTWZhU2V0dXAsXG4gIFNlc3Npb25JbmZvLFxuICBQZXJtaXNzaW9uXG59IGZyb20gJ0AvdHlwZXMvYXV0aC50eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9rZW5QYXlsb2FkIHtcbiAgdXNlcklkOiBzdHJpbmc7XG4gIHVzZXJuYW1lOiBzdHJpbmc7XG4gIHJvbGU6IFVzZXJSb2xlO1xuICBwZXJtaXNzaW9uczogUGVybWlzc2lvbltdO1xuICBzZXNzaW9uSWQ6IHN0cmluZztcbiAgaWF0PzogbnVtYmVyO1xuICBleHA/OiBudW1iZXI7XG4gIGlzcz86IHN0cmluZztcbiAgYXVkPzogc3RyaW5nO1xufVxuXG5jb25zdCBBVVRIX0NPTkZJRyA9IHtcbiAgand0OiB7XG4gICAgYWNjZXNzVG9rZW5TZWNyZXQ6IHByb2Nlc3MuZW52LkpXVF9BQ0NFU1NfU0VDUkVUIHx8ICdhY2Nlc3Mtc2VjcmV0LWNoYW5nZS1pbi1wcm9kdWN0aW9uJyxcbiAgICByZWZyZXNoVG9rZW5TZWNyZXQ6IHByb2Nlc3MuZW52LkpXVF9SRUZSRVNIX1NFQ1JFVCB8fCAncmVmcmVzaC1zZWNyZXQtY2hhbmdlLWluLXByb2R1Y3Rpb24nLFxuICAgIGFjY2Vzc1Rva2VuRXhwaXJ5OiAnMTVtJyxcbiAgICByZWZyZXNoVG9rZW5FeHBpcnk6ICc3ZCcsXG4gICAgaXNzdWVyOiAnb21uaWNhcmUtZW1yJyxcbiAgICBhdWRpZW5jZTogJ29tbmljYXJlLWFwcCcsXG4gICAgYWxnb3JpdGhtOiAnSFMyNTYnIGFzIGNvbnN0XG4gIH0sXG4gIHNlY3VyaXR5OiB7XG4gICAgc2FsdFJvdW5kczogMTIsXG4gICAgc2Vzc2lvblRpbWVvdXQ6IDE1ICogNjAgKiAxMDAwIC8vIDE1IG1pbnV0ZXNcbiAgfSxcbiAgbWZhOiB7XG4gICAgd2luZG93OiAxLFxuICAgIGRpZ2l0czogNixcbiAgICBwZXJpb2Q6IDMwLFxuICAgIGlzc3VlcjogJ09tbmlDYXJlIEVNUicsXG4gICAgYmFja3VwQ29kZXNDb3VudDogMTBcbiAgfSxcbiAgZW5jcnlwdGlvbjoge1xuICAgIGl2TGVuZ3RoOiAxNixcbiAgICBlbmNvZGluZzogJ2hleCcgYXMgY29uc3RcbiAgfVxufTtcblxuY29uc3QgUEFTU1dPUkRfUE9MSUNZID0ge1xuICBtaW5MZW5ndGg6IDgsXG4gIHJlcXVpcmVVcHBlcmNhc2U6IHRydWUsXG4gIHJlcXVpcmVMb3dlcmNhc2U6IHRydWUsXG4gIHJlcXVpcmVOdW1iZXJzOiB0cnVlLFxuICByZXF1aXJlU3BlY2lhbENoYXJzOiB0cnVlXG59O1xuXG5jb25zdCBNRkFfUkVRVUlSRURfUk9MRVM6IFVzZXJSb2xlW10gPSBbVXNlclJvbGVzLlBIWVNJQ0lBTiwgVXNlclJvbGVzLlNZU1RFTV9BRE1JTklTVFJBVE9SXTtcblxuZXhwb3J0IGNsYXNzIEpXVEF1dGhTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBhY2Nlc3NUb2tlblNlY3JldDogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZnJlc2hUb2tlblNlY3JldDogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuYWNjZXNzVG9rZW5TZWNyZXQgPSBBVVRIX0NPTkZJRy5qd3QuYWNjZXNzVG9rZW5TZWNyZXQ7XG4gICAgdGhpcy5yZWZyZXNoVG9rZW5TZWNyZXQgPSBBVVRIX0NPTkZJRy5qd3QucmVmcmVzaFRva2VuU2VjcmV0O1xuICAgIFxuICAgIC8vIENvbmZpZ3VyZSBPVFAgbGlicmFyeSAgXG4gICAgYXV0aGVudGljYXRvci5vcHRpb25zID0ge1xuICAgICAgd2luZG93OiBBVVRIX0NPTkZJRy5tZmEud2luZG93LFxuICAgICAgZGlnaXRzOiBBVVRIX0NPTkZJRy5tZmEuZGlnaXRzLFxuICAgICAgc3RlcDogQVVUSF9DT05GSUcubWZhLnBlcmlvZFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgSldUIGFjY2VzcyBhbmQgcmVmcmVzaCB0b2tlbnNcbiAgICovXG4gIGdlbmVyYXRlVG9rZW5zKHVzZXI6IFVzZXIpOiBBdXRoVG9rZW4ge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHV1aWR2NCgpO1xuICAgIGNvbnN0IHBlcm1pc3Npb25zID0gdGhpcy5nZXRSb2xlUGVybWlzc2lvbnModXNlci5yb2xlKTtcblxuICAgIGNvbnN0IHBheWxvYWQ6IFRva2VuUGF5bG9hZCA9IHtcbiAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgIHVzZXJuYW1lOiB1c2VyLnVzZXJuYW1lLFxuICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgcGVybWlzc2lvbnMsXG4gICAgICBzZXNzaW9uSWRcbiAgICB9O1xuXG4gICAgY29uc3QgYWNjZXNzVG9rZW4gPSBqd3Quc2lnbihcbiAgICAgIHBheWxvYWQsIFxuICAgICAgdGhpcy5hY2Nlc3NUb2tlblNlY3JldCwgXG4gICAgICB7XG4gICAgICAgIGV4cGlyZXNJbjogQVVUSF9DT05GSUcuand0LmFjY2Vzc1Rva2VuRXhwaXJ5LFxuICAgICAgICBpc3N1ZXI6IEFVVEhfQ09ORklHLmp3dC5pc3N1ZXIsXG4gICAgICAgIGF1ZGllbmNlOiBBVVRIX0NPTkZJRy5qd3QuYXVkaWVuY2UsXG4gICAgICAgIGFsZ29yaXRobTogQVVUSF9DT05GSUcuand0LmFsZ29yaXRobVxuICAgICAgfSBhcyBqd3QuU2lnbk9wdGlvbnNcbiAgICApO1xuXG4gICAgY29uc3QgcmVmcmVzaFRva2VuID0gand0LnNpZ24oXG4gICAgICB7IHVzZXJJZDogdXNlci5pZCwgc2Vzc2lvbklkIH0sXG4gICAgICB0aGlzLnJlZnJlc2hUb2tlblNlY3JldCxcbiAgICAgIHtcbiAgICAgICAgZXhwaXJlc0luOiBBVVRIX0NPTkZJRy5qd3QucmVmcmVzaFRva2VuRXhwaXJ5LFxuICAgICAgICBpc3N1ZXI6IEFVVEhfQ09ORklHLmp3dC5pc3N1ZXIsXG4gICAgICAgIGF1ZGllbmNlOiBBVVRIX0NPTkZJRy5qd3QuYXVkaWVuY2UsXG4gICAgICAgIGFsZ29yaXRobTogQVVUSF9DT05GSUcuand0LmFsZ29yaXRobVxuICAgICAgfSBhcyBqd3QuU2lnbk9wdGlvbnNcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGFjY2Vzc1Rva2VuLFxuICAgICAgcmVmcmVzaFRva2VuLFxuICAgICAgZXhwaXJlc0luOiB0aGlzLmdldFRva2VuRXhwaXJ5VGltZShBVVRIX0NPTkZJRy5qd3QuYWNjZXNzVG9rZW5FeHBpcnkpLFxuICAgICAgdG9rZW5UeXBlOiAnQmVhcmVyJ1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZ5IGFuZCBkZWNvZGUgSldUIGFjY2VzcyB0b2tlblxuICAgKi9cbiAgdmVyaWZ5QWNjZXNzVG9rZW4odG9rZW46IHN0cmluZyk6IFRva2VuUGF5bG9hZCB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRlY29kZWQgPSBqd3QudmVyaWZ5KHRva2VuLCB0aGlzLmFjY2Vzc1Rva2VuU2VjcmV0LCB7XG4gICAgICAgIGlzc3VlcjogQVVUSF9DT05GSUcuand0Lmlzc3VlcixcbiAgICAgICAgYXVkaWVuY2U6IEFVVEhfQ09ORklHLmp3dC5hdWRpZW5jZSxcbiAgICAgICAgYWxnb3JpdGhtczogW0FVVEhfQ09ORklHLmp3dC5hbGdvcml0aG1dXG4gICAgICB9KSBhcyBUb2tlblBheWxvYWQ7XG5cbiAgICAgIHJldHVybiBkZWNvZGVkO1xuICAgIH0gY2F0Y2gge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIG9yIGV4cGlyZWQgYWNjZXNzIHRva2VuJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSBhbmQgZGVjb2RlIEpXVCByZWZyZXNoIHRva2VuXG4gICAqL1xuICB2ZXJpZnlSZWZyZXNoVG9rZW4odG9rZW46IHN0cmluZyk6IHsgdXNlcklkOiBzdHJpbmc7IHNlc3Npb25JZDogc3RyaW5nIH0ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkZWNvZGVkID0gand0LnZlcmlmeSh0b2tlbiwgdGhpcy5yZWZyZXNoVG9rZW5TZWNyZXQsIHtcbiAgICAgICAgaXNzdWVyOiBBVVRIX0NPTkZJRy5qd3QuaXNzdWVyLFxuICAgICAgICBhdWRpZW5jZTogQVVUSF9DT05GSUcuand0LmF1ZGllbmNlLFxuICAgICAgICBhbGdvcml0aG1zOiBbQVVUSF9DT05GSUcuand0LmFsZ29yaXRobV1cbiAgICAgIH0pIGFzIHsgdXNlcklkOiBzdHJpbmc7IHNlc3Npb25JZDogc3RyaW5nIH07XG5cbiAgICAgIHJldHVybiBkZWNvZGVkO1xuICAgIH0gY2F0Y2gge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIG9yIGV4cGlyZWQgcmVmcmVzaCB0b2tlbicpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZWZyZXNoIGFjY2VzcyB0b2tlbiB1c2luZyB2YWxpZCByZWZyZXNoIHRva2VuXG4gICAqL1xuICByZWZyZXNoQWNjZXNzVG9rZW4ocmVmcmVzaFRva2VuOiBzdHJpbmcsIHVzZXI6IFVzZXIpOiBBdXRoVG9rZW4ge1xuICAgIGNvbnN0IGRlY29kZWQgPSB0aGlzLnZlcmlmeVJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW4pO1xuICAgIGlmIChkZWNvZGVkLnVzZXJJZCAhPT0gdXNlci5pZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUb2tlbiB1c2VyIG1pc21hdGNoJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuZ2VuZXJhdGVUb2tlbnModXNlcik7XG4gIH1cblxuICAvKipcbiAgICogSGFzaCBwYXNzd29yZCB1c2luZyBiY3J5cHRcbiAgICovXG4gIGFzeW5jIGhhc2hQYXNzd29yZChwYXNzd29yZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gYmNyeXB0Lmhhc2gocGFzc3dvcmQsIEFVVEhfQ09ORklHLnNlY3VyaXR5LnNhbHRSb3VuZHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSBwYXNzd29yZCBhZ2FpbnN0IGhhc2hcbiAgICovXG4gIGFzeW5jIHZlcmlmeVBhc3N3b3JkKHBhc3N3b3JkOiBzdHJpbmcsIGhhc2hlZFBhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gYmNyeXB0LmNvbXBhcmUocGFzc3dvcmQsIGhhc2hlZFBhc3N3b3JkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBwYXNzd29yZCBhZ2FpbnN0IHBvbGljeVxuICAgKi9cbiAgdmFsaWRhdGVQYXNzd29yZChwYXNzd29yZDogc3RyaW5nKTogeyBpc1ZhbGlkOiBib29sZWFuOyBlcnJvcnM6IHN0cmluZ1tdIH0ge1xuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICAgIGlmIChwYXNzd29yZC5sZW5ndGggPCBQQVNTV09SRF9QT0xJQ1kubWluTGVuZ3RoKSB7XG4gICAgICBlcnJvcnMucHVzaChgUGFzc3dvcmQgbXVzdCBiZSBhdCBsZWFzdCAke1BBU1NXT1JEX1BPTElDWS5taW5MZW5ndGh9IGNoYXJhY3RlcnMgbG9uZ2ApO1xuICAgIH1cblxuICAgIGlmIChQQVNTV09SRF9QT0xJQ1kucmVxdWlyZVVwcGVyY2FzZSAmJiAhL1tBLVpdLy50ZXN0KHBhc3N3b3JkKSkge1xuICAgICAgZXJyb3JzLnB1c2goJ1Bhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgdXBwZXJjYXNlIGxldHRlcicpO1xuICAgIH1cblxuICAgIGlmIChQQVNTV09SRF9QT0xJQ1kucmVxdWlyZUxvd2VyY2FzZSAmJiAhL1thLXpdLy50ZXN0KHBhc3N3b3JkKSkge1xuICAgICAgZXJyb3JzLnB1c2goJ1Bhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgbG93ZXJjYXNlIGxldHRlcicpO1xuICAgIH1cblxuICAgIGlmIChQQVNTV09SRF9QT0xJQ1kucmVxdWlyZU51bWJlcnMgJiYgIS9cXGQvLnRlc3QocGFzc3dvcmQpKSB7XG4gICAgICBlcnJvcnMucHVzaCgnUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBudW1iZXInKTtcbiAgICB9XG5cbiAgICBpZiAoUEFTU1dPUkRfUE9MSUNZLnJlcXVpcmVTcGVjaWFsQ2hhcnMgJiYgIS9bIUAjJCVeJiooKV8rXFwtPVtcXF17fTsnOlwiXFxcXHwsLjw+Lz9dLy50ZXN0KHBhc3N3b3JkKSkge1xuICAgICAgZXJyb3JzLnB1c2goJ1Bhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgc3BlY2lhbCBjaGFyYWN0ZXInKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNWYWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICAgIGVycm9yc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgTUZBIHNlY3JldCBmb3IgdXNlclxuICAgKi9cbiAgYXN5bmMgZ2VuZXJhdGVNZmFTZWNyZXQodXNlcjogVXNlcik6IFByb21pc2U8TWZhU2V0dXA+IHtcbiAgICBjb25zdCBzZWNyZXQgPSBhdXRoZW50aWNhdG9yLmdlbmVyYXRlU2VjcmV0KCk7XG4gICAgY29uc3Qga2V5dXJpID0gYXV0aGVudGljYXRvci5rZXl1cmkoXG4gICAgICB1c2VyLnVzZXJuYW1lLFxuICAgICAgQVVUSF9DT05GSUcubWZhLmlzc3VlcixcbiAgICAgIHNlY3JldFxuICAgICk7XG5cbiAgICAvLyBTaW1wbGlmaWVkIFFSIGNvZGUgZ2VuZXJhdGlvbiAod291bGQgdXNlIHByb3BlciBsaWJyYXJ5IGluIHByb2R1Y3Rpb24pXG4gICAgY29uc3QgcXJDb2RlID0gYGRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsJHtCdWZmZXIuZnJvbShrZXl1cmkpLnRvU3RyaW5nKCdiYXNlNjQnKX1gO1xuICAgIGNvbnN0IGJhY2t1cENvZGVzID0gdGhpcy5nZW5lcmF0ZUJhY2t1cENvZGVzKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc2VjcmV0LFxuICAgICAgcXJDb2RlLFxuICAgICAgYmFja3VwQ29kZXNcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSBNRkEgdG9rZW5cbiAgICovXG4gIHZlcmlmeU1mYVRva2VuKHRva2VuOiBzdHJpbmcsIHNlY3JldDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGF1dGhlbnRpY2F0b3IuY2hlY2sodG9rZW4sIHNlY3JldCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgTUZBIGlzIHJlcXVpcmVkIGZvciB1c2VyIHJvbGVcbiAgICovXG4gIGlzTWZhUmVxdWlyZWQocm9sZTogVXNlclJvbGUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gTUZBX1JFUVVJUkVEX1JPTEVTLmluY2x1ZGVzKHJvbGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3QgdG9rZW4gZnJvbSBBdXRob3JpemF0aW9uIGhlYWRlclxuICAgKi9cbiAgZXh0cmFjdFRva2VuRnJvbUhlYWRlcihhdXRoSGVhZGVyOiBzdHJpbmcgfCB1bmRlZmluZWQpOiBzdHJpbmcgfCBudWxsIHtcbiAgICBpZiAoIWF1dGhIZWFkZXIgfHwgIWF1dGhIZWFkZXIuc3RhcnRzV2l0aCgnQmVhcmVyICcpKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIGF1dGhIZWFkZXIuc3Vic3RyaW5nKDcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCByb2xlIHBlcm1pc3Npb25zIChzaW1wbGlmaWVkKVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRSb2xlUGVybWlzc2lvbnMocm9sZTogVXNlclJvbGUpOiBQZXJtaXNzaW9uW10ge1xuICAgIC8vIFNpbXBsaWZpZWQgcGVybWlzc2lvbiBtYXBwaW5nIHVzaW5nIHJvbGUgc3RyaW5nc1xuICAgIGNvbnN0IHJvbGVQZXJtaXNzaW9uczogUmVjb3JkPHN0cmluZywgUGVybWlzc2lvbltdPiA9IHtcbiAgICAgIFtVc2VyUm9sZXMuUEhZU0lDSUFOXTogW1Blcm1pc3Npb24uQ1JFQVRFX0NMSU5JQ0FMX05PVEVTLCBQZXJtaXNzaW9uLlZJRVdfUEFUSUVOVF9SRUNPUkRTLCBQZXJtaXNzaW9uLkNSRUFURV9QUkVTQ1JJUFRJT05TXSxcbiAgICAgIFtVc2VyUm9sZXMuTlVSU0lOR19TVEFGRl06IFtQZXJtaXNzaW9uLkNSRUFURV9DTElOSUNBTF9OT1RFUywgUGVybWlzc2lvbi5WSUVXX1BBVElFTlRfUkVDT1JEUywgUGVybWlzc2lvbi5ET0NVTUVOVF9WSVRBTF9TSUdOU10sXG4gICAgICBbVXNlclJvbGVzLkFETUlOSVNUUkFUSVZFX1NUQUZGXTogW1Blcm1pc3Npb24uU0NIRURVTEVfQVBQT0lOVE1FTlRTLCBQZXJtaXNzaW9uLk1BTkFHRV9CSUxMSU5HLCBQZXJtaXNzaW9uLlZJRVdfUEFUSUVOVF9ERU1PR1JBUEhJQ1NdLFxuICAgICAgW1VzZXJSb2xlcy5TWVNURU1fQURNSU5JU1RSQVRPUl06IFtQZXJtaXNzaW9uLk1BTkFHRV9VU0VSUywgUGVybWlzc2lvbi5DT05GSUdVUkVfU1lTVEVNLCBQZXJtaXNzaW9uLlZJRVdfQVVESVRfTE9HU10sXG4gICAgICBbVXNlclJvbGVzLlBIQVJNQUNJU1RdOiBbUGVybWlzc2lvbi5WSUVXX1BSRVNDUklQVElPTlMsIFBlcm1pc3Npb24uVkVSSUZZX1BSRVNDUklQVElPTlMsIFBlcm1pc3Npb24uRElTUEVOU0VfTUVESUNBVElPTlNdLFxuICAgICAgW1VzZXJSb2xlcy5MQUJPUkFUT1JZX1RFQ0hOSUNJQU5dOiBbUGVybWlzc2lvbi5WSUVXX0xBQl9SRVNVTFRTLCBQZXJtaXNzaW9uLkVOVEVSX0xBQl9SRVNVTFRTXSxcbiAgICAgIFtVc2VyUm9sZXMuUkFESU9MT0dZX1RFQ0hOSUNJQU5dOiBbUGVybWlzc2lvbi5QRVJGT1JNX0lNQUdJTkdfU1RVRElFUywgUGVybWlzc2lvbi5WSUVXX0lNQUdJTkdfUkVTVUxUU10sXG4gICAgICBbVXNlclJvbGVzLlBBVElFTlRdOiBbUGVybWlzc2lvbi5WSUVXX09XTl9SRUNPUkRTLCBQZXJtaXNzaW9uLlJFUVVFU1RfQVBQT0lOVE1FTlRTXVxuICAgIH07XG4gICAgXG4gICAgcmV0dXJuIHJvbGVQZXJtaXNzaW9uc1tyb2xlXSB8fCBbXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBiYWNrdXAgY29kZXMgZm9yIE1GQVxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZUJhY2t1cENvZGVzKCk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBjb2Rlczogc3RyaW5nW10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IEFVVEhfQ09ORklHLm1mYS5iYWNrdXBDb2Rlc0NvdW50OyBpKyspIHtcbiAgICAgIGNvbnN0IGNvZGUgPSBjcnlwdG8ucmFuZG9tQnl0ZXMoNCkudG9TdHJpbmcoJ2hleCcpLnRvVXBwZXJDYXNlKCk7XG4gICAgICBjb2Rlcy5wdXNoKGNvZGUpO1xuICAgIH1cbiAgICByZXR1cm4gY29kZXM7XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydCBKV1QgZXhwaXJ5IHN0cmluZyB0byBzZWNvbmRzXG4gICAqL1xuICBwcml2YXRlIGdldFRva2VuRXhwaXJ5VGltZShleHBpcnk6IHN0cmluZyk6IG51bWJlciB7XG4gICAgY29uc3QgdW5pdCA9IGV4cGlyeS5zbGljZSgtMSk7XG4gICAgY29uc3QgdmFsdWUgPSBwYXJzZUludChleHBpcnkuc2xpY2UoMCwgLTEpKTtcblxuICAgIHN3aXRjaCAodW5pdCkge1xuICAgICAgY2FzZSAncyc6IHJldHVybiB2YWx1ZTtcbiAgICAgIGNhc2UgJ20nOiByZXR1cm4gdmFsdWUgKiA2MDtcbiAgICAgIGNhc2UgJ2gnOiByZXR1cm4gdmFsdWUgKiA2MCAqIDYwO1xuICAgICAgY2FzZSAnZCc6IHJldHVybiB2YWx1ZSAqIDI0ICogNjAgKiA2MDtcbiAgICAgIGRlZmF1bHQ6IHJldHVybiAxNSAqIDYwOyAvLyBEZWZhdWx0IDE1IG1pbnV0ZXNcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgc2VjdXJlIHJhbmRvbSB0b2tlbiBmb3IgcGFzc3dvcmQgcmVzZXRcbiAgICovXG4gIGdlbmVyYXRlU2VjdXJlVG9rZW4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY3J5cHRvLnJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jyk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==