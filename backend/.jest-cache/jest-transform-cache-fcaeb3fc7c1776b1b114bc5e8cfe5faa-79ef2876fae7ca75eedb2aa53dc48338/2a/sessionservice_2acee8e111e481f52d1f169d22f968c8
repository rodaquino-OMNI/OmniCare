bcb09f0598bf8676535201b00d23d802
"use strict";
/**
 * OmniCare EMR Backend - Session Management Service
 * HIPAA-Compliant Session Handling
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.SessionManager = exports.InMemorySessionStore = void 0;
const events_1 = require("events");
const uuid_1 = require("uuid");
const audit_service_1 = require("@/services/audit.service");
const auth_types_1 = require("@/types/auth.types");
const AUTH_CONFIG = {
    security: {
        sessionTimeout: 15 * 60 * 1000 // 15 minutes
    }
};
const ROLE_SESSION_TIMEOUTS = {
    [auth_types_1.UserRoles.PHYSICIAN]: 30 * 60 * 1000, // 30 minutes
    [auth_types_1.UserRoles.NURSING_STAFF]: 20 * 60 * 1000, // 20 minutes
    [auth_types_1.UserRoles.ADMINISTRATIVE_STAFF]: 15 * 60 * 1000, // 15 minutes
    [auth_types_1.UserRoles.SYSTEM_ADMINISTRATOR]: 10 * 60 * 1000, // 10 minutes (more secure)
    [auth_types_1.UserRoles.PHARMACIST]: 25 * 60 * 1000, // 25 minutes
    [auth_types_1.UserRoles.LABORATORY_TECHNICIAN]: 20 * 60 * 1000, // 20 minutes
    [auth_types_1.UserRoles.RADIOLOGY_TECHNICIAN]: 20 * 60 * 1000, // 20 minutes
    [auth_types_1.UserRoles.PATIENT]: 60 * 60 * 1000, // 60 minutes (patient portal)
    [auth_types_1.UserRoles.BILLING]: 15 * 60 * 1000, // 15 minutes
    [auth_types_1.UserRoles.RECEPTIONIST]: 15 * 60 * 1000 // 15 minutes
};
class InMemorySessionStore {
    sessions = new Map();
    userSessions = new Map();
    async get(sessionId) {
        return this.sessions.get(sessionId) || null;
    }
    async set(sessionId, session, _ttl) {
        this.sessions.set(sessionId, session);
        // Add to user index
        if (!this.userSessions.has(session.userId)) {
            this.userSessions.set(session.userId, new Set());
        }
        this.userSessions.get(session.userId).add(sessionId);
    }
    async delete(sessionId) {
        const session = this.sessions.get(sessionId);
        this.sessions.delete(sessionId);
        if (session) {
            const userSessions = this.userSessions.get(session.userId);
            if (userSessions) {
                userSessions.delete(sessionId);
                if (userSessions.size === 0) {
                    this.userSessions.delete(session.userId);
                }
            }
        }
    }
    async exists(sessionId) {
        return this.sessions.has(sessionId);
    }
    async getAllUserSessions(userId) {
        const sessionIds = this.userSessions.get(userId) || new Set();
        const sessions = [];
        for (const sessionId of sessionIds) {
            const session = this.sessions.get(sessionId);
            if (session) {
                sessions.push(session);
            }
        }
        return sessions;
    }
    async deleteUserSessions(userId) {
        const sessionIds = this.userSessions.get(userId) || new Set();
        for (const sessionId of sessionIds) {
            this.sessions.delete(sessionId);
        }
        this.userSessions.delete(userId);
    }
    async cleanup() {
        let cleanedCount = 0;
        const now = new Date();
        for (const [sessionId, session] of this.sessions.entries()) {
            if (new Date(session.expiresAt) < now) {
                await this.delete(sessionId);
                cleanedCount++;
            }
        }
        return cleanedCount;
    }
}
exports.InMemorySessionStore = InMemorySessionStore;
class SessionManager extends events_1.EventEmitter {
    store;
    auditService;
    cleanupInterval;
    constructor(store) {
        super();
        this.store = store || new InMemorySessionStore();
        this.auditService = new audit_service_1.AuditService();
        // Setup periodic cleanup
        this.cleanupInterval = setInterval(() => {
            this.cleanupExpiredSessions();
        }, 5 * 60 * 1000); // Every 5 minutes
    }
    /**
     * Create a new session
     */
    async createSession(user, ipAddress, userAgent) {
        const sessionId = (0, uuid_1.v4)();
        const now = new Date();
        const sessionTimeout = ROLE_SESSION_TIMEOUTS[user.role] || AUTH_CONFIG.security.sessionTimeout;
        const expiresAt = new Date(now.getTime() + sessionTimeout);
        const session = {
            userId: user.id,
            sessionId,
            role: user.role,
            permissions: [], // Will be populated by role permissions
            ipAddress,
            userAgent,
            lastActivity: now,
            expiresAt
        };
        await this.store.set(sessionId, session, Math.floor(sessionTimeout / 1000));
        // Log session creation
        await this.auditService.logSecurityEvent({
            type: 'LOGIN_SUCCESS',
            userId: user.id,
            severity: 'LOW',
            description: `Session created for user ${user.username}`,
            metadata: { sessionId, ipAddress, userAgent, role: user.role }
        });
        this.emit('sessionCreated', session);
        return session;
    }
    /**
     * Get session by ID
     */
    async getSession(sessionId) {
        const session = await this.store.get(sessionId);
        if (!session) {
            return null;
        }
        // Check if session is expired
        if (!this.isSessionValid(session)) {
            await this.destroySession(sessionId);
            return null;
        }
        return session;
    }
    /**
     * Update session activity
     */
    async updateSessionActivity(sessionId) {
        const session = await this.getSession(sessionId);
        if (!session) {
            return null;
        }
        const now = new Date();
        const sessionTimeout = ROLE_SESSION_TIMEOUTS[session.role] || AUTH_CONFIG.security.sessionTimeout;
        session.lastActivity = now;
        session.expiresAt = new Date(now.getTime() + sessionTimeout);
        await this.store.set(sessionId, session, Math.floor(sessionTimeout / 1000));
        this.emit('sessionUpdated', session);
        return session;
    }
    /**
     * Destroy a session
     */
    async destroySession(sessionId) {
        const session = await this.store.get(sessionId);
        await this.store.delete(sessionId);
        if (session) {
            // Log session destruction
            await this.auditService.logSecurityEvent({
                type: 'LOGOUT',
                userId: session.userId,
                severity: 'LOW',
                description: `Session destroyed for user`,
                metadata: { sessionId, ipAddress: session.ipAddress }
            });
            this.emit('sessionDestroyed', session);
        }
    }
    /**
     * Destroy all sessions for a user
     */
    async destroyUserSessions(userId, excludeSessionId) {
        const sessions = await this.store.getAllUserSessions(userId);
        for (const session of sessions) {
            if (!excludeSessionId || session.sessionId !== excludeSessionId) {
                await this.destroySession(session.sessionId);
            }
        }
        // Log bulk session destruction
        await this.auditService.logSecurityEvent({
            type: 'LOGOUT',
            userId,
            severity: 'MEDIUM',
            description: `All user sessions destroyed`,
            metadata: { sessionCount: sessions.length, excludeSessionId }
        });
    }
    /**
     * Get all active sessions for a user
     */
    async getUserSessions(userId) {
        return await this.store.getAllUserSessions(userId);
    }
    /**
     * Check if session is valid
     */
    isSessionValid(session) {
        const now = new Date();
        const timeSinceLastActivity = now.getTime() - new Date(session.lastActivity).getTime();
        const sessionTimeout = ROLE_SESSION_TIMEOUTS[session.role] || AUTH_CONFIG.security.sessionTimeout;
        return (new Date(session.expiresAt) > now &&
            timeSinceLastActivity < sessionTimeout);
    }
    /**
     * Validate session security
     */
    async validateSessionSecurity(session, currentIpAddress, currentUserAgent) {
        const securityIssues = [];
        // Check IP address consistency
        if (session.ipAddress !== currentIpAddress) {
            securityIssues.push('IP address mismatch');
            // Log security event
            await this.auditService.logSecurityEvent({
                type: 'UNAUTHORIZED_ACCESS',
                userId: session.userId,
                severity: 'HIGH',
                description: `IP address mismatch for session ${session.sessionId}`,
                metadata: {
                    sessionId: session.sessionId,
                    originalIp: session.ipAddress,
                    currentIp: currentIpAddress
                }
            });
        }
        // Check user agent consistency (basic check)
        if (session.userAgent !== currentUserAgent) {
            securityIssues.push('User agent mismatch');
            // Log security event
            await this.auditService.logSecurityEvent({
                type: 'UNAUTHORIZED_ACCESS',
                userId: session.userId,
                severity: 'MEDIUM',
                description: `User agent mismatch for session ${session.sessionId}`,
                metadata: {
                    sessionId: session.sessionId,
                    originalUserAgent: session.userAgent,
                    currentUserAgent
                }
            });
        }
        return {
            isValid: securityIssues.length === 0,
            securityIssues
        };
    }
    /**
     * Force logout based on security policy
     */
    async forceLogout(userId, reason) {
        await this.destroyUserSessions(userId);
        await this.auditService.logSecurityEvent({
            type: 'LOGOUT',
            userId,
            severity: 'HIGH',
            description: `Forced logout: ${reason}`,
            metadata: { reason, forced: true }
        });
        this.emit('forceLogout', { userId, reason });
    }
    /**
     * Cleanup expired sessions
     */
    async cleanupExpiredSessions() {
        try {
            const cleanedCount = await this.store.cleanup();
            if (cleanedCount > 0) {
                console.log(`Cleaned up ${cleanedCount} expired sessions`);
                this.emit('sessionsCleanedUp', cleanedCount);
            }
        }
        catch (error) {
            console.error('Error during session cleanup:', error);
        }
    }
    /**
     * Shutdown session manager
     */
    shutdown() {
        if (this.cleanupInterval) {
            clearInterval(this.cleanupInterval);
        }
        this.removeAllListeners();
    }
}
exports.SessionManager = SessionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3JvZHJpZ28vY2xhdWRlLXByb2plY3RzL09tbmlDYXJlL2JhY2tlbmQvc3JjL3NlcnZpY2VzL3Nlc3Npb24uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFFSCxtQ0FBc0M7QUFDdEMsK0JBQW9DO0FBRXBDLDREQUF3RDtBQUN4RCxtREFBNEU7QUFFNUUsTUFBTSxXQUFXLEdBQUc7SUFDbEIsUUFBUSxFQUFFO1FBQ1IsY0FBYyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWE7S0FDN0M7Q0FDRixDQUFDO0FBRUYsTUFBTSxxQkFBcUIsR0FBNkI7SUFDdEQsQ0FBQyxzQkFBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLGFBQWE7SUFDcEQsQ0FBQyxzQkFBUyxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLGFBQWE7SUFDeEQsQ0FBQyxzQkFBUyxDQUFDLG9CQUFvQixDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsYUFBYTtJQUMvRCxDQUFDLHNCQUFTLENBQUMsb0JBQW9CLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSwyQkFBMkI7SUFDN0UsQ0FBQyxzQkFBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLGFBQWE7SUFDckQsQ0FBQyxzQkFBUyxDQUFDLHFCQUFxQixDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsYUFBYTtJQUNoRSxDQUFDLHNCQUFTLENBQUMsb0JBQW9CLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxhQUFhO0lBQy9ELENBQUMsc0JBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSw4QkFBOEI7SUFDbkUsQ0FBQyxzQkFBUyxD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aWdvL2NsYXVkZS1wcm9qZWN0cy9PbW5pQ2FyZS9iYWNrZW5kL3NyYy9zZXJ2aWNlcy9zZXNzaW9uLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBPbW5pQ2FyZSBFTVIgQmFja2VuZCAtIFNlc3Npb24gTWFuYWdlbWVudCBTZXJ2aWNlXG4gKiBISVBBQS1Db21wbGlhbnQgU2Vzc2lvbiBIYW5kbGluZ1xuICovXG5cbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcblxuaW1wb3J0IHsgQXVkaXRTZXJ2aWNlIH0gZnJvbSAnQC9zZXJ2aWNlcy9hdWRpdC5zZXJ2aWNlJztcbmltcG9ydCB7IFNlc3Npb25JbmZvLCBVc2VyLCBVc2VyUm9sZSwgVXNlclJvbGVzIH0gZnJvbSAnQC90eXBlcy9hdXRoLnR5cGVzJztcblxuY29uc3QgQVVUSF9DT05GSUcgPSB7XG4gIHNlY3VyaXR5OiB7XG4gICAgc2Vzc2lvblRpbWVvdXQ6IDE1ICogNjAgKiAxMDAwIC8vIDE1IG1pbnV0ZXNcbiAgfVxufTtcblxuY29uc3QgUk9MRV9TRVNTSU9OX1RJTUVPVVRTOiBSZWNvcmQ8VXNlclJvbGUsIG51bWJlcj4gPSB7XG4gIFtVc2VyUm9sZXMuUEhZU0lDSUFOXTogMzAgKiA2MCAqIDEwMDAsIC8vIDMwIG1pbnV0ZXNcbiAgW1VzZXJSb2xlcy5OVVJTSU5HX1NUQUZGXTogMjAgKiA2MCAqIDEwMDAsIC8vIDIwIG1pbnV0ZXNcbiAgW1VzZXJSb2xlcy5BRE1JTklTVFJBVElWRV9TVEFGRl06IDE1ICogNjAgKiAxMDAwLCAvLyAxNSBtaW51dGVzXG4gIFtVc2VyUm9sZXMuU1lTVEVNX0FETUlOSVNUUkFUT1JdOiAxMCAqIDYwICogMTAwMCwgLy8gMTAgbWludXRlcyAobW9yZSBzZWN1cmUpXG4gIFtVc2VyUm9sZXMuUEhBUk1BQ0lTVF06IDI1ICogNjAgKiAxMDAwLCAvLyAyNSBtaW51dGVzXG4gIFtVc2VyUm9sZXMuTEFCT1JBVE9SWV9URUNITklDSUFOXTogMjAgKiA2MCAqIDEwMDAsIC8vIDIwIG1pbnV0ZXNcbiAgW1VzZXJSb2xlcy5SQURJT0xPR1lfVEVDSE5JQ0lBTl06IDIwICogNjAgKiAxMDAwLCAvLyAyMCBtaW51dGVzXG4gIFtVc2VyUm9sZXMuUEFUSUVOVF06IDYwICogNjAgKiAxMDAwLCAvLyA2MCBtaW51dGVzIChwYXRpZW50IHBvcnRhbClcbiAgW1VzZXJSb2xlcy5CSUxMSU5HXTogMTUgKiA2MCAqIDEwMDAsIC8vIDE1IG1pbnV0ZXNcbiAgW1VzZXJSb2xlcy5SRUNFUFRJT05JU1RdOiAxNSAqIDYwICogMTAwMCAvLyAxNSBtaW51dGVzXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIFNlc3Npb25TdG9yZSB7XG4gIGdldChzZXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8U2Vzc2lvbkluZm8gfCBudWxsPjtcbiAgc2V0KHNlc3Npb25JZDogc3RyaW5nLCBzZXNzaW9uOiBTZXNzaW9uSW5mbywgdHRsPzogbnVtYmVyKTogUHJvbWlzZTx2b2lkPjtcbiAgZGVsZXRlKHNlc3Npb25JZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPjtcbiAgZXhpc3RzKHNlc3Npb25JZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPjtcbiAgZ2V0QWxsVXNlclNlc3Npb25zKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxTZXNzaW9uSW5mb1tdPjtcbiAgZGVsZXRlVXNlclNlc3Npb25zKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPjtcbiAgY2xlYW51cCgpOiBQcm9taXNlPG51bWJlcj47XG59XG5cbmV4cG9ydCBjbGFzcyBJbk1lbW9yeVNlc3Npb25TdG9yZSBpbXBsZW1lbnRzIFNlc3Npb25TdG9yZSB7XG4gIHByaXZhdGUgc2Vzc2lvbnM6IE1hcDxzdHJpbmcsIFNlc3Npb25JbmZvPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSB1c2VyU2Vzc2lvbnM6IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PiA9IG5ldyBNYXAoKTtcblxuICBhc3luYyBnZXQoc2Vzc2lvbklkOiBzdHJpbmcpOiBQcm9taXNlPFNlc3Npb25JbmZvIHwgbnVsbD4ge1xuICAgIHJldHVybiB0aGlzLnNlc3Npb25zLmdldChzZXNzaW9uSWQpIHx8IG51bGw7XG4gIH1cblxuICBhc3luYyBzZXQoc2Vzc2lvbklkOiBzdHJpbmcsIHNlc3Npb246IFNlc3Npb25JbmZvLCBfdHRsPzogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5zZXNzaW9ucy5zZXQoc2Vzc2lvbklkLCBzZXNzaW9uKTtcbiAgICBcbiAgICAvLyBBZGQgdG8gdXNlciBpbmRleFxuICAgIGlmICghdGhpcy51c2VyU2Vzc2lvbnMuaGFzKHNlc3Npb24udXNlcklkKSkge1xuICAgICAgdGhpcy51c2VyU2Vzc2lvbnMuc2V0KHNlc3Npb24udXNlcklkLCBuZXcgU2V0KCkpO1xuICAgIH1cbiAgICB0aGlzLnVzZXJTZXNzaW9ucy5nZXQoc2Vzc2lvbi51c2VySWQpIS5hZGQoc2Vzc2lvbklkKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZShzZXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zLmdldChzZXNzaW9uSWQpO1xuICAgIHRoaXMuc2Vzc2lvbnMuZGVsZXRlKHNlc3Npb25JZCk7XG4gICAgXG4gICAgaWYgKHNlc3Npb24pIHtcbiAgICAgIGNvbnN0IHVzZXJTZXNzaW9ucyA9IHRoaXMudXNlclNlc3Npb25zLmdldChzZXNzaW9uLnVzZXJJZCk7XG4gICAgICBpZiAodXNlclNlc3Npb25zKSB7XG4gICAgICAgIHVzZXJTZXNzaW9ucy5kZWxldGUoc2Vzc2lvbklkKTtcbiAgICAgICAgaWYgKHVzZXJTZXNzaW9ucy5zaXplID09PSAwKSB7XG4gICAgICAgICAgdGhpcy51c2VyU2Vzc2lvbnMuZGVsZXRlKHNlc3Npb24udXNlcklkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGV4aXN0cyhzZXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnNlc3Npb25zLmhhcyhzZXNzaW9uSWQpO1xuICB9XG5cbiAgYXN5bmMgZ2V0QWxsVXNlclNlc3Npb25zKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxTZXNzaW9uSW5mb1tdPiB7XG4gICAgY29uc3Qgc2Vzc2lvbklkcyA9IHRoaXMudXNlclNlc3Npb25zLmdldCh1c2VySWQpIHx8IG5ldyBTZXQoKTtcbiAgICBjb25zdCBzZXNzaW9uczogU2Vzc2lvbkluZm9bXSA9IFtdO1xuICAgIFxuICAgIGZvciAoY29uc3Qgc2Vzc2lvbklkIG9mIHNlc3Npb25JZHMpIHtcbiAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zLmdldChzZXNzaW9uSWQpO1xuICAgICAgaWYgKHNlc3Npb24pIHtcbiAgICAgICAgc2Vzc2lvbnMucHVzaChzZXNzaW9uKTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHNlc3Npb25zO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlVXNlclNlc3Npb25zKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgc2Vzc2lvbklkcyA9IHRoaXMudXNlclNlc3Npb25zLmdldCh1c2VySWQpIHx8IG5ldyBTZXQoKTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IHNlc3Npb25JZCBvZiBzZXNzaW9uSWRzKSB7XG4gICAgICB0aGlzLnNlc3Npb25zLmRlbGV0ZShzZXNzaW9uSWQpO1xuICAgIH1cbiAgICBcbiAgICB0aGlzLnVzZXJTZXNzaW9ucy5kZWxldGUodXNlcklkKTtcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXAoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBsZXQgY2xlYW5lZENvdW50ID0gMDtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIFxuICAgIGZvciAoY29uc3QgW3Nlc3Npb25JZCwgc2Vzc2lvbl0gb2YgdGhpcy5zZXNzaW9ucy5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChuZXcgRGF0ZShzZXNzaW9uLmV4cGlyZXNBdCkgPCBub3cpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5kZWxldGUoc2Vzc2lvbklkKTtcbiAgICAgICAgY2xlYW5lZENvdW50Kys7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBjbGVhbmVkQ291bnQ7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFNlc3Npb25NYW5hZ2VyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgcHJpdmF0ZSBzdG9yZTogU2Vzc2lvblN0b3JlO1xuICBwcml2YXRlIGF1ZGl0U2VydmljZTogQXVkaXRTZXJ2aWNlO1xuICBwcml2YXRlIGNsZWFudXBJbnRlcnZhbDogTm9kZUpTLlRpbWVvdXQ7XG5cbiAgY29uc3RydWN0b3Ioc3RvcmU/OiBTZXNzaW9uU3RvcmUpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuc3RvcmUgPSBzdG9yZSB8fCBuZXcgSW5NZW1vcnlTZXNzaW9uU3RvcmUoKTtcbiAgICB0aGlzLmF1ZGl0U2VydmljZSA9IG5ldyBBdWRpdFNlcnZpY2UoKTtcbiAgICBcbiAgICAvLyBTZXR1cCBwZXJpb2RpYyBjbGVhbnVwXG4gICAgdGhpcy5jbGVhbnVwSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICB0aGlzLmNsZWFudXBFeHBpcmVkU2Vzc2lvbnMoKTtcbiAgICB9LCA1ICogNjAgKiAxMDAwKTsgLy8gRXZlcnkgNSBtaW51dGVzXG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IHNlc3Npb25cbiAgICovXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24odXNlcjogVXNlciwgaXBBZGRyZXNzOiBzdHJpbmcsIHVzZXJBZ2VudDogc3RyaW5nKTogUHJvbWlzZTxTZXNzaW9uSW5mbz4ge1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHV1aWR2NCgpO1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3Qgc2Vzc2lvblRpbWVvdXQgPSBST0xFX1NFU1NJT05fVElNRU9VVFNbdXNlci5yb2xlXSB8fCBBVVRIX0NPTkZJRy5zZWN1cml0eS5zZXNzaW9uVGltZW91dDtcbiAgICBjb25zdCBleHBpcmVzQXQgPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpICsgc2Vzc2lvblRpbWVvdXQpO1xuXG4gICAgY29uc3Qgc2Vzc2lvbjogU2Vzc2lvbkluZm8gPSB7XG4gICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICBzZXNzaW9uSWQsXG4gICAgICByb2xlOiB1c2VyLnJvbGUsXG4gICAgICBwZXJtaXNzaW9uczogW10sIC8vIFdpbGwgYmUgcG9wdWxhdGVkIGJ5IHJvbGUgcGVybWlzc2lvbnNcbiAgICAgIGlwQWRkcmVzcyxcbiAgICAgIHVzZXJBZ2VudCxcbiAgICAgIGxhc3RBY3Rpdml0eTogbm93LFxuICAgICAgZXhwaXJlc0F0XG4gICAgfTtcblxuICAgIGF3YWl0IHRoaXMuc3RvcmUuc2V0KHNlc3Npb25JZCwgc2Vzc2lvbiwgTWF0aC5mbG9vcihzZXNzaW9uVGltZW91dCAvIDEwMDApKTtcblxuICAgIC8vIExvZyBzZXNzaW9uIGNyZWF0aW9uXG4gICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nU2VjdXJpdHlFdmVudCh7XG4gICAgICB0eXBlOiAnTE9HSU5fU1VDQ0VTUycsXG4gICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICBzZXZlcml0eTogJ0xPVycsXG4gICAgICBkZXNjcmlwdGlvbjogYFNlc3Npb24gY3JlYXRlZCBmb3IgdXNlciAke3VzZXIudXNlcm5hbWV9YCxcbiAgICAgIG1ldGFkYXRhOiB7IHNlc3Npb25JZCwgaXBBZGRyZXNzLCB1c2VyQWdlbnQsIHJvbGU6IHVzZXIucm9sZSB9XG4gICAgfSk7XG5cbiAgICB0aGlzLmVtaXQoJ3Nlc3Npb25DcmVhdGVkJywgc2Vzc2lvbik7XG4gICAgcmV0dXJuIHNlc3Npb247XG4gIH1cblxuICAvKipcbiAgICogR2V0IHNlc3Npb24gYnkgSURcbiAgICovXG4gIGFzeW5jIGdldFNlc3Npb24oc2Vzc2lvbklkOiBzdHJpbmcpOiBQcm9taXNlPFNlc3Npb25JbmZvIHwgbnVsbD4ge1xuICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCB0aGlzLnN0b3JlLmdldChzZXNzaW9uSWQpO1xuICAgIFxuICAgIGlmICghc2Vzc2lvbikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgc2Vzc2lvbiBpcyBleHBpcmVkXG4gICAgaWYgKCF0aGlzLmlzU2Vzc2lvblZhbGlkKHNlc3Npb24pKSB7XG4gICAgICBhd2FpdCB0aGlzLmRlc3Ryb3lTZXNzaW9uKHNlc3Npb25JZCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gc2Vzc2lvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgc2Vzc2lvbiBhY3Rpdml0eVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlU2Vzc2lvbkFjdGl2aXR5KHNlc3Npb25JZDogc3RyaW5nKTogUHJvbWlzZTxTZXNzaW9uSW5mbyB8IG51bGw+IHtcbiAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgdGhpcy5nZXRTZXNzaW9uKHNlc3Npb25JZCk7XG4gICAgXG4gICAgaWYgKCFzZXNzaW9uKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IHNlc3Npb25UaW1lb3V0ID0gUk9MRV9TRVNTSU9OX1RJTUVPVVRTW3Nlc3Npb24ucm9sZV0gfHwgQVVUSF9DT05GSUcuc2VjdXJpdHkuc2Vzc2lvblRpbWVvdXQ7XG4gICAgXG4gICAgc2Vzc2lvbi5sYXN0QWN0aXZpdHkgPSBub3c7XG4gICAgc2Vzc2lvbi5leHBpcmVzQXQgPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpICsgc2Vzc2lvblRpbWVvdXQpO1xuXG4gICAgYXdhaXQgdGhpcy5zdG9yZS5zZXQoc2Vzc2lvbklkLCBzZXNzaW9uLCBNYXRoLmZsb29yKHNlc3Npb25UaW1lb3V0IC8gMTAwMCkpO1xuICAgIFxuICAgIHRoaXMuZW1pdCgnc2Vzc2lvblVwZGF0ZWQnLCBzZXNzaW9uKTtcbiAgICByZXR1cm4gc2Vzc2lvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXN0cm95IGEgc2Vzc2lvblxuICAgKi9cbiAgYXN5bmMgZGVzdHJveVNlc3Npb24oc2Vzc2lvbklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgdGhpcy5zdG9yZS5nZXQoc2Vzc2lvbklkKTtcbiAgICBhd2FpdCB0aGlzLnN0b3JlLmRlbGV0ZShzZXNzaW9uSWQpO1xuXG4gICAgaWYgKHNlc3Npb24pIHtcbiAgICAgIC8vIExvZyBzZXNzaW9uIGRlc3RydWN0aW9uXG4gICAgICBhd2FpdCB0aGlzLmF1ZGl0U2VydmljZS5sb2dTZWN1cml0eUV2ZW50KHtcbiAgICAgICAgdHlwZTogJ0xPR09VVCcsXG4gICAgICAgIHVzZXJJZDogc2Vzc2lvbi51c2VySWQsXG4gICAgICAgIHNldmVyaXR5OiAnTE9XJyxcbiAgICAgICAgZGVzY3JpcHRpb246IGBTZXNzaW9uIGRlc3Ryb3llZCBmb3IgdXNlcmAsXG4gICAgICAgIG1ldGFkYXRhOiB7IHNlc3Npb25JZCwgaXBBZGRyZXNzOiBzZXNzaW9uLmlwQWRkcmVzcyB9XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5lbWl0KCdzZXNzaW9uRGVzdHJveWVkJywgc2Vzc2lvbik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlc3Ryb3kgYWxsIHNlc3Npb25zIGZvciBhIHVzZXJcbiAgICovXG4gIGFzeW5jIGRlc3Ryb3lVc2VyU2Vzc2lvbnModXNlcklkOiBzdHJpbmcsIGV4Y2x1ZGVTZXNzaW9uSWQ/OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzZXNzaW9ucyA9IGF3YWl0IHRoaXMuc3RvcmUuZ2V0QWxsVXNlclNlc3Npb25zKHVzZXJJZCk7XG4gICAgXG4gICAgZm9yIChjb25zdCBzZXNzaW9uIG9mIHNlc3Npb25zKSB7XG4gICAgICBpZiAoIWV4Y2x1ZGVTZXNzaW9uSWQgfHwgc2Vzc2lvbi5zZXNzaW9uSWQgIT09IGV4Y2x1ZGVTZXNzaW9uSWQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5kZXN0cm95U2Vzc2lvbihzZXNzaW9uLnNlc3Npb25JZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTG9nIGJ1bGsgc2Vzc2lvbiBkZXN0cnVjdGlvblxuICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoe1xuICAgICAgdHlwZTogJ0xPR09VVCcsXG4gICAgICB1c2VySWQsXG4gICAgICBzZXZlcml0eTogJ01FRElVTScsXG4gICAgICBkZXNjcmlwdGlvbjogYEFsbCB1c2VyIHNlc3Npb25zIGRlc3Ryb3llZGAsXG4gICAgICBtZXRhZGF0YTogeyBzZXNzaW9uQ291bnQ6IHNlc3Npb25zLmxlbmd0aCwgZXhjbHVkZVNlc3Npb25JZCB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCBhY3RpdmUgc2Vzc2lvbnMgZm9yIGEgdXNlclxuICAgKi9cbiAgYXN5bmMgZ2V0VXNlclNlc3Npb25zKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxTZXNzaW9uSW5mb1tdPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc3RvcmUuZ2V0QWxsVXNlclNlc3Npb25zKHVzZXJJZCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgc2Vzc2lvbiBpcyB2YWxpZFxuICAgKi9cbiAgaXNTZXNzaW9uVmFsaWQoc2Vzc2lvbjogU2Vzc2lvbkluZm8pOiBib29sZWFuIHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IHRpbWVTaW5jZUxhc3RBY3Rpdml0eSA9IG5vdy5nZXRUaW1lKCkgLSBuZXcgRGF0ZShzZXNzaW9uLmxhc3RBY3Rpdml0eSkuZ2V0VGltZSgpO1xuICAgIGNvbnN0IHNlc3Npb25UaW1lb3V0ID0gUk9MRV9TRVNTSU9OX1RJTUVPVVRTW3Nlc3Npb24ucm9sZV0gfHwgQVVUSF9DT05GSUcuc2VjdXJpdHkuc2Vzc2lvblRpbWVvdXQ7XG4gICAgXG4gICAgcmV0dXJuIChcbiAgICAgIG5ldyBEYXRlKHNlc3Npb24uZXhwaXJlc0F0KSA+IG5vdyAmJlxuICAgICAgdGltZVNpbmNlTGFzdEFjdGl2aXR5IDwgc2Vzc2lvblRpbWVvdXRcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIHNlc3Npb24gc2VjdXJpdHlcbiAgICovXG4gIGFzeW5jIHZhbGlkYXRlU2Vzc2lvblNlY3VyaXR5KHNlc3Npb246IFNlc3Npb25JbmZvLCBjdXJyZW50SXBBZGRyZXNzOiBzdHJpbmcsIGN1cnJlbnRVc2VyQWdlbnQ6IHN0cmluZyk6IFByb21pc2U8e1xuICAgIGlzVmFsaWQ6IGJvb2xlYW47XG4gICAgc2VjdXJpdHlJc3N1ZXM6IHN0cmluZ1tdO1xuICB9PiB7XG4gICAgY29uc3Qgc2VjdXJpdHlJc3N1ZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBDaGVjayBJUCBhZGRyZXNzIGNvbnNpc3RlbmN5XG4gICAgaWYgKHNlc3Npb24uaXBBZGRyZXNzICE9PSBjdXJyZW50SXBBZGRyZXNzKSB7XG4gICAgICBzZWN1cml0eUlzc3Vlcy5wdXNoKCdJUCBhZGRyZXNzIG1pc21hdGNoJyk7XG4gICAgICBcbiAgICAgIC8vIExvZyBzZWN1cml0eSBldmVudFxuICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nU2VjdXJpdHlFdmVudCh7XG4gICAgICAgIHR5cGU6ICdVTkFVVEhPUklaRURfQUNDRVNTJyxcbiAgICAgICAgdXNlcklkOiBzZXNzaW9uLnVzZXJJZCxcbiAgICAgICAgc2V2ZXJpdHk6ICdISUdIJyxcbiAgICAgICAgZGVzY3JpcHRpb246IGBJUCBhZGRyZXNzIG1pc21hdGNoIGZvciBzZXNzaW9uICR7c2Vzc2lvbi5zZXNzaW9uSWR9YCxcbiAgICAgICAgbWV0YWRhdGE6IHsgXG4gICAgICAgICAgc2Vzc2lvbklkOiBzZXNzaW9uLnNlc3Npb25JZCxcbiAgICAgICAgICBvcmlnaW5hbElwOiBzZXNzaW9uLmlwQWRkcmVzcyxcbiAgICAgICAgICBjdXJyZW50SXA6IGN1cnJlbnRJcEFkZHJlc3NcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgdXNlciBhZ2VudCBjb25zaXN0ZW5jeSAoYmFzaWMgY2hlY2spXG4gICAgaWYgKHNlc3Npb24udXNlckFnZW50ICE9PSBjdXJyZW50VXNlckFnZW50KSB7XG4gICAgICBzZWN1cml0eUlzc3Vlcy5wdXNoKCdVc2VyIGFnZW50IG1pc21hdGNoJyk7XG4gICAgICBcbiAgICAgIC8vIExvZyBzZWN1cml0eSBldmVudFxuICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nU2VjdXJpdHlFdmVudCh7XG4gICAgICAgIHR5cGU6ICdVTkFVVEhPUklaRURfQUNDRVNTJyxcbiAgICAgICAgdXNlcklkOiBzZXNzaW9uLnVzZXJJZCxcbiAgICAgICAgc2V2ZXJpdHk6ICdNRURJVU0nLFxuICAgICAgICBkZXNjcmlwdGlvbjogYFVzZXIgYWdlbnQgbWlzbWF0Y2ggZm9yIHNlc3Npb24gJHtzZXNzaW9uLnNlc3Npb25JZH1gLFxuICAgICAgICBtZXRhZGF0YTogeyBcbiAgICAgICAgICBzZXNzaW9uSWQ6IHNlc3Npb24uc2Vzc2lvbklkLFxuICAgICAgICAgIG9yaWdpbmFsVXNlckFnZW50OiBzZXNzaW9uLnVzZXJBZ2VudCxcbiAgICAgICAgICBjdXJyZW50VXNlckFnZW50XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBpc1ZhbGlkOiBzZWN1cml0eUlzc3Vlcy5sZW5ndGggPT09IDAsXG4gICAgICBzZWN1cml0eUlzc3Vlc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogRm9yY2UgbG9nb3V0IGJhc2VkIG9uIHNlY3VyaXR5IHBvbGljeVxuICAgKi9cbiAgYXN5bmMgZm9yY2VMb2dvdXQodXNlcklkOiBzdHJpbmcsIHJlYXNvbjogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5kZXN0cm95VXNlclNlc3Npb25zKHVzZXJJZCk7XG4gICAgXG4gICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nU2VjdXJpdHlFdmVudCh7XG4gICAgICB0eXBlOiAnTE9HT1VUJyxcbiAgICAgIHVzZXJJZCxcbiAgICAgIHNldmVyaXR5OiAnSElHSCcsXG4gICAgICBkZXNjcmlwdGlvbjogYEZvcmNlZCBsb2dvdXQ6ICR7cmVhc29ufWAsXG4gICAgICBtZXRhZGF0YTogeyByZWFzb24sIGZvcmNlZDogdHJ1ZSB9XG4gICAgfSk7XG5cbiAgICB0aGlzLmVtaXQoJ2ZvcmNlTG9nb3V0JywgeyB1c2VySWQsIHJlYXNvbiB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbnVwIGV4cGlyZWQgc2Vzc2lvbnNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgY2xlYW51cEV4cGlyZWRTZXNzaW9ucygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY2xlYW5lZENvdW50ID0gYXdhaXQgdGhpcy5zdG9yZS5jbGVhbnVwKCk7XG4gICAgICBcbiAgICAgIGlmIChjbGVhbmVkQ291bnQgPiAwKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBDbGVhbmVkIHVwICR7Y2xlYW5lZENvdW50fSBleHBpcmVkIHNlc3Npb25zYCk7XG4gICAgICAgIHRoaXMuZW1pdCgnc2Vzc2lvbnNDbGVhbmVkVXAnLCBjbGVhbmVkQ291bnQpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBkdXJpbmcgc2Vzc2lvbiBjbGVhbnVwOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2h1dGRvd24gc2Vzc2lvbiBtYW5hZ2VyXG4gICAqL1xuICBzaHV0ZG93bigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jbGVhbnVwSW50ZXJ2YWwpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5jbGVhbnVwSW50ZXJ2YWwpO1xuICAgIH1cbiAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=