8013826315b1f8085516b7d2e3f6cd5e
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.authController = exports.AuthController = void 0;
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const jwt_service_1 = require("@/auth/jwt.service");
const config_1 = __importDefault(require("@/config"));
const audit_service_1 = require("@/services/audit.service");
const session_service_1 = require("@/services/session.service");
const smart_fhir_service_1 = require("@/services/smart-fhir.service");
const auth_types_1 = require("@/types/auth.types");
const logger_1 = __importDefault(require("@/utils/logger"));
const error_utils_1 = require("@/utils/error.utils");
/**
 * Authentication Controller
 * Handles SMART on FHIR authentication flows and internal JWT authentication
 */
class AuthController {
    jwtService;
    sessionManager;
    auditService;
    constructor() {
        this.jwtService = new jwt_service_1.JWTAuthService();
        this.sessionManager = new session_service_1.SessionManager();
        this.auditService = new audit_service_1.AuditService();
    }
    // ===============================
    // SMART ON FHIR AUTHORIZATION
    // ===============================
    /**
     * GET /auth/authorize - SMART authorization endpoint
     */
    async authorize(req, res) {
        try {
            const { response_type, client_id, redirect_uri, scope, state, aud, launch, } = req.query;
            logger_1.default.security('SMART authorization request', {
                client_id,
                response_type,
                scope,
                aud,
                launch: !!launch,
                ip: req.ip,
                userAgent: req.get('User-Agent'),
            });
            // Validate required parameters
            if (!response_type || response_type !== 'code') {
                res.status(400).json({
                    error: 'invalid_request',
                    error_description: 'response_type must be "code"',
                });
                return;
            }
            if (!client_id) {
                res.status(400).json({
                    error: 'invalid_request',
                    error_description: 'client_id is required',
                });
                return;
            }
            if (!redirect_uri) {
                res.status(400).json({
                    error: 'invalid_request',
                    error_description: 'redirect_uri is required',
                });
                return;
            }
            const scopes = scope ? scope.split(' ') : config_1.default.smart.scopes;
            let authResult;
            if (launch) {
                // EHR launch scenario
                if (!aud) {
                    res.status(400).json({
                        error: 'invalid_request',
                        error_description: 'aud parameter required for EHR launch',
                    });
                    return;
                }
                authResult = await smart_fhir_service_1.smartFHIRService.handleEHRLaunch(aud, launch, client_id, redirect_uri, scopes);
            }
            else {
                // Standalone launch scenario
                authResult = await smart_fhir_service_1.smartFHIRService.initiateAuthorization(client_id, redirect_uri, scopes, state, aud);
            }
            // For this example, we'll redirect directly to simulate user consent
            // In production, this would show a consent screen
            const authCode = this.generateAuthorizationCode();
            const finalState = state || authResult.state;
            // Store authorization code temporarily (in production, use secure storage)
            this.storeAuthorizationCode(authCode, {
                client_id,
                redirect_uri,
                scope: scopes.join(' '),
                state: finalState,
                aud,
                launch,
                expiresAt: Date.now() + (10 * 60 * 1000), // 10 minutes
            });
            const redirectUrl = new URL(redirect_uri);
            redirectUrl.searchParams.append('code', authCode);
            redirectUrl.searchParams.append('state', finalState);
            logger_1.default.security('SMART authorization code generated', {
                client_id,
                state: finalState,
                hasLaunch: !!launch,
            });
            res.redirect(redirectUrl.toString());
        }
        catch (error) {
            logger_1.default.error('SMART authorization failed:', error);
            res.status(500).json({
                error: 'server_error',
                error_description: 'Authorization server error',
            });
        }
    }
    /**
     * POST /auth/token - SMART token endpoint
     */
    async token(req, res) {
        try {
            const { grant_type, code, redirect_uri, client_id, client_secret, code_verifier, refresh_token, } = req.body;
            logger_1.default.security('SMART token request', {
                grant_type,
                client_id,
                hasCode: !!code,
                hasRefreshToken: !!refresh_token,
                ip: req.ip,
            });
            if (grant_type === 'authorization_code') {
                await this.handleAuthorizationCodeGrant(req, res);
            }
            else if (grant_type === 'refresh_token') {
                await this.handleRefreshTokenGrant(req, res);
            }
            else if (grant_type === 'client_credentials') {
                await this.handleClientCredentialsGrant(req, res);
            }
            else {
                res.status(400).json({
                    error: 'unsupported_grant_type',
                    error_description: 'Supported grant types: authorization_code, refresh_token, client_credentials',
                });
            }
        }
        catch (error) {
            logger_1.default.error('SMART token request failed:', error);
            res.status(500).json({
                error: 'server_error',
                error_description: 'Token server error',
            });
        }
    }
    /**
     * Handle authorization code grant
     */
    async handleAuthorizationCodeGrant(req, res) {
        const { code, redirect_uri, client_id, code_verifier } = req.body;
        // Validate required parameters
        if (!code || !redirect_uri || !client_id) {
            res.status(400).json({
                error: 'invalid_request',
                error_description: 'code, redirect_uri, and client_id are required',
            });
            return;
        }
        // Retrieve and validate authorization code
        const authData = this.getAuthorizationCode(code);
        if (!authData) {
            res.status(400).json({
                error: 'invalid_grant',
                error_description: 'Invalid or expired authorization code',
            });
            return;
        }
        if (authData.client_id !== client_id || authData.redirect_uri !== redirect_uri) {
            res.status(400).json({
                error: 'invalid_grant',
                error_description: 'Invalid client_id or redirect_uri',
            });
            return;
        }
        if (Date.now() > authData.expiresAt) {
            this.removeAuthorizationCode(code);
            res.status(400).json({
                error: 'invalid_grant',
                error_description: 'Authorization code expired',
            });
            return;
        }
        // Generate tokens
        const accessToken = this.generateAccessToken({
            client_id,
            scope: authData.scope,
            aud: authData.aud,
            launch: authData.launch,
        });
        const refreshToken = this.generateRefreshToken({
            client_id,
            scope: authData.scope,
        });
        // Remove used authorization code
        this.removeAuthorizationCode(code);
        const tokenResponse = {
            access_token: accessToken,
            token_type: 'bearer',
            expires_in: 3600,
            scope: authData.scope,
            refresh_token: refreshToken,
        };
        // Add SMART-specific parameters if available
        if (authData.launch) {
            // In a real implementation, you would extract patient/encounter from launch context
            tokenResponse.patient = 'example-patient-id';
            tokenResponse.encounter = 'example-encounter-id';
            tokenResponse.need_patient_banner = true;
            tokenResponse.smart_style_url = `${config_1.default.fhir.baseUrl}/smart-style.json`;
        }
        logger_1.default.security('SMART access token issued', {
            client_id,
            scope: authData.scope,
            hasLaunch: !!authData.launch,
        });
        res.json(tokenResponse);
    }
    /**
     * Handle refresh token grant
     */
    async handleRefreshTokenGrant(req, res) {
        const { refresh_token, client_id } = req.body;
        if (!refresh_token || !client_id) {
            res.status(400).json({
                error: 'invalid_request',
                error_description: 'refresh_token and client_id are required',
            });
            return;
        }
        try {
            // Verify refresh token
            const decoded = jsonwebtoken_1.default.verify(refresh_token, config_1.default.jwt.secret);
            if (decoded.client_id !== client_id || decoded.type !== 'refresh') {
                res.status(400).json({
                    error: 'invalid_grant',
                    error_description: 'Invalid refresh token',
                });
                return;
            }
            // Generate new access token
            const accessToken = this.generateAccessToken({
                client_id,
                scope: decoded.scope,
                aud: decoded.aud,
            });
            const tokenResponse = {
                access_token: accessToken,
                token_type: 'bearer',
                expires_in: 3600,
                scope: decoded.scope,
            };
            logger_1.default.security('SMART token refreshed', {
                client_id,
                scope: decoded.scope,
            });
            res.json(tokenResponse);
        }
        catch (error) {
            res.status(400).json({
                error: 'invalid_grant',
                error_description: 'Invalid refresh token',
            });
        }
    }
    /**
     * Handle client credentials grant
     */
    async handleClientCredentialsGrant(req, res) {
        const { client_id, client_secret, scope } = req.body;
        if (!client_id || !client_secret) {
            res.status(400).json({
                error: 'invalid_request',
                error_description: 'client_id and client_secret are required',
            });
            return;
        }
        // In production, validate client credentials against a secure store
        const isValidClient = await this.validateClientCredentials(client_id, client_secret);
        if (!isValidClient) {
            res.status(401).json({
                error: 'invalid_client',
                error_description: 'Invalid client credentials',
            });
            return;
        }
        const requestedScope = scope || 'system/*.read';
        // Generate access token for system access
        const accessToken = this.generateAccessToken({
            client_id,
            scope: requestedScope,
            type: 'system',
        });
        const tokenResponse = {
            access_token: accessToken,
            token_type: 'bearer',
            expires_in: 3600,
            scope: requestedScope,
        };
        logger_1.default.security('System access token issued', {
            client_id,
            scope: requestedScope,
        });
        res.json(tokenResponse);
    }
    /**
     * POST /auth/introspect - Token introspection endpoint
     */
    async introspect(req, res) {
        try {
            const { token } = req.body;
            if (!token) {
                res.status(400).json({
                    error: 'invalid_request',
                    error_description: 'token parameter is required',
                });
                return;
            }
            logger_1.default.security('Token introspection request', {
                ip: req.ip,
            });
            try {
                const decoded = jsonwebtoken_1.default.verify(token, config_1.default.jwt.secret);
                const introspectionResponse = {
                    active: true,
                    scope: decoded.scope,
                    client_id: decoded.client_id,
                    sub: decoded.sub,
                    exp: decoded.exp,
                    iat: decoded.iat,
                    aud: decoded.aud,
                    iss: decoded.iss,
                    patient: decoded.patient,
                    encounter: decoded.encounter,
                    fhirUser: decoded.fhirUser,
                };
                res.json(introspectionResponse);
            }
            catch (jwtError) {
                // Token is invalid or expired
                res.json({ active: false });
            }
        }
        catch (error) {
            logger_1.default.error('Token introspection failed:', error);
            res.status(500).json({
                error: 'server_error',
                error_description: 'Introspection server error',
            });
        }
    }
    // ===============================
    // INTERNAL API AUTHENTICATION
    // ===============================
    /**
     * POST /auth/login - JWT-based authentication
     */
    async login(req, res) {
        try {
            const { username, password, mfaToken } = req.body;
            const ipAddress = req.ip || 'unknown';
            const userAgent = req.get('User-Agent') || 'unknown';
            await this.auditService.logSecurityEvent({
                type: 'LOGIN_FAILURE',
                severity: 'LOW',
                description: `Login attempt for username: ${username}`,
                metadata: { username, ipAddress, userAgent }
            });
            // Validate credentials
            const user = await this.validateUserCredentials(username, password);
            if (!user) {
                await this.auditService.logSecurityEvent({
                    type: 'LOGIN_FAILURE',
                    severity: 'MEDIUM',
                    description: `Failed login attempt - invalid credentials`,
                    metadata: { username, ipAddress, userAgent }
                });
                res.status(401).json({
                    success: false,
                    error: 'INVALID_CREDENTIALS',
                    message: 'Invalid username or password'
                });
                return;
            }
            // Check if account is locked
            if (user.accountLockedUntil && user.accountLockedUntil > new Date()) {
                await this.auditService.logSecurityEvent({
                    type: 'LOGIN_FAILURE',
                    userId: user.id,
                    severity: 'MEDIUM',
                    description: 'Login attempt on locked account',
                    metadata: { username, ipAddress, userAgent, lockedUntil: user.accountLockedUntil }
                });
                res.status(423).json({
                    success: false,
                    error: 'ACCOUNT_LOCKED',
                    message: 'Account is temporarily locked due to multiple failed login attempts'
                });
                return;
            }
            // Check if user is active
            if (!user.isActive) {
                await this.auditService.logSecurityEvent({
                    type: 'LOGIN_FAILURE',
                    userId: user.id,
                    severity: 'MEDIUM',
                    description: 'Login attempt on inactive account',
                    metadata: { username, ipAddress, userAgent }
                });
                res.status(403).json({
                    success: false,
                    error: 'ACCOUNT_INACTIVE',
                    message: 'Account is not active'
                });
                return;
            }
            // Check MFA if required
            if (this.jwtService.isMfaRequired(user.role) && user.isMfaEnabled) {
                if (!mfaToken) {
                    res.status(200).json({
                        success: false,
                        requiresMfa: true,
                        message: 'Multi-factor authentication required'
                    });
                    return;
                }
                if (!user.mfaSecret || !this.jwtService.verifyMfaToken(mfaToken, user.mfaSecret)) {
                    await this.auditService.logSecurityEvent({
                        type: 'LOGIN_FAILURE',
                        userId: user.id,
                        severity: 'HIGH',
                        description: 'Invalid MFA token provided',
                        metadata: { username, ipAddress, userAgent }
                    });
                    res.status(401).json({
                        success: false,
                        error: 'INVALID_MFA_TOKEN',
                        message: 'Invalid multi-factor authentication token'
                    });
                    return;
                }
            }
            // Generate JWT tokens
            const tokens = await this.jwtService.generateTokens(user);
            // Create session
            const session = await this.sessionManager.createSession(user, ipAddress, userAgent);
            // Update user login info
            await this.updateUserLoginInfo(user.id, ipAddress);
            // Log successful login
            await this.auditService.logSecurityEvent({
                type: 'LOGIN_SUCCESS',
                userId: user.id,
                severity: 'LOW',
                description: `Successful login for ${user.username}`,
                metadata: {
                    username: user.username,
                    role: user.role,
                    sessionId: session.sessionId,
                    ipAddress,
                    userAgent
                }
            });
            res.json({
                success: true,
                tokens,
                user: {
                    id: user.id,
                    username: user.username,
                    email: user.email,
                    firstName: user.firstName,
                    lastName: user.lastName,
                    role: user.role,
                    department: user.department,
                    isActive: user.isActive,
                    isMfaEnabled: user.isMfaEnabled,
                    lastLogin: user.lastLogin
                },
                session: {
                    sessionId: session.sessionId,
                    expiresAt: session.expiresAt
                }
            });
        }
        catch (error) {
            logger_1.default.error('Login failed:', error);
            await this.auditService.logSecurityEvent({
                type: 'LOGIN_FAILURE',
                severity: 'HIGH',
                description: 'Login system error',
                metadata: { error: (0, error_utils_1.getErrorMessage)(error), ipAddress: req.ip }
            });
            res.status(500).json({
                success: false,
                error: 'INTERNAL_ERROR',
                message: 'An internal error occurred during login'
            });
        }
    }
    /**
     * POST /auth/refresh - Refresh access token
     */
    async refreshToken(req, res) {
        try {
            const { refreshToken } = req.body;
            const ipAddress = req.ip || 'unknown';
            const userAgent = req.get('User-Agent') || 'unknown';
            if (!refreshToken) {
                res.status(400).json({
                    success: false,
                    error: 'MISSING_REFRESH_TOKEN',
                    message: 'Refresh token is required'
                });
                return;
            }
            // Verify refresh token
            const decoded = await this.jwtService.verifyRefreshToken(refreshToken);
            // Get user
            const user = await this.getUserById(decoded.userId);
            if (!user || !user.isActive) {
                res.status(401).json({
                    success: false,
                    error: 'USER_NOT_FOUND',
                    message: 'User not found or inactive'
                });
                return;
            }
            // Generate new tokens
            const tokens = await this.jwtService.refreshAccessToken(refreshToken, user);
            // Log token refresh
            await this.auditService.logUserAction(user.id, 'token_refresh', '/auth/refresh', undefined, ipAddress, userAgent, true);
            res.json({
                success: true,
                tokens
            });
        }
        catch (error) {
            logger_1.default.error('Token refresh failed:', error);
            await this.auditService.logSecurityEvent({
                type: 'LOGIN_FAILURE',
                severity: 'MEDIUM',
                description: 'Token refresh failed',
                metadata: { error: (0, error_utils_1.getErrorMessage)(error), ipAddress: req.ip }
            });
            res.status(401).json({
                success: false,
                error: 'INVALID_REFRESH_TOKEN',
                message: 'Invalid or expired refresh token'
            });
        }
    }
    /**
     * POST /auth/logout - Logout and destroy session
     */
    async logout(req, res) {
        try {
            const authHeader = req.get('Authorization');
            const token = this.jwtService.extractTokenFromHeader(authHeader);
            const ipAddress = req.ip || 'unknown';
            const userAgent = req.get('User-Agent') || 'unknown';
            if (token) {
                try {
                    const tokenPayload = await this.jwtService.verifyAccessToken(token);
                    // Destroy session
                    await this.sessionManager.destroySession(tokenPayload.sessionId);
                    // Log logout
                    await this.auditService.logSecurityEvent({
                        type: 'LOGOUT',
                        userId: tokenPayload.userId,
                        severity: 'LOW',
                        description: `User ${tokenPayload.username} logged out`,
                        metadata: {
                            sessionId: tokenPayload.sessionId,
                            ipAddress,
                            userAgent
                        }
                    });
                }
                catch (error) {
                    // Token might be invalid, but that's okay for logout
                    logger_1.default.warn('Token verification failed during logout:', (0, error_utils_1.getErrorMessage)(error));
                }
            }
            res.json({
                success: true,
                message: 'Successfully logged out'
            });
        }
        catch (error) {
            logger_1.default.error('Logout failed:', error);
            res.status(500).json({
                success: false,
                error: 'LOGOUT_ERROR',
                message: 'An error occurred during logout'
            });
        }
    }
    /**
     * POST /auth/setup-mfa - Setup multi-factor authentication
     */
    async setupMfa(req, res) {
        try {
            const { userId } = req.body;
            const user = await this.getUserById(userId);
            if (!user) {
                res.status(404).json({
                    success: false,
                    error: 'USER_NOT_FOUND',
                    message: 'User not found'
                });
                return;
            }
            const mfaSetup = await this.jwtService.generateMfaSecret(user);
            // Store secret temporarily (user must verify before enabling)
            await this.storeTempMfaSecret(userId, mfaSetup.secret);
            await this.auditService.logUserAction(userId, 'mfa_setup_initiated', '/auth/setup-mfa', undefined, req.ip || 'unknown', req.get('User-Agent') || 'unknown', true);
            res.json({
                success: true,
                mfaSetup: {
                    qrCode: mfaSetup.qrCode,
                    backupCodes: mfaSetup.backupCodes
                }
            });
        }
        catch (error) {
            logger_1.default.error('MFA setup failed:', error);
            res.status(500).json({
                success: false,
                error: 'MFA_SETUP_ERROR',
                message: 'Failed to setup multi-factor authentication'
            });
        }
    }
    /**
     * POST /auth/verify-mfa - Verify and enable MFA
     */
    async verifyMfa(req, res) {
        try {
            const { userId, token } = req.body;
            const tempSecret = await this.getTempMfaSecret(userId);
            if (!tempSecret) {
                res.status(400).json({
                    success: false,
                    error: 'NO_PENDING_MFA_SETUP',
                    message: 'No pending MFA setup found'
                });
                return;
            }
            if (!this.jwtService.verifyMfaToken(token, tempSecret)) {
                res.status(401).json({
                    success: false,
                    error: 'INVALID_MFA_TOKEN',
                    message: 'Invalid MFA token'
                });
                return;
            }
            // Enable MFA for user
            await this.enableUserMfa(userId, tempSecret);
            await this.clearTempMfaSecret(userId);
            await this.auditService.logSecurityEvent({
                type: 'MFA_ENABLED',
                userId,
                severity: 'MEDIUM',
                description: 'Multi-factor authentication enabled',
                metadata: { ipAddress: req.ip }
            });
            res.json({
                success: true,
                message: 'Multi-factor authentication enabled successfully'
            });
        }
        catch (error) {
            logger_1.default.error('MFA verification failed:', error);
            res.status(500).json({
                success: false,
                error: 'MFA_VERIFICATION_ERROR',
                message: 'Failed to verify multi-factor authentication'
            });
        }
    }
    /**
     * GET /auth/me - Get current user info
     */
    async getCurrentUser(req, res) {
        try {
            const authHeader = req.get('Authorization');
            const token = this.jwtService.extractTokenFromHeader(authHeader);
            if (!token) {
                res.status(401).json({
                    success: false,
                    error: 'NO_TOKEN',
                    message: 'No authentication token provided'
                });
                return;
            }
            const tokenPayload = await this.jwtService.verifyAccessToken(token);
            const user = await this.getUserById(tokenPayload.userId);
            if (!user) {
                res.status(404).json({
                    success: false,
                    error: 'USER_NOT_FOUND',
                    message: 'User not found'
                });
                return;
            }
            res.json({
                success: true,
                user: {
                    id: user.id,
                    username: user.username,
                    email: user.email,
                    firstName: user.firstName,
                    lastName: user.lastName,
                    role: user.role,
                    department: user.department,
                    isActive: user.isActive,
                    isMfaEnabled: user.isMfaEnabled,
                    lastLogin: user.lastLogin
                }
            });
        }
        catch (error) {
            res.status(401).json({
                success: false,
                error: 'INVALID_TOKEN',
                message: 'Invalid or expired token'
            });
        }
    }
    // ===============================
    // UTILITY METHODS
    // ===============================
    generateAuthorizationCode() {
        return `code_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    generateAccessToken(payload) {
        return jsonwebtoken_1.default.sign({
            ...payload,
            type: 'access',
            iss: config_1.default.fhir.baseUrl,
            aud: payload.aud || config_1.default.fhir.baseUrl,
            iat: Math.floor(Date.now() / 1000),
        }, config_1.default.jwt.secret, { expiresIn: '1h' });
    }
    generateRefreshToken(payload) {
        return jsonwebtoken_1.default.sign({
            ...payload,
            type: 'refresh',
            iss: config_1.default.fhir.baseUrl,
            iat: Math.floor(Date.now() / 1000),
        }, config_1.default.jwt.secret, { expiresIn: '30d' });
    }
    // Temporary in-memory storage for demo purposes
    // In production, use Redis or secure database
    authCodes = new Map();
    storeAuthorizationCode(code, data) {
        this.authCodes.set(code, data);
        // Clean up expired codes after timeout
        setTimeout(() => {
            this.authCodes.delete(code);
        }, 10 * 60 * 1000); // 10 minutes
    }
    getAuthorizationCode(code) {
        return this.authCodes.get(code);
    }
    removeAuthorizationCode(code) {
        this.authCodes.delete(code);
    }
    async validateClientCredentials(clientId, clientSecret) {
        // In production, validate against secure client registry
        // This is a placeholder implementation
        return clientId === 'omnicare-client' && clientSecret === 'omnicare-secret';
    }
    async validateUserCredentials(username, password) {
        try {
            // Get user by username or email
            const user = await this.getUserByUsernameOrEmail(username);
            if (!user) {
                return null;
            }
            // Verify password
            const isPasswordValid = await this.jwtService.verifyPassword(password, user.passwordHash || '');
            if (!isPasswordValid) {
                // Increment failed login attempts
                await this.incrementFailedLoginAttempts(user.id);
                return null;
            }
            // Reset failed login attempts on successful authentication
            await this.resetFailedLoginAttempts(user.id);
            return user;
        }
        catch (error) {
            logger_1.default.error('User credential validation failed:', error);
            return null;
        }
    }
    async getUserById(userId) {
        try {
            // Mock implementation - replace with actual database query
            const mockUsers = {
                'user-1': {
                    id: 'user-1',
                    username: 'admin@omnicare.com',
                    email: 'admin@omnicare.com',
                    firstName: 'System',
                    lastName: 'Administrator',
                    role: auth_types_1.UserRoles.SYSTEM_ADMINISTRATOR,
                    department: 'IT',
                    isActive: true,
                    isMfaEnabled: true,
                    passwordChangedAt: new Date(),
                    failedLoginAttempts: 0,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    passwordHash: await this.jwtService.hashPassword('admin123')
                },
                'user-2': {
                    id: 'user-2',
                    username: 'doctor@omnicare.com',
                    email: 'doctor@omnicare.com',
                    firstName: 'Dr. Jane',
                    lastName: 'Smith',
                    role: auth_types_1.UserRoles.PHYSICIAN,
                    department: 'Cardiology',
                    licenseNumber: 'MD123456',
                    npiNumber: '1234567890',
                    isActive: true,
                    isMfaEnabled: true,
                    passwordChangedAt: new Date(),
                    failedLoginAttempts: 0,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    passwordHash: await this.jwtService.hashPassword('demo123')
                },
                'user-3': {
                    id: 'user-3',
                    username: 'nurse@omnicare.com',
                    email: 'nurse@omnicare.com',
                    firstName: 'Sarah',
                    lastName: 'Johnson',
                    role: auth_types_1.UserRoles.NURSING_STAFF,
                    department: 'Emergency',
                    licenseNumber: 'RN789012',
                    isActive: true,
                    isMfaEnabled: false,
                    passwordChangedAt: new Date(),
                    failedLoginAttempts: 0,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    passwordHash: await this.jwtService.hashPassword('demo123')
                }
            };
            return mockUsers[userId] || null;
            // TODO: Replace with actual database query
            // return await UserRepository.findById(userId);
        }
        catch (error) {
            logger_1.default.error('Get user by ID failed:', error);
            return null;
        }
    }
    async getUserByUsernameOrEmail(usernameOrEmail) {
        try {
            // Mock implementation - replace with actual database query
            const mockUsers = [
                {
                    id: 'user-1',
                    username: 'admin@omnicare.com',
                    email: 'admin@omnicare.com',
                    firstName: 'System',
                    lastName: 'Administrator',
                    role: auth_types_1.UserRoles.SYSTEM_ADMINISTRATOR,
                    department: 'IT',
                    isActive: true,
                    isMfaEnabled: true,
                    passwordChangedAt: new Date(),
                    failedLoginAttempts: 0,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    passwordHash: await this.jwtService.hashPassword('admin123')
                },
                {
                    id: 'user-2',
                    username: 'doctor@omnicare.com',
                    email: 'doctor@omnicare.com',
                    firstName: 'Dr. Jane',
                    lastName: 'Smith',
                    role: auth_types_1.UserRoles.PHYSICIAN,
                    department: 'Cardiology',
                    licenseNumber: 'MD123456',
                    npiNumber: '1234567890',
                    isActive: true,
                    isMfaEnabled: true,
                    passwordChangedAt: new Date(),
                    failedLoginAttempts: 0,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    passwordHash: await this.jwtService.hashPassword('demo123')
                },
                {
                    id: 'user-3',
                    username: 'nurse@omnicare.com',
                    email: 'nurse@omnicare.com',
                    firstName: 'Sarah',
                    lastName: 'Johnson',
                    role: auth_types_1.UserRoles.NURSING_STAFF,
                    department: 'Emergency',
                    licenseNumber: 'RN789012',
                    isActive: true,
                    isMfaEnabled: false,
                    passwordChangedAt: new Date(),
                    failedLoginAttempts: 0,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    passwordHash: await this.jwtService.hashPassword('demo123')
                }
            ];
            return mockUsers.find(user => user.username === usernameOrEmail || user.email === usernameOrEmail) || null;
            // TODO: Replace with actual database query
            // return await UserRepository.findByUsernameOrEmail(usernameOrEmail);
        }
        catch (error) {
            logger_1.default.error('Get user by username/email failed:', error);
            return null;
        }
    }
    async updateUserLoginInfo(userId, ipAddress) {
        try {
            // TODO: Update user's last login timestamp and IP in database
            logger_1.default.info(`Updated login info for user ${userId} from ${ipAddress}`);
        }
        catch (error) {
            logger_1.default.error('Update user login info failed:', error);
        }
    }
    async incrementFailedLoginAttempts(userId) {
        try {
            // TODO: Increment failed login attempts in database
            // If attempts exceed threshold, lock account
            logger_1.default.info(`Incremented failed login attempts for user ${userId}`);
        }
        catch (error) {
            logger_1.default.error('Increment failed login attempts failed:', error);
        }
    }
    async resetFailedLoginAttempts(userId) {
        try {
            // TODO: Reset failed login attempts in database
            logger_1.default.info(`Reset failed login attempts for user ${userId}`);
        }
        catch (error) {
            logger_1.default.error('Reset failed login attempts failed:', error);
        }
    }
    async storeTempMfaSecret(userId, secret) {
        try {
            // TODO: Store temporary MFA secret (expires in 10 minutes)
            logger_1.default.info(`Stored temporary MFA secret for user ${userId}`);
        }
        catch (error) {
            logger_1.default.error('Store temp MFA secret failed:', error);
        }
    }
    async getTempMfaSecret(userId) {
        try {
            // TODO: Get temporary MFA secret from storage
            logger_1.default.info(`Retrieved temporary MFA secret for user ${userId}`);
            return null; // Mock implementation
        }
        catch (error) {
            logger_1.default.error('Get temp MFA secret failed:', error);
            return null;
        }
    }
    async clearTempMfaSecret(userId) {
        try {
            // TODO: Clear temporary MFA secret from storage
            logger_1.default.info(`Cleared temporary MFA secret for user ${userId}`);
        }
        catch (error) {
            logger_1.default.error('Clear temp MFA secret failed:', error);
        }
    }
    async enableUserMfa(userId, secret) {
        try {
            // TODO: Enable MFA for user in database
            logger_1.default.info(`Enabled MFA for user ${userId}`);
        }
        catch (error) {
            logger_1.default.error('Enable user MFA failed:', error);
        }
    }
}
exports.AuthController = AuthController;
// Export singleton instance
// Export singleton instance
exports.authController = new AuthController();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3JvZHJpZ28vY2xhdWRlLXByb2plY3RzL09tbmlDYXJlL2JhY2tlbmQvc3JjL2NvbnRyb2xsZXJzL2F1dGguY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxnRUFBK0I7QUFFL0Isb0RBQW9EO0FBQ3BELHNEQUE4QjtBQUM5Qiw0REFBd0Q7QUFDeEQsZ0VBQTREO0FBQzVELHNFQUFpRTtBQUNqRSxtREFBaUY7QUFDakYsNERBQW9DO0FBQ3BDLHFEQUFzRDtBQUV0RDs7O0dBR0c7QUFDSCxNQUFhLGNBQWM7SUFDakIsVUFBVSxDQUFpQjtJQUMzQixjQUFjLENBQWlCO0lBQy9CLFlBQVksQ0FBZTtJQUVuQztRQUNFLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSw0QkFBYyxFQUFFLENBQUM7UUFDdkMsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLGdDQUFjLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksNEJBQVksRUFBRSxDQUFDO0lBQ3pDLENBQUM7SUFFRCxrQ0FBa0M7SUFDbEMsOEJBQThCO0lBQzlCLGtDQUFrQztJQUVsQzs7T0FFRztJQUNILEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBWSxFQUFFLEdBQWE7UUFDekMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUNKLGFBQWEsRUFDYixTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFDTCxLQUFLLEVBQ0wsR0FBRyxFQUNILE1BQU0sR0FDUCxHQUFHLEdBQUcsQ0FBQyxLQUErQixDQUFDO1lBRXhDLGdCQUFNLENBQUMsUUFBUSxDQUFDLDZCQUE2QixFQUFFO2dCQUM3QyxTQUFTO2dCQUNULGFBQWE7Z0JBQ2IsS0FBSztnQkFDTCxHQUFHO2dCQUNILE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTTtnQkFDaEIsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFO2dCQUNWLFNBQVMsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQzthQUNqQyxDQUFDLENBQUM7WUFFSCwrQkFBK0I7WUFDL0IsSUFBSSxDQUFDLGFBQWEsSUFBSSxhQUFhLEtBQUssTUFBTSxFQUFFLENBQUM7Z0JBQy9DLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNuQixLQUFLLEVBQUUsaUJBQWlCO29CQUN4QixpQkFBaUIsRUFBRSw4QkFBOEI7aUJBQ2xELENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDZixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDbkIsS0FBSyxFQUFFLGlCQUFpQjtvQkFDeEIsaUJBQWlCLEVBQUUsdUJBQXVCO2lCQUMzQyxDQUFDLENBQUM7Z0JBQ0gsT0FBTztZQUNULENBQUM7WUFFRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ2xCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNuQixLQUFLLEVBQUUsaUJBQWlCO29CQUN4QixpQkFBaUIsRUFBRSwwQkFBMEI7aUJBQzlDLENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBRTlELElBQUksVUFBVSxDQUFDO1lBRWYsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDWCxzQkFBc0I7Z0JBQ3RCLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztvQkFDVCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQzt3QkFDbkIsS0FBSyxFQUFFLGlCQUFpQjt3QkFDeEIsaUJBQWlCLEVBQUUsdUNBQXVDO3FCQUMzRCxDQUFDLENBQUM7b0JBQ0gsT0FBTztnQkFDVCxDQUFDO2dCQUVELFVBQVUsR0FBRyxNQUFNLHFDQUFnQixDQUFDLGVBQWUsQ0FDakQsR0FBRyxFQUNILE1BQU0sRUFDTixTQUFTLEVBQ1QsWUFBWSxFQUNaLE1BQU0sQ0FDUCxDQUFDO1lBQ0osQ0FBQztpQkFBTSxDQUFDO2dCQUNOLDZCQUE2QjtnQkFDN0IsVUFBVSxHQUFHLE1BQU0scUNBQWdCLENBQUMscUJBQXFCLENBQ3ZELFNBQVMsRUFDVCxZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFDTCxHQUFHLENBQ0osQ0FBQztZQUNKLENBQUM7WUFFRCxxRUFBcUU7WUFDckUsa0RBQWtEO1lBQ2xELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1lBQ2xELE1BQU0sVUFBVSxHQUFHLEtBQUssSUFBSSxVQUFVLENBQUMsS0FBSyxDQUFDO1lBRTdDLDJFQUEyRTtZQUMzRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsUUFBUSxFQUFFO2dCQUNwQyxTQUFTO2dCQUNULFlBQVk7Z0JBQ1osS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO2dCQUN2QixLQUFLLEVBQUUsVUFBVTtnQkFDakIsR0FBRztnQkFDSCxNQUFNO2dCQUNOLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLGFBQWE7YUFDeEQsQ0FBQyxDQUFDO1lBRUgsTUFBTSxXQUFXLEdBQUcsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDMUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ2xELFdBQVcsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQztZQUVyRCxnQkFBTSxDQUFDLFFBQVEsQ0FBQyxvQ0FBb0MsRUFBRTtnQkFDcEQsU0FBUztnQkFDVCxLQUFLLEVBQUUsVUFBVTtnQkFDakIsU0FBUyxFQUFFLENBQUMsQ0FBQyxNQUFNO2FBQ3BCLENBQUMsQ0FBQztZQUVILEdBQUcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDdkMsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixnQkFBTSxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNuRCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsS0FBSyxFQUFFLGNBQWM7Z0JBQ3JCLGlCQUFpQixFQUFFLDRCQUE0QjthQUNoRCxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFZLEVBQUUsR0FBYTtRQUNyQyxJQUFJLENBQUM7WUFDSCxNQUFNLEVBQ0osVUFBVSxFQUNWLElBQUksRUFDSixZQUFZLEVBQ1osU0FBUyxFQUNULGFBQWEsRUFDYixhQUFhLEVBQ2IsYUFBYSxHQUNkLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztZQUViLGdCQUFNLENBQUMsUUFBUSxDQUFDLHFCQUFxQixFQUFFO2dCQUNyQyxVQUFVO2dCQUNWLFNBQVM7Z0JBQ1QsT0FBTyxFQUFFLENBQUMsQ0FBQyxJQUFJO2dCQUNmLGVBQWUsRUFBRSxDQUFDLENBQUMsYUFBYTtnQkFDaEMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFO2FBQ1gsQ0FBQyxDQUFDO1lBRUgsSUFBSSxVQUFVLEtBQUssb0JBQW9CLEVBQUUsQ0FBQztnQkFDeEMsTUFBTSxJQUFJLENBQUMsNEJBQTRCLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3BELENBQUM7aUJBQU0sSUFBSSxVQUFVLEtBQUssZUFBZSxFQUFFLENBQUM7Z0JBQzFDLE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUMvQyxDQUFDO2lCQUFNLElBQUksVUFBVSxLQUFLLG9CQUFvQixFQUFFLENBQUM7Z0JBQy9DLE1BQU0sSUFBSSxDQUFDLDRCQUE0QixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNwRCxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLEtBQUssRUFBRSx3QkFBd0I7b0JBQy9CLGlCQUFpQixFQUFFLDhFQUE4RTtpQkFDbEcsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDbkQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLEtBQUssRUFBRSxjQUFjO2dCQUNyQixpQkFBaUIsRUFBRSxvQkFBb0I7YUFDeEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxHQUFZLEVBQUUsR0FBYTtRQUNwRSxNQUFNLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUVsRSwrQkFBK0I7UUFDL0IsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3pDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixLQUFLLEVBQUUsaUJBQWlCO2dCQUN4QixpQkFBaUIsRUFBRSxnREFBZ0Q7YUFDcEUsQ0FBQyxDQUFDO1lBQ0gsT0FBTztRQUNULENBQUM7UUFFRCwyQ0FBMkM7UUFDM0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNkLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixLQUFLLEVBQUUsZUFBZTtnQkFDdEIsaUJBQWlCLEVBQUUsdUNBQXVDO2FBQzNELENBQUMsQ0FBQztZQUNILE9BQU87UUFDVCxDQUFDO1FBRUQsSUFBSSxRQUFRLENBQUMsU0FBUyxLQUFLLFNBQVMsSUFBSSxRQUFRLENBQUMsWUFBWSxLQUFLLFlBQVksRUFBRSxDQUFDO1lBQy9FLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixLQUFLLEVBQUUsZUFBZTtnQkFDdEIsaUJBQWlCLEVBQUUsbUNBQW1DO2FBQ3ZELENBQUMsQ0FBQztZQUNILE9BQU87UUFDVCxDQUFDO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsUUFBUSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3BDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNuQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsS0FBSyxFQUFFLGVBQWU7Z0JBQ3RCLGlCQUFpQixFQUFFLDRCQUE0QjthQUNoRCxDQUFDLENBQUM7WUFDSCxPQUFPO1FBQ1QsQ0FBQztRQUVELGtCQUFrQjtRQUNsQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0MsU0FBUztZQUNULEtBQUssRUFBRSxRQUFRLENBQUMsS0FBSztZQUNyQixHQUFHLEVBQUUsUUFBUSxDQUFDLEdBQUc7WUFDakIsTUFBTSxFQUFFLFFBQVEsQ0FBQyxNQUFNO1NBQ3hCLENBQUMsQ0FBQztRQUVILE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztZQUM3QyxTQUFTO1lBQ1QsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLO1NBQ3RCLENBQUMsQ0FBQztRQUVILGlDQUFpQztRQUNqQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFbkMsTUFBTSxhQUFhLEdBQUc7WUFDcEIsWUFBWSxFQUFFLFdBQVc7WUFDekIsVUFBVSxFQUFFLFFBQVE7WUFDcEIsVUFBVSxFQUFFLElBQUk7WUFDaEIsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLO1lBQ3JCLGFBQWEsRUFBRSxZQUFZO1NBQzVCLENBQUM7UUFFRiw2Q0FBNkM7UUFDN0MsSUFBSSxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDcEIsb0ZBQW9GO1lBQ25GLGFBQXFCLENBQUMsT0FBTyxHQUFHLG9CQUFvQixDQUFDO1lBQ3JELGFBQXFCLENBQUMsU0FBUyxHQUFHLHNCQUFzQixDQUFDO1lBQ3pELGFBQXFCLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDO1lBQ2pELGFBQXFCLENBQUMsZUFBZSxHQUFHLEdBQUcsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxtQkFBbUIsQ0FBQztRQUNyRixDQUFDO1FBRUQsZ0JBQU0sQ0FBQyxRQUFRLENBQUMsMkJBQTJCLEVBQUU7WUFDM0MsU0FBUztZQUNULEtBQUssRUFBRSxRQUFRLENBQUMsS0FBSztZQUNyQixTQUFTLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNO1NBQzdCLENBQUMsQ0FBQztRQUVILEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssS0FBSyxDQUFDLHVCQUF1QixDQUFDLEdBQVksRUFBRSxHQUFhO1FBQy9ELE1BQU0sRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUU5QyxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDakMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLEtBQUssRUFBRSxpQkFBaUI7Z0JBQ3hCLGlCQUFpQixFQUFFLDBDQUEwQzthQUM5RCxDQUFDLENBQUM7WUFDSCxPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILHVCQUF1QjtZQUN2QixNQUFNLE9BQU8sR0FBRyxzQkFBRyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsZ0JBQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFRLENBQUM7WUFFcEUsSUFBSSxPQUFPLENBQUMsU0FBUyxLQUFLLFNBQVMsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRSxDQUFDO2dCQUNsRSxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDbkIsS0FBSyxFQUFFLGVBQWU7b0JBQ3RCLGlCQUFpQixFQUFFLHVCQUF1QjtpQkFDM0MsQ0FBQyxDQUFDO2dCQUNILE9BQU87WUFDVCxDQUFDO1lBRUQsNEJBQTRCO1lBQzVCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztnQkFDM0MsU0FBUztnQkFDVCxLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7Z0JBQ3BCLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRzthQUNqQixDQUFDLENBQUM7WUFFSCxNQUFNLGFBQWEsR0FBRztnQkFDcEIsWUFBWSxFQUFFLFdBQVc7Z0JBQ3pCLFVBQVUsRUFBRSxRQUFRO2dCQUNwQixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLO2FBQ3JCLENBQUM7WUFFRixnQkFBTSxDQUFDLFFBQVEsQ0FBQyx1QkFBdUIsRUFBRTtnQkFDdkMsU0FBUztnQkFDVCxLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7YUFDckIsQ0FBQyxDQUFDO1lBRUgsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMxQixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixLQUFLLEVBQUUsZUFBZTtnQkFDdEIsaUJBQWlCLEVBQUUsdUJBQXVCO2FBQzNDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxLQUFLLENBQUMsNEJBQTRCLENBQUMsR0FBWSxFQUFFLEdBQWE7UUFDcEUsTUFBTSxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUVyRCxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDakMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLEtBQUssRUFBRSxpQkFBaUI7Z0JBQ3hCLGlCQUFpQixFQUFFLDBDQUEwQzthQUM5RCxDQUFDLENBQUM7WUFDSCxPQUFPO1FBQ1QsQ0FBQztRQUVELG9FQUFvRTtRQUNwRSxNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxTQUFTLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFFckYsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ25CLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixLQUFLLEVBQUUsZ0JBQWdCO2dCQUN2QixpQkFBaUIsRUFBRSw0QkFBNEI7YUFDaEQsQ0FBQyxDQUFDO1lBQ0gsT0FBTztRQUNULENBQUM7UUFFRCxNQUFNLGNBQWMsR0FBRyxLQUFLLElBQUksZUFBZSxDQUFDO1FBRWhELDBDQUEwQztRQUMxQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0MsU0FBUztZQUNULEtBQUssRUFBRSxjQUFjO1lBQ3JCLElBQUksRUFBRSxRQUFRO1NBQ2YsQ0FBQyxDQUFDO1FBRUgsTUFBTSxhQUFhLEdBQUc7WUFDcEIsWUFBWSxFQUFFLFdBQVc7WUFDekIsVUFBVSxFQUFFLFFBQVE7WUFDcEIsVUFBVSxFQUFFLElBQUk7WUFDaEIsS0FBSyxFQUFFLGNBQWM7U0FDdEIsQ0FBQztRQUVGLGdCQUFNLENBQUMsUUFBUSxDQUFDLDRCQUE0QixFQUFFO1lBQzVDLFNBQVM7WUFDVCxLQUFLLEVBQUUsY0FBYztTQUN0QixDQUFDLENBQUM7UUFFSCxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBWSxFQUFFLEdBQWE7UUFDMUMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFFM0IsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNYLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNuQixLQUFLLEVBQUUsaUJBQWlCO29CQUN4QixpQkFBaUIsRUFBRSw2QkFBNkI7aUJBQ2pELENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELGdCQUFNLENBQUMsUUFBUSxDQUFDLDZCQUE2QixFQUFFO2dCQUM3QyxFQUFFLEVBQUUsR0FBRyxDQUFDLEVBQUU7YUFDWCxDQUFDLENBQUM7WUFFSCxJQUFJLENBQUM7Z0JBQ0gsTUFBTSxPQUFPLEdBQUcsc0JBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLGdCQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBUSxDQUFDO2dCQUU1RCxNQUFNLHFCQUFxQixHQUFHO29CQUM1QixNQUFNLEVBQUUsSUFBSTtvQkFDWixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7b0JBQ3BCLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUztvQkFDNUIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHO29CQUNoQixHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUc7b0JBQ2hCLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRztvQkFDaEIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHO29CQUNoQixHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUc7b0JBQ2hCLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTztvQkFDeEIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxTQUFTO29CQUM1QixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7aUJBQzNCLENBQUM7Z0JBRUYsR0FBRyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1lBQ2xDLENBQUM7WUFBQyxPQUFPLFFBQVEsRUFBRSxDQUFDO2dCQUNsQiw4QkFBOEI7Z0JBQzlCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUM5QixDQUFDO1FBQ0gsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixnQkFBTSxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNuRCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsS0FBSyxFQUFFLGNBQWM7Z0JBQ3JCLGlCQUFpQixFQUFFLDRCQUE0QjthQUNoRCxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQztJQUVELGtDQUFrQztJQUNsQyw4QkFBOEI7SUFDOUIsa0NBQWtDO0lBRWxDOztPQUVHO0lBQ0gsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFZLEVBQUUsR0FBYTtRQUNyQyxJQUFJLENBQUM7WUFDSCxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsR0FBcUIsR0FBRyxDQUFDLElBQUksQ0FBQztZQUNwRSxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsRUFBRSxJQUFJLFNBQVMsQ0FBQztZQUN0QyxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLFNBQVMsQ0FBQztZQUVyRCxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3ZDLElBQUksRUFBRSxlQUFlO2dCQUNyQixRQUFRLEVBQUUsS0FBSztnQkFDZixXQUFXLEVBQUUsK0JBQStCLFFBQVEsRUFBRTtnQkFDdEQsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUU7YUFDN0MsQ0FBQyxDQUFDO1lBRUgsdUJBQXVCO1lBQ3ZCLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUVwRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ1YsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDO29CQUN2QyxJQUFJLEVBQUUsZUFBZTtvQkFDckIsUUFBUSxFQUFFLFFBQVE7b0JBQ2xCLFdBQVcsRUFBRSw0Q0FBNEM7b0JBQ3pELFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFO2lCQUM3QyxDQUFDLENBQUM7Z0JBRUgsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSxxQkFBcUI7b0JBQzVCLE9BQU8sRUFBRSw4QkFBOEI7aUJBQ3hDLENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELDZCQUE2QjtZQUM3QixJQUFJLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxJQUFJLEVBQUUsRUFBRSxDQUFDO2dCQUNwRSxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUM7b0JBQ3ZDLElBQUksRUFBRSxlQUFlO29CQUNyQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7b0JBQ2YsUUFBUSxFQUFFLFFBQVE7b0JBQ2xCLFdBQVcsRUFBRSxpQ0FBaUM7b0JBQzlDLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7aUJBQ25GLENBQUMsQ0FBQztnQkFFSCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDbkIsT0FBTyxFQUFFLEtBQUs7b0JBQ2QsS0FBSyxFQUFFLGdCQUFnQjtvQkFDdkIsT0FBTyxFQUFFLHFFQUFxRTtpQkFDL0UsQ0FBQyxDQUFDO2dCQUNILE9BQU87WUFDVCxDQUFDO1lBRUQsMEJBQTBCO1lBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ25CLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDdkMsSUFBSSxFQUFFLGVBQWU7b0JBQ3JCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRTtvQkFDZixRQUFRLEVBQUUsUUFBUTtvQkFDbEIsV0FBVyxFQUFFLG1DQUFtQztvQkFDaEQsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUU7aUJBQzdDLENBQUMsQ0FBQztnQkFFSCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDbkIsT0FBTyxFQUFFLEtBQUs7b0JBQ2QsS0FBSyxFQUFFLGtCQUFrQjtvQkFDekIsT0FBTyxFQUFFLHVCQUF1QjtpQkFDakMsQ0FBQyxDQUFDO2dCQUNILE9BQU87WUFDVCxDQUFDO1lBRUQsd0JBQXdCO1lBQ3hCLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDbEUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUNkLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO3dCQUNuQixPQUFPLEVBQUUsS0FBSzt3QkFDZCxXQUFXLEVBQUUsSUFBSTt3QkFDakIsT0FBTyxFQUFFLHNDQUFzQztxQkFDaEQsQ0FBQyxDQUFDO29CQUNILE9BQU87Z0JBQ1QsQ0FBQztnQkFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztvQkFDakYsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDO3dCQUN2QyxJQUFJLEVBQUUsZUFBZTt3QkFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFO3dCQUNmLFFBQVEsRUFBRSxNQUFNO3dCQUNoQixXQUFXLEVBQUUsNEJBQTRCO3dCQUN6QyxRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRTtxQkFDN0MsQ0FBQyxDQUFDO29CQUVILEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO3dCQUNuQixPQUFPLEVBQUUsS0FBSzt3QkFDZCxLQUFLLEVBQUUsbUJBQW1CO3dCQUMxQixPQUFPLEVBQUUsMkNBQTJDO3FCQUNyRCxDQUFDLENBQUM7b0JBQ0gsT0FBTztnQkFDVCxDQUFDO1lBQ0gsQ0FBQztZQUVELHNCQUFzQjtZQUN0QixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTFELGlCQUFpQjtZQUNqQixNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFcEYseUJBQXlCO1lBQ3pCLE1BQU0sSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFbkQsdUJBQXVCO1lBQ3ZCLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdkMsSUFBSSxFQUFFLGVBQWU7Z0JBQ3JCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDZixRQUFRLEVBQUUsS0FBSztnQkFDZixXQUFXLEVBQUUsd0JBQXdCLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ3BELFFBQVEsRUFBRTtvQkFDUixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7b0JBQ3ZCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtvQkFDZixTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVM7b0JBQzVCLFNBQVM7b0JBQ1QsU0FBUztpQkFDVjthQUNGLENBQUMsQ0FBQztZQUVILEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsTUFBTTtnQkFDTixJQUFJLEVBQUU7b0JBQ0osRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFO29CQUNYLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtvQkFDdkIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO29CQUNqQixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7b0JBQ3pCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtvQkFDdkIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO29CQUNmLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtvQkFDM0IsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO29CQUN2QixZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7b0JBQy9CLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztpQkFDMUI7Z0JBQ0QsT0FBTyxFQUFFO29CQUNQLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUztvQkFDNUIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxTQUFTO2lCQUM3QjthQUNGLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3JDLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdkMsSUFBSSxFQUFFLGVBQWU7Z0JBQ3JCLFFBQVEsRUFBRSxNQUFNO2dCQUNoQixXQUFXLEVBQUUsb0JBQW9CO2dCQUNqQyxRQUFRLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBQSw2QkFBZSxFQUFDLEtBQUssQ0FBQyxFQUFFLFNBQVMsRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFO2FBQy9ELENBQUMsQ0FBQztZQUVILEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsS0FBSztnQkFDZCxLQUFLLEVBQUUsZ0JBQWdCO2dCQUN2QixPQUFPLEVBQUUseUNBQXlDO2FBQ25ELENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsWUFBWSxDQUFDLEdBQVksRUFBRSxHQUFhO1FBQzVDLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ2xDLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxFQUFFLElBQUksU0FBUyxDQUFDO1lBQ3RDLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksU0FBUyxDQUFDO1lBRXJELElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDbEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSx1QkFBdUI7b0JBQzlCLE9BQU8sRUFBRSwyQkFBMkI7aUJBQ3JDLENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELHVCQUF1QjtZQUN2QixNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFdkUsV0FBVztZQUNYLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDcEQsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDNUIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSxnQkFBZ0I7b0JBQ3ZCLE9BQU8sRUFBRSw0QkFBNEI7aUJBQ3RDLENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELHNCQUFzQjtZQUN0QixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRTVFLG9CQUFvQjtZQUNwQixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUNuQyxJQUFJLENBQUMsRUFBRSxFQUNQLGVBQWUsRUFDZixlQUFlLEVBQ2YsU0FBUyxFQUNULFNBQVMsRUFDVCxTQUFTLEVBQ1QsSUFBSSxDQUNMLENBQUM7WUFFRixHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNQLE9BQU8sRUFBRSxJQUFJO2dCQUNiLE1BQU07YUFDUCxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLGdCQUFNLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzdDLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdkMsSUFBSSxFQUFFLGVBQWU7Z0JBQ3JCLFFBQVEsRUFBRSxRQUFRO2dCQUNsQixXQUFXLEVBQUUsc0JBQXNCO2dCQUNuQyxRQUFRLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBQSw2QkFBZSxFQUFDLEtBQUssQ0FBQyxFQUFFLFNBQVMsRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFO2FBQy9ELENBQUMsQ0FBQztZQUVILEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsS0FBSztnQkFDZCxLQUFLLEVBQUUsdUJBQXVCO2dCQUM5QixPQUFPLEVBQUUsa0NBQWtDO2FBQzVDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQVksRUFBRSxHQUFhO1FBQ3RDLElBQUksQ0FBQztZQUNILE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDNUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNqRSxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsRUFBRSxJQUFJLFNBQVMsQ0FBQztZQUN0QyxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLFNBQVMsQ0FBQztZQUVyRCxJQUFJLEtBQUssRUFBRSxDQUFDO2dCQUNWLElBQUksQ0FBQztvQkFDSCxNQUFNLFlBQVksR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBRXBFLGtCQUFrQjtvQkFDbEIsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBRWpFLGFBQWE7b0JBQ2IsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDO3dCQUN2QyxJQUFJLEVBQUUsUUFBUTt3QkFDZCxNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07d0JBQzNCLFFBQVEsRUFBRSxLQUFLO3dCQUNmLFdBQVcsRUFBRSxRQUFRLFlBQVksQ0FBQyxRQUFRLGFBQWE7d0JBQ3ZELFFBQVEsRUFBRTs0QkFDUixTQUFTLEVBQUUsWUFBWSxDQUFDLFNBQVM7NEJBQ2pDLFNBQVM7NEJBQ1QsU0FBUzt5QkFDVjtxQkFDRixDQUFDLENBQUM7Z0JBQ0wsQ0FBQztnQkFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO29CQUNmLHFEQUFxRDtvQkFDckQsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsMENBQTBDLEVBQUUsSUFBQSw2QkFBZSxFQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ2xGLENBQUM7WUFDSCxDQUFDO1lBRUQsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDUCxPQUFPLEVBQUUsSUFBSTtnQkFDYixPQUFPLEVBQUUseUJBQXlCO2FBQ25DLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdEMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSxLQUFLO2dCQUNkLEtBQUssRUFBRSxjQUFjO2dCQUNyQixPQUFPLEVBQUUsaUNBQWlDO2FBQzNDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQVksRUFBRSxHQUFhO1FBQ3hDLElBQUksQ0FBQztZQUNILE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQzVCLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUU1QyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ1YsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSxnQkFBZ0I7b0JBQ3ZCLE9BQU8sRUFBRSxnQkFBZ0I7aUJBQzFCLENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUUvRCw4REFBOEQ7WUFDOUQsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV2RCxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUNuQyxNQUFNLEVBQ04scUJBQXFCLEVBQ3JCLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsR0FBRyxDQUFDLEVBQUUsSUFBSSxTQUFTLEVBQ25CLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksU0FBUyxFQUNsQyxJQUFJLENBQ0wsQ0FBQztZQUVGLEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsUUFBUSxFQUFFO29CQUNSLE1BQU0sRUFBRSxRQUFRLENBQUMsTUFBTTtvQkFDdkIsV0FBVyxFQUFFLFFBQVEsQ0FBQyxXQUFXO2lCQUNsQzthQUNGLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDekMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSxLQUFLO2dCQUNkLEtBQUssRUFBRSxpQkFBaUI7Z0JBQ3hCLE9BQU8sRUFBRSw2Q0FBNkM7YUFDdkQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBWSxFQUFFLEdBQWE7UUFDekMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBRW5DLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3ZELElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDaEIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSxzQkFBc0I7b0JBQzdCLE9BQU8sRUFBRSw0QkFBNEI7aUJBQ3RDLENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsVUFBVSxDQUFDLEVBQUUsQ0FBQztnQkFDdkQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSxtQkFBbUI7b0JBQzFCLE9BQU8sRUFBRSxtQkFBbUI7aUJBQzdCLENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELHNCQUFzQjtZQUN0QixNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXRDLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdkMsSUFBSSxFQUFFLGFBQWE7Z0JBQ25CLE1BQU07Z0JBQ04sUUFBUSxFQUFFLFFBQVE7Z0JBQ2xCLFdBQVcsRUFBRSxxQ0FBcUM7Z0JBQ2xELFFBQVEsRUFBRSxFQUFFLFNBQVMsRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFO2FBQ2hDLENBQUMsQ0FBQztZQUVILEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsT0FBTyxFQUFFLGtEQUFrRDthQUM1RCxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLGdCQUFNLENBQUMsS0FBSyxDQUFDLDBCQUEwQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2hELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsS0FBSztnQkFDZCxLQUFLLEVBQUUsd0JBQXdCO2dCQUMvQixPQUFPLEVBQUUsOENBQThDO2FBQ3hELENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsY0FBYyxDQUFDLEdBQVksRUFBRSxHQUFhO1FBQzlDLElBQUksQ0FBQztZQUNILE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDNUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUVqRSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ1gsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSxVQUFVO29CQUNqQixPQUFPLEVBQUUsa0NBQWtDO2lCQUM1QyxDQUFDLENBQUM7Z0JBQ0gsT0FBTztZQUNULENBQUM7WUFFRCxNQUFNLFlBQVksR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDcEUsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV6RCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ1YsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLE9BQU8sRUFBRSxLQUFLO29CQUNkLEtBQUssRUFBRSxnQkFBZ0I7b0JBQ3ZCLE9BQU8sRUFBRSxnQkFBZ0I7aUJBQzFCLENBQUMsQ0FBQztnQkFDSCxPQUFPO1lBQ1QsQ0FBQztZQUVELEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsSUFBSSxFQUFFO29CQUNKLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtvQkFDWCxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7b0JBQ3ZCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztvQkFDakIsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO29CQUN6QixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7b0JBQ3ZCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtvQkFDZixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7b0JBQzNCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtvQkFDdkIsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO29CQUMvQixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7aUJBQzFCO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUFFLGVBQWU7Z0JBQ3RCLE9BQU8sRUFBRSwwQkFBMEI7YUFDcEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUM7SUFFRCxrQ0FBa0M7SUFDbEMsa0JBQWtCO0lBQ2xCLGtDQUFrQztJQUUxQix5QkFBeUI7UUFDL0IsT0FBTyxRQUFRLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUN6RSxDQUFDO0lBRU8sbUJBQW1CLENBQUMsT0FBWTtRQUN0QyxPQUFPLHNCQUFHLENBQUMsSUFBSSxDQUNiO1lBQ0UsR0FBRyxPQUFPO1lBQ1YsSUFBSSxFQUFFLFFBQVE7WUFDZCxHQUFHLEVBQUUsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsT0FBTztZQUN4QixHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsSUFBSSxnQkFBTSxDQUFDLElBQUksQ0FBQyxPQUFPO1lBQ3ZDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7U0FDbkMsRUFDRCxnQkFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQ2pCLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUNwQixDQUFDO0lBQ0osQ0FBQztJQUVPLG9CQUFvQixDQUFDLE9BQVk7UUFDdkMsT0FBTyxzQkFBRyxDQUFDLElBQUksQ0FDYjtZQUNFLEdBQUcsT0FBTztZQUNWLElBQUksRUFBRSxTQUFTO1lBQ2YsR0FBRyxFQUFFLGdCQUFNLENBQUMsSUFBSSxDQUFDLE9BQU87WUFDeEIsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztTQUNuQyxFQUNELGdCQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFDakIsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQ3JCLENBQUM7SUFDSixDQUFDO0lBRUQsZ0RBQWdEO0lBQ2hELDhDQUE4QztJQUN0QyxTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQWUsQ0FBQztJQUVuQyxzQkFBc0IsQ0FBQyxJQUFZLEVBQUUsSUFBUztRQUNwRCxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFL0IsdUNBQXVDO1FBQ3ZDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLGFBQWE7SUFDbkMsQ0FBQztJQUVPLG9CQUFvQixDQUFDLElBQVk7UUFDdkMsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRU8sdUJBQXVCLENBQUMsSUFBWTtRQUMxQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRU8sS0FBSyxDQUFDLHlCQUF5QixDQUFDLFFBQWdCLEVBQUUsWUFBb0I7UUFDNUUseURBQXlEO1FBQ3pELHVDQUF1QztRQUN2QyxPQUFPLFFBQVEsS0FBSyxpQkFBaUIsSUFBSSxZQUFZLEtBQUssaUJBQWlCLENBQUM7SUFDOUUsQ0FBQztJQUVPLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxRQUFnQixFQUFFLFFBQWdCO1FBQ3RFLElBQUksQ0FBQztZQUNILGdDQUFnQztZQUNoQyxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUUzRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ1YsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDO1lBRUQsa0JBQWtCO1lBQ2xCLE1BQU0sZUFBZSxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxZQUFZLElBQUksRUFBRSxDQUFDLENBQUM7WUFFaEcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUNyQixrQ0FBa0M7Z0JBQ2xDLE1BQU0sSUFBSSxDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDakQsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDO1lBRUQsMkRBQTJEO1lBQzNELE1BQU0sSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUU3QyxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDMUQsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxXQUFXLENBQUMsTUFBYztRQUN0QyxJQUFJLENBQUM7WUFDSCwyREFBMkQ7WUFDM0QsTUFBTSxTQUFTLEdBQXlCO2dCQUN0QyxRQUFRLEVBQUU7b0JBQ1IsRUFBRSxFQUFFLFFBQVE7b0JBQ1osUUFBUSxFQUFFLG9CQUFvQjtvQkFDOUIsS0FBSyxFQUFFLG9CQUFvQjtvQkFDM0IsU0FBUyxFQUFFLFFBQVE7b0JBQ25CLFFBQVEsRUFBRSxlQUFlO29CQUN6QixJQUFJLEVBQUUsc0JBQVMsQ0FBQyxvQkFBb0I7b0JBQ3BDLFVBQVUsRUFBRSxJQUFJO29CQUNoQixRQUFRLEVBQUUsSUFBSTtvQkFDZCxZQUFZLEVBQUUsSUFBSTtvQkFDbEIsaUJBQWlCLEVBQUUsSUFBSSxJQUFJLEVBQUU7b0JBQzdCLG1CQUFtQixFQUFFLENBQUM7b0JBQ3RCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtvQkFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO29CQUNyQixZQUFZLEVBQUUsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUM7aUJBQzdEO2dCQUNELFFBQVEsRUFBRTtvQkFDUixFQUFFLEVBQUUsUUFBUTtvQkFDWixRQUFRLEVBQUUscUJBQXFCO29CQUMvQixLQUFLLEVBQUUscUJBQXFCO29CQUM1QixTQUFTLEVBQUUsVUFBVTtvQkFDckIsUUFBUSxFQUFFLE9BQU87b0JBQ2pCLElBQUksRUFBRSxzQkFBUyxDQUFDLFNBQVM7b0JBQ3pCLFVBQVUsRUFBRSxZQUFZO29CQUN4QixhQUFhLEVBQUUsVUFBVTtvQkFDekIsU0FBUyxFQUFFLFlBQVk7b0JBQ3ZCLFFBQVEsRUFBRSxJQUFJO29CQUNkLFlBQVksRUFBRSxJQUFJO29CQUNsQixpQkFBaUIsRUFBRSxJQUFJLElBQUksRUFBRTtvQkFDN0IsbUJBQW1CLEVBQUUsQ0FBQztvQkFDdEIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO29CQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7b0JBQ3JCLFlBQVksRUFBRSxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztpQkFDNUQ7Z0JBQ0QsUUFBUSxFQUFFO29CQUNSLEVBQUUsRUFBRSxRQUFRO29CQUNaLFFBQVEsRUFBRSxvQkFBb0I7b0JBQzlCLEtBQUssRUFBRSxvQkFBb0I7b0JBQzNCLFNBQVMsRUFBRSxPQUFPO29CQUNsQixRQUFRLEVBQUUsU0FBUztvQkFDbkIsSUFBSSxFQUFFLHNCQUFTLENBQUMsYUFBYTtvQkFDN0IsVUFBVSxFQUFFLFdBQVc7b0JBQ3ZCLGFBQWEsRUFBRSxVQUFVO29CQUN6QixRQUFRLEVBQUUsSUFBSTtvQkFDZCxZQUFZLEVBQUUsS0FBSztvQkFDbkIsaUJBQWlCLEVBQUUsSUFBSSxJQUFJLEVBQUU7b0JBQzdCLG1CQUFtQixFQUFFLENBQUM7b0JBQ3RCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtvQkFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO29CQUNyQixZQUFZLEVBQUUsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUM7aUJBQzVEO2FBQ0YsQ0FBQztZQUVGLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQztZQUVqQywyQ0FBMkM7WUFDM0MsZ0RBQWdEO1FBQ2xELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDOUMsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxlQUF1QjtRQUM1RCxJQUFJLENBQUM7WUFDSCwyREFBMkQ7WUFDM0QsTUFBTSxTQUFTLEdBQVc7Z0JBQ3hCO29CQUNFLEVBQUUsRUFBRSxRQUFRO29CQUNaLFFBQVEsRUFBRSxvQkFBb0I7b0JBQzlCLEtBQUssRUFBRSxvQkFBb0I7b0JBQzNCLFNBQVMsRUFBRSxRQUFRO29CQUNuQixRQUFRLEVBQUUsZUFBZTtvQkFDekIsSUFBSSxFQUFFLHNCQUFTLENBQUMsb0JBQW9CO29CQUNwQyxVQUFVLEVBQUUsSUFBSTtvQkFDaEIsUUFBUSxFQUFFLElBQUk7b0JBQ2QsWUFBWSxFQUFFLElBQUk7b0JBQ2xCLGlCQUFpQixFQUFFLElBQUksSUFBSSxFQUFFO29CQUM3QixtQkFBbUIsRUFBRSxDQUFDO29CQUN0QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7b0JBQ3JCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtvQkFDckIsWUFBWSxFQUFFLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDO2lCQUM3RDtnQkFDRDtvQkFDRSxFQUFFLEVBQUUsUUFBUTtvQkFDWixRQUFRLEVBQUUscUJBQXFCO29CQUMvQixLQUFLLEVBQUUscUJBQXFCO29CQUM1QixTQUFTLEVBQUUsVUFBVTtvQkFDckIsUUFBUSxFQUFFLE9BQU87b0JBQ2pCLElBQUksRUFBRSxzQkFBUyxDQUFDLFNBQVM7b0JBQ3pCLFVBQVUsRUFBRSxZQUFZO29CQUN4QixhQUFhLEVBQUUsVUFBVTtvQkFDekIsU0FBUyxFQUFFLFlBQVk7b0JBQ3ZCLFFBQVEsRUFBRSxJQUFJO29CQUNkLFlBQVksRUFBRSxJQUFJO29CQUNsQixpQkFBaUIsRUFBRSxJQUFJLElBQUksRUFBRTtvQkFDN0IsbUJBQW1CLEVBQUUsQ0FBQztvQkFDdEIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO29CQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7b0JBQ3JCLFlBQVksRUFBRSxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztpQkFDNUQ7Z0JBQ0Q7b0JBQ0UsRUFBRSxFQUFFLFFBQVE7b0JBQ1osUUFBUSxFQUFFLG9CQUFvQjtvQkFDOUIsS0FBSyxFQUFFLG9CQUFvQjtvQkFDM0IsU0FBUyxFQUFFLE9BQU87b0JBQ2xCLFFBQVEsRUFBRSxTQUFTO29CQUNuQixJQUFJLEVBQUUsc0JBQVMsQ0FBQyxhQUFhO29CQUM3QixVQUFVLEVBQUUsV0FBVztvQkFDdkIsYUFBYSxFQUFFLFVBQVU7b0JBQ3pCLFFBQVEsRUFBRSxJQUFJO29CQUNkLFlBQVksRUFBRSxLQUFLO29CQUNuQixpQkFBaUIsRUFBRSxJQUFJLElBQUksRUFBRTtvQkFDN0IsbUJBQW1CLEVBQUUsQ0FBQztvQkFDdEIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO29CQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7b0JBQ3JCLFlBQVksRUFBRSxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztpQkFDNUQ7YUFDRixDQUFDO1lBRUYsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQzNCLElBQUksQ0FBQyxRQUFRLEtBQUssZUFBZSxJQUFJLElBQUksQ0FBQyxLQUFLLEtBQUssZUFBZSxDQUNwRSxJQUFJLElBQUksQ0FBQztZQUVWLDJDQUEyQztZQUMzQyxzRUFBc0U7UUFDeEUsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixnQkFBTSxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBRU8sS0FBSyxDQUFDLG1CQUFtQixDQUFDLE1BQWMsRUFBRSxTQUFpQjtRQUNqRSxJQUFJLENBQUM7WUFDSCw4REFBOEQ7WUFDOUQsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsK0JBQStCLE1BQU0sU0FBUyxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ3pFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEQsQ0FBQztJQUNILENBQUM7SUFFTyxLQUFLLENBQUMsNEJBQTRCLENBQUMsTUFBYztRQUN2RCxJQUFJLENBQUM7WUFDSCxvREFBb0Q7WUFDcEQsNkNBQTZDO1lBQzdDLGdCQUFNLENBQUMsSUFBSSxDQUFDLDhDQUE4QyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ3RFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMseUNBQXlDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakUsQ0FBQztJQUNILENBQUM7SUFFTyxLQUFLLENBQUMsd0JBQXdCLENBQUMsTUFBYztRQUNuRCxJQUFJLENBQUM7WUFDSCxnREFBZ0Q7WUFDaEQsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsd0NBQXdDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDaEUsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixnQkFBTSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM3RCxDQUFDO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxNQUFjLEVBQUUsTUFBYztRQUM3RCxJQUFJLENBQUM7WUFDSCwyREFBMkQ7WUFDM0QsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsd0NBQXdDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDaEUsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixnQkFBTSxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN2RCxDQUFDO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFjO1FBQzNDLElBQUksQ0FBQztZQUNILDhDQUE4QztZQUM5QyxnQkFBTSxDQUFDLElBQUksQ0FBQywyQ0FBMkMsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUNqRSxPQUFPLElBQUksQ0FBQyxDQUFDLHNCQUFzQjtRQUNyQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLGdCQUFNLENBQUMsS0FBSyxDQUFDLDZCQUE2QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ25ELE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFFTyxLQUFLLENBQUMsa0JBQWtCLENBQUMsTUFBYztRQUM3QyxJQUFJLENBQUM7WUFDSCxnREFBZ0Q7WUFDaEQsZ0JBQU0sQ0FBQyxJQUFJLENBQUMseUNBQXlDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDakUsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixnQkFBTSxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN2RCxDQUFDO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxhQUFhLENBQUMsTUFBYyxFQUFFLE1BQWM7UUFDeEQsSUFBSSxDQUFDO1lBQ0gsd0NBQXdDO1lBQ3hDLGdCQUFNLENBQUMsSUFBSSxDQUFDLHdCQUF3QixNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ2hELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakQsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXBuQ0Qsd0NBb25DQztBQUVELDRCQUE0QjtBQUM1Qiw0QkFBNEI7QUFDZixRQUFBLGNBQWMsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9yb2RyaWdvL2NsYXVkZS1wcm9qZWN0cy9PbW5pQ2FyZS9iYWNrZW5kL3NyYy9jb250cm9sbGVycy9hdXRoLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcblxuaW1wb3J0IHsgSldUQXV0aFNlcnZpY2UgfSBmcm9tICdAL2F1dGgvand0LnNlcnZpY2UnO1xuaW1wb3J0IGNvbmZpZyBmcm9tICdAL2NvbmZpZyc7XG5pbXBvcnQgeyBBdWRpdFNlcnZpY2UgfSBmcm9tICdAL3NlcnZpY2VzL2F1ZGl0LnNlcnZpY2UnO1xuaW1wb3J0IHsgU2Vzc2lvbk1hbmFnZXIgfSBmcm9tICdAL3NlcnZpY2VzL3Nlc3Npb24uc2VydmljZSc7XG5pbXBvcnQgeyBzbWFydEZISVJTZXJ2aWNlIH0gZnJvbSAnQC9zZXJ2aWNlcy9zbWFydC1maGlyLnNlcnZpY2UnO1xuaW1wb3J0IHsgVXNlciwgVXNlclJvbGUsIFVzZXJSb2xlcywgTG9naW5DcmVkZW50aWFscyB9IGZyb20gJ0AvdHlwZXMvYXV0aC50eXBlcyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0AvdXRpbHMvbG9nZ2VyJztcbmltcG9ydCB7IGdldEVycm9yTWVzc2FnZSB9IGZyb20gJ0AvdXRpbHMvZXJyb3IudXRpbHMnO1xuXG4vKipcbiAqIEF1dGhlbnRpY2F0aW9uIENvbnRyb2xsZXJcbiAqIEhhbmRsZXMgU01BUlQgb24gRkhJUiBhdXRoZW50aWNhdGlvbiBmbG93cyBhbmQgaW50ZXJuYWwgSldUIGF1dGhlbnRpY2F0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBBdXRoQ29udHJvbGxlciB7XG4gIHByaXZhdGUgand0U2VydmljZTogSldUQXV0aFNlcnZpY2U7XG4gIHByaXZhdGUgc2Vzc2lvbk1hbmFnZXI6IFNlc3Npb25NYW5hZ2VyO1xuICBwcml2YXRlIGF1ZGl0U2VydmljZTogQXVkaXRTZXJ2aWNlO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuand0U2VydmljZSA9IG5ldyBKV1RBdXRoU2VydmljZSgpO1xuICAgIHRoaXMuc2Vzc2lvbk1hbmFnZXIgPSBuZXcgU2Vzc2lvbk1hbmFnZXIoKTtcbiAgICB0aGlzLmF1ZGl0U2VydmljZSA9IG5ldyBBdWRpdFNlcnZpY2UoKTtcbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gU01BUlQgT04gRkhJUiBBVVRIT1JJWkFUSU9OXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICAvKipcbiAgICogR0VUIC9hdXRoL2F1dGhvcml6ZSAtIFNNQVJUIGF1dGhvcml6YXRpb24gZW5kcG9pbnRcbiAgICovXG4gIGFzeW5jIGF1dGhvcml6ZShyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge1xuICAgICAgICByZXNwb25zZV90eXBlLFxuICAgICAgICBjbGllbnRfaWQsXG4gICAgICAgIHJlZGlyZWN0X3VyaSxcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIHN0YXRlLFxuICAgICAgICBhdWQsXG4gICAgICAgIGxhdW5jaCxcbiAgICAgIH0gPSByZXEucXVlcnkgYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcblxuICAgICAgbG9nZ2VyLnNlY3VyaXR5KCdTTUFSVCBhdXRob3JpemF0aW9uIHJlcXVlc3QnLCB7XG4gICAgICAgIGNsaWVudF9pZCxcbiAgICAgICAgcmVzcG9uc2VfdHlwZSxcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIGF1ZCxcbiAgICAgICAgbGF1bmNoOiAhIWxhdW5jaCxcbiAgICAgICAgaXA6IHJlcS5pcCxcbiAgICAgICAgdXNlckFnZW50OiByZXEuZ2V0KCdVc2VyLUFnZW50JyksXG4gICAgICB9KTtcblxuICAgICAgLy8gVmFsaWRhdGUgcmVxdWlyZWQgcGFyYW1ldGVyc1xuICAgICAgaWYgKCFyZXNwb25zZV90eXBlIHx8IHJlc3BvbnNlX3R5cGUgIT09ICdjb2RlJykge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdpbnZhbGlkX3JlcXVlc3QnLFxuICAgICAgICAgIGVycm9yX2Rlc2NyaXB0aW9uOiAncmVzcG9uc2VfdHlwZSBtdXN0IGJlIFwiY29kZVwiJyxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKCFjbGllbnRfaWQpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnaW52YWxpZF9yZXF1ZXN0JyxcbiAgICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbjogJ2NsaWVudF9pZCBpcyByZXF1aXJlZCcsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmICghcmVkaXJlY3RfdXJpKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ2ludmFsaWRfcmVxdWVzdCcsXG4gICAgICAgICAgZXJyb3JfZGVzY3JpcHRpb246ICdyZWRpcmVjdF91cmkgaXMgcmVxdWlyZWQnLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzY29wZXMgPSBzY29wZSA/IHNjb3BlLnNwbGl0KCcgJykgOiBjb25maWcuc21hcnQuc2NvcGVzO1xuXG4gICAgICBsZXQgYXV0aFJlc3VsdDtcblxuICAgICAgaWYgKGxhdW5jaCkge1xuICAgICAgICAvLyBFSFIgbGF1bmNoIHNjZW5hcmlvXG4gICAgICAgIGlmICghYXVkKSB7XG4gICAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgZXJyb3I6ICdpbnZhbGlkX3JlcXVlc3QnLFxuICAgICAgICAgICAgZXJyb3JfZGVzY3JpcHRpb246ICdhdWQgcGFyYW1ldGVyIHJlcXVpcmVkIGZvciBFSFIgbGF1bmNoJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBhdXRoUmVzdWx0ID0gYXdhaXQgc21hcnRGSElSU2VydmljZS5oYW5kbGVFSFJMYXVuY2goXG4gICAgICAgICAgYXVkLFxuICAgICAgICAgIGxhdW5jaCxcbiAgICAgICAgICBjbGllbnRfaWQsXG4gICAgICAgICAgcmVkaXJlY3RfdXJpLFxuICAgICAgICAgIHNjb3Blc1xuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gU3RhbmRhbG9uZSBsYXVuY2ggc2NlbmFyaW9cbiAgICAgICAgYXV0aFJlc3VsdCA9IGF3YWl0IHNtYXJ0RkhJUlNlcnZpY2UuaW5pdGlhdGVBdXRob3JpemF0aW9uKFxuICAgICAgICAgIGNsaWVudF9pZCxcbiAgICAgICAgICByZWRpcmVjdF91cmksXG4gICAgICAgICAgc2NvcGVzLFxuICAgICAgICAgIHN0YXRlLFxuICAgICAgICAgIGF1ZFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBGb3IgdGhpcyBleGFtcGxlLCB3ZSdsbCByZWRpcmVjdCBkaXJlY3RseSB0byBzaW11bGF0ZSB1c2VyIGNvbnNlbnRcbiAgICAgIC8vIEluIHByb2R1Y3Rpb24sIHRoaXMgd291bGQgc2hvdyBhIGNvbnNlbnQgc2NyZWVuXG4gICAgICBjb25zdCBhdXRoQ29kZSA9IHRoaXMuZ2VuZXJhdGVBdXRob3JpemF0aW9uQ29kZSgpO1xuICAgICAgY29uc3QgZmluYWxTdGF0ZSA9IHN0YXRlIHx8IGF1dGhSZXN1bHQuc3RhdGU7XG5cbiAgICAgIC8vIFN0b3JlIGF1dGhvcml6YXRpb24gY29kZSB0ZW1wb3JhcmlseSAoaW4gcHJvZHVjdGlvbiwgdXNlIHNlY3VyZSBzdG9yYWdlKVxuICAgICAgdGhpcy5zdG9yZUF1dGhvcml6YXRpb25Db2RlKGF1dGhDb2RlLCB7XG4gICAgICAgIGNsaWVudF9pZCxcbiAgICAgICAgcmVkaXJlY3RfdXJpLFxuICAgICAgICBzY29wZTogc2NvcGVzLmpvaW4oJyAnKSxcbiAgICAgICAgc3RhdGU6IGZpbmFsU3RhdGUsXG4gICAgICAgIGF1ZCxcbiAgICAgICAgbGF1bmNoLFxuICAgICAgICBleHBpcmVzQXQ6IERhdGUubm93KCkgKyAoMTAgKiA2MCAqIDEwMDApLCAvLyAxMCBtaW51dGVzXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVkaXJlY3RVcmwgPSBuZXcgVVJMKHJlZGlyZWN0X3VyaSk7XG4gICAgICByZWRpcmVjdFVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKCdjb2RlJywgYXV0aENvZGUpO1xuICAgICAgcmVkaXJlY3RVcmwuc2VhcmNoUGFyYW1zLmFwcGVuZCgnc3RhdGUnLCBmaW5hbFN0YXRlKTtcblxuICAgICAgbG9nZ2VyLnNlY3VyaXR5KCdTTUFSVCBhdXRob3JpemF0aW9uIGNvZGUgZ2VuZXJhdGVkJywge1xuICAgICAgICBjbGllbnRfaWQsXG4gICAgICAgIHN0YXRlOiBmaW5hbFN0YXRlLFxuICAgICAgICBoYXNMYXVuY2g6ICEhbGF1bmNoLFxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5yZWRpcmVjdChyZWRpcmVjdFVybC50b1N0cmluZygpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdTTUFSVCBhdXRob3JpemF0aW9uIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnc2VydmVyX2Vycm9yJyxcbiAgICAgICAgZXJyb3JfZGVzY3JpcHRpb246ICdBdXRob3JpemF0aW9uIHNlcnZlciBlcnJvcicsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUE9TVCAvYXV0aC90b2tlbiAtIFNNQVJUIHRva2VuIGVuZHBvaW50XG4gICAqL1xuICBhc3luYyB0b2tlbihyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBncmFudF90eXBlLFxuICAgICAgICBjb2RlLFxuICAgICAgICByZWRpcmVjdF91cmksXG4gICAgICAgIGNsaWVudF9pZCxcbiAgICAgICAgY2xpZW50X3NlY3JldCxcbiAgICAgICAgY29kZV92ZXJpZmllcixcbiAgICAgICAgcmVmcmVzaF90b2tlbixcbiAgICAgIH0gPSByZXEuYm9keTtcblxuICAgICAgbG9nZ2VyLnNlY3VyaXR5KCdTTUFSVCB0b2tlbiByZXF1ZXN0Jywge1xuICAgICAgICBncmFudF90eXBlLFxuICAgICAgICBjbGllbnRfaWQsXG4gICAgICAgIGhhc0NvZGU6ICEhY29kZSxcbiAgICAgICAgaGFzUmVmcmVzaFRva2VuOiAhIXJlZnJlc2hfdG9rZW4sXG4gICAgICAgIGlwOiByZXEuaXAsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGdyYW50X3R5cGUgPT09ICdhdXRob3JpemF0aW9uX2NvZGUnKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlQXV0aG9yaXphdGlvbkNvZGVHcmFudChyZXEsIHJlcyk7XG4gICAgICB9IGVsc2UgaWYgKGdyYW50X3R5cGUgPT09ICdyZWZyZXNoX3Rva2VuJykge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVJlZnJlc2hUb2tlbkdyYW50KHJlcSwgcmVzKTtcbiAgICAgIH0gZWxzZSBpZiAoZ3JhbnRfdHlwZSA9PT0gJ2NsaWVudF9jcmVkZW50aWFscycpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVDbGllbnRDcmVkZW50aWFsc0dyYW50KHJlcSwgcmVzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICBlcnJvcjogJ3Vuc3VwcG9ydGVkX2dyYW50X3R5cGUnLFxuICAgICAgICAgIGVycm9yX2Rlc2NyaXB0aW9uOiAnU3VwcG9ydGVkIGdyYW50IHR5cGVzOiBhdXRob3JpemF0aW9uX2NvZGUsIHJlZnJlc2hfdG9rZW4sIGNsaWVudF9jcmVkZW50aWFscycsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ1NNQVJUIHRva2VuIHJlcXVlc3QgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdzZXJ2ZXJfZXJyb3InLFxuICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbjogJ1Rva2VuIHNlcnZlciBlcnJvcicsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlIGF1dGhvcml6YXRpb24gY29kZSBncmFudFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBoYW5kbGVBdXRob3JpemF0aW9uQ29kZUdyYW50KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHsgY29kZSwgcmVkaXJlY3RfdXJpLCBjbGllbnRfaWQsIGNvZGVfdmVyaWZpZXIgfSA9IHJlcS5ib2R5O1xuXG4gICAgLy8gVmFsaWRhdGUgcmVxdWlyZWQgcGFyYW1ldGVyc1xuICAgIGlmICghY29kZSB8fCAhcmVkaXJlY3RfdXJpIHx8ICFjbGllbnRfaWQpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdpbnZhbGlkX3JlcXVlc3QnLFxuICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbjogJ2NvZGUsIHJlZGlyZWN0X3VyaSwgYW5kIGNsaWVudF9pZCBhcmUgcmVxdWlyZWQnLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gUmV0cmlldmUgYW5kIHZhbGlkYXRlIGF1dGhvcml6YXRpb24gY29kZVxuICAgIGNvbnN0IGF1dGhEYXRhID0gdGhpcy5nZXRBdXRob3JpemF0aW9uQ29kZShjb2RlKTtcbiAgICBpZiAoIWF1dGhEYXRhKSB7XG4gICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnaW52YWxpZF9ncmFudCcsXG4gICAgICAgIGVycm9yX2Rlc2NyaXB0aW9uOiAnSW52YWxpZCBvciBleHBpcmVkIGF1dGhvcml6YXRpb24gY29kZScsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoYXV0aERhdGEuY2xpZW50X2lkICE9PSBjbGllbnRfaWQgfHwgYXV0aERhdGEucmVkaXJlY3RfdXJpICE9PSByZWRpcmVjdF91cmkpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdpbnZhbGlkX2dyYW50JyxcbiAgICAgICAgZXJyb3JfZGVzY3JpcHRpb246ICdJbnZhbGlkIGNsaWVudF9pZCBvciByZWRpcmVjdF91cmknLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKERhdGUubm93KCkgPiBhdXRoRGF0YS5leHBpcmVzQXQpIHtcbiAgICAgIHRoaXMucmVtb3ZlQXV0aG9yaXphdGlvbkNvZGUoY29kZSk7XG4gICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnaW52YWxpZF9ncmFudCcsXG4gICAgICAgIGVycm9yX2Rlc2NyaXB0aW9uOiAnQXV0aG9yaXphdGlvbiBjb2RlIGV4cGlyZWQnLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gR2VuZXJhdGUgdG9rZW5zXG4gICAgY29uc3QgYWNjZXNzVG9rZW4gPSB0aGlzLmdlbmVyYXRlQWNjZXNzVG9rZW4oe1xuICAgICAgY2xpZW50X2lkLFxuICAgICAgc2NvcGU6IGF1dGhEYXRhLnNjb3BlLFxuICAgICAgYXVkOiBhdXRoRGF0YS5hdWQsXG4gICAgICBsYXVuY2g6IGF1dGhEYXRhLmxhdW5jaCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlZnJlc2hUb2tlbiA9IHRoaXMuZ2VuZXJhdGVSZWZyZXNoVG9rZW4oe1xuICAgICAgY2xpZW50X2lkLFxuICAgICAgc2NvcGU6IGF1dGhEYXRhLnNjb3BlLFxuICAgIH0pO1xuXG4gICAgLy8gUmVtb3ZlIHVzZWQgYXV0aG9yaXphdGlvbiBjb2RlXG4gICAgdGhpcy5yZW1vdmVBdXRob3JpemF0aW9uQ29kZShjb2RlKTtcblxuICAgIGNvbnN0IHRva2VuUmVzcG9uc2UgPSB7XG4gICAgICBhY2Nlc3NfdG9rZW46IGFjY2Vzc1Rva2VuLFxuICAgICAgdG9rZW5fdHlwZTogJ2JlYXJlcicsXG4gICAgICBleHBpcmVzX2luOiAzNjAwLFxuICAgICAgc2NvcGU6IGF1dGhEYXRhLnNjb3BlLFxuICAgICAgcmVmcmVzaF90b2tlbjogcmVmcmVzaFRva2VuLFxuICAgIH07XG5cbiAgICAvLyBBZGQgU01BUlQtc3BlY2lmaWMgcGFyYW1ldGVycyBpZiBhdmFpbGFibGVcbiAgICBpZiAoYXV0aERhdGEubGF1bmNoKSB7XG4gICAgICAvLyBJbiBhIHJlYWwgaW1wbGVtZW50YXRpb24sIHlvdSB3b3VsZCBleHRyYWN0IHBhdGllbnQvZW5jb3VudGVyIGZyb20gbGF1bmNoIGNvbnRleHRcbiAgICAgICh0b2tlblJlc3BvbnNlIGFzIGFueSkucGF0aWVudCA9ICdleGFtcGxlLXBhdGllbnQtaWQnO1xuICAgICAgKHRva2VuUmVzcG9uc2UgYXMgYW55KS5lbmNvdW50ZXIgPSAnZXhhbXBsZS1lbmNvdW50ZXItaWQnO1xuICAgICAgKHRva2VuUmVzcG9uc2UgYXMgYW55KS5uZWVkX3BhdGllbnRfYmFubmVyID0gdHJ1ZTtcbiAgICAgICh0b2tlblJlc3BvbnNlIGFzIGFueSkuc21hcnRfc3R5bGVfdXJsID0gYCR7Y29uZmlnLmZoaXIuYmFzZVVybH0vc21hcnQtc3R5bGUuanNvbmA7XG4gICAgfVxuXG4gICAgbG9nZ2VyLnNlY3VyaXR5KCdTTUFSVCBhY2Nlc3MgdG9rZW4gaXNzdWVkJywge1xuICAgICAgY2xpZW50X2lkLFxuICAgICAgc2NvcGU6IGF1dGhEYXRhLnNjb3BlLFxuICAgICAgaGFzTGF1bmNoOiAhIWF1dGhEYXRhLmxhdW5jaCxcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHRva2VuUmVzcG9uc2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSByZWZyZXNoIHRva2VuIGdyYW50XG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGhhbmRsZVJlZnJlc2hUb2tlbkdyYW50KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHsgcmVmcmVzaF90b2tlbiwgY2xpZW50X2lkIH0gPSByZXEuYm9keTtcblxuICAgIGlmICghcmVmcmVzaF90b2tlbiB8fCAhY2xpZW50X2lkKSB7XG4gICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnaW52YWxpZF9yZXF1ZXN0JyxcbiAgICAgICAgZXJyb3JfZGVzY3JpcHRpb246ICdyZWZyZXNoX3Rva2VuIGFuZCBjbGllbnRfaWQgYXJlIHJlcXVpcmVkJyxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBWZXJpZnkgcmVmcmVzaCB0b2tlblxuICAgICAgY29uc3QgZGVjb2RlZCA9IGp3dC52ZXJpZnkocmVmcmVzaF90b2tlbiwgY29uZmlnLmp3dC5zZWNyZXQpIGFzIGFueTtcbiAgICAgIFxuICAgICAgaWYgKGRlY29kZWQuY2xpZW50X2lkICE9PSBjbGllbnRfaWQgfHwgZGVjb2RlZC50eXBlICE9PSAncmVmcmVzaCcpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIGVycm9yOiAnaW52YWxpZF9ncmFudCcsXG4gICAgICAgICAgZXJyb3JfZGVzY3JpcHRpb246ICdJbnZhbGlkIHJlZnJlc2ggdG9rZW4nLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBHZW5lcmF0ZSBuZXcgYWNjZXNzIHRva2VuXG4gICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IHRoaXMuZ2VuZXJhdGVBY2Nlc3NUb2tlbih7XG4gICAgICAgIGNsaWVudF9pZCxcbiAgICAgICAgc2NvcGU6IGRlY29kZWQuc2NvcGUsXG4gICAgICAgIGF1ZDogZGVjb2RlZC5hdWQsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdG9rZW5SZXNwb25zZSA9IHtcbiAgICAgICAgYWNjZXNzX3Rva2VuOiBhY2Nlc3NUb2tlbixcbiAgICAgICAgdG9rZW5fdHlwZTogJ2JlYXJlcicsXG4gICAgICAgIGV4cGlyZXNfaW46IDM2MDAsXG4gICAgICAgIHNjb3BlOiBkZWNvZGVkLnNjb3BlLFxuICAgICAgfTtcblxuICAgICAgbG9nZ2VyLnNlY3VyaXR5KCdTTUFSVCB0b2tlbiByZWZyZXNoZWQnLCB7XG4gICAgICAgIGNsaWVudF9pZCxcbiAgICAgICAgc2NvcGU6IGRlY29kZWQuc2NvcGUsXG4gICAgICB9KTtcblxuICAgICAgcmVzLmpzb24odG9rZW5SZXNwb25zZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdpbnZhbGlkX2dyYW50JyxcbiAgICAgICAgZXJyb3JfZGVzY3JpcHRpb246ICdJbnZhbGlkIHJlZnJlc2ggdG9rZW4nLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBjbGllbnQgY3JlZGVudGlhbHMgZ3JhbnRcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgaGFuZGxlQ2xpZW50Q3JlZGVudGlhbHNHcmFudChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB7IGNsaWVudF9pZCwgY2xpZW50X3NlY3JldCwgc2NvcGUgfSA9IHJlcS5ib2R5O1xuXG4gICAgaWYgKCFjbGllbnRfaWQgfHwgIWNsaWVudF9zZWNyZXQpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdpbnZhbGlkX3JlcXVlc3QnLFxuICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbjogJ2NsaWVudF9pZCBhbmQgY2xpZW50X3NlY3JldCBhcmUgcmVxdWlyZWQnLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gSW4gcHJvZHVjdGlvbiwgdmFsaWRhdGUgY2xpZW50IGNyZWRlbnRpYWxzIGFnYWluc3QgYSBzZWN1cmUgc3RvcmVcbiAgICBjb25zdCBpc1ZhbGlkQ2xpZW50ID0gYXdhaXQgdGhpcy52YWxpZGF0ZUNsaWVudENyZWRlbnRpYWxzKGNsaWVudF9pZCwgY2xpZW50X3NlY3JldCk7XG4gICAgXG4gICAgaWYgKCFpc1ZhbGlkQ2xpZW50KSB7XG4gICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIGVycm9yOiAnaW52YWxpZF9jbGllbnQnLFxuICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbjogJ0ludmFsaWQgY2xpZW50IGNyZWRlbnRpYWxzJyxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcXVlc3RlZFNjb3BlID0gc2NvcGUgfHwgJ3N5c3RlbS8qLnJlYWQnO1xuICAgIFxuICAgIC8vIEdlbmVyYXRlIGFjY2VzcyB0b2tlbiBmb3Igc3lzdGVtIGFjY2Vzc1xuICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gdGhpcy5nZW5lcmF0ZUFjY2Vzc1Rva2VuKHtcbiAgICAgIGNsaWVudF9pZCxcbiAgICAgIHNjb3BlOiByZXF1ZXN0ZWRTY29wZSxcbiAgICAgIHR5cGU6ICdzeXN0ZW0nLFxuICAgIH0pO1xuXG4gICAgY29uc3QgdG9rZW5SZXNwb25zZSA9IHtcbiAgICAgIGFjY2Vzc190b2tlbjogYWNjZXNzVG9rZW4sXG4gICAgICB0b2tlbl90eXBlOiAnYmVhcmVyJyxcbiAgICAgIGV4cGlyZXNfaW46IDM2MDAsXG4gICAgICBzY29wZTogcmVxdWVzdGVkU2NvcGUsXG4gICAgfTtcblxuICAgIGxvZ2dlci5zZWN1cml0eSgnU3lzdGVtIGFjY2VzcyB0b2tlbiBpc3N1ZWQnLCB7XG4gICAgICBjbGllbnRfaWQsXG4gICAgICBzY29wZTogcmVxdWVzdGVkU2NvcGUsXG4gICAgfSk7XG5cbiAgICByZXMuanNvbih0b2tlblJlc3BvbnNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQT1NUIC9hdXRoL2ludHJvc3BlY3QgLSBUb2tlbiBpbnRyb3NwZWN0aW9uIGVuZHBvaW50XG4gICAqL1xuICBhc3luYyBpbnRyb3NwZWN0KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHRva2VuIH0gPSByZXEuYm9keTtcblxuICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgZXJyb3I6ICdpbnZhbGlkX3JlcXVlc3QnLFxuICAgICAgICAgIGVycm9yX2Rlc2NyaXB0aW9uOiAndG9rZW4gcGFyYW1ldGVyIGlzIHJlcXVpcmVkJyxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgbG9nZ2VyLnNlY3VyaXR5KCdUb2tlbiBpbnRyb3NwZWN0aW9uIHJlcXVlc3QnLCB7XG4gICAgICAgIGlwOiByZXEuaXAsXG4gICAgICB9KTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZGVjb2RlZCA9IGp3dC52ZXJpZnkodG9rZW4sIGNvbmZpZy5qd3Quc2VjcmV0KSBhcyBhbnk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBpbnRyb3NwZWN0aW9uUmVzcG9uc2UgPSB7XG4gICAgICAgICAgYWN0aXZlOiB0cnVlLFxuICAgICAgICAgIHNjb3BlOiBkZWNvZGVkLnNjb3BlLFxuICAgICAgICAgIGNsaWVudF9pZDogZGVjb2RlZC5jbGllbnRfaWQsXG4gICAgICAgICAgc3ViOiBkZWNvZGVkLnN1YixcbiAgICAgICAgICBleHA6IGRlY29kZWQuZXhwLFxuICAgICAgICAgIGlhdDogZGVjb2RlZC5pYXQsXG4gICAgICAgICAgYXVkOiBkZWNvZGVkLmF1ZCxcbiAgICAgICAgICBpc3M6IGRlY29kZWQuaXNzLFxuICAgICAgICAgIHBhdGllbnQ6IGRlY29kZWQucGF0aWVudCxcbiAgICAgICAgICBlbmNvdW50ZXI6IGRlY29kZWQuZW5jb3VudGVyLFxuICAgICAgICAgIGZoaXJVc2VyOiBkZWNvZGVkLmZoaXJVc2VyLFxuICAgICAgICB9O1xuXG4gICAgICAgIHJlcy5qc29uKGludHJvc3BlY3Rpb25SZXNwb25zZSk7XG4gICAgICB9IGNhdGNoIChqd3RFcnJvcikge1xuICAgICAgICAvLyBUb2tlbiBpcyBpbnZhbGlkIG9yIGV4cGlyZWRcbiAgICAgICAgcmVzLmpzb24oeyBhY3RpdmU6IGZhbHNlIH0pO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ1Rva2VuIGludHJvc3BlY3Rpb24gZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdzZXJ2ZXJfZXJyb3InLFxuICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbjogJ0ludHJvc3BlY3Rpb24gc2VydmVyIGVycm9yJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gSU5URVJOQUwgQVBJIEFVVEhFTlRJQ0FUSU9OXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICAvKipcbiAgICogUE9TVCAvYXV0aC9sb2dpbiAtIEpXVC1iYXNlZCBhdXRoZW50aWNhdGlvblxuICAgKi9cbiAgYXN5bmMgbG9naW4ocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdXNlcm5hbWUsIHBhc3N3b3JkLCBtZmFUb2tlbiB9OiBMb2dpbkNyZWRlbnRpYWxzID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCBpcEFkZHJlc3MgPSByZXEuaXAgfHwgJ3Vua25vd24nO1xuICAgICAgY29uc3QgdXNlckFnZW50ID0gcmVxLmdldCgnVXNlci1BZ2VudCcpIHx8ICd1bmtub3duJztcblxuICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nU2VjdXJpdHlFdmVudCh7XG4gICAgICAgIHR5cGU6ICdMT0dJTl9GQUlMVVJFJyxcbiAgICAgICAgc2V2ZXJpdHk6ICdMT1cnLFxuICAgICAgICBkZXNjcmlwdGlvbjogYExvZ2luIGF0dGVtcHQgZm9yIHVzZXJuYW1lOiAke3VzZXJuYW1lfWAsXG4gICAgICAgIG1ldGFkYXRhOiB7IHVzZXJuYW1lLCBpcEFkZHJlc3MsIHVzZXJBZ2VudCB9XG4gICAgICB9KTtcblxuICAgICAgLy8gVmFsaWRhdGUgY3JlZGVudGlhbHNcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnZhbGlkYXRlVXNlckNyZWRlbnRpYWxzKHVzZXJuYW1lLCBwYXNzd29yZCk7XG4gICAgICBcbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICBhd2FpdCB0aGlzLmF1ZGl0U2VydmljZS5sb2dTZWN1cml0eUV2ZW50KHtcbiAgICAgICAgICB0eXBlOiAnTE9HSU5fRkFJTFVSRScsXG4gICAgICAgICAgc2V2ZXJpdHk6ICdNRURJVU0nLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBgRmFpbGVkIGxvZ2luIGF0dGVtcHQgLSBpbnZhbGlkIGNyZWRlbnRpYWxzYCxcbiAgICAgICAgICBtZXRhZGF0YTogeyB1c2VybmFtZSwgaXBBZGRyZXNzLCB1c2VyQWdlbnQgfVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogJ0lOVkFMSURfQ1JFREVOVElBTFMnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdJbnZhbGlkIHVzZXJuYW1lIG9yIHBhc3N3b3JkJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiBhY2NvdW50IGlzIGxvY2tlZFxuICAgICAgaWYgKHVzZXIuYWNjb3VudExvY2tlZFVudGlsICYmIHVzZXIuYWNjb3VudExvY2tlZFVudGlsID4gbmV3IERhdGUoKSkge1xuICAgICAgICBhd2FpdCB0aGlzLmF1ZGl0U2VydmljZS5sb2dTZWN1cml0eUV2ZW50KHtcbiAgICAgICAgICB0eXBlOiAnTE9HSU5fRkFJTFVSRScsXG4gICAgICAgICAgdXNlcklkOiB1c2VyLmlkLFxuICAgICAgICAgIHNldmVyaXR5OiAnTUVESVVNJyxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ0xvZ2luIGF0dGVtcHQgb24gbG9ja2VkIGFjY291bnQnLFxuICAgICAgICAgIG1ldGFkYXRhOiB7IHVzZXJuYW1lLCBpcEFkZHJlc3MsIHVzZXJBZ2VudCwgbG9ja2VkVW50aWw6IHVzZXIuYWNjb3VudExvY2tlZFVudGlsIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVzLnN0YXR1cyg0MjMpLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnQUNDT1VOVF9MT0NLRUQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdBY2NvdW50IGlzIHRlbXBvcmFyaWx5IGxvY2tlZCBkdWUgdG8gbXVsdGlwbGUgZmFpbGVkIGxvZ2luIGF0dGVtcHRzJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiB1c2VyIGlzIGFjdGl2ZVxuICAgICAgaWYgKCF1c2VyLmlzQWN0aXZlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoe1xuICAgICAgICAgIHR5cGU6ICdMT0dJTl9GQUlMVVJFJyxcbiAgICAgICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICAgICAgc2V2ZXJpdHk6ICdNRURJVU0nLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnTG9naW4gYXR0ZW1wdCBvbiBpbmFjdGl2ZSBhY2NvdW50JyxcbiAgICAgICAgICBtZXRhZGF0YTogeyB1c2VybmFtZSwgaXBBZGRyZXNzLCB1c2VyQWdlbnQgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdBQ0NPVU5UX0lOQUNUSVZFJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQWNjb3VudCBpcyBub3QgYWN0aXZlJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBNRkEgaWYgcmVxdWlyZWRcbiAgICAgIGlmICh0aGlzLmp3dFNlcnZpY2UuaXNNZmFSZXF1aXJlZCh1c2VyLnJvbGUpICYmIHVzZXIuaXNNZmFFbmFibGVkKSB7XG4gICAgICAgIGlmICghbWZhVG9rZW4pIHtcbiAgICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgIHJlcXVpcmVzTWZhOiB0cnVlLFxuICAgICAgICAgICAgbWVzc2FnZTogJ011bHRpLWZhY3RvciBhdXRoZW50aWNhdGlvbiByZXF1aXJlZCdcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXVzZXIubWZhU2VjcmV0IHx8ICF0aGlzLmp3dFNlcnZpY2UudmVyaWZ5TWZhVG9rZW4obWZhVG9rZW4sIHVzZXIubWZhU2VjcmV0KSkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoe1xuICAgICAgICAgICAgdHlwZTogJ0xPR0lOX0ZBSUxVUkUnLFxuICAgICAgICAgICAgdXNlcklkOiB1c2VyLmlkLFxuICAgICAgICAgICAgc2V2ZXJpdHk6ICdISUdIJyxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnSW52YWxpZCBNRkEgdG9rZW4gcHJvdmlkZWQnLFxuICAgICAgICAgICAgbWV0YWRhdGE6IHsgdXNlcm5hbWUsIGlwQWRkcmVzcywgdXNlckFnZW50IH1cbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgZXJyb3I6ICdJTlZBTElEX01GQV9UT0tFTicsXG4gICAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBtdWx0aS1mYWN0b3IgYXV0aGVudGljYXRpb24gdG9rZW4nXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEdlbmVyYXRlIEpXVCB0b2tlbnNcbiAgICAgIGNvbnN0IHRva2VucyA9IGF3YWl0IHRoaXMuand0U2VydmljZS5nZW5lcmF0ZVRva2Vucyh1c2VyKTtcbiAgICAgIFxuICAgICAgLy8gQ3JlYXRlIHNlc3Npb25cbiAgICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCB0aGlzLnNlc3Npb25NYW5hZ2VyLmNyZWF0ZVNlc3Npb24odXNlciwgaXBBZGRyZXNzLCB1c2VyQWdlbnQpO1xuXG4gICAgICAvLyBVcGRhdGUgdXNlciBsb2dpbiBpbmZvXG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZVVzZXJMb2dpbkluZm8odXNlci5pZCwgaXBBZGRyZXNzKTtcblxuICAgICAgLy8gTG9nIHN1Y2Nlc3NmdWwgbG9naW5cbiAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoe1xuICAgICAgICB0eXBlOiAnTE9HSU5fU1VDQ0VTUycsXG4gICAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgICAgc2V2ZXJpdHk6ICdMT1cnLFxuICAgICAgICBkZXNjcmlwdGlvbjogYFN1Y2Nlc3NmdWwgbG9naW4gZm9yICR7dXNlci51c2VybmFtZX1gLFxuICAgICAgICBtZXRhZGF0YTogeyBcbiAgICAgICAgICB1c2VybmFtZTogdXNlci51c2VybmFtZSwgXG4gICAgICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgICAgIHNlc3Npb25JZDogc2Vzc2lvbi5zZXNzaW9uSWQsXG4gICAgICAgICAgaXBBZGRyZXNzLCBcbiAgICAgICAgICB1c2VyQWdlbnQgXG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIHRva2VucyxcbiAgICAgICAgdXNlcjoge1xuICAgICAgICAgIGlkOiB1c2VyLmlkLFxuICAgICAgICAgIHVzZXJuYW1lOiB1c2VyLnVzZXJuYW1lLFxuICAgICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICAgIGZpcnN0TmFtZTogdXNlci5maXJzdE5hbWUsXG4gICAgICAgICAgbGFzdE5hbWU6IHVzZXIubGFzdE5hbWUsXG4gICAgICAgICAgcm9sZTogdXNlci5yb2xlLFxuICAgICAgICAgIGRlcGFydG1lbnQ6IHVzZXIuZGVwYXJ0bWVudCxcbiAgICAgICAgICBpc0FjdGl2ZTogdXNlci5pc0FjdGl2ZSxcbiAgICAgICAgICBpc01mYUVuYWJsZWQ6IHVzZXIuaXNNZmFFbmFibGVkLFxuICAgICAgICAgIGxhc3RMb2dpbjogdXNlci5sYXN0TG9naW5cbiAgICAgICAgfSxcbiAgICAgICAgc2Vzc2lvbjoge1xuICAgICAgICAgIHNlc3Npb25JZDogc2Vzc2lvbi5zZXNzaW9uSWQsXG4gICAgICAgICAgZXhwaXJlc0F0OiBzZXNzaW9uLmV4cGlyZXNBdFxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdMb2dpbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nU2VjdXJpdHlFdmVudCh7XG4gICAgICAgIHR5cGU6ICdMT0dJTl9GQUlMVVJFJyxcbiAgICAgICAgc2V2ZXJpdHk6ICdISUdIJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdMb2dpbiBzeXN0ZW0gZXJyb3InLFxuICAgICAgICBtZXRhZGF0YTogeyBlcnJvcjogZ2V0RXJyb3JNZXNzYWdlKGVycm9yKSwgaXBBZGRyZXNzOiByZXEuaXAgfVxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnSU5URVJOQUxfRVJST1InLFxuICAgICAgICBtZXNzYWdlOiAnQW4gaW50ZXJuYWwgZXJyb3Igb2NjdXJyZWQgZHVyaW5nIGxvZ2luJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFBPU1QgL2F1dGgvcmVmcmVzaCAtIFJlZnJlc2ggYWNjZXNzIHRva2VuXG4gICAqL1xuICBhc3luYyByZWZyZXNoVG9rZW4ocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgcmVmcmVzaFRva2VuIH0gPSByZXEuYm9keTtcbiAgICAgIGNvbnN0IGlwQWRkcmVzcyA9IHJlcS5pcCB8fCAndW5rbm93bic7XG4gICAgICBjb25zdCB1c2VyQWdlbnQgPSByZXEuZ2V0KCdVc2VyLUFnZW50JykgfHwgJ3Vua25vd24nO1xuXG4gICAgICBpZiAoIXJlZnJlc2hUb2tlbikge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdNSVNTSU5HX1JFRlJFU0hfVE9LRU4nLFxuICAgICAgICAgIG1lc3NhZ2U6ICdSZWZyZXNoIHRva2VuIGlzIHJlcXVpcmVkJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZnkgcmVmcmVzaCB0b2tlblxuICAgICAgY29uc3QgZGVjb2RlZCA9IGF3YWl0IHRoaXMuand0U2VydmljZS52ZXJpZnlSZWZyZXNoVG9rZW4ocmVmcmVzaFRva2VuKTtcbiAgICAgIFxuICAgICAgLy8gR2V0IHVzZXJcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLmdldFVzZXJCeUlkKGRlY29kZWQudXNlcklkKTtcbiAgICAgIGlmICghdXNlciB8fCAhdXNlci5pc0FjdGl2ZSkge1xuICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdVU0VSX05PVF9GT1VORCcsXG4gICAgICAgICAgbWVzc2FnZTogJ1VzZXIgbm90IGZvdW5kIG9yIGluYWN0aXZlJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBHZW5lcmF0ZSBuZXcgdG9rZW5zXG4gICAgICBjb25zdCB0b2tlbnMgPSBhd2FpdCB0aGlzLmp3dFNlcnZpY2UucmVmcmVzaEFjY2Vzc1Rva2VuKHJlZnJlc2hUb2tlbiwgdXNlcik7XG5cbiAgICAgIC8vIExvZyB0b2tlbiByZWZyZXNoXG4gICAgICBhd2FpdCB0aGlzLmF1ZGl0U2VydmljZS5sb2dVc2VyQWN0aW9uKFxuICAgICAgICB1c2VyLmlkLFxuICAgICAgICAndG9rZW5fcmVmcmVzaCcsXG4gICAgICAgICcvYXV0aC9yZWZyZXNoJyxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICBpcEFkZHJlc3MsXG4gICAgICAgIHVzZXJBZ2VudCxcbiAgICAgICAgdHJ1ZVxuICAgICAgKTtcblxuICAgICAgcmVzLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICB0b2tlbnNcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ1Rva2VuIHJlZnJlc2ggZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoe1xuICAgICAgICB0eXBlOiAnTE9HSU5fRkFJTFVSRScsXG4gICAgICAgIHNldmVyaXR5OiAnTUVESVVNJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdUb2tlbiByZWZyZXNoIGZhaWxlZCcsXG4gICAgICAgIG1ldGFkYXRhOiB7IGVycm9yOiBnZXRFcnJvck1lc3NhZ2UoZXJyb3IpLCBpcEFkZHJlc3M6IHJlcS5pcCB9XG4gICAgICB9KTtcblxuICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdJTlZBTElEX1JFRlJFU0hfVE9LRU4nLFxuICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBvciBleHBpcmVkIHJlZnJlc2ggdG9rZW4nXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUE9TVCAvYXV0aC9sb2dvdXQgLSBMb2dvdXQgYW5kIGRlc3Ryb3kgc2Vzc2lvblxuICAgKi9cbiAgYXN5bmMgbG9nb3V0KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmdldCgnQXV0aG9yaXphdGlvbicpO1xuICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLmp3dFNlcnZpY2UuZXh0cmFjdFRva2VuRnJvbUhlYWRlcihhdXRoSGVhZGVyKTtcbiAgICAgIGNvbnN0IGlwQWRkcmVzcyA9IHJlcS5pcCB8fCAndW5rbm93bic7XG4gICAgICBjb25zdCB1c2VyQWdlbnQgPSByZXEuZ2V0KCdVc2VyLUFnZW50JykgfHwgJ3Vua25vd24nO1xuXG4gICAgICBpZiAodG9rZW4pIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCB0b2tlblBheWxvYWQgPSBhd2FpdCB0aGlzLmp3dFNlcnZpY2UudmVyaWZ5QWNjZXNzVG9rZW4odG9rZW4pO1xuICAgICAgICAgIFxuICAgICAgICAgIC8vIERlc3Ryb3kgc2Vzc2lvblxuICAgICAgICAgIGF3YWl0IHRoaXMuc2Vzc2lvbk1hbmFnZXIuZGVzdHJveVNlc3Npb24odG9rZW5QYXlsb2FkLnNlc3Npb25JZCk7XG4gICAgICAgICAgXG4gICAgICAgICAgLy8gTG9nIGxvZ291dFxuICAgICAgICAgIGF3YWl0IHRoaXMuYXVkaXRTZXJ2aWNlLmxvZ1NlY3VyaXR5RXZlbnQoe1xuICAgICAgICAgICAgdHlwZTogJ0xPR09VVCcsXG4gICAgICAgICAgICB1c2VySWQ6IHRva2VuUGF5bG9hZC51c2VySWQsXG4gICAgICAgICAgICBzZXZlcml0eTogJ0xPVycsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogYFVzZXIgJHt0b2tlblBheWxvYWQudXNlcm5hbWV9IGxvZ2dlZCBvdXRgLFxuICAgICAgICAgICAgbWV0YWRhdGE6IHsgXG4gICAgICAgICAgICAgIHNlc3Npb25JZDogdG9rZW5QYXlsb2FkLnNlc3Npb25JZCxcbiAgICAgICAgICAgICAgaXBBZGRyZXNzLCBcbiAgICAgICAgICAgICAgdXNlckFnZW50IFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIC8vIFRva2VuIG1pZ2h0IGJlIGludmFsaWQsIGJ1dCB0aGF0J3Mgb2theSBmb3IgbG9nb3V0XG4gICAgICAgICAgbG9nZ2VyLndhcm4oJ1Rva2VuIHZlcmlmaWNhdGlvbiBmYWlsZWQgZHVyaW5nIGxvZ291dDonLCBnZXRFcnJvck1lc3NhZ2UoZXJyb3IpKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6ICdTdWNjZXNzZnVsbHkgbG9nZ2VkIG91dCdcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0xvZ291dCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdMT0dPVVRfRVJST1InLFxuICAgICAgICBtZXNzYWdlOiAnQW4gZXJyb3Igb2NjdXJyZWQgZHVyaW5nIGxvZ291dCdcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQT1NUIC9hdXRoL3NldHVwLW1mYSAtIFNldHVwIG11bHRpLWZhY3RvciBhdXRoZW50aWNhdGlvblxuICAgKi9cbiAgYXN5bmMgc2V0dXBNZmEocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdXNlcklkIH0gPSByZXEuYm9keTtcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLmdldFVzZXJCeUlkKHVzZXJJZCk7XG4gICAgICBcbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdVU0VSX05PVF9GT1VORCcsXG4gICAgICAgICAgbWVzc2FnZTogJ1VzZXIgbm90IGZvdW5kJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBtZmFTZXR1cCA9IGF3YWl0IHRoaXMuand0U2VydmljZS5nZW5lcmF0ZU1mYVNlY3JldCh1c2VyKTtcbiAgICAgIFxuICAgICAgLy8gU3RvcmUgc2VjcmV0IHRlbXBvcmFyaWx5ICh1c2VyIG11c3QgdmVyaWZ5IGJlZm9yZSBlbmFibGluZylcbiAgICAgIGF3YWl0IHRoaXMuc3RvcmVUZW1wTWZhU2VjcmV0KHVzZXJJZCwgbWZhU2V0dXAuc2VjcmV0KTtcblxuICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nVXNlckFjdGlvbihcbiAgICAgICAgdXNlcklkLFxuICAgICAgICAnbWZhX3NldHVwX2luaXRpYXRlZCcsXG4gICAgICAgICcvYXV0aC9zZXR1cC1tZmEnLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIHJlcS5pcCB8fCAndW5rbm93bicsXG4gICAgICAgIHJlcS5nZXQoJ1VzZXItQWdlbnQnKSB8fCAndW5rbm93bicsXG4gICAgICAgIHRydWVcbiAgICAgICk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgbWZhU2V0dXA6IHtcbiAgICAgICAgICBxckNvZGU6IG1mYVNldHVwLnFyQ29kZSxcbiAgICAgICAgICBiYWNrdXBDb2RlczogbWZhU2V0dXAuYmFja3VwQ29kZXNcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignTUZBIHNldHVwIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ01GQV9TRVRVUF9FUlJPUicsXG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gc2V0dXAgbXVsdGktZmFjdG9yIGF1dGhlbnRpY2F0aW9uJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFBPU1QgL2F1dGgvdmVyaWZ5LW1mYSAtIFZlcmlmeSBhbmQgZW5hYmxlIE1GQVxuICAgKi9cbiAgYXN5bmMgdmVyaWZ5TWZhKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHVzZXJJZCwgdG9rZW4gfSA9IHJlcS5ib2R5O1xuICAgICAgXG4gICAgICBjb25zdCB0ZW1wU2VjcmV0ID0gYXdhaXQgdGhpcy5nZXRUZW1wTWZhU2VjcmV0KHVzZXJJZCk7XG4gICAgICBpZiAoIXRlbXBTZWNyZXQpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnTk9fUEVORElOR19NRkFfU0VUVVAnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdObyBwZW5kaW5nIE1GQSBzZXR1cCBmb3VuZCdcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKCF0aGlzLmp3dFNlcnZpY2UudmVyaWZ5TWZhVG9rZW4odG9rZW4sIHRlbXBTZWNyZXQpKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogJ0lOVkFMSURfTUZBX1RPS0VOJyxcbiAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBNRkEgdG9rZW4nXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIEVuYWJsZSBNRkEgZm9yIHVzZXJcbiAgICAgIGF3YWl0IHRoaXMuZW5hYmxlVXNlck1mYSh1c2VySWQsIHRlbXBTZWNyZXQpO1xuICAgICAgYXdhaXQgdGhpcy5jbGVhclRlbXBNZmFTZWNyZXQodXNlcklkKTtcblxuICAgICAgYXdhaXQgdGhpcy5hdWRpdFNlcnZpY2UubG9nU2VjdXJpdHlFdmVudCh7XG4gICAgICAgIHR5cGU6ICdNRkFfRU5BQkxFRCcsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgc2V2ZXJpdHk6ICdNRURJVU0nLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ011bHRpLWZhY3RvciBhdXRoZW50aWNhdGlvbiBlbmFibGVkJyxcbiAgICAgICAgbWV0YWRhdGE6IHsgaXBBZGRyZXNzOiByZXEuaXAgfVxuICAgICAgfSk7XG5cbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgbWVzc2FnZTogJ011bHRpLWZhY3RvciBhdXRoZW50aWNhdGlvbiBlbmFibGVkIHN1Y2Nlc3NmdWxseSdcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ01GQSB2ZXJpZmljYXRpb24gZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnTUZBX1ZFUklGSUNBVElPTl9FUlJPUicsXG4gICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gdmVyaWZ5IG11bHRpLWZhY3RvciBhdXRoZW50aWNhdGlvbidcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHRVQgL2F1dGgvbWUgLSBHZXQgY3VycmVudCB1c2VyIGluZm9cbiAgICovXG4gIGFzeW5jIGdldEN1cnJlbnRVc2VyKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmdldCgnQXV0aG9yaXphdGlvbicpO1xuICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLmp3dFNlcnZpY2UuZXh0cmFjdFRva2VuRnJvbUhlYWRlcihhdXRoSGVhZGVyKTtcbiAgICAgIFxuICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdOT19UT0tFTicsXG4gICAgICAgICAgbWVzc2FnZTogJ05vIGF1dGhlbnRpY2F0aW9uIHRva2VuIHByb3ZpZGVkJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB0b2tlblBheWxvYWQgPSBhd2FpdCB0aGlzLmp3dFNlcnZpY2UudmVyaWZ5QWNjZXNzVG9rZW4odG9rZW4pO1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMuZ2V0VXNlckJ5SWQodG9rZW5QYXlsb2FkLnVzZXJJZCk7XG4gICAgICBcbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdVU0VSX05PVF9GT1VORCcsXG4gICAgICAgICAgbWVzc2FnZTogJ1VzZXIgbm90IGZvdW5kJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICByZXMuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIHVzZXI6IHtcbiAgICAgICAgICBpZDogdXNlci5pZCxcbiAgICAgICAgICB1c2VybmFtZTogdXNlci51c2VybmFtZSxcbiAgICAgICAgICBlbWFpbDogdXNlci5lbWFpbCxcbiAgICAgICAgICBmaXJzdE5hbWU6IHVzZXIuZmlyc3ROYW1lLFxuICAgICAgICAgIGxhc3ROYW1lOiB1c2VyLmxhc3ROYW1lLFxuICAgICAgICAgIHJvbGU6IHVzZXIucm9sZSxcbiAgICAgICAgICBkZXBhcnRtZW50OiB1c2VyLmRlcGFydG1lbnQsXG4gICAgICAgICAgaXNBY3RpdmU6IHVzZXIuaXNBY3RpdmUsXG4gICAgICAgICAgaXNNZmFFbmFibGVkOiB1c2VyLmlzTWZhRW5hYmxlZCxcbiAgICAgICAgICBsYXN0TG9naW46IHVzZXIubGFzdExvZ2luXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ0lOVkFMSURfVE9LRU4nLFxuICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBvciBleHBpcmVkIHRva2VuJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBVVElMSVRZIE1FVEhPRFNcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVBdXRob3JpemF0aW9uQ29kZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgY29kZV8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlQWNjZXNzVG9rZW4ocGF5bG9hZDogYW55KTogc3RyaW5nIHtcbiAgICByZXR1cm4gand0LnNpZ24oXG4gICAgICB7XG4gICAgICAgIC4uLnBheWxvYWQsXG4gICAgICAgIHR5cGU6ICdhY2Nlc3MnLFxuICAgICAgICBpc3M6IGNvbmZpZy5maGlyLmJhc2VVcmwsXG4gICAgICAgIGF1ZDogcGF5bG9hZC5hdWQgfHwgY29uZmlnLmZoaXIuYmFzZVVybCxcbiAgICAgICAgaWF0OiBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKSxcbiAgICAgIH0sXG4gICAgICBjb25maWcuand0LnNlY3JldCxcbiAgICAgIHsgZXhwaXJlc0luOiAnMWgnIH1cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZVJlZnJlc2hUb2tlbihwYXlsb2FkOiBhbnkpOiBzdHJpbmcge1xuICAgIHJldHVybiBqd3Quc2lnbihcbiAgICAgIHtcbiAgICAgICAgLi4ucGF5bG9hZCxcbiAgICAgICAgdHlwZTogJ3JlZnJlc2gnLFxuICAgICAgICBpc3M6IGNvbmZpZy5maGlyLmJhc2VVcmwsXG4gICAgICAgIGlhdDogTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMCksXG4gICAgICB9LFxuICAgICAgY29uZmlnLmp3dC5zZWNyZXQsXG4gICAgICB7IGV4cGlyZXNJbjogJzMwZCcgfVxuICAgICk7XG4gIH1cblxuICAvLyBUZW1wb3JhcnkgaW4tbWVtb3J5IHN0b3JhZ2UgZm9yIGRlbW8gcHVycG9zZXNcbiAgLy8gSW4gcHJvZHVjdGlvbiwgdXNlIFJlZGlzIG9yIHNlY3VyZSBkYXRhYmFzZVxuICBwcml2YXRlIGF1dGhDb2RlcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG5cbiAgcHJpdmF0ZSBzdG9yZUF1dGhvcml6YXRpb25Db2RlKGNvZGU6IHN0cmluZywgZGF0YTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5hdXRoQ29kZXMuc2V0KGNvZGUsIGRhdGEpO1xuICAgIFxuICAgIC8vIENsZWFuIHVwIGV4cGlyZWQgY29kZXMgYWZ0ZXIgdGltZW91dFxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5hdXRoQ29kZXMuZGVsZXRlKGNvZGUpO1xuICAgIH0sIDEwICogNjAgKiAxMDAwKTsgLy8gMTAgbWludXRlc1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBdXRob3JpemF0aW9uQ29kZShjb2RlOiBzdHJpbmcpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLmF1dGhDb2Rlcy5nZXQoY29kZSk7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUF1dGhvcml6YXRpb25Db2RlKGNvZGU6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuYXV0aENvZGVzLmRlbGV0ZShjb2RlKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdmFsaWRhdGVDbGllbnRDcmVkZW50aWFscyhjbGllbnRJZDogc3RyaW5nLCBjbGllbnRTZWNyZXQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vIEluIHByb2R1Y3Rpb24sIHZhbGlkYXRlIGFnYWluc3Qgc2VjdXJlIGNsaWVudCByZWdpc3RyeVxuICAgIC8vIFRoaXMgaXMgYSBwbGFjZWhvbGRlciBpbXBsZW1lbnRhdGlvblxuICAgIHJldHVybiBjbGllbnRJZCA9PT0gJ29tbmljYXJlLWNsaWVudCcgJiYgY2xpZW50U2VjcmV0ID09PSAnb21uaWNhcmUtc2VjcmV0JztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdmFsaWRhdGVVc2VyQ3JlZGVudGlhbHModXNlcm5hbWU6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8VXNlciB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgLy8gR2V0IHVzZXIgYnkgdXNlcm5hbWUgb3IgZW1haWxcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLmdldFVzZXJCeVVzZXJuYW1lT3JFbWFpbCh1c2VybmFtZSk7XG4gICAgICBcbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZ5IHBhc3N3b3JkXG4gICAgICBjb25zdCBpc1Bhc3N3b3JkVmFsaWQgPSBhd2FpdCB0aGlzLmp3dFNlcnZpY2UudmVyaWZ5UGFzc3dvcmQocGFzc3dvcmQsIHVzZXIucGFzc3dvcmRIYXNoIHx8ICcnKTtcbiAgICAgIFxuICAgICAgaWYgKCFpc1Bhc3N3b3JkVmFsaWQpIHtcbiAgICAgICAgLy8gSW5jcmVtZW50IGZhaWxlZCBsb2dpbiBhdHRlbXB0c1xuICAgICAgICBhd2FpdCB0aGlzLmluY3JlbWVudEZhaWxlZExvZ2luQXR0ZW1wdHModXNlci5pZCk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBSZXNldCBmYWlsZWQgbG9naW4gYXR0ZW1wdHMgb24gc3VjY2Vzc2Z1bCBhdXRoZW50aWNhdGlvblxuICAgICAgYXdhaXQgdGhpcy5yZXNldEZhaWxlZExvZ2luQXR0ZW1wdHModXNlci5pZCk7XG4gICAgICBcbiAgICAgIHJldHVybiB1c2VyO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ1VzZXIgY3JlZGVudGlhbCB2YWxpZGF0aW9uIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFVzZXJCeUlkKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyIHwgbnVsbD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBNb2NrIGltcGxlbWVudGF0aW9uIC0gcmVwbGFjZSB3aXRoIGFjdHVhbCBkYXRhYmFzZSBxdWVyeVxuICAgICAgY29uc3QgbW9ja1VzZXJzOiBSZWNvcmQ8c3RyaW5nLCBVc2VyPiA9IHtcbiAgICAgICAgJ3VzZXItMSc6IHtcbiAgICAgICAgICBpZDogJ3VzZXItMScsXG4gICAgICAgICAgdXNlcm5hbWU6ICdhZG1pbkBvbW5pY2FyZS5jb20nLFxuICAgICAgICAgIGVtYWlsOiAnYWRtaW5Ab21uaWNhcmUuY29tJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdTeXN0ZW0nLFxuICAgICAgICAgIGxhc3ROYW1lOiAnQWRtaW5pc3RyYXRvcicsXG4gICAgICAgICAgcm9sZTogVXNlclJvbGVzLlNZU1RFTV9BRE1JTklTVFJBVE9SLFxuICAgICAgICAgIGRlcGFydG1lbnQ6ICdJVCcsXG4gICAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgICAgaXNNZmFFbmFibGVkOiB0cnVlLFxuICAgICAgICAgIHBhc3N3b3JkQ2hhbmdlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIGZhaWxlZExvZ2luQXR0ZW1wdHM6IDAsXG4gICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICBwYXNzd29yZEhhc2g6IGF3YWl0IHRoaXMuand0U2VydmljZS5oYXNoUGFzc3dvcmQoJ2FkbWluMTIzJylcbiAgICAgICAgfSxcbiAgICAgICAgJ3VzZXItMic6IHtcbiAgICAgICAgICBpZDogJ3VzZXItMicsXG4gICAgICAgICAgdXNlcm5hbWU6ICdkb2N0b3JAb21uaWNhcmUuY29tJyxcbiAgICAgICAgICBlbWFpbDogJ2RvY3RvckBvbW5pY2FyZS5jb20nLFxuICAgICAgICAgIGZpcnN0TmFtZTogJ0RyLiBKYW5lJyxcbiAgICAgICAgICBsYXN0TmFtZTogJ1NtaXRoJyxcbiAgICAgICAgICByb2xlOiBVc2VyUm9sZXMuUEhZU0lDSUFOLFxuICAgICAgICAgIGRlcGFydG1lbnQ6ICdDYXJkaW9sb2d5JyxcbiAgICAgICAgICBsaWNlbnNlTnVtYmVyOiAnTUQxMjM0NTYnLFxuICAgICAgICAgIG5waU51bWJlcjogJzEyMzQ1Njc4OTAnLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIGlzTWZhRW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgICBwYXNzd29yZENoYW5nZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICBmYWlsZWRMb2dpbkF0dGVtcHRzOiAwLFxuICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgcGFzc3dvcmRIYXNoOiBhd2FpdCB0aGlzLmp3dFNlcnZpY2UuaGFzaFBhc3N3b3JkKCdkZW1vMTIzJylcbiAgICAgICAgfSxcbiAgICAgICAgJ3VzZXItMyc6IHtcbiAgICAgICAgICBpZDogJ3VzZXItMycsXG4gICAgICAgICAgdXNlcm5hbWU6ICdudXJzZUBvbW5pY2FyZS5jb20nLFxuICAgICAgICAgIGVtYWlsOiAnbnVyc2VAb21uaWNhcmUuY29tJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdTYXJhaCcsXG4gICAgICAgICAgbGFzdE5hbWU6ICdKb2huc29uJyxcbiAgICAgICAgICByb2xlOiBVc2VyUm9sZXMuTlVSU0lOR19TVEFGRixcbiAgICAgICAgICBkZXBhcnRtZW50OiAnRW1lcmdlbmN5JyxcbiAgICAgICAgICBsaWNlbnNlTnVtYmVyOiAnUk43ODkwMTInLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIGlzTWZhRW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgcGFzc3dvcmRDaGFuZ2VkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgZmFpbGVkTG9naW5BdHRlbXB0czogMCxcbiAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIHBhc3N3b3JkSGFzaDogYXdhaXQgdGhpcy5qd3RTZXJ2aWNlLmhhc2hQYXNzd29yZCgnZGVtbzEyMycpXG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBtb2NrVXNlcnNbdXNlcklkXSB8fCBudWxsO1xuICAgICAgXG4gICAgICAvLyBUT0RPOiBSZXBsYWNlIHdpdGggYWN0dWFsIGRhdGFiYXNlIHF1ZXJ5XG4gICAgICAvLyByZXR1cm4gYXdhaXQgVXNlclJlcG9zaXRvcnkuZmluZEJ5SWQodXNlcklkKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdHZXQgdXNlciBieSBJRCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRVc2VyQnlVc2VybmFtZU9yRW1haWwodXNlcm5hbWVPckVtYWlsOiBzdHJpbmcpOiBQcm9taXNlPFVzZXIgfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIE1vY2sgaW1wbGVtZW50YXRpb24gLSByZXBsYWNlIHdpdGggYWN0dWFsIGRhdGFiYXNlIHF1ZXJ5XG4gICAgICBjb25zdCBtb2NrVXNlcnM6IFVzZXJbXSA9IFtcbiAgICAgICAge1xuICAgICAgICAgIGlkOiAndXNlci0xJyxcbiAgICAgICAgICB1c2VybmFtZTogJ2FkbWluQG9tbmljYXJlLmNvbScsXG4gICAgICAgICAgZW1haWw6ICdhZG1pbkBvbW5pY2FyZS5jb20nLFxuICAgICAgICAgIGZpcnN0TmFtZTogJ1N5c3RlbScsXG4gICAgICAgICAgbGFzdE5hbWU6ICdBZG1pbmlzdHJhdG9yJyxcbiAgICAgICAgICByb2xlOiBVc2VyUm9sZXMuU1lTVEVNX0FETUlOSVNUUkFUT1IsXG4gICAgICAgICAgZGVwYXJ0bWVudDogJ0lUJyxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICBpc01mYUVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgcGFzc3dvcmRDaGFuZ2VkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgZmFpbGVkTG9naW5BdHRlbXB0czogMCxcbiAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIHBhc3N3b3JkSGFzaDogYXdhaXQgdGhpcy5qd3RTZXJ2aWNlLmhhc2hQYXNzd29yZCgnYWRtaW4xMjMnKVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgaWQ6ICd1c2VyLTInLFxuICAgICAgICAgIHVzZXJuYW1lOiAnZG9jdG9yQG9tbmljYXJlLmNvbScsXG4gICAgICAgICAgZW1haWw6ICdkb2N0b3JAb21uaWNhcmUuY29tJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdEci4gSmFuZScsXG4gICAgICAgICAgbGFzdE5hbWU6ICdTbWl0aCcsXG4gICAgICAgICAgcm9sZTogVXNlclJvbGVzLlBIWVNJQ0lBTixcbiAgICAgICAgICBkZXBhcnRtZW50OiAnQ2FyZGlvbG9neScsXG4gICAgICAgICAgbGljZW5zZU51bWJlcjogJ01EMTIzNDU2JyxcbiAgICAgICAgICBucGlOdW1iZXI6ICcxMjM0NTY3ODkwJyxcbiAgICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgICAgICBpc01mYUVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgcGFzc3dvcmRDaGFuZ2VkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgZmFpbGVkTG9naW5BdHRlbXB0czogMCxcbiAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIHBhc3N3b3JkSGFzaDogYXdhaXQgdGhpcy5qd3RTZXJ2aWNlLmhhc2hQYXNzd29yZCgnZGVtbzEyMycpXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogJ3VzZXItMycsXG4gICAgICAgICAgdXNlcm5hbWU6ICdudXJzZUBvbW5pY2FyZS5jb20nLFxuICAgICAgICAgIGVtYWlsOiAnbnVyc2VAb21uaWNhcmUuY29tJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdTYXJhaCcsXG4gICAgICAgICAgbGFzdE5hbWU6ICdKb2huc29uJyxcbiAgICAgICAgICByb2xlOiBVc2VyUm9sZXMuTlVSU0lOR19TVEFGRixcbiAgICAgICAgICBkZXBhcnRtZW50OiAnRW1lcmdlbmN5JyxcbiAgICAgICAgICBsaWNlbnNlTnVtYmVyOiAnUk43ODkwMTInLFxuICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgIGlzTWZhRW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgcGFzc3dvcmRDaGFuZ2VkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgZmFpbGVkTG9naW5BdHRlbXB0czogMCxcbiAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIHBhc3N3b3JkSGFzaDogYXdhaXQgdGhpcy5qd3RTZXJ2aWNlLmhhc2hQYXNzd29yZCgnZGVtbzEyMycpXG4gICAgICAgIH1cbiAgICAgIF07XG5cbiAgICAgIHJldHVybiBtb2NrVXNlcnMuZmluZCh1c2VyID0+IFxuICAgICAgICB1c2VyLnVzZXJuYW1lID09PSB1c2VybmFtZU9yRW1haWwgfHwgdXNlci5lbWFpbCA9PT0gdXNlcm5hbWVPckVtYWlsXG4gICAgICApIHx8IG51bGw7XG4gICAgICBcbiAgICAgIC8vIFRPRE86IFJlcGxhY2Ugd2l0aCBhY3R1YWwgZGF0YWJhc2UgcXVlcnlcbiAgICAgIC8vIHJldHVybiBhd2FpdCBVc2VyUmVwb3NpdG9yeS5maW5kQnlVc2VybmFtZU9yRW1haWwodXNlcm5hbWVPckVtYWlsKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdHZXQgdXNlciBieSB1c2VybmFtZS9lbWFpbCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1cGRhdGVVc2VyTG9naW5JbmZvKHVzZXJJZDogc3RyaW5nLCBpcEFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBUT0RPOiBVcGRhdGUgdXNlcidzIGxhc3QgbG9naW4gdGltZXN0YW1wIGFuZCBJUCBpbiBkYXRhYmFzZVxuICAgICAgbG9nZ2VyLmluZm8oYFVwZGF0ZWQgbG9naW4gaW5mbyBmb3IgdXNlciAke3VzZXJJZH0gZnJvbSAke2lwQWRkcmVzc31gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdVcGRhdGUgdXNlciBsb2dpbiBpbmZvIGZhaWxlZDonLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBpbmNyZW1lbnRGYWlsZWRMb2dpbkF0dGVtcHRzKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFRPRE86IEluY3JlbWVudCBmYWlsZWQgbG9naW4gYXR0ZW1wdHMgaW4gZGF0YWJhc2VcbiAgICAgIC8vIElmIGF0dGVtcHRzIGV4Y2VlZCB0aHJlc2hvbGQsIGxvY2sgYWNjb3VudFxuICAgICAgbG9nZ2VyLmluZm8oYEluY3JlbWVudGVkIGZhaWxlZCBsb2dpbiBhdHRlbXB0cyBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdJbmNyZW1lbnQgZmFpbGVkIGxvZ2luIGF0dGVtcHRzIGZhaWxlZDonLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZXNldEZhaWxlZExvZ2luQXR0ZW1wdHModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVE9ETzogUmVzZXQgZmFpbGVkIGxvZ2luIGF0dGVtcHRzIGluIGRhdGFiYXNlXG4gICAgICBsb2dnZXIuaW5mbyhgUmVzZXQgZmFpbGVkIGxvZ2luIGF0dGVtcHRzIGZvciB1c2VyICR7dXNlcklkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ1Jlc2V0IGZhaWxlZCBsb2dpbiBhdHRlbXB0cyBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc3RvcmVUZW1wTWZhU2VjcmV0KHVzZXJJZDogc3RyaW5nLCBzZWNyZXQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBUT0RPOiBTdG9yZSB0ZW1wb3JhcnkgTUZBIHNlY3JldCAoZXhwaXJlcyBpbiAxMCBtaW51dGVzKVxuICAgICAgbG9nZ2VyLmluZm8oYFN0b3JlZCB0ZW1wb3JhcnkgTUZBIHNlY3JldCBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdTdG9yZSB0ZW1wIE1GQSBzZWNyZXQgZmFpbGVkOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFRlbXBNZmFTZWNyZXQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVE9ETzogR2V0IHRlbXBvcmFyeSBNRkEgc2VjcmV0IGZyb20gc3RvcmFnZVxuICAgICAgbG9nZ2VyLmluZm8oYFJldHJpZXZlZCB0ZW1wb3JhcnkgTUZBIHNlY3JldCBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgICAgIHJldHVybiBudWxsOyAvLyBNb2NrIGltcGxlbWVudGF0aW9uXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignR2V0IHRlbXAgTUZBIHNlY3JldCBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjbGVhclRlbXBNZmFTZWNyZXQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVE9ETzogQ2xlYXIgdGVtcG9yYXJ5IE1GQSBzZWNyZXQgZnJvbSBzdG9yYWdlXG4gICAgICBsb2dnZXIuaW5mbyhgQ2xlYXJlZCB0ZW1wb3JhcnkgTUZBIHNlY3JldCBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdDbGVhciB0ZW1wIE1GQSBzZWNyZXQgZmFpbGVkOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGVuYWJsZVVzZXJNZmEodXNlcklkOiBzdHJpbmcsIHNlY3JldDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFRPRE86IEVuYWJsZSBNRkEgZm9yIHVzZXIgaW4gZGF0YWJhc2VcbiAgICAgIGxvZ2dlci5pbmZvKGBFbmFibGVkIE1GQSBmb3IgdXNlciAke3VzZXJJZH1gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFbmFibGUgdXNlciBNRkEgZmFpbGVkOicsIGVycm9yKTtcbiAgICB9XG4gIH1cbn1cblxuLy8gRXhwb3J0IHNpbmdsZXRvbiBpbnN0YW5jZVxuLy8gRXhwb3J0IHNpbmdsZXRvbiBpbnN0YW5jZVxuZXhwb3J0IGNvbnN0IGF1dGhDb250cm9sbGVyID0gbmV3IEF1dGhDb250cm9sbGVyKCk7Il0sInZlcnNpb24iOjN9