0b5839a59b29ee162a6eb1f27acc179d
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.fhirValidationService = exports.FHIRValidationService = void 0;
const ajv_1 = __importDefault(require("ajv"));
const ajv_formats_1 = __importDefault(require("ajv-formats"));
const logger_1 = __importDefault(require("@/utils/logger"));
const axios_1 = __importDefault(require("axios"));
const error_utils_1 = require("@/utils/error.utils");
/**
 * FHIR R4 Validation Service
 * Provides comprehensive FHIR resource validation and compliance testing
 */
class FHIRValidationService {
    ajv;
    fhirSchemas = new Map();
    validationCache = new Map();
    cacheTimeout = 300000; // 5 minutes
    constructor() {
        this.ajv = new ajv_1.default({
            allErrors: true,
            verbose: true,
            strict: false,
            loadSchema: this.loadSchema.bind(this)
        });
        (0, ajv_formats_1.default)(this.ajv);
        this.initializeValidation();
    }
    /**
     * Initialize validation service with FHIR schemas
     */
    async initializeValidation() {
        try {
            await this.loadFHIRSchemas();
            await this.setupCustomValidators();
            logger_1.default.info('FHIR validation service initialized successfully');
        }
        catch (error) {
            logger_1.default.error('Failed to initialize FHIR validation service:', error);
            throw error;
        }
    }
    /**
     * Load FHIR R4 schemas
     */
    async loadFHIRSchemas() {
        const resourceTypes = [
            'Patient', 'Practitioner', 'Organization', 'Location', 'Device',
            'Encounter', 'Observation', 'Condition', 'Procedure', 'DiagnosticReport',
            'MedicationRequest', 'MedicationAdministration', 'MedicationStatement',
            'AllergyIntolerance', 'CarePlan', 'ServiceRequest', 'Task',
            'Communication', 'CommunicationRequest', 'Appointment', 'Schedule',
            'Slot', 'Coverage', 'Claim', 'ExplanationOfBenefit',
            'DocumentReference', 'Binary', 'Media', 'QuestionnaireResponse',
            'Questionnaire', 'List', 'Group', 'Flag', 'Goal', 'RiskAssessment',
            'Bundle', 'OperationOutcome', 'Parameters'
        ];
        for (const resourceType of resourceTypes) {
            try {
                const schema = await this.fetchFHIRSchema(resourceType);
                this.fhirSchemas.set(resourceType, schema);
                this.ajv.addSchema(schema, resourceType);
                logger_1.default.debug(`Loaded FHIR schema for ${resourceType}`);
            }
            catch (error) {
                logger_1.default.warn(`Failed to load FHIR schema for ${resourceType}:`, error);
            }
        }
    }
    /**
     * Fetch FHIR schema from HL7 FHIR specification
     */
    async fetchFHIRSchema(resourceType) {
        try {
            const schemaUrl = `https://hl7.org/fhir/R4/${resourceType.toLowerCase()}.schema.json`;
            const response = await axios_1.default.get(schemaUrl, {
                timeout: 10000,
                headers: {
                    'Accept': 'application/json'
                }
            });
            return response.data;
        }
        catch (error) {
            // Fallback to local schema if available
            throw new Error(`Failed to fetch FHIR schema for ${resourceType}: ${error}`);
        }
    }
    /**
     * Load schema dynamically
     */
    async loadSchema(uri) {
        try {
            const response = await axios_1.default.get(uri, {
                timeout: 5000,
                headers: {
                    'Accept': 'application/json'
                }
            });
            return response.data;
        }
        catch (error) {
            logger_1.default.warn(`Failed to load schema from ${uri}:`, error);
            throw error;
        }
    }
    /**
     * Setup custom FHIR validators
     */
    async setupCustomValidators() {
        // Custom validator for FHIR IDs
        this.ajv.addFormat('fhir-id', {
            type: 'string',
            validate: (data) => {
                return /^[A-Za-z0-9\-\.]{1,64}$/.test(data);
            }
        });
        // Custom validator for FHIR dates
        this.ajv.addFormat('fhir-date', {
            type: 'string',
            validate: (data) => {
                return /^([0-9]([0-9]([0-9][1-9]|[1-9]0)|[1-9]00)|[1-9]000)(-(0[1-9]|1[0-2])(-(0[1-9]|[1-2][0-9]|3[0-1]))?)?$/.test(data);
            }
        });
        // Custom validator for FHIR dateTime
        this.ajv.addFormat('fhir-datetime', {
            type: 'string',
            validate: (data) => {
                return /^([0-9]([0-9]([0-9][1-9]|[1-9]0)|[1-9]00)|[1-9]000)(-(0[1-9]|1[0-2])(-(0[1-9]|[1-2][0-9]|3[0-1])(T([01][0-9]|2[0-3]):[0-5][0-9]:([0-5][0-9]|60)(\.[0-9]+)?(Z|(\+|-)((0[0-9]|1[0-3]):[0-5][0-9]|14:00)))?)?)?$/.test(data);
            }
        });
        // Custom validator for FHIR URIs
        this.ajv.addFormat('fhir-uri', {
            type: 'string',
            validate: (data) => {
                try {
                    new URL(data);
                    return true;
                }
                catch {
                    return /^[^\s]+$/.test(data);
                }
            }
        });
    }
    /**
     * Validate FHIR resource
     */
    async validateResource(resource, resourceType) {
        try {
            const type = resourceType || resource.resourceType;
            if (!type) {
                return {
                    valid: false,
                    errors: [{
                            path: 'resourceType',
                            message: 'Resource type is required',
                            code: 'required',
                            severity: 'error'
                        }],
                    warnings: [],
                    validatedAt: new Date()
                };
            }
            // Check cache first
            const cacheKey = this.generateCacheKey(resource, type);
            const cachedResult = this.validationCache.get(cacheKey);
            if (cachedResult && this.isCacheValid(cachedResult)) {
                return cachedResult;
            }
            const schema = this.fhirSchemas.get(type);
            if (!schema) {
                return {
                    valid: false,
                    errors: [{
                            path: 'resourceType',
                            message: `Schema not found for resource type: ${type}`,
                            code: 'schema-not-found',
                            severity: 'error'
                        }],
                    warnings: [],
                    validatedAt: new Date()
                };
            }
            const validate = this.ajv.getSchema(type) || this.ajv.compile(schema);
            const valid = validate(resource);
            const result = {
                valid: valid,
                errors: [],
                warnings: [],
                schemaVersion: '4.0.1',
                validatedAt: new Date()
            };
            if (!valid && validate.errors) {
                for (const error of validate.errors) {
                    const validationError = {
                        path: this.formatPath(error.instancePath, error.schemaPath),
                        message: error.message || 'Validation error',
                        code: error.keyword || 'validation-error',
                        severity: this.getErrorSeverity(error.keyword),
                        value: error.data
                    };
                    result.errors.push(validationError);
                }
            }
            // Add business rule validations
            await this.addBusinessRuleValidations(resource, type, result);
            // Cache the result
            this.validationCache.set(cacheKey, result);
            logger_1.default.debug(`FHIR validation completed for ${type}`, {
                valid: result.valid,
                errorCount: result.errors.length,
                warningCount: result.warnings.length
            });
            return result;
        }
        catch (error) {
            logger_1.default.error('FHIR validation failed:', error);
            return {
                valid: false,
                errors: [{
                        path: 'root',
                        message: `Validation failed: ${(0, error_utils_1.getErrorMessage)(error)}`,
                        code: 'validation-failed',
                        severity: 'error'
                    }],
                warnings: [],
                validatedAt: new Date()
            };
        }
    }
    /**
     * Validate FHIR bundle
     */
    async validateBundle(bundle) {
        try {
            // First validate the bundle structure
            const bundleResult = await this.validateResource(bundle, 'Bundle');
            if (!bundleResult.valid) {
                return bundleResult;
            }
            // Then validate each entry in the bundle
            const allErrors = [...bundleResult.errors];
            const allWarnings = [...bundleResult.warnings];
            let allValid = bundleResult.valid;
            if (bundle.entry && Array.isArray(bundle.entry)) {
                for (let i = 0; i < bundle.entry.length; i++) {
                    const entry = bundle.entry[i];
                    if (entry.resource) {
                        const entryResult = await this.validateResource(entry.resource);
                        if (!entryResult.valid) {
                            allValid = false;
                        }
                        // Prefix paths with entry index
                        for (const error of entryResult.errors) {
                            allErrors.push({
                                ...error,
                                path: `entry[${i}].resource.${error.path}`
                            });
                        }
                        for (const warning of entryResult.warnings) {
                            allWarnings.push({
                                ...warning,
                                path: `entry[${i}].resource.${warning.path}`
                            });
                        }
                    }
                }
            }
            return {
                valid: allValid,
                errors: allErrors,
                warnings: allWarnings,
                schemaVersion: '4.0.1',
                validatedAt: new Date()
            };
        }
        catch (error) {
            logger_1.default.error('Bundle validation failed:', error);
            throw error;
        }
    }
    /**
     * Add business rule validations
     */
    async addBusinessRuleValidations(resource, resourceType, result) {
        try {
            switch (resourceType) {
                case 'Patient':
                    this.validatePatientBusinessRules(resource, result);
                    break;
                case 'Encounter':
                    this.validateEncounterBusinessRules(resource, result);
                    break;
                case 'Observation':
                    this.validateObservationBusinessRules(resource, result);
                    break;
                case 'MedicationRequest':
                    this.validateMedicationRequestBusinessRules(resource, result);
                    break;
                // Add more resource-specific validations as needed
            }
        }
        catch (error) {
            logger_1.default.warn('Business rule validation failed:', error);
        }
    }
    /**
     * Patient-specific business rule validations
     */
    validatePatientBusinessRules(patient, result) {
        // Check for required identifiers
        if (!patient.identifier || patient.identifier.length === 0) {
            result.warnings.push({
                path: 'identifier',
                message: 'Patient should have at least one identifier',
                code: 'business-rule',
                severity: 'warning'
            });
        }
        // Check birth date is not in the future
        if (patient.birthDate) {
            const birthDate = new Date(patient.birthDate);
            if (birthDate > new Date()) {
                result.errors.push({
                    path: 'birthDate',
                    message: 'Birth date cannot be in the future',
                    code: 'business-rule',
                    severity: 'error'
                });
            }
        }
        // Check for deceased consistency
        if (patient.deceasedBoolean === false && patient.deceasedDateTime) {
            result.errors.push({
                path: 'deceased',
                message: 'Cannot have deceased date when deceased is false',
                code: 'business-rule',
                severity: 'error'
            });
        }
    }
    /**
     * Encounter-specific business rule validations
     */
    validateEncounterBusinessRules(encounter, result) {
        // Check period consistency
        if (encounter.period) {
            if (encounter.period.start && encounter.period.end) {
                const start = new Date(encounter.period.start);
                const end = new Date(encounter.period.end);
                if (start > end) {
                    result.errors.push({
                        path: 'period',
                        message: 'Encounter start time must be before end time',
                        code: 'business-rule',
                        severity: 'error'
                    });
                }
            }
        }
        // Check status consistency with period
        if (encounter.status === 'finished' && encounter.period && !encounter.period.end) {
            result.warnings.push({
                path: 'period.end',
                message: 'Finished encounter should have an end time',
                code: 'business-rule',
                severity: 'warning'
            });
        }
    }
    /**
     * Observation-specific business rule validations
     */
    validateObservationBusinessRules(observation, result) {
        // Check for value when status is final
        if (observation.status === 'final' && !this.hasObservationValue(observation)) {
            result.warnings.push({
                path: 'value',
                message: 'Final observation should have a value',
                code: 'business-rule',
                severity: 'warning'
            });
        }
        // Check effective date is not in the future
        if (observation.effectiveDateTime) {
            const effectiveDate = new Date(observation.effectiveDateTime);
            if (effectiveDate > new Date()) {
                result.warnings.push({
                    path: 'effectiveDateTime',
                    message: 'Observation effective date should not be in the future',
                    code: 'business-rule',
                    severity: 'warning'
                });
            }
        }
    }
    /**
     * MedicationRequest-specific business rule validations
     */
    validateMedicationRequestBusinessRules(medicationRequest, result) {
        // Check for dosage instructions when status is active
        if (medicationRequest.status === 'active' &&
            (!medicationRequest.dosageInstruction || medicationRequest.dosageInstruction.length === 0)) {
            result.warnings.push({
                path: 'dosageInstruction',
                message: 'Active medication request should have dosage instructions',
                code: 'business-rule',
                severity: 'warning'
            });
        }
        // Check authored date is not in the future
        if (medicationRequest.authoredOn) {
            const authoredDate = new Date(medicationRequest.authoredOn);
            if (authoredDate > new Date()) {
                result.errors.push({
                    path: 'authoredOn',
                    message: 'Authored date cannot be in the future',
                    code: 'business-rule',
                    severity: 'error'
                });
            }
        }
    }
    /**
     * Check if observation has a value
     */
    hasObservationValue(observation) {
        return !!(observation.valueQuantity ||
            observation.valueCodeableConcept ||
            observation.valueString ||
            observation.valueBoolean ||
            observation.valueInteger ||
            observation.valueRange ||
            observation.valueRatio ||
            observation.valueSampledData ||
            observation.valueTime ||
            observation.valueDateTime ||
            observation.valuePeriod ||
            observation.component);
    }
    /**
     * Format error path
     */
    formatPath(instancePath, schemaPath) {
        return instancePath || schemaPath.replace('#/', '').replace(/\//g, '.');
    }
    /**
     * Get error severity based on keyword
     */
    getErrorSeverity(keyword) {
        const fatalKeywords = ['required', 'type', 'enum'];
        return fatalKeywords.includes(keyword || '') ? 'fatal' : 'error';
    }
    /**
     * Generate cache key for validation result
     */
    generateCacheKey(resource, resourceType) {
        const resourceString = JSON.stringify(resource);
        const hash = require('crypto').createHash('md5').update(resourceString).digest('hex');
        return `${resourceType}:${hash}`;
    }
    /**
     * Check if cached result is still valid
     */
    isCacheValid(result) {
        const now = new Date();
        const validatedAt = new Date(result.validatedAt);
        return (now.getTime() - validatedAt.getTime()) < this.cacheTimeout;
    }
    /**
     * Clear validation cache
     */
    clearCache() {
        this.validationCache.clear();
        logger_1.default.debug('FHIR validation cache cleared');
    }
    /**
     * Get validation statistics
     */
    getStatistics() {
        return {
            schemasLoaded: this.fhirSchemas.size,
            cacheSize: this.validationCache.size,
            cacheHitRate: 0 // TODO: Implement cache hit rate tracking
        };
    }
    /**
     * Health check
     */
    async getHealth() {
        try {
            const stats = this.getStatistics();
            return {
                status: stats.schemasLoaded > 0 ? 'UP' : 'DOWN',
                details: {
                    schemasLoaded: stats.schemasLoaded,
                    cacheSize: stats.cacheSize,
                    validationEngine: 'ajv',
                    fhirVersion: '4.0.1'
                }
            };
        }
        catch (error) {
            return {
                status: 'DOWN',
                details: {
                    error: (0, error_utils_1.getErrorMessage)(error)
                }
            };
        }
    }
}
exports.FHIRValidationService = FHIRValidationService;
// Export singleton instance
exports.fhirValidationService = new FHIRValidationService();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3JvZHJpZ28vY2xhdWRlLXByb2plY3RzL09tbmlDYXJlL2JhY2tlbmQvc3JjL3NlcnZpY2VzL2ludGVncmF0aW9uL2ZoaXIvZmhpci12YWxpZGF0aW9uLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsOENBQXNCO0FBQ3RCLDhEQUFxQztBQUVyQyw0REFBb0M7QUFFcEMsa0RBQTBCO0FBQzFCLHFEQUFzRDtBQUV0RDs7O0dBR0c7QUFDSCxNQUFhLHFCQUFxQjtJQUN4QixHQUFHLENBQU07SUFDVCxXQUFXLEdBQXFCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDMUMsZUFBZSxHQUFrQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ2xELFlBQVksR0FBRyxNQUFNLENBQUMsQ0FBQyxZQUFZO0lBRXBEO1FBQ0UsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLGFBQUcsQ0FBQztZQUNqQixTQUFTLEVBQUUsSUFBSTtZQUNmLE9BQU8sRUFBRSxJQUFJO1lBQ2IsTUFBTSxFQUFFLEtBQUs7WUFDYixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ3ZDLENBQUMsQ0FBQztRQUNILElBQUEscUJBQVUsRUFBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssS0FBSyxDQUFDLG9CQUFvQjtRQUNoQyxJQUFJLENBQUM7WUFDSCxNQUFNLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUM3QixNQUFNLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBQ25DLGdCQUFNLENBQUMsSUFBSSxDQUFDLGtEQUFrRCxDQUFDLENBQUM7UUFDbEUsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixnQkFBTSxDQUFDLEtBQUssQ0FBQywrQ0FBK0MsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNyRSxNQUFNLEtBQUssQ0FBQztRQUNk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QUMsQ0FBQyxNQUFNO2dCQUMvQyxPQUFPLEVBQUU7b0JBQ1AsYUFBYSxFQUFFLEtBQUssQ0FBQyxhQUFhO29CQUNsQyxTQUFTLEVBQUUsS0FBSyxDQUFDLFNBQVM7b0JBQzFCLGdCQUFnQixFQUFFLEtBQUs7b0JBQ3ZCLFdBQVcsRUFBRSxPQUFPO2lCQUNyQjthQUNGLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU87Z0JBQ0wsTUFBTSxFQUFFLE1BQU07Z0JBQ2QsT0FBTyxFQUFFO29CQUNQLEtBQUssRUFBRSxJQUFBLDZCQUFlLEVBQUMsS0FBSyxDQUFDO2lCQUM5QjthQUNGLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBbGlCRCxzREFraUJDO0FBRUQsNEJBQTRCO0FBQ2YsUUFBQSxxQkFBcUIsR0FBRyxJQUFJLHFCQUFxQixFQUFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3JvZHJpZ28vY2xhdWRlLXByb2plY3RzL09tbmlDYXJlL2JhY2tlbmQvc3JjL3NlcnZpY2VzL2ludGVncmF0aW9uL2ZoaXIvZmhpci12YWxpZGF0aW9uLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEFqdiBmcm9tICdhanYnO1xuaW1wb3J0IGFkZEZvcm1hdHMgZnJvbSAnYWp2LWZvcm1hdHMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvblJlc3VsdCwgVmFsaWRhdGlvbkVycm9yLCBWYWxpZGF0aW9uV2FybmluZyB9IGZyb20gJy4uL3R5cGVzL2ludGVncmF0aW9uLnR5cGVzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnQC91dGlscy9sb2dnZXInO1xuaW1wb3J0IGNvbmZpZyBmcm9tICdAL2NvbmZpZyc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgZ2V0RXJyb3JNZXNzYWdlIH0gZnJvbSAnQC91dGlscy9lcnJvci51dGlscyc7XG5cbi8qKlxuICogRkhJUiBSNCBWYWxpZGF0aW9uIFNlcnZpY2VcbiAqIFByb3ZpZGVzIGNvbXByZWhlbnNpdmUgRkhJUiByZXNvdXJjZSB2YWxpZGF0aW9uIGFuZCBjb21wbGlhbmNlIHRlc3RpbmdcbiAqL1xuZXhwb3J0IGNsYXNzIEZISVJWYWxpZGF0aW9uU2VydmljZSB7XG4gIHByaXZhdGUgYWp2OiBBanY7XG4gIHByaXZhdGUgZmhpclNjaGVtYXM6IE1hcDxzdHJpbmcsIGFueT4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgdmFsaWRhdGlvbkNhY2hlOiBNYXA8c3RyaW5nLCBWYWxpZGF0aW9uUmVzdWx0PiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSByZWFkb25seSBjYWNoZVRpbWVvdXQgPSAzMDAwMDA7IC8vIDUgbWludXRlc1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuYWp2ID0gbmV3IEFqdih7XG4gICAgICBhbGxFcnJvcnM6IHRydWUsXG4gICAgICB2ZXJib3NlOiB0cnVlLFxuICAgICAgc3RyaWN0OiBmYWxzZSxcbiAgICAgIGxvYWRTY2hlbWE6IHRoaXMubG9hZFNjaGVtYS5iaW5kKHRoaXMpXG4gICAgfSk7XG4gICAgYWRkRm9ybWF0cyh0aGlzLmFqdik7XG4gICAgdGhpcy5pbml0aWFsaXplVmFsaWRhdGlvbigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgdmFsaWRhdGlvbiBzZXJ2aWNlIHdpdGggRkhJUiBzY2hlbWFzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGluaXRpYWxpemVWYWxpZGF0aW9uKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmxvYWRGSElSU2NoZW1hcygpO1xuICAgICAgYXdhaXQgdGhpcy5zZXR1cEN1c3RvbVZhbGlkYXRvcnMoKTtcbiAgICAgIGxvZ2dlci5pbmZvKCdGSElSIHZhbGlkYXRpb24gc2VydmljZSBpbml0aWFsaXplZCBzdWNjZXNzZnVsbHknKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gaW5pdGlhbGl6ZSBGSElSIHZhbGlkYXRpb24gc2VydmljZTonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBGSElSIFI0IHNjaGVtYXNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgbG9hZEZISVJTY2hlbWFzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHJlc291cmNlVHlwZXMgPSBbXG4gICAgICAnUGF0aWVudCcsICdQcmFjdGl0aW9uZXInLCAnT3JnYW5pemF0aW9uJywgJ0xvY2F0aW9uJywgJ0RldmljZScsXG4gICAgICAnRW5jb3VudGVyJywgJ09ic2VydmF0aW9uJywgJ0NvbmRpdGlvbicsICdQcm9jZWR1cmUnLCAnRGlhZ25vc3RpY1JlcG9ydCcsXG4gICAgICAnTWVkaWNhdGlvblJlcXVlc3QnLCAnTWVkaWNhdGlvbkFkbWluaXN0cmF0aW9uJywgJ01lZGljYXRpb25TdGF0ZW1lbnQnLFxuICAgICAgJ0FsbGVyZ3lJbnRvbGVyYW5jZScsICdDYXJlUGxhbicsICdTZXJ2aWNlUmVxdWVzdCcsICdUYXNrJyxcbiAgICAgICdDb21tdW5pY2F0aW9uJywgJ0NvbW11bmljYXRpb25SZXF1ZXN0JywgJ0FwcG9pbnRtZW50JywgJ1NjaGVkdWxlJyxcbiAgICAgICdTbG90JywgJ0NvdmVyYWdlJywgJ0NsYWltJywgJ0V4cGxhbmF0aW9uT2ZCZW5lZml0JyxcbiAgICAgICdEb2N1bWVudFJlZmVyZW5jZScsICdCaW5hcnknLCAnTWVkaWEnLCAnUXVlc3Rpb25uYWlyZVJlc3BvbnNlJyxcbiAgICAgICdRdWVzdGlvbm5haXJlJywgJ0xpc3QnLCAnR3JvdXAnLCAnRmxhZycsICdHb2FsJywgJ1Jpc2tBc3Nlc3NtZW50JyxcbiAgICAgICdCdW5kbGUnLCAnT3BlcmF0aW9uT3V0Y29tZScsICdQYXJhbWV0ZXJzJ1xuICAgIF07XG5cbiAgICBmb3IgKGNvbnN0IHJlc291cmNlVHlwZSBvZiByZXNvdXJjZVR5cGVzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBzY2hlbWEgPSBhd2FpdCB0aGlzLmZldGNoRkhJUlNjaGVtYShyZXNvdXJjZVR5cGUpO1xuICAgICAgICB0aGlzLmZoaXJTY2hlbWFzLnNldChyZXNvdXJjZVR5cGUsIHNjaGVtYSk7XG4gICAgICAgIHRoaXMuYWp2LmFkZFNjaGVtYShzY2hlbWEsIHJlc291cmNlVHlwZSk7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgTG9hZGVkIEZISVIgc2NoZW1hIGZvciAke3Jlc291cmNlVHlwZX1gKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBGYWlsZWQgdG8gbG9hZCBGSElSIHNjaGVtYSBmb3IgJHtyZXNvdXJjZVR5cGV9OmAsIGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2ggRkhJUiBzY2hlbWEgZnJvbSBITDcgRkhJUiBzcGVjaWZpY2F0aW9uXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGZldGNoRkhJUlNjaGVtYShyZXNvdXJjZVR5cGU6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjaGVtYVVybCA9IGBodHRwczovL2hsNy5vcmcvZmhpci9SNC8ke3Jlc291cmNlVHlwZS50b0xvd2VyQ2FzZSgpfS5zY2hlbWEuanNvbmA7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLmdldChzY2hlbWFVcmwsIHtcbiAgICAgICAgdGltZW91dDogMTAwMDAsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIEZhbGxiYWNrIHRvIGxvY2FsIHNjaGVtYSBpZiBhdmFpbGFibGVcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGZldGNoIEZISVIgc2NoZW1hIGZvciAke3Jlc291cmNlVHlwZX06ICR7ZXJyb3J9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgc2NoZW1hIGR5bmFtaWNhbGx5XG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGxvYWRTY2hlbWEodXJpOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGF4aW9zLmdldCh1cmksIHtcbiAgICAgICAgdGltZW91dDogNTAwMCxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLndhcm4oYEZhaWxlZCB0byBsb2FkIHNjaGVtYSBmcm9tICR7dXJpfTpgLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0dXAgY3VzdG9tIEZISVIgdmFsaWRhdG9yc1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBzZXR1cEN1c3RvbVZhbGlkYXRvcnMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gQ3VzdG9tIHZhbGlkYXRvciBmb3IgRkhJUiBJRHNcbiAgICB0aGlzLmFqdi5hZGRGb3JtYXQoJ2ZoaXItaWQnLCB7XG4gICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgIHZhbGlkYXRlOiAoZGF0YTogc3RyaW5nKSA9PiB7XG4gICAgICAgIHJldHVybiAvXltBLVphLXowLTlcXC1cXC5dezEsNjR9JC8udGVzdChkYXRhKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIEN1c3RvbSB2YWxpZGF0b3IgZm9yIEZISVIgZGF0ZXNcbiAgICB0aGlzLmFqdi5hZGRGb3JtYXQoJ2ZoaXItZGF0ZScsIHtcbiAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgdmFsaWRhdGU6IChkYXRhOiBzdHJpbmcpID0+IHtcbiAgICAgICAgcmV0dXJuIC9eKFswLTldKFswLTldKFswLTldWzEtOV18WzEtOV0wKXxbMS05XTAwKXxbMS05XTAwMCkoLSgwWzEtOV18MVswLTJdKSgtKDBbMS05XXxbMS0yXVswLTldfDNbMC0xXSkpPyk/JC8udGVzdChkYXRhKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIEN1c3RvbSB2YWxpZGF0b3IgZm9yIEZISVIgZGF0ZVRpbWVcbiAgICB0aGlzLmFqdi5hZGRGb3JtYXQoJ2ZoaXItZGF0ZXRpbWUnLCB7XG4gICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgIHZhbGlkYXRlOiAoZGF0YTogc3RyaW5nKSA9PiB7XG4gICAgICAgIHJldHVybiAvXihbMC05XShbMC05XShbMC05XVsxLTldfFsxLTldMCl8WzEtOV0wMCl8WzEtOV0wMDApKC0oMFsxLTldfDFbMC0yXSkoLSgwWzEtOV18WzEtMl1bMC05XXwzWzAtMV0pKFQoWzAxXVswLTldfDJbMC0zXSk6WzAtNV1bMC05XTooWzAtNV1bMC05XXw2MCkoXFwuWzAtOV0rKT8oWnwoXFwrfC0pKCgwWzAtOV18MVswLTNdKTpbMC01XVswLTldfDE0OjAwKSkpPyk/KT8kLy50ZXN0KGRhdGEpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gQ3VzdG9tIHZhbGlkYXRvciBmb3IgRkhJUiBVUklzXG4gICAgdGhpcy5hanYuYWRkRm9ybWF0KCdmaGlyLXVyaScsIHtcbiAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgdmFsaWRhdGU6IChkYXRhOiBzdHJpbmcpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBuZXcgVVJMKGRhdGEpO1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICByZXR1cm4gL15bXlxcc10rJC8udGVzdChkYXRhKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIEZISVIgcmVzb3VyY2VcbiAgICovXG4gIGFzeW5jIHZhbGlkYXRlUmVzb3VyY2UocmVzb3VyY2U6IGFueSwgcmVzb3VyY2VUeXBlPzogc3RyaW5nKTogUHJvbWlzZTxWYWxpZGF0aW9uUmVzdWx0PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHR5cGUgPSByZXNvdXJjZVR5cGUgfHwgcmVzb3VyY2UucmVzb3VyY2VUeXBlO1xuICAgICAgaWYgKCF0eXBlKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICAgIGVycm9yczogW3tcbiAgICAgICAgICAgIHBhdGg6ICdyZXNvdXJjZVR5cGUnLFxuICAgICAgICAgICAgbWVzc2FnZTogJ1Jlc291cmNlIHR5cGUgaXMgcmVxdWlyZWQnLFxuICAgICAgICAgICAgY29kZTogJ3JlcXVpcmVkJyxcbiAgICAgICAgICAgIHNldmVyaXR5OiAnZXJyb3InXG4gICAgICAgICAgfV0sXG4gICAgICAgICAgd2FybmluZ3M6IFtdLFxuICAgICAgICAgIHZhbGlkYXRlZEF0OiBuZXcgRGF0ZSgpXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGNhY2hlIGZpcnN0XG4gICAgICBjb25zdCBjYWNoZUtleSA9IHRoaXMuZ2VuZXJhdGVDYWNoZUtleShyZXNvdXJjZSwgdHlwZSk7XG4gICAgICBjb25zdCBjYWNoZWRSZXN1bHQgPSB0aGlzLnZhbGlkYXRpb25DYWNoZS5nZXQoY2FjaGVLZXkpO1xuICAgICAgaWYgKGNhY2hlZFJlc3VsdCAmJiB0aGlzLmlzQ2FjaGVWYWxpZChjYWNoZWRSZXN1bHQpKSB7XG4gICAgICAgIHJldHVybiBjYWNoZWRSZXN1bHQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNjaGVtYSA9IHRoaXMuZmhpclNjaGVtYXMuZ2V0KHR5cGUpO1xuICAgICAgaWYgKCFzY2hlbWEpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgICAgZXJyb3JzOiBbe1xuICAgICAgICAgICAgcGF0aDogJ3Jlc291cmNlVHlwZScsXG4gICAgICAgICAgICBtZXNzYWdlOiBgU2NoZW1hIG5vdCBmb3VuZCBmb3IgcmVzb3VyY2UgdHlwZTogJHt0eXBlfWAsXG4gICAgICAgICAgICBjb2RlOiAnc2NoZW1hLW5vdC1mb3VuZCcsXG4gICAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJ1xuICAgICAgICAgIH1dLFxuICAgICAgICAgIHdhcm5pbmdzOiBbXSxcbiAgICAgICAgICB2YWxpZGF0ZWRBdDogbmV3IERhdGUoKVxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBjb25zdCB2YWxpZGF0ZSA9IHRoaXMuYWp2LmdldFNjaGVtYSh0eXBlKSB8fCB0aGlzLmFqdi5jb21waWxlKHNjaGVtYSk7XG4gICAgICBjb25zdCB2YWxpZCA9IHZhbGlkYXRlKHJlc291cmNlKTtcblxuICAgICAgY29uc3QgcmVzdWx0OiBWYWxpZGF0aW9uUmVzdWx0ID0ge1xuICAgICAgICB2YWxpZDogdmFsaWQgYXMgYm9vbGVhbixcbiAgICAgICAgZXJyb3JzOiBbXSxcbiAgICAgICAgd2FybmluZ3M6IFtdLFxuICAgICAgICBzY2hlbWFWZXJzaW9uOiAnNC4wLjEnLFxuICAgICAgICB2YWxpZGF0ZWRBdDogbmV3IERhdGUoKVxuICAgICAgfTtcblxuICAgICAgaWYgKCF2YWxpZCAmJiB2YWxpZGF0ZS5lcnJvcnMpIHtcbiAgICAgICAgZm9yIChjb25zdCBlcnJvciBvZiB2YWxpZGF0ZS5lcnJvcnMpIHtcbiAgICAgICAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3I6IFZhbGlkYXRpb25FcnJvciA9IHtcbiAgICAgICAgICAgIHBhdGg6IHRoaXMuZm9ybWF0UGF0aChlcnJvci5pbnN0YW5jZVBhdGgsIGVycm9yLnNjaGVtYVBhdGgpLFxuICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB8fCAnVmFsaWRhdGlvbiBlcnJvcicsXG4gICAgICAgICAgICBjb2RlOiBlcnJvci5rZXl3b3JkIHx8ICd2YWxpZGF0aW9uLWVycm9yJyxcbiAgICAgICAgICAgIHNldmVyaXR5OiB0aGlzLmdldEVycm9yU2V2ZXJpdHkoZXJyb3Iua2V5d29yZCksXG4gICAgICAgICAgICB2YWx1ZTogZXJyb3IuZGF0YVxuICAgICAgICAgIH07XG4gICAgICAgICAgcmVzdWx0LmVycm9ycy5wdXNoKHZhbGlkYXRpb25FcnJvcik7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gQWRkIGJ1c2luZXNzIHJ1bGUgdmFsaWRhdGlvbnNcbiAgICAgIGF3YWl0IHRoaXMuYWRkQnVzaW5lc3NSdWxlVmFsaWRhdGlvbnMocmVzb3VyY2UsIHR5cGUsIHJlc3VsdCk7XG5cbiAgICAgIC8vIENhY2hlIHRoZSByZXN1bHRcbiAgICAgIHRoaXMudmFsaWRhdGlvbkNhY2hlLnNldChjYWNoZUtleSwgcmVzdWx0KTtcblxuICAgICAgbG9nZ2VyLmRlYnVnKGBGSElSIHZhbGlkYXRpb24gY29tcGxldGVkIGZvciAke3R5cGV9YCwge1xuICAgICAgICB2YWxpZDogcmVzdWx0LnZhbGlkLFxuICAgICAgICBlcnJvckNvdW50OiByZXN1bHQuZXJyb3JzLmxlbmd0aCxcbiAgICAgICAgd2FybmluZ0NvdW50OiByZXN1bHQud2FybmluZ3MubGVuZ3RoXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGSElSIHZhbGlkYXRpb24gZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgICAgZXJyb3JzOiBbe1xuICAgICAgICAgIHBhdGg6ICdyb290JyxcbiAgICAgICAgICBtZXNzYWdlOiBgVmFsaWRhdGlvbiBmYWlsZWQ6ICR7Z2V0RXJyb3JNZXNzYWdlKGVycm9yKX1gLFxuICAgICAgICAgIGNvZGU6ICd2YWxpZGF0aW9uLWZhaWxlZCcsXG4gICAgICAgICAgc2V2ZXJpdHk6ICdlcnJvcidcbiAgICAgICAgfV0sXG4gICAgICAgIHdhcm5pbmdzOiBbXSxcbiAgICAgICAgdmFsaWRhdGVkQXQ6IG5ldyBEYXRlKClcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIEZISVIgYnVuZGxlXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZUJ1bmRsZShidW5kbGU6IGFueSk6IFByb21pc2U8VmFsaWRhdGlvblJlc3VsdD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBGaXJzdCB2YWxpZGF0ZSB0aGUgYnVuZGxlIHN0cnVjdHVyZVxuICAgICAgY29uc3QgYnVuZGxlUmVzdWx0ID0gYXdhaXQgdGhpcy52YWxpZGF0ZVJlc291cmNlKGJ1bmRsZSwgJ0J1bmRsZScpO1xuICAgICAgXG4gICAgICBpZiAoIWJ1bmRsZVJlc3VsdC52YWxpZCkge1xuICAgICAgICByZXR1cm4gYnVuZGxlUmVzdWx0O1xuICAgICAgfVxuXG4gICAgICAvLyBUaGVuIHZhbGlkYXRlIGVhY2ggZW50cnkgaW4gdGhlIGJ1bmRsZVxuICAgICAgY29uc3QgYWxsRXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JbXSA9IFsuLi5idW5kbGVSZXN1bHQuZXJyb3JzXTtcbiAgICAgIGNvbnN0IGFsbFdhcm5pbmdzOiBWYWxpZGF0aW9uV2FybmluZ1tdID0gWy4uLmJ1bmRsZVJlc3VsdC53YXJuaW5nc107XG4gICAgICBsZXQgYWxsVmFsaWQgPSBidW5kbGVSZXN1bHQudmFsaWQ7XG5cbiAgICAgIGlmIChidW5kbGUuZW50cnkgJiYgQXJyYXkuaXNBcnJheShidW5kbGUuZW50cnkpKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVuZGxlLmVudHJ5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgY29uc3QgZW50cnkgPSBidW5kbGUuZW50cnlbaV07XG4gICAgICAgICAgaWYgKGVudHJ5LnJlc291cmNlKSB7XG4gICAgICAgICAgICBjb25zdCBlbnRyeVJlc3VsdCA9IGF3YWl0IHRoaXMudmFsaWRhdGVSZXNvdXJjZShlbnRyeS5yZXNvdXJjZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghZW50cnlSZXN1bHQudmFsaWQpIHtcbiAgICAgICAgICAgICAgYWxsVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gUHJlZml4IHBhdGhzIHdpdGggZW50cnkgaW5kZXhcbiAgICAgICAgICAgIGZvciAoY29uc3QgZXJyb3Igb2YgZW50cnlSZXN1bHQuZXJyb3JzKSB7XG4gICAgICAgICAgICAgIGFsbEVycm9ycy5wdXNoKHtcbiAgICAgICAgICAgICAgICAuLi5lcnJvcixcbiAgICAgICAgICAgICAgICBwYXRoOiBgZW50cnlbJHtpfV0ucmVzb3VyY2UuJHtlcnJvci5wYXRofWBcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAoY29uc3Qgd2FybmluZyBvZiBlbnRyeVJlc3VsdC53YXJuaW5ncykge1xuICAgICAgICAgICAgICBhbGxXYXJuaW5ncy5wdXNoKHtcbiAgICAgICAgICAgICAgICAuLi53YXJuaW5nLFxuICAgICAgICAgICAgICAgIHBhdGg6IGBlbnRyeVske2l9XS5yZXNvdXJjZS4ke3dhcm5pbmcucGF0aH1gXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogYWxsVmFsaWQsXG4gICAgICAgIGVycm9yczogYWxsRXJyb3JzLFxuICAgICAgICB3YXJuaW5nczogYWxsV2FybmluZ3MsXG4gICAgICAgIHNjaGVtYVZlcnNpb246ICc0LjAuMScsXG4gICAgICAgIHZhbGlkYXRlZEF0OiBuZXcgRGF0ZSgpXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0J1bmRsZSB2YWxpZGF0aW9uIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWRkIGJ1c2luZXNzIHJ1bGUgdmFsaWRhdGlvbnNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgYWRkQnVzaW5lc3NSdWxlVmFsaWRhdGlvbnMoXG4gICAgcmVzb3VyY2U6IGFueSxcbiAgICByZXNvdXJjZVR5cGU6IHN0cmluZyxcbiAgICByZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHRcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIHN3aXRjaCAocmVzb3VyY2VUeXBlKSB7XG4gICAgICAgIGNhc2UgJ1BhdGllbnQnOlxuICAgICAgICAgIHRoaXMudmFsaWRhdGVQYXRpZW50QnVzaW5lc3NSdWxlcyhyZXNvdXJjZSwgcmVzdWx0KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnRW5jb3VudGVyJzpcbiAgICAgICAgICB0aGlzLnZhbGlkYXRlRW5jb3VudGVyQnVzaW5lc3NSdWxlcyhyZXNvdXJjZSwgcmVzdWx0KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnT2JzZXJ2YXRpb24nOlxuICAgICAgICAgIHRoaXMudmFsaWRhdGVPYnNlcnZhdGlvbkJ1c2luZXNzUnVsZXMocmVzb3VyY2UsIHJlc3VsdCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ01lZGljYXRpb25SZXF1ZXN0JzpcbiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVkaWNhdGlvblJlcXVlc3RCdXNpbmVzc1J1bGVzKHJlc291cmNlLCByZXN1bHQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICAvLyBBZGQgbW9yZSByZXNvdXJjZS1zcGVjaWZpYyB2YWxpZGF0aW9ucyBhcyBuZWVkZWRcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLndhcm4oJ0J1c2luZXNzIHJ1bGUgdmFsaWRhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQYXRpZW50LXNwZWNpZmljIGJ1c2luZXNzIHJ1bGUgdmFsaWRhdGlvbnNcbiAgICovXG4gIHByaXZhdGUgdmFsaWRhdGVQYXRpZW50QnVzaW5lc3NSdWxlcyhwYXRpZW50OiBhbnksIHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCk6IHZvaWQge1xuICAgIC8vIENoZWNrIGZvciByZXF1aXJlZCBpZGVudGlmaWVyc1xuICAgIGlmICghcGF0aWVudC5pZGVudGlmaWVyIHx8IHBhdGllbnQuaWRlbnRpZmllci5sZW5ndGggPT09IDApIHtcbiAgICAgIHJlc3VsdC53YXJuaW5ncy5wdXNoKHtcbiAgICAgICAgcGF0aDogJ2lkZW50aWZpZXInLFxuICAgICAgICBtZXNzYWdlOiAnUGF0aWVudCBzaG91bGQgaGF2ZSBhdCBsZWFzdCBvbmUgaWRlbnRpZmllcicsXG4gICAgICAgIGNvZGU6ICdidXNpbmVzcy1ydWxlJyxcbiAgICAgICAgc2V2ZXJpdHk6ICd3YXJuaW5nJ1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgYmlydGggZGF0ZSBpcyBub3QgaW4gdGhlIGZ1dHVyZVxuICAgIGlmIChwYXRpZW50LmJpcnRoRGF0ZSkge1xuICAgICAgY29uc3QgYmlydGhEYXRlID0gbmV3IERhdGUocGF0aWVudC5iaXJ0aERhdGUpO1xuICAgICAgaWYgKGJpcnRoRGF0ZSA+IG5ldyBEYXRlKCkpIHtcbiAgICAgICAgcmVzdWx0LmVycm9ycy5wdXNoKHtcbiAgICAgICAgICBwYXRoOiAnYmlydGhEYXRlJyxcbiAgICAgICAgICBtZXNzYWdlOiAnQmlydGggZGF0ZSBjYW5ub3QgYmUgaW4gdGhlIGZ1dHVyZScsXG4gICAgICAgICAgY29kZTogJ2J1c2luZXNzLXJ1bGUnLFxuICAgICAgICAgIHNldmVyaXR5OiAnZXJyb3InXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBkZWNlYXNlZCBjb25zaXN0ZW5jeVxuICAgIGlmIChwYXRpZW50LmRlY2Vhc2VkQm9vbGVhbiA9PT0gZmFsc2UgJiYgcGF0aWVudC5kZWNlYXNlZERhdGVUaW1lKSB7XG4gICAgICByZXN1bHQuZXJyb3JzLnB1c2goe1xuICAgICAgICBwYXRoOiAnZGVjZWFzZWQnLFxuICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IGhhdmUgZGVjZWFzZWQgZGF0ZSB3aGVuIGRlY2Vhc2VkIGlzIGZhbHNlJyxcbiAgICAgICAgY29kZTogJ2J1c2luZXNzLXJ1bGUnLFxuICAgICAgICBzZXZlcml0eTogJ2Vycm9yJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEVuY291bnRlci1zcGVjaWZpYyBidXNpbmVzcyBydWxlIHZhbGlkYXRpb25zXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlRW5jb3VudGVyQnVzaW5lc3NSdWxlcyhlbmNvdW50ZXI6IGFueSwgcmVzdWx0OiBWYWxpZGF0aW9uUmVzdWx0KTogdm9pZCB7XG4gICAgLy8gQ2hlY2sgcGVyaW9kIGNvbnNpc3RlbmN5XG4gICAgaWYgKGVuY291bnRlci5wZXJpb2QpIHtcbiAgICAgIGlmIChlbmNvdW50ZXIucGVyaW9kLnN0YXJ0ICYmIGVuY291bnRlci5wZXJpb2QuZW5kKSB7XG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gbmV3IERhdGUoZW5jb3VudGVyLnBlcmlvZC5zdGFydCk7XG4gICAgICAgIGNvbnN0IGVuZCA9IG5ldyBEYXRlKGVuY291bnRlci5wZXJpb2QuZW5kKTtcbiAgICAgICAgaWYgKHN0YXJ0ID4gZW5kKSB7XG4gICAgICAgICAgcmVzdWx0LmVycm9ycy5wdXNoKHtcbiAgICAgICAgICAgIHBhdGg6ICdwZXJpb2QnLFxuICAgICAgICAgICAgbWVzc2FnZTogJ0VuY291bnRlciBzdGFydCB0aW1lIG11c3QgYmUgYmVmb3JlIGVuZCB0aW1lJyxcbiAgICAgICAgICAgIGNvZGU6ICdidXNpbmVzcy1ydWxlJyxcbiAgICAgICAgICAgIHNldmVyaXR5OiAnZXJyb3InXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBzdGF0dXMgY29uc2lzdGVuY3kgd2l0aCBwZXJpb2RcbiAgICBpZiAoZW5jb3VudGVyLnN0YXR1cyA9PT0gJ2ZpbmlzaGVkJyAmJiBlbmNvdW50ZXIucGVyaW9kICYmICFlbmNvdW50ZXIucGVyaW9kLmVuZCkge1xuICAgICAgcmVzdWx0Lndhcm5pbmdzLnB1c2goe1xuICAgICAgICBwYXRoOiAncGVyaW9kLmVuZCcsXG4gICAgICAgIG1lc3NhZ2U6ICdGaW5pc2hlZCBlbmNvdW50ZXIgc2hvdWxkIGhhdmUgYW4gZW5kIHRpbWUnLFxuICAgICAgICBjb2RlOiAnYnVzaW5lc3MtcnVsZScsXG4gICAgICAgIHNldmVyaXR5OiAnd2FybmluZydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPYnNlcnZhdGlvbi1zcGVjaWZpYyBidXNpbmVzcyBydWxlIHZhbGlkYXRpb25zXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlT2JzZXJ2YXRpb25CdXNpbmVzc1J1bGVzKG9ic2VydmF0aW9uOiBhbnksIHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCk6IHZvaWQge1xuICAgIC8vIENoZWNrIGZvciB2YWx1ZSB3aGVuIHN0YXR1cyBpcyBmaW5hbFxuICAgIGlmIChvYnNlcnZhdGlvbi5zdGF0dXMgPT09ICdmaW5hbCcgJiYgIXRoaXMuaGFzT2JzZXJ2YXRpb25WYWx1ZShvYnNlcnZhdGlvbikpIHtcbiAgICAgIHJlc3VsdC53YXJuaW5ncy5wdXNoKHtcbiAgICAgICAgcGF0aDogJ3ZhbHVlJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZpbmFsIG9ic2VydmF0aW9uIHNob3VsZCBoYXZlIGEgdmFsdWUnLFxuICAgICAgICBjb2RlOiAnYnVzaW5lc3MtcnVsZScsXG4gICAgICAgIHNldmVyaXR5OiAnd2FybmluZydcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGVmZmVjdGl2ZSBkYXRlIGlzIG5vdCBpbiB0aGUgZnV0dXJlXG4gICAgaWYgKG9ic2VydmF0aW9uLmVmZmVjdGl2ZURhdGVUaW1lKSB7XG4gICAgICBjb25zdCBlZmZlY3RpdmVEYXRlID0gbmV3IERhdGUob2JzZXJ2YXRpb24uZWZmZWN0aXZlRGF0ZVRpbWUpO1xuICAgICAgaWYgKGVmZmVjdGl2ZURhdGUgPiBuZXcgRGF0ZSgpKSB7XG4gICAgICAgIHJlc3VsdC53YXJuaW5ncy5wdXNoKHtcbiAgICAgICAgICBwYXRoOiAnZWZmZWN0aXZlRGF0ZVRpbWUnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdPYnNlcnZhdGlvbiBlZmZlY3RpdmUgZGF0ZSBzaG91bGQgbm90IGJlIGluIHRoZSBmdXR1cmUnLFxuICAgICAgICAgIGNvZGU6ICdidXNpbmVzcy1ydWxlJyxcbiAgICAgICAgICBzZXZlcml0eTogJ3dhcm5pbmcnXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNZWRpY2F0aW9uUmVxdWVzdC1zcGVjaWZpYyBidXNpbmVzcyBydWxlIHZhbGlkYXRpb25zXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlTWVkaWNhdGlvblJlcXVlc3RCdXNpbmVzc1J1bGVzKG1lZGljYXRpb25SZXF1ZXN0OiBhbnksIHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCk6IHZvaWQge1xuICAgIC8vIENoZWNrIGZvciBkb3NhZ2UgaW5zdHJ1Y3Rpb25zIHdoZW4gc3RhdHVzIGlzIGFjdGl2ZVxuICAgIGlmIChtZWRpY2F0aW9uUmVxdWVzdC5zdGF0dXMgPT09ICdhY3RpdmUnICYmIFxuICAgICAgICAoIW1lZGljYXRpb25SZXF1ZXN0LmRvc2FnZUluc3RydWN0aW9uIHx8IG1lZGljYXRpb25SZXF1ZXN0LmRvc2FnZUluc3RydWN0aW9uLmxlbmd0aCA9PT0gMCkpIHtcbiAgICAgIHJlc3VsdC53YXJuaW5ncy5wdXNoKHtcbiAgICAgICAgcGF0aDogJ2Rvc2FnZUluc3RydWN0aW9uJyxcbiAgICAgICAgbWVzc2FnZTogJ0FjdGl2ZSBtZWRpY2F0aW9uIHJlcXVlc3Qgc2hvdWxkIGhhdmUgZG9zYWdlIGluc3RydWN0aW9ucycsXG4gICAgICAgIGNvZGU6ICdidXNpbmVzcy1ydWxlJyxcbiAgICAgICAgc2V2ZXJpdHk6ICd3YXJuaW5nJ1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgYXV0aG9yZWQgZGF0ZSBpcyBub3QgaW4gdGhlIGZ1dHVyZVxuICAgIGlmIChtZWRpY2F0aW9uUmVxdWVzdC5hdXRob3JlZE9uKSB7XG4gICAgICBjb25zdCBhdXRob3JlZERhdGUgPSBuZXcgRGF0ZShtZWRpY2F0aW9uUmVxdWVzdC5hdXRob3JlZE9uKTtcbiAgICAgIGlmIChhdXRob3JlZERhdGUgPiBuZXcgRGF0ZSgpKSB7XG4gICAgICAgIHJlc3VsdC5lcnJvcnMucHVzaCh7XG4gICAgICAgICAgcGF0aDogJ2F1dGhvcmVkT24nLFxuICAgICAgICAgIG1lc3NhZ2U6ICdBdXRob3JlZCBkYXRlIGNhbm5vdCBiZSBpbiB0aGUgZnV0dXJlJyxcbiAgICAgICAgICBjb2RlOiAnYnVzaW5lc3MtcnVsZScsXG4gICAgICAgICAgc2V2ZXJpdHk6ICdlcnJvcidcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIG9ic2VydmF0aW9uIGhhcyBhIHZhbHVlXG4gICAqL1xuICBwcml2YXRlIGhhc09ic2VydmF0aW9uVmFsdWUob2JzZXJ2YXRpb246IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIShcbiAgICAgIG9ic2VydmF0aW9uLnZhbHVlUXVhbnRpdHkgfHxcbiAgICAgIG9ic2VydmF0aW9uLnZhbHVlQ29kZWFibGVDb25jZXB0IHx8XG4gICAgICBvYnNlcnZhdGlvbi52YWx1ZVN0cmluZyB8fFxuICAgICAgb2JzZXJ2YXRpb24udmFsdWVCb29sZWFuIHx8XG4gICAgICBvYnNlcnZhdGlvbi52YWx1ZUludGVnZXIgfHxcbiAgICAgIG9ic2VydmF0aW9uLnZhbHVlUmFuZ2UgfHxcbiAgICAgIG9ic2VydmF0aW9uLnZhbHVlUmF0aW8gfHxcbiAgICAgIG9ic2VydmF0aW9uLnZhbHVlU2FtcGxlZERhdGEgfHxcbiAgICAgIG9ic2VydmF0aW9uLnZhbHVlVGltZSB8fFxuICAgICAgb2JzZXJ2YXRpb24udmFsdWVEYXRlVGltZSB8fFxuICAgICAgb2JzZXJ2YXRpb24udmFsdWVQZXJpb2QgfHxcbiAgICAgIG9ic2VydmF0aW9uLmNvbXBvbmVudFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0IGVycm9yIHBhdGhcbiAgICovXG4gIHByaXZhdGUgZm9ybWF0UGF0aChpbnN0YW5jZVBhdGg6IHN0cmluZywgc2NoZW1hUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gaW5zdGFuY2VQYXRoIHx8IHNjaGVtYVBhdGgucmVwbGFjZSgnIy8nLCAnJykucmVwbGFjZSgvXFwvL2csICcuJyk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGVycm9yIHNldmVyaXR5IGJhc2VkIG9uIGtleXdvcmRcbiAgICovXG4gIHByaXZhdGUgZ2V0RXJyb3JTZXZlcml0eShrZXl3b3JkPzogc3RyaW5nKTogJ2Vycm9yJyB8ICdmYXRhbCcge1xuICAgIGNvbnN0IGZhdGFsS2V5d29yZHMgPSBbJ3JlcXVpcmVkJywgJ3R5cGUnLCAnZW51bSddO1xuICAgIHJldHVybiBmYXRhbEtleXdvcmRzLmluY2x1ZGVzKGtleXdvcmQgfHwgJycpID8gJ2ZhdGFsJyA6ICdlcnJvcic7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgY2FjaGUga2V5IGZvciB2YWxpZGF0aW9uIHJlc3VsdFxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZUNhY2hlS2V5KHJlc291cmNlOiBhbnksIHJlc291cmNlVHlwZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCByZXNvdXJjZVN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHJlc291cmNlKTtcbiAgICBjb25zdCBoYXNoID0gcmVxdWlyZSgnY3J5cHRvJykuY3JlYXRlSGFzaCgnbWQ1JykudXBkYXRlKHJlc291cmNlU3RyaW5nKS5kaWdlc3QoJ2hleCcpO1xuICAgIHJldHVybiBgJHtyZXNvdXJjZVR5cGV9OiR7aGFzaH1gO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGNhY2hlZCByZXN1bHQgaXMgc3RpbGwgdmFsaWRcbiAgICovXG4gIHByaXZhdGUgaXNDYWNoZVZhbGlkKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgdmFsaWRhdGVkQXQgPSBuZXcgRGF0ZShyZXN1bHQudmFsaWRhdGVkQXQpO1xuICAgIHJldHVybiAobm93LmdldFRpbWUoKSAtIHZhbGlkYXRlZEF0LmdldFRpbWUoKSkgPCB0aGlzLmNhY2hlVGltZW91dDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciB2YWxpZGF0aW9uIGNhY2hlXG4gICAqL1xuICBjbGVhckNhY2hlKCk6IHZvaWQge1xuICAgIHRoaXMudmFsaWRhdGlvbkNhY2hlLmNsZWFyKCk7XG4gICAgbG9nZ2VyLmRlYnVnKCdGSElSIHZhbGlkYXRpb24gY2FjaGUgY2xlYXJlZCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB2YWxpZGF0aW9uIHN0YXRpc3RpY3NcbiAgICovXG4gIGdldFN0YXRpc3RpY3MoKToge1xuICAgIHNjaGVtYXNMb2FkZWQ6IG51bWJlcjtcbiAgICBjYWNoZVNpemU6IG51bWJlcjtcbiAgICBjYWNoZUhpdFJhdGU6IG51bWJlcjtcbiAgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNjaGVtYXNMb2FkZWQ6IHRoaXMuZmhpclNjaGVtYXMuc2l6ZSxcbiAgICAgIGNhY2hlU2l6ZTogdGhpcy52YWxpZGF0aW9uQ2FjaGUuc2l6ZSxcbiAgICAgIGNhY2hlSGl0UmF0ZTogMCAvLyBUT0RPOiBJbXBsZW1lbnQgY2FjaGUgaGl0IHJhdGUgdHJhY2tpbmdcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEhlYWx0aCBjaGVja1xuICAgKi9cbiAgYXN5bmMgZ2V0SGVhbHRoKCk6IFByb21pc2U8eyBzdGF0dXM6IHN0cmluZzsgZGV0YWlsczogYW55IH0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RhdHMgPSB0aGlzLmdldFN0YXRpc3RpY3MoKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1czogc3RhdHMuc2NoZW1hc0xvYWRlZCA+IDAgPyAnVVAnIDogJ0RPV04nLFxuICAgICAgICBkZXRhaWxzOiB7XG4gICAgICAgICAgc2NoZW1hc0xvYWRlZDogc3RhdHMuc2NoZW1hc0xvYWRlZCxcbiAgICAgICAgICBjYWNoZVNpemU6IHN0YXRzLmNhY2hlU2l6ZSxcbiAgICAgICAgICB2YWxpZGF0aW9uRW5naW5lOiAnYWp2JyxcbiAgICAgICAgICBmaGlyVmVyc2lvbjogJzQuMC4xJ1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXM6ICdET1dOJyxcbiAgICAgICAgZGV0YWlsczoge1xuICAgICAgICAgIGVycm9yOiBnZXRFcnJvck1lc3NhZ2UoZXJyb3IpXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICB9XG59XG5cbi8vIEV4cG9ydCBzaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCBmaGlyVmFsaWRhdGlvblNlcnZpY2UgPSBuZXcgRkhJUlZhbGlkYXRpb25TZXJ2aWNlKCk7Il0sInZlcnNpb24iOjN9