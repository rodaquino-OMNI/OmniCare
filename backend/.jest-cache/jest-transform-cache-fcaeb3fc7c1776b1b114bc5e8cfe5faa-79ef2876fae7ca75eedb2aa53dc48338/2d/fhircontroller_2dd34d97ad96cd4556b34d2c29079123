529c8e0a3bcccae0ecf2b15c431fc6ad
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.fhirController = exports.FHIRController = void 0;
const cds_hooks_service_1 = require("@/services/cds-hooks.service");
const fhir_resources_service_1 = require("@/services/fhir-resources.service");
const medplum_service_1 = require("@/services/medplum.service");
const subscriptions_service_1 = require("@/services/subscriptions.service");
const logger_1 = __importDefault(require("@/utils/logger"));
const error_utils_1 = require("@/utils/error.utils");
/**
 * FHIR API Controller
 * Handles all FHIR REST API endpoints according to FHIR R4 specification
 */
class FHIRController {
    // ===============================
    // FHIR METADATA AND CAPABILITY
    // ===============================
    /**
     * GET /fhir/R4/metadata - FHIR Capability Statement
     */
    async getCapabilityStatement(req, res) {
        try {
            logger_1.default.fhir('Capability statement requested', {
                userAgent: req.get('User-Agent'),
                ip: req.ip,
            });
            const capabilityStatement = await medplum_service_1.medplumService.getCapabilityStatement();
            res.json(capabilityStatement);
        }
        catch (error) {
            logger_1.default.error('Failed to get capability statement:', error);
            res.status(500).json({
                resourceType: 'OperationOutcome',
                issue: [{
                        severity: 'error',
                        code: 'exception',
                        diagnostics: 'Failed to retrieve capability statement',
                    }],
            });
        }
    }
    // ===============================
    // RESOURCE CRUD OPERATIONS
    // ===============================
    /**
     * POST /fhir/R4/{resourceType} - Create resource
     */
    async createResource(req, res) {
        try {
            const { resourceType } = req.params;
            const resource = req.body;
            logger_1.default.fhir('Creating resource', {
                resourceType,
                userId: req.user?.id,
                hasId: !!resource.id,
            });
            // Validate resource type
            if (resource.resourceType !== resourceType) {
                res.status(400).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'invalid',
                            diagnostics: `Resource type mismatch: expected ${resourceType}, got ${resource.resourceType}`,
                        }],
                });
                return;
            }
            // Remove id if present (server assigns IDs)
            if (resource.id) {
                delete resource.id;
            }
            const createdResource = await medplum_service_1.medplumService.createResource(resource);
            // Notify subscriptions
            await subscriptions_service_1.subscriptionsService.processResourceChange(resourceType ?? '', createdResource.id ?? '', 'create', createdResource);
            res.status(201)
                .location(`/fhir/R4/${resourceType}/${createdResource.id}`)
                .json(createdResource);
        }
        catch (error) {
            logger_1.default.error('Failed to create resource:', error);
            res.status(500).json({
                resourceType: 'OperationOutcome',
                issue: [{
                        severity: 'error',
                        code: 'exception',
                        diagnostics: 'Failed to create resource',
                    }],
            });
        }
    }
    /**
     * GET /fhir/R4/{resourceType}/{id} - Read resource
     */
    async readResource(req, res) {
        try {
            const { resourceType, id } = req.params;
            logger_1.default.fhir('Reading resource', {
                resourceType,
                id,
                userId: req.user?.id,
            });
            const resource = await medplum_service_1.medplumService.readResource(resourceType ?? '', id ?? '');
            res.json(resource);
        }
        catch (error) {
            logger_1.default.error('Failed to read resource:', error);
            if (((0, error_utils_1.hasMessage)(error) && error.message.includes('not found')) || error.status === 404) {
                res.status(404).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'not-found',
                            diagnostics: `${req.params.resourceType}/${req.params.id} not found`,
                        }],
                });
            }
            else {
                res.status(500).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'exception',
                            diagnostics: 'Failed to read resource',
                        }],
                });
            }
        }
    }
    /**
     * PUT /fhir/R4/{resourceType}/{id} - Update resource
     */
    async updateResource(req, res) {
        try {
            const { resourceType, id } = req.params;
            const resource = req.body;
            logger_1.default.fhir('Updating resource', {
                resourceType,
                id,
                userId: req.user?.id,
            });
            // Validate resource type and ID
            if (resource.resourceType !== resourceType) {
                res.status(400).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'invalid',
                            diagnostics: `Resource type mismatch: expected ${resourceType}, got ${resource.resourceType}`,
                        }],
                });
                return;
            }
            if (resource.id && resource.id !== id) {
                res.status(400).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'invalid',
                            diagnostics: `Resource ID mismatch: expected ${id}, got ${resource.id}`,
                        }],
                });
                return;
            }
            // Ensure resource has the correct ID
            resource.id = id;
            const updatedResource = await medplum_service_1.medplumService.updateResource(resource);
            // Notify subscriptions
            await subscriptions_service_1.subscriptionsService.processResourceChange(resourceType ?? '', id ?? '', 'update', updatedResource);
            res.json(updatedResource);
        }
        catch (error) {
            logger_1.default.error('Failed to update resource:', error);
            if (((0, error_utils_1.hasMessage)(error) && error.message.includes('not found')) || error.status === 404) {
                res.status(404).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'not-found',
                            diagnostics: `${req.params.resourceType}/${req.params.id} not found`,
                        }],
                });
            }
            else {
                res.status(500).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'exception',
                            diagnostics: 'Failed to update resource',
                        }],
                });
            }
        }
    }
    /**
     * DELETE /fhir/R4/{resourceType}/{id} - Delete resource
     */
    async deleteResource(req, res) {
        try {
            const { resourceType, id } = req.params;
            logger_1.default.fhir('Deleting resource', {
                resourceType,
                id,
                userId: req.user?.id,
            });
            await medplum_service_1.medplumService.deleteResource(resourceType ?? '', id ?? '');
            // Notify subscriptions
            await subscriptions_service_1.subscriptionsService.processResourceChange(resourceType ?? '', id ?? '', 'delete');
            res.status(204).send();
        }
        catch (error) {
            logger_1.default.error('Failed to delete resource:', error);
            if (((0, error_utils_1.hasMessage)(error) && error.message.includes('not found')) || error.status === 404) {
                res.status(404).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'not-found',
                            diagnostics: `${req.params.resourceType}/${req.params.id} not found`,
                        }],
                });
            }
            else {
                res.status(500).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'exception',
                            diagnostics: 'Failed to delete resource',
                        }],
                });
            }
        }
    }
    // ===============================
    // SEARCH OPERATIONS
    // ===============================
    /**
     * GET /fhir/R4/{resourceType} - Search resources
     */
    async searchResources(req, res) {
        try {
            const { resourceType } = req.params;
            const searchParams = req.query;
            logger_1.default.fhir('Searching resources', {
                resourceType,
                searchParams: Object.keys(searchParams),
                userId: req.user?.id,
            });
            const searchResults = await medplum_service_1.medplumService.searchResources(resourceType ?? '', searchParams);
            res.json(searchResults);
        }
        catch (error) {
            logger_1.default.error('Failed to search resources:', error);
            res.status(500).json({
                resourceType: 'OperationOutcome',
                issue: [{
                        severity: 'error',
                        code: 'exception',
                        diagnostics: 'Failed to search resources',
                    }],
            });
        }
    }
    // ===============================
    // BATCH/TRANSACTION OPERATIONS
    // ===============================
    /**
     * POST /fhir/R4 - Process batch/transaction bundle
     */
    async processBatch(req, res) {
        try {
            const bundle = req.body;
            logger_1.default.fhir('Processing batch/transaction', {
                bundleType: bundle.type,
                entryCount: bundle.entry?.length || 0,
                userId: req.user?.id,
            });
            if (bundle.resourceType !== 'Bundle') {
                res.status(400).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'invalid',
                            diagnostics: 'Expected Bundle resource type',
                        }],
                });
                return;
            }
            if (!['batch', 'transaction'].includes(bundle.type)) {
                res.status(400).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'error',
                            code: 'invalid',
                            diagnostics: 'Bundle type must be batch or transaction',
                        }],
                });
                return;
            }
            const bundleRequest = {
                resourceType: 'Bundle',
                type: bundle.type,
                resources: bundle.entry?.map((entry) => entry.resource) || [],
                timestamp: bundle.timestamp,
            };
            const result = await medplum_service_1.medplumService.executeBatch(bundleRequest);
            res.json(result);
        }
        catch (error) {
            logger_1.default.error('Failed to process batch/transaction:', error);
            res.status(500).json({
                resourceType: 'OperationOutcome',
                issue: [{
                        severity: 'error',
                        code: 'exception',
                        diagnostics: 'Failed to process batch/transaction',
                    }],
            });
        }
    }
    // ===============================
    // PATIENT-SPECIFIC OPERATIONS
    // ===============================
    /**
     * GET /fhir/R4/Patient/{id}/$everything - Get all patient data
     */
    async getPatientEverything(req, res) {
        try {
            const { id } = req.params;
            logger_1.default.fhir('Getting patient everything', {
                patientId: id,
                userId: req.user?.id,
            });
            const result = await fhir_resources_service_1.fhirResourcesService.getPatientEverything(id ?? '');
            res.json(result);
        }
        catch (error) {
            logger_1.default.error('Failed to get patient everything:', error);
            res.status(500).json({
                resourceType: 'OperationOutcome',
                issue: [{
                        severity: 'error',
                        code: 'exception',
                        diagnostics: 'Failed to retrieve patient data',
                    }],
            });
        }
    }
    // ===============================
    // VALIDATION OPERATIONS
    // ===============================
    /**
     * POST /fhir/R4/{resourceType}/$validate - Validate resource
     */
    async validateResource(req, res) {
        try {
            const { resourceType } = req.params;
            const resource = req.body;
            logger_1.default.fhir('Validating resource', {
                resourceType,
                userId: req.user?.id,
            });
            const validationResult = await fhir_resources_service_1.fhirResourcesService.validateResource(resource);
            if (validationResult.valid) {
                res.status(200).json({
                    resourceType: 'OperationOutcome',
                    issue: [{
                            severity: 'information',
                            code: 'informational',
                            diagnostics: 'Resource is valid',
                        }],
                });
            }
            else {
                res.status(400).json({
                    resourceType: 'OperationOutcome',
                    issue: [
                        ...validationResult.errors.map(error => ({
                            severity: 'error',
                            code: error.code,
                            diagnostics: error.message,
                            expression: error.path ? [error.path] : undefined,
                        })),
                        ...validationResult.warnings.map(warning => ({
                            severity: 'warning',
                            code: warning.code,
                            diagnostics: warning.message,
                            expression: warning.path ? [warning.path] : undefined,
                        })),
                    ],
                });
            }
        }
        catch (error) {
            logger_1.default.error('Failed to validate resource:', error);
            res.status(500).json({
                resourceType: 'OperationOutcome',
                issue: [{
                        severity: 'error',
                        code: 'exception',
                        diagnostics: 'Failed to validate resource',
                    }],
            });
        }
    }
    // ===============================
    // GRAPHQL OPERATIONS
    // ===============================
    /**
     * POST /fhir/R4/$graphql - Execute GraphQL query
     */
    async executeGraphQL(req, res) {
        try {
            const { query, variables } = req.body;
            logger_1.default.fhir('Executing GraphQL query', {
                userId: req.user?.id,
                hasVariables: !!variables,
            });
            const result = await medplum_service_1.medplumService.graphql(query, variables);
            res.json(result);
        }
        catch (error) {
            logger_1.default.error('Failed to execute GraphQL query:', error);
            res.status(500).json({
                resourceType: 'OperationOutcome',
                issue: [{
                        severity: 'error',
                        code: 'exception',
                        diagnostics: 'Failed to execute GraphQL query',
                    }],
            });
        }
    }
    // ===============================
    // CDS HOOKS OPERATIONS
    // ===============================
    /**
     * GET /cds-services - CDS Hooks discovery
     */
    async getCDSServices(req, res) {
        try {
            logger_1.default.info('CDS Hooks discovery requested', {
                userAgent: req.get('User-Agent'),
                ip: req.ip,
            });
            const discoveryDocument = cds_hooks_service_1.cdsHooksService.getDiscoveryDocument();
            res.json(discoveryDocument);
        }
        catch (error) {
            logger_1.default.error('Failed to get CDS services:', error);
            res.status(500).json({
                error: 'Failed to retrieve CDS services',
            });
        }
    }
    /**
     * POST /cds-services/{service-id} - Execute CDS Hook
     */
    async executeCDSHook(req, res) {
        try {
            const { serviceId } = req.params;
            const hookRequest = req.body;
            logger_1.default.info('CDS Hook execution requested', {
                serviceId,
                hook: hookRequest.hook,
                patientId: hookRequest.context.patientId,
                userId: req.user?.id,
            });
            let response;
            switch (serviceId) {
                case 'omnicare-patient-risk-assessment':
                    response = await cds_hooks_service_1.cdsHooksService.executePatientView(hookRequest);
                    break;
                case 'omnicare-medication-safety':
                    response = await cds_hooks_service_1.cdsHooksService.executeMedicationPrescribe(hookRequest);
                    break;
                case 'omnicare-order-review':
                    response = await cds_hooks_service_1.cdsHooksService.executeOrderReview(hookRequest);
                    break;
                default:
                    res.status(404).json({
                        error: `CDS service ${serviceId} not found`,
                    });
                    return;
            }
            res.json(response);
        }
        catch (error) {
            logger_1.default.error('Failed to execute CDS hook:', error);
            res.status(500).json({
                error: 'Failed to execute CDS hook',
            });
        }
    }
    // ===============================
    // SUBSCRIPTION OPERATIONS
    // ===============================
    /**
     * GET /fhir/R4/Subscription - List subscriptions
     */
    async listSubscriptions(req, res) {
        try {
            logger_1.default.fhir('Listing subscriptions', {
                userId: req.user?.id,
            });
            const subscriptions = subscriptions_service_1.subscriptionsService.listActiveSubscriptions();
            const bundle = {
                resourceType: 'Bundle',
                type: 'searchset',
                total: subscriptions.length,
                entry: subscriptions.map(sub => ({
                    resource: {
                        resourceType: 'Subscription',
                        id: sub.id,
                        status: sub.status,
                        criteria: sub.criteria,
                        channel: sub.channel,
                        reason: 'OmniCare EMR Subscription',
                    },
                })),
            };
            res.json(bundle);
        }
        catch (error) {
            logger_1.default.error('Failed to list subscriptions:', error);
            res.status(500).json({
                resourceType: 'OperationOutcome',
                issue: [{
                        severity: 'error',
                        code: 'exception',
                        diagnostics: 'Failed to list subscriptions',
                    }],
            });
        }
    }
    // ===============================
    // HEALTH CHECK
    // ===============================
    /**
     * GET /health - Health check endpoint
     */
    async healthCheck(req, res) {
        try {
            const [medplumHealth, cdsHealth, subscriptionsHealth] = await Promise.all([
                medplum_service_1.medplumService.getHealthStatus(),
                cds_hooks_service_1.cdsHooksService.getHealthStatus(),
                subscriptions_service_1.subscriptionsService.getHealthStatus(),
            ]);
            const overallStatus = [medplumHealth, cdsHealth, subscriptionsHealth]
                .every(health => health.status === 'UP') ? 'UP' : 'DOWN';
            const healthStatus = {
                status: overallStatus,
                timestamp: new Date().toISOString(),
                components: {
                    medplum: medplumHealth,
                    cdsHooks: cdsHealth,
                    subscriptions: subscriptionsHealth,
                },
            };
            res.status(overallStatus === 'UP' ? 200 : 503).json(healthStatus);
        }
        catch (error) {
            logger_1.default.error('Health check failed:', error);
            res.status(503).json({
                status: 'DOWN',
                timestamp: new Date().toISOString(),
                error: 'Health check failed',
            });
        }
    }
}
exports.FHIRController = FHIRController;
// Export singleton instance
exports.fhirController = new FHIRController();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3JvZHJpZ28vY2xhdWRlLXByb2plY3RzL09tbmlDYXJlL2JhY2tlbmQvc3JjL2NvbnRyb2xsZXJzL2ZoaXIuY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQSxvRUFBK0Q7QUFDL0QsOEVBQXlFO0FBQ3pFLGdFQUE0RDtBQUM1RCw0RUFBd0U7QUFFeEUsNERBQW9DO0FBQ3BDLHFEQUFrRTtBQUVsRTs7O0dBR0c7QUFDSCxNQUFhLGNBQWM7SUFFekIsa0NBQWtDO0lBQ2xDLCtCQUErQjtJQUMvQixrQ0FBa0M7SUFFbEM7O09BRUc7SUFDSCxLQUFLLENBQUMsc0JBQXNCLENBQUMsR0FBWSxFQUFFLEdBQWE7UUFDdEQsSUFBSSxDQUFDO1lBQ0gsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsZ0NBQWdDLEVBQUU7Z0JBQzVDLFNBQVMsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQztnQkFDaEMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFO2FBQ1gsQ0FBQyxDQUFDO1lBRUgsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLGdDQUFjLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUUxRSxHQUFHLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDaEMsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixnQkFBTSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMzRCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsWUFBWSxFQUFFLGtCQUFrQjtnQkFDaEMsS0FBSyxFQUFFLENBQUM7d0JBQ04sUUFBUSxFQUFFLE9BQU87d0JBQ2pCLElBQUksRUFBRSxXQUFXO3dCQUNqQixXQUFXLEVBQUUseUNBQXlDO3FCQUN2RCxDQUFDO2FBQ0gsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUM7SUFFRCxrQ0FBa0M7SUFDbEMsMkJBQTJCO0lBQzNCLGtDQUFrQztJQUVsQzs7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ZWN0cy9PbW5pQ2FyZS9iYWNrZW5kL3NyYy9jb250cm9sbGVycy9maGlyLmNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcblxuaW1wb3J0IHsgY2RzSG9va3NTZXJ2aWNlIH0gZnJvbSAnQC9zZXJ2aWNlcy9jZHMtaG9va3Muc2VydmljZSc7XG5pbXBvcnQgeyBmaGlyUmVzb3VyY2VzU2VydmljZSB9IGZyb20gJ0Avc2VydmljZXMvZmhpci1yZXNvdXJjZXMuc2VydmljZSc7XG5pbXBvcnQgeyBtZWRwbHVtU2VydmljZSB9IGZyb20gJ0Avc2VydmljZXMvbWVkcGx1bS5zZXJ2aWNlJztcbmltcG9ydCB7IHN1YnNjcmlwdGlvbnNTZXJ2aWNlIH0gZnJvbSAnQC9zZXJ2aWNlcy9zdWJzY3JpcHRpb25zLnNlcnZpY2UnO1xuaW1wb3J0IHsgRkhJUlNlYXJjaFBhcmFtcywgQ0RTSG9va1JlcXVlc3QsIEJ1bmRsZVJlcXVlc3QgfSBmcm9tICdAL3R5cGVzL2ZoaXInO1xuaW1wb3J0IGxvZ2dlciBmcm9tICdAL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBnZXRFcnJvck1lc3NhZ2UsIGhhc01lc3NhZ2UgfSBmcm9tICdAL3V0aWxzL2Vycm9yLnV0aWxzJztcblxuLyoqXG4gKiBGSElSIEFQSSBDb250cm9sbGVyXG4gKiBIYW5kbGVzIGFsbCBGSElSIFJFU1QgQVBJIGVuZHBvaW50cyBhY2NvcmRpbmcgdG8gRkhJUiBSNCBzcGVjaWZpY2F0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBGSElSQ29udHJvbGxlciB7XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBGSElSIE1FVEFEQVRBIEFORCBDQVBBQklMSVRZXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICAvKipcbiAgICogR0VUIC9maGlyL1I0L21ldGFkYXRhIC0gRkhJUiBDYXBhYmlsaXR5IFN0YXRlbWVudFxuICAgKi9cbiAgYXN5bmMgZ2V0Q2FwYWJpbGl0eVN0YXRlbWVudChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgbG9nZ2VyLmZoaXIoJ0NhcGFiaWxpdHkgc3RhdGVtZW50IHJlcXVlc3RlZCcsIHtcbiAgICAgICAgdXNlckFnZW50OiByZXEuZ2V0KCdVc2VyLUFnZW50JyksXG4gICAgICAgIGlwOiByZXEuaXAsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgY2FwYWJpbGl0eVN0YXRlbWVudCA9IGF3YWl0IG1lZHBsdW1TZXJ2aWNlLmdldENhcGFiaWxpdHlTdGF0ZW1lbnQoKTtcbiAgICAgIFxuICAgICAgcmVzLmpzb24oY2FwYWJpbGl0eVN0YXRlbWVudCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGdldCBjYXBhYmlsaXR5IHN0YXRlbWVudDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHJlc291cmNlVHlwZTogJ09wZXJhdGlvbk91dGNvbWUnLFxuICAgICAgICBpc3N1ZTogW3tcbiAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcbiAgICAgICAgICBjb2RlOiAnZXhjZXB0aW9uJyxcbiAgICAgICAgICBkaWFnbm9zdGljczogJ0ZhaWxlZCB0byByZXRyaWV2ZSBjYXBhYmlsaXR5IHN0YXRlbWVudCcsXG4gICAgICAgIH1dLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBSRVNPVVJDRSBDUlVEIE9QRVJBVElPTlNcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiBQT1NUIC9maGlyL1I0L3tyZXNvdXJjZVR5cGV9IC0gQ3JlYXRlIHJlc291cmNlXG4gICAqL1xuICBhc3luYyBjcmVhdGVSZXNvdXJjZShyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZXNvdXJjZVR5cGUgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCByZXNvdXJjZSA9IHJlcS5ib2R5O1xuXG4gICAgICBsb2dnZXIuZmhpcignQ3JlYXRpbmcgcmVzb3VyY2UnLCB7XG4gICAgICAgIHJlc291cmNlVHlwZSxcbiAgICAgICAgdXNlcklkOiByZXEudXNlcj8uaWQsXG4gICAgICAgIGhhc0lkOiAhIXJlc291cmNlLmlkLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFZhbGlkYXRlIHJlc291cmNlIHR5cGVcbiAgICAgIGlmIChyZXNvdXJjZS5yZXNvdXJjZVR5cGUgIT09IHJlc291cmNlVHlwZSkge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiAnT3BlcmF0aW9uT3V0Y29tZScsXG4gICAgICAgICAgaXNzdWU6IFt7XG4gICAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcbiAgICAgICAgICAgIGNvZGU6ICdpbnZhbGlkJyxcbiAgICAgICAgICAgIGRpYWdub3N0aWNzOiBgUmVzb3VyY2UgdHlwZSBtaXNtYXRjaDogZXhwZWN0ZWQgJHtyZXNvdXJjZVR5cGV9LCBnb3QgJHtyZXNvdXJjZS5yZXNvdXJjZVR5cGV9YCxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gUmVtb3ZlIGlkIGlmIHByZXNlbnQgKHNlcnZlciBhc3NpZ25zIElEcylcbiAgICAgIGlmIChyZXNvdXJjZS5pZCkge1xuICAgICAgICBkZWxldGUgcmVzb3VyY2UuaWQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNyZWF0ZWRSZXNvdXJjZSA9IGF3YWl0IG1lZHBsdW1TZXJ2aWNlLmNyZWF0ZVJlc291cmNlKHJlc291cmNlKTtcblxuICAgICAgLy8gTm90aWZ5IHN1YnNjcmlwdGlvbnNcbiAgICAgIGF3YWl0IHN1YnNjcmlwdGlvbnNTZXJ2aWNlLnByb2Nlc3NSZXNvdXJjZUNoYW5nZShcbiAgICAgICAgcmVzb3VyY2VUeXBlID8/ICcnLFxuICAgICAgICBjcmVhdGVkUmVzb3VyY2UuaWQgPz8gJycsXG4gICAgICAgICdjcmVhdGUnLFxuICAgICAgICBjcmVhdGVkUmVzb3VyY2VcbiAgICAgICk7XG5cbiAgICAgIHJlcy5zdGF0dXMoMjAxKVxuICAgICAgICAubG9jYXRpb24oYC9maGlyL1I0LyR7cmVzb3VyY2VUeXBlfS8ke2NyZWF0ZWRSZXNvdXJjZS5pZH1gKVxuICAgICAgICAuanNvbihjcmVhdGVkUmVzb3VyY2UpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgcmVzb3VyY2U6JywgZXJyb3IpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICByZXNvdXJjZVR5cGU6ICdPcGVyYXRpb25PdXRjb21lJyxcbiAgICAgICAgaXNzdWU6IFt7XG4gICAgICAgICAgc2V2ZXJpdHk6ICdlcnJvcicsXG4gICAgICAgICAgY29kZTogJ2V4Y2VwdGlvbicsXG4gICAgICAgICAgZGlhZ25vc3RpY3M6ICdGYWlsZWQgdG8gY3JlYXRlIHJlc291cmNlJyxcbiAgICAgICAgfV0sXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR0VUIC9maGlyL1I0L3tyZXNvdXJjZVR5cGV9L3tpZH0gLSBSZWFkIHJlc291cmNlXG4gICAqL1xuICBhc3luYyByZWFkUmVzb3VyY2UocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgcmVzb3VyY2VUeXBlLCBpZCB9ID0gcmVxLnBhcmFtcztcblxuICAgICAgbG9nZ2VyLmZoaXIoJ1JlYWRpbmcgcmVzb3VyY2UnLCB7XG4gICAgICAgIHJlc291cmNlVHlwZSxcbiAgICAgICAgaWQsXG4gICAgICAgIHVzZXJJZDogcmVxLnVzZXI/LmlkLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc291cmNlID0gYXdhaXQgbWVkcGx1bVNlcnZpY2UucmVhZFJlc291cmNlKHJlc291cmNlVHlwZSA/PyAnJywgaWQgPz8gJycpO1xuICAgICAgXG4gICAgICByZXMuanNvbihyZXNvdXJjZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHJlYWQgcmVzb3VyY2U6JywgZXJyb3IpO1xuICAgICAgXG4gICAgICBpZiAoKGhhc01lc3NhZ2UoZXJyb3IpICYmIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ25vdCBmb3VuZCcpKSB8fCAoZXJyb3IgYXMgYW55KS5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgICByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiAnT3BlcmF0aW9uT3V0Y29tZScsXG4gICAgICAgICAgaXNzdWU6IFt7XG4gICAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcbiAgICAgICAgICAgIGNvZGU6ICdub3QtZm91bmQnLFxuICAgICAgICAgICAgZGlhZ25vc3RpY3M6IGAke3JlcS5wYXJhbXMucmVzb3VyY2VUeXBlfS8ke3JlcS5wYXJhbXMuaWR9IG5vdCBmb3VuZGAsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICAgIHJlc291cmNlVHlwZTogJ09wZXJhdGlvbk91dGNvbWUnLFxuICAgICAgICAgIGlzc3VlOiBbe1xuICAgICAgICAgICAgc2V2ZXJpdHk6ICdlcnJvcicsXG4gICAgICAgICAgICBjb2RlOiAnZXhjZXB0aW9uJyxcbiAgICAgICAgICAgIGRpYWdub3N0aWNzOiAnRmFpbGVkIHRvIHJlYWQgcmVzb3VyY2UnLFxuICAgICAgICAgIH1dLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUFVUIC9maGlyL1I0L3tyZXNvdXJjZVR5cGV9L3tpZH0gLSBVcGRhdGUgcmVzb3VyY2VcbiAgICovXG4gIGFzeW5jIHVwZGF0ZVJlc291cmNlKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHJlc291cmNlVHlwZSwgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCByZXNvdXJjZSA9IHJlcS5ib2R5O1xuXG4gICAgICBsb2dnZXIuZmhpcignVXBkYXRpbmcgcmVzb3VyY2UnLCB7XG4gICAgICAgIHJlc291cmNlVHlwZSxcbiAgICAgICAgaWQsXG4gICAgICAgIHVzZXJJZDogcmVxLnVzZXI/LmlkLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFZhbGlkYXRlIHJlc291cmNlIHR5cGUgYW5kIElEXG4gICAgICBpZiAocmVzb3VyY2UucmVzb3VyY2VUeXBlICE9PSByZXNvdXJjZVR5cGUpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHJlc291cmNlVHlwZTogJ09wZXJhdGlvbk91dGNvbWUnLFxuICAgICAgICAgIGlzc3VlOiBbe1xuICAgICAgICAgICAgc2V2ZXJpdHk6ICdlcnJvcicsXG4gICAgICAgICAgICBjb2RlOiAnaW52YWxpZCcsXG4gICAgICAgICAgICBkaWFnbm9zdGljczogYFJlc291cmNlIHR5cGUgbWlzbWF0Y2g6IGV4cGVjdGVkICR7cmVzb3VyY2VUeXBlfSwgZ290ICR7cmVzb3VyY2UucmVzb3VyY2VUeXBlfWAsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXNvdXJjZS5pZCAmJiByZXNvdXJjZS5pZCAhPT0gaWQpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgIHJlc291cmNlVHlwZTogJ09wZXJhdGlvbk91dGNvbWUnLFxuICAgICAgICAgIGlzc3VlOiBbe1xuICAgICAgICAgICAgc2V2ZXJpdHk6ICdlcnJvcicsXG4gICAgICAgICAgICBjb2RlOiAnaW52YWxpZCcsXG4gICAgICAgICAgICBkaWFnbm9zdGljczogYFJlc291cmNlIElEIG1pc21hdGNoOiBleHBlY3RlZCAke2lkfSwgZ290ICR7cmVzb3VyY2UuaWR9YCxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gRW5zdXJlIHJlc291cmNlIGhhcyB0aGUgY29ycmVjdCBJRFxuICAgICAgcmVzb3VyY2UuaWQgPSBpZDtcblxuICAgICAgY29uc3QgdXBkYXRlZFJlc291cmNlID0gYXdhaXQgbWVkcGx1bVNlcnZpY2UudXBkYXRlUmVzb3VyY2UocmVzb3VyY2UpO1xuXG4gICAgICAvLyBOb3RpZnkgc3Vic2NyaXB0aW9uc1xuICAgICAgYXdhaXQgc3Vic2NyaXB0aW9uc1NlcnZpY2UucHJvY2Vzc1Jlc291cmNlQ2hhbmdlKFxuICAgICAgICByZXNvdXJjZVR5cGUgPz8gJycsXG4gICAgICAgIGlkID8/ICcnLFxuICAgICAgICAndXBkYXRlJyxcbiAgICAgICAgdXBkYXRlZFJlc291cmNlXG4gICAgICApO1xuXG4gICAgICByZXMuanNvbih1cGRhdGVkUmVzb3VyY2UpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byB1cGRhdGUgcmVzb3VyY2U6JywgZXJyb3IpO1xuICAgICAgXG4gICAgICBpZiAoKGhhc01lc3NhZ2UoZXJyb3IpICYmIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ25vdCBmb3VuZCcpKSB8fCAoZXJyb3IgYXMgYW55KS5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgICByZXMuc3RhdHVzKDQwNCkuanNvbih7XG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiAnT3BlcmF0aW9uT3V0Y29tZScsXG4gICAgICAgICAgaXNzdWU6IFt7XG4gICAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcbiAgICAgICAgICAgIGNvZGU6ICdub3QtZm91bmQnLFxuICAgICAgICAgICAgZGlhZ25vc3RpY3M6IGAke3JlcS5wYXJhbXMucmVzb3VyY2VUeXBlfS8ke3JlcS5wYXJhbXMuaWR9IG5vdCBmb3VuZGAsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICAgIHJlc291cmNlVHlwZTogJ09wZXJhdGlvbk91dGNvbWUnLFxuICAgICAgICAgIGlzc3VlOiBbe1xuICAgICAgICAgICAgc2V2ZXJpdHk6ICdlcnJvcicsXG4gICAgICAgICAgICBjb2RlOiAnZXhjZXB0aW9uJyxcbiAgICAgICAgICAgIGRpYWdub3N0aWNzOiAnRmFpbGVkIHRvIHVwZGF0ZSByZXNvdXJjZScsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBERUxFVEUgL2ZoaXIvUjQve3Jlc291cmNlVHlwZX0ve2lkfSAtIERlbGV0ZSByZXNvdXJjZVxuICAgKi9cbiAgYXN5bmMgZGVsZXRlUmVzb3VyY2UocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgcmVzb3VyY2VUeXBlLCBpZCB9ID0gcmVxLnBhcmFtcztcblxuICAgICAgbG9nZ2VyLmZoaXIoJ0RlbGV0aW5nIHJlc291cmNlJywge1xuICAgICAgICByZXNvdXJjZVR5cGUsXG4gICAgICAgIGlkLFxuICAgICAgICB1c2VySWQ6IHJlcS51c2VyPy5pZCxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBtZWRwbHVtU2VydmljZS5kZWxldGVSZXNvdXJjZShyZXNvdXJjZVR5cGUgPz8gJycsIGlkID8/ICcnKTtcblxuICAgICAgLy8gTm90aWZ5IHN1YnNjcmlwdGlvbnNcbiAgICAgIGF3YWl0IHN1YnNjcmlwdGlvbnNTZXJ2aWNlLnByb2Nlc3NSZXNvdXJjZUNoYW5nZShcbiAgICAgICAgcmVzb3VyY2VUeXBlID8/ICcnLFxuICAgICAgICBpZCA/PyAnJyxcbiAgICAgICAgJ2RlbGV0ZSdcbiAgICAgICk7XG5cbiAgICAgIHJlcy5zdGF0dXMoMjA0KS5zZW5kKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGRlbGV0ZSByZXNvdXJjZTonLCBlcnJvcik7XG4gICAgICBcbiAgICAgIGlmICgoaGFzTWVzc2FnZShlcnJvcikgJiYgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnbm90IGZvdW5kJykpIHx8IChlcnJvciBhcyBhbnkpLnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgICAgICByZXNvdXJjZVR5cGU6ICdPcGVyYXRpb25PdXRjb21lJyxcbiAgICAgICAgICBpc3N1ZTogW3tcbiAgICAgICAgICAgIHNldmVyaXR5OiAnZXJyb3InLFxuICAgICAgICAgICAgY29kZTogJ25vdC1mb3VuZCcsXG4gICAgICAgICAgICBkaWFnbm9zdGljczogYCR7cmVxLnBhcmFtcy5yZXNvdXJjZVR5cGV9LyR7cmVxLnBhcmFtcy5pZH0gbm90IGZvdW5kYCxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiAnT3BlcmF0aW9uT3V0Y29tZScsXG4gICAgICAgICAgaXNzdWU6IFt7XG4gICAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcbiAgICAgICAgICAgIGNvZGU6ICdleGNlcHRpb24nLFxuICAgICAgICAgICAgZGlhZ25vc3RpY3M6ICdGYWlsZWQgdG8gZGVsZXRlIHJlc291cmNlJyxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBTRUFSQ0ggT1BFUkFUSU9OU1xuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgLyoqXG4gICAqIEdFVCAvZmhpci9SNC97cmVzb3VyY2VUeXBlfSAtIFNlYXJjaCByZXNvdXJjZXNcbiAgICovXG4gIGFzeW5jIHNlYXJjaFJlc291cmNlcyhyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyByZXNvdXJjZVR5cGUgfSA9IHJlcS5wYXJhbXM7XG4gICAgICBjb25zdCBzZWFyY2hQYXJhbXM6IEZISVJTZWFyY2hQYXJhbXMgPSByZXEucXVlcnkgYXMgYW55O1xuXG4gICAgICBsb2dnZXIuZmhpcignU2VhcmNoaW5nIHJlc291cmNlcycsIHtcbiAgICAgICAgcmVzb3VyY2VUeXBlLFxuICAgICAgICBzZWFyY2hQYXJhbXM6IE9iamVjdC5rZXlzKHNlYXJjaFBhcmFtcyksXG4gICAgICAgIHVzZXJJZDogcmVxLnVzZXI/LmlkLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHNlYXJjaFJlc3VsdHMgPSBhd2FpdCBtZWRwbHVtU2VydmljZS5zZWFyY2hSZXNvdXJjZXMocmVzb3VyY2VUeXBlID8/ICcnLCBzZWFyY2hQYXJhbXMpO1xuICAgICAgXG4gICAgICByZXMuanNvbihzZWFyY2hSZXN1bHRzKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gc2VhcmNoIHJlc291cmNlczonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHJlc291cmNlVHlwZTogJ09wZXJhdGlvbk91dGNvbWUnLFxuICAgICAgICBpc3N1ZTogW3tcbiAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcbiAgICAgICAgICBjb2RlOiAnZXhjZXB0aW9uJyxcbiAgICAgICAgICBkaWFnbm9zdGljczogJ0ZhaWxlZCB0byBzZWFyY2ggcmVzb3VyY2VzJyxcbiAgICAgICAgfV0sXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIEJBVENIL1RSQU5TQUNUSU9OIE9QRVJBVElPTlNcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiBQT1NUIC9maGlyL1I0IC0gUHJvY2VzcyBiYXRjaC90cmFuc2FjdGlvbiBidW5kbGVcbiAgICovXG4gIGFzeW5jIHByb2Nlc3NCYXRjaChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYnVuZGxlID0gcmVxLmJvZHk7XG5cbiAgICAgIGxvZ2dlci5maGlyKCdQcm9jZXNzaW5nIGJhdGNoL3RyYW5zYWN0aW9uJywge1xuICAgICAgICBidW5kbGVUeXBlOiBidW5kbGUudHlwZSxcbiAgICAgICAgZW50cnlDb3VudDogYnVuZGxlLmVudHJ5Py5sZW5ndGggfHwgMCxcbiAgICAgICAgdXNlcklkOiByZXEudXNlcj8uaWQsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGJ1bmRsZS5yZXNvdXJjZVR5cGUgIT09ICdCdW5kbGUnKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICByZXNvdXJjZVR5cGU6ICdPcGVyYXRpb25PdXRjb21lJyxcbiAgICAgICAgICBpc3N1ZTogW3tcbiAgICAgICAgICAgIHNldmVyaXR5OiAnZXJyb3InLFxuICAgICAgICAgICAgY29kZTogJ2ludmFsaWQnLFxuICAgICAgICAgICAgZGlhZ25vc3RpY3M6ICdFeHBlY3RlZCBCdW5kbGUgcmVzb3VyY2UgdHlwZScsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmICghWydiYXRjaCcsICd0cmFuc2FjdGlvbiddLmluY2x1ZGVzKGJ1bmRsZS50eXBlKSkge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiAnT3BlcmF0aW9uT3V0Y29tZScsXG4gICAgICAgICAgaXNzdWU6IFt7XG4gICAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcbiAgICAgICAgICAgIGNvZGU6ICdpbnZhbGlkJyxcbiAgICAgICAgICAgIGRpYWdub3N0aWNzOiAnQnVuZGxlIHR5cGUgbXVzdCBiZSBiYXRjaCBvciB0cmFuc2FjdGlvbicsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGJ1bmRsZVJlcXVlc3Q6IEJ1bmRsZVJlcXVlc3QgPSB7XG4gICAgICAgIHJlc291cmNlVHlwZTogJ0J1bmRsZScsXG4gICAgICAgIHR5cGU6IGJ1bmRsZS50eXBlLFxuICAgICAgICByZXNvdXJjZXM6IGJ1bmRsZS5lbnRyeT8ubWFwKChlbnRyeTogYW55KSA9PiBlbnRyeS5yZXNvdXJjZSkgfHwgW10sXG4gICAgICAgIHRpbWVzdGFtcDogYnVuZGxlLnRpbWVzdGFtcCxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG1lZHBsdW1TZXJ2aWNlLmV4ZWN1dGVCYXRjaChidW5kbGVSZXF1ZXN0KTtcbiAgICAgIFxuICAgICAgcmVzLmpzb24ocmVzdWx0KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcHJvY2VzcyBiYXRjaC90cmFuc2FjdGlvbjonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHJlc291cmNlVHlwZTogJ09wZXJhdGlvbk91dGNvbWUnLFxuICAgICAgICBpc3N1ZTogW3tcbiAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcbiAgICAgICAgICBjb2RlOiAnZXhjZXB0aW9uJyxcbiAgICAgICAgICBkaWFnbm9zdGljczogJ0ZhaWxlZCB0byBwcm9jZXNzIGJhdGNoL3RyYW5zYWN0aW9uJyxcbiAgICAgICAgfV0sXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIFBBVElFTlQtU1BFQ0lGSUMgT1BFUkFUSU9OU1xuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgLyoqXG4gICAqIEdFVCAvZmhpci9SNC9QYXRpZW50L3tpZH0vJGV2ZXJ5dGhpbmcgLSBHZXQgYWxsIHBhdGllbnQgZGF0YVxuICAgKi9cbiAgYXN5bmMgZ2V0UGF0aWVudEV2ZXJ5dGhpbmcocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG5cbiAgICAgIGxvZ2dlci5maGlyKCdHZXR0aW5nIHBhdGllbnQgZXZlcnl0aGluZycsIHtcbiAgICAgICAgcGF0aWVudElkOiBpZCxcbiAgICAgICAgdXNlcklkOiByZXEudXNlcj8uaWQsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmhpclJlc291cmNlc1NlcnZpY2UuZ2V0UGF0aWVudEV2ZXJ5dGhpbmcoaWQgPz8gJycpO1xuICAgICAgXG4gICAgICByZXMuanNvbihyZXN1bHQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgcGF0aWVudCBldmVyeXRoaW5nOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgcmVzb3VyY2VUeXBlOiAnT3BlcmF0aW9uT3V0Y29tZScsXG4gICAgICAgIGlzc3VlOiBbe1xuICAgICAgICAgIHNldmVyaXR5OiAnZXJyb3InLFxuICAgICAgICAgIGNvZGU6ICdleGNlcHRpb24nLFxuICAgICAgICAgIGRpYWdub3N0aWNzOiAnRmFpbGVkIHRvIHJldHJpZXZlIHBhdGllbnQgZGF0YScsXG4gICAgICAgIH1dLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBWQUxJREFUSU9OIE9QRVJBVElPTlNcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiBQT1NUIC9maGlyL1I0L3tyZXNvdXJjZVR5cGV9LyR2YWxpZGF0ZSAtIFZhbGlkYXRlIHJlc291cmNlXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZVJlc291cmNlKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHJlc291cmNlVHlwZSB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IHJlc291cmNlID0gcmVxLmJvZHk7XG5cbiAgICAgIGxvZ2dlci5maGlyKCdWYWxpZGF0aW5nIHJlc291cmNlJywge1xuICAgICAgICByZXNvdXJjZVR5cGUsXG4gICAgICAgIHVzZXJJZDogcmVxLnVzZXI/LmlkLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBhd2FpdCBmaGlyUmVzb3VyY2VzU2VydmljZS52YWxpZGF0ZVJlc291cmNlKHJlc291cmNlKTtcbiAgICAgIFxuICAgICAgaWYgKHZhbGlkYXRpb25SZXN1bHQudmFsaWQpIHtcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgIHJlc291cmNlVHlwZTogJ09wZXJhdGlvbk91dGNvbWUnLFxuICAgICAgICAgIGlzc3VlOiBbe1xuICAgICAgICAgICAgc2V2ZXJpdHk6ICdpbmZvcm1hdGlvbicsXG4gICAgICAgICAgICBjb2RlOiAnaW5mb3JtYXRpb25hbCcsXG4gICAgICAgICAgICBkaWFnbm9zdGljczogJ1Jlc291cmNlIGlzIHZhbGlkJyxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiAnT3BlcmF0aW9uT3V0Y29tZScsXG4gICAgICAgICAgaXNzdWU6IFtcbiAgICAgICAgICAgIC4uLnZhbGlkYXRpb25SZXN1bHQuZXJyb3JzLm1hcChlcnJvciA9PiAoe1xuICAgICAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyBhcyBjb25zdCxcbiAgICAgICAgICAgICAgY29kZTogZXJyb3IuY29kZSxcbiAgICAgICAgICAgICAgZGlhZ25vc3RpY3M6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgICAgICAgIGV4cHJlc3Npb246IGVycm9yLnBhdGggPyBbZXJyb3IucGF0aF0gOiB1bmRlZmluZWQsXG4gICAgICAgICAgICB9KSksXG4gICAgICAgICAgICAuLi52YWxpZGF0aW9uUmVzdWx0Lndhcm5pbmdzLm1hcCh3YXJuaW5nID0+ICh7XG4gICAgICAgICAgICAgIHNldmVyaXR5OiAnd2FybmluZycgYXMgY29uc3QsXG4gICAgICAgICAgICAgIGNvZGU6IHdhcm5pbmcuY29kZSxcbiAgICAgICAgICAgICAgZGlhZ25vc3RpY3M6IHdhcm5pbmcubWVzc2FnZSxcbiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogd2FybmluZy5wYXRoID8gW3dhcm5pbmcucGF0aF0gOiB1bmRlZmluZWQsXG4gICAgICAgICAgICB9KSksXG4gICAgICAgICAgXSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHZhbGlkYXRlIHJlc291cmNlOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgcmVzb3VyY2VUeXBlOiAnT3BlcmF0aW9uT3V0Y29tZScsXG4gICAgICAgIGlzc3VlOiBbe1xuICAgICAgICAgIHNldmVyaXR5OiAnZXJyb3InLFxuICAgICAgICAgIGNvZGU6ICdleGNlcHRpb24nLFxuICAgICAgICAgIGRpYWdub3N0aWNzOiAnRmFpbGVkIHRvIHZhbGlkYXRlIHJlc291cmNlJyxcbiAgICAgICAgfV0sXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIEdSQVBIUUwgT1BFUkFUSU9OU1xuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgLyoqXG4gICAqIFBPU1QgL2ZoaXIvUjQvJGdyYXBocWwgLSBFeGVjdXRlIEdyYXBoUUwgcXVlcnlcbiAgICovXG4gIGFzeW5jIGV4ZWN1dGVHcmFwaFFMKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHF1ZXJ5LCB2YXJpYWJsZXMgfSA9IHJlcS5ib2R5O1xuXG4gICAgICBsb2dnZXIuZmhpcignRXhlY3V0aW5nIEdyYXBoUUwgcXVlcnknLCB7XG4gICAgICAgIHVzZXJJZDogcmVxLnVzZXI/LmlkLFxuICAgICAgICBoYXNWYXJpYWJsZXM6ICEhdmFyaWFibGVzLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG1lZHBsdW1TZXJ2aWNlLmdyYXBocWwocXVlcnksIHZhcmlhYmxlcyk7XG4gICAgICBcbiAgICAgIHJlcy5qc29uKHJlc3VsdCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGV4ZWN1dGUgR3JhcGhRTCBxdWVyeTonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIHJlc291cmNlVHlwZTogJ09wZXJhdGlvbk91dGNvbWUnLFxuICAgICAgICBpc3N1ZTogW3tcbiAgICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcbiAgICAgICAgICBjb2RlOiAnZXhjZXB0aW9uJyxcbiAgICAgICAgICBkaWFnbm9zdGljczogJ0ZhaWxlZCB0byBleGVjdXRlIEdyYXBoUUwgcXVlcnknLFxuICAgICAgICB9XSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gQ0RTIEhPT0tTIE9QRVJBVElPTlNcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiBHRVQgL2Nkcy1zZXJ2aWNlcyAtIENEUyBIb29rcyBkaXNjb3ZlcnlcbiAgICovXG4gIGFzeW5jIGdldENEU1NlcnZpY2VzKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBsb2dnZXIuaW5mbygnQ0RTIEhvb2tzIGRpc2NvdmVyeSByZXF1ZXN0ZWQnLCB7XG4gICAgICAgIHVzZXJBZ2VudDogcmVxLmdldCgnVXNlci1BZ2VudCcpLFxuICAgICAgICBpcDogcmVxLmlwLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGRpc2NvdmVyeURvY3VtZW50ID0gY2RzSG9va3NTZXJ2aWNlLmdldERpc2NvdmVyeURvY3VtZW50KCk7XG4gICAgICBcbiAgICAgIHJlcy5qc29uKGRpc2NvdmVyeURvY3VtZW50KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gZ2V0IENEUyBzZXJ2aWNlczonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIHJldHJpZXZlIENEUyBzZXJ2aWNlcycsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUE9TVCAvY2RzLXNlcnZpY2VzL3tzZXJ2aWNlLWlkfSAtIEV4ZWN1dGUgQ0RTIEhvb2tcbiAgICovXG4gIGFzeW5jIGV4ZWN1dGVDRFNIb29rKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHNlcnZpY2VJZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGNvbnN0IGhvb2tSZXF1ZXN0OiBDRFNIb29rUmVxdWVzdCA9IHJlcS5ib2R5O1xuXG4gICAgICBsb2dnZXIuaW5mbygnQ0RTIEhvb2sgZXhlY3V0aW9uIHJlcXVlc3RlZCcsIHtcbiAgICAgICAgc2VydmljZUlkLFxuICAgICAgICBob29rOiBob29rUmVxdWVzdC5ob29rLFxuICAgICAgICBwYXRpZW50SWQ6IGhvb2tSZXF1ZXN0LmNvbnRleHQucGF0aWVudElkLFxuICAgICAgICB1c2VySWQ6IHJlcS51c2VyPy5pZCxcbiAgICAgIH0pO1xuXG4gICAgICBsZXQgcmVzcG9uc2U7XG4gICAgICBcbiAgICAgIHN3aXRjaCAoc2VydmljZUlkKSB7XG4gICAgICAgIGNhc2UgJ29tbmljYXJlLXBhdGllbnQtcmlzay1hc3Nlc3NtZW50JzpcbiAgICAgICAgICByZXNwb25zZSA9IGF3YWl0IGNkc0hvb2tzU2VydmljZS5leGVjdXRlUGF0aWVudFZpZXcoaG9va1JlcXVlc3QpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdvbW5pY2FyZS1tZWRpY2F0aW9uLXNhZmV0eSc6XG4gICAgICAgICAgcmVzcG9uc2UgPSBhd2FpdCBjZHNIb29rc1NlcnZpY2UuZXhlY3V0ZU1lZGljYXRpb25QcmVzY3JpYmUoaG9va1JlcXVlc3QpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdvbW5pY2FyZS1vcmRlci1yZXZpZXcnOlxuICAgICAgICAgIHJlc3BvbnNlID0gYXdhaXQgY2RzSG9va3NTZXJ2aWNlLmV4ZWN1dGVPcmRlclJldmlldyhob29rUmVxdWVzdCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xuICAgICAgICAgICAgZXJyb3I6IGBDRFMgc2VydmljZSAke3NlcnZpY2VJZH0gbm90IGZvdW5kYCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHJlcy5qc29uKHJlc3BvbnNlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gZXhlY3V0ZSBDRFMgaG9vazonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGV4ZWN1dGUgQ0RTIGhvb2snLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBTVUJTQ1JJUFRJT04gT1BFUkFUSU9OU1xuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgLyoqXG4gICAqIEdFVCAvZmhpci9SNC9TdWJzY3JpcHRpb24gLSBMaXN0IHN1YnNjcmlwdGlvbnNcbiAgICovXG4gIGFzeW5jIGxpc3RTdWJzY3JpcHRpb25zKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBsb2dnZXIuZmhpcignTGlzdGluZyBzdWJzY3JpcHRpb25zJywge1xuICAgICAgICB1c2VySWQ6IHJlcS51c2VyPy5pZCxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb25zID0gc3Vic2NyaXB0aW9uc1NlcnZpY2UubGlzdEFjdGl2ZVN1YnNjcmlwdGlvbnMoKTtcbiAgICAgIFxuICAgICAgY29uc3QgYnVuZGxlID0ge1xuICAgICAgICByZXNvdXJjZVR5cGU6ICdCdW5kbGUnLFxuICAgICAgICB0eXBlOiAnc2VhcmNoc2V0JyxcbiAgICAgICAgdG90YWw6IHN1YnNjcmlwdGlvbnMubGVuZ3RoLFxuICAgICAgICBlbnRyeTogc3Vic2NyaXB0aW9ucy5tYXAoc3ViID0+ICh7XG4gICAgICAgICAgcmVzb3VyY2U6IHtcbiAgICAgICAgICAgIHJlc291cmNlVHlwZTogJ1N1YnNjcmlwdGlvbicsXG4gICAgICAgICAgICBpZDogc3ViLmlkLFxuICAgICAgICAgICAgc3RhdHVzOiBzdWIuc3RhdHVzLFxuICAgICAgICAgICAgY3JpdGVyaWE6IHN1Yi5jcml0ZXJpYSxcbiAgICAgICAgICAgIGNoYW5uZWw6IHN1Yi5jaGFubmVsLFxuICAgICAgICAgICAgcmVhc29uOiAnT21uaUNhcmUgRU1SIFN1YnNjcmlwdGlvbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSkpLFxuICAgICAgfTtcblxuICAgICAgcmVzLmpzb24oYnVuZGxlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gbGlzdCBzdWJzY3JpcHRpb25zOicsIGVycm9yKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgcmVzb3VyY2VUeXBlOiAnT3BlcmF0aW9uT3V0Y29tZScsXG4gICAgICAgIGlzc3VlOiBbe1xuICAgICAgICAgIHNldmVyaXR5OiAnZXJyb3InLFxuICAgICAgICAgIGNvZGU6ICdleGNlcHRpb24nLFxuICAgICAgICAgIGRpYWdub3N0aWNzOiAnRmFpbGVkIHRvIGxpc3Qgc3Vic2NyaXB0aW9ucycsXG4gICAgICAgIH1dLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBIRUFMVEggQ0hFQ0tcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiBHRVQgL2hlYWx0aCAtIEhlYWx0aCBjaGVjayBlbmRwb2ludFxuICAgKi9cbiAgYXN5bmMgaGVhbHRoQ2hlY2socmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IFttZWRwbHVtSGVhbHRoLCBjZHNIZWFsdGgsIHN1YnNjcmlwdGlvbnNIZWFsdGhdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICBtZWRwbHVtU2VydmljZS5nZXRIZWFsdGhTdGF0dXMoKSxcbiAgICAgICAgY2RzSG9va3NTZXJ2aWNlLmdldEhlYWx0aFN0YXR1cygpLFxuICAgICAgICBzdWJzY3JpcHRpb25zU2VydmljZS5nZXRIZWFsdGhTdGF0dXMoKSxcbiAgICAgIF0pO1xuXG4gICAgICBjb25zdCBvdmVyYWxsU3RhdHVzID0gW21lZHBsdW1IZWFsdGgsIGNkc0hlYWx0aCwgc3Vic2NyaXB0aW9uc0hlYWx0aF1cbiAgICAgICAgLmV2ZXJ5KGhlYWx0aCA9PiBoZWFsdGguc3RhdHVzID09PSAnVVAnKSA/ICdVUCcgOiAnRE9XTic7XG5cbiAgICAgIGNvbnN0IGhlYWx0aFN0YXR1cyA9IHtcbiAgICAgICAgc3RhdHVzOiBvdmVyYWxsU3RhdHVzLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgY29tcG9uZW50czoge1xuICAgICAgICAgIG1lZHBsdW06IG1lZHBsdW1IZWFsdGgsXG4gICAgICAgICAgY2RzSG9va3M6IGNkc0hlYWx0aCxcbiAgICAgICAgICBzdWJzY3JpcHRpb25zOiBzdWJzY3JpcHRpb25zSGVhbHRoLFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgcmVzLnN0YXR1cyhvdmVyYWxsU3RhdHVzID09PSAnVVAnID8gMjAwIDogNTAzKS5qc29uKGhlYWx0aFN0YXR1cyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignSGVhbHRoIGNoZWNrIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICByZXMuc3RhdHVzKDUwMykuanNvbih7XG4gICAgICAgIHN0YXR1czogJ0RPV04nLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgZXJyb3I6ICdIZWFsdGggY2hlY2sgZmFpbGVkJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuXG4vLyBFeHBvcnQgc2luZ2xldG9uIGluc3RhbmNlXG5leHBvcnQgY29uc3QgZmhpckNvbnRyb2xsZXIgPSBuZXcgRkhJUkNvbnRyb2xsZXIoKTsiXSwidmVyc2lvbiI6M30=