da39869b6a4d53b289b6ba9e423fae39
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.medplumService = exports.MedplumService = void 0;
// Import MedplumClient only if not in test environment
let MedplumClient;
if (process.env.NODE_ENV !== 'test') {
    try {
        const medplumCore = require('@medplum/core');
        MedplumClient = medplumCore.MedplumClient;
    }
    catch (error) {
        // Mock MedplumClient for environments where Medplum isn't available
        MedplumClient = class MockMedplumClient {
            constructor(options) { }
            async startClientLogin(clientId, clientSecret) { return Promise.resolve(); }
            async readResource(resourceType, id) {
                return Promise.resolve({ resourceType, id, active: true });
            }
            async createResource(resource) {
                return Promise.resolve({ ...resource, id: `mock-${Date.now()}` });
            }
            async updateResource(resource) {
                return Promise.resolve(resource);
            }
            async deleteResource(resourceType, id) {
                return Promise.resolve();
            }
            async searchResources(resourceType, params) {
                return Promise.resolve({ resourceType: 'Bundle', type: 'searchset', entry: [] });
            }
            async executeBatch(bundle) {
                return Promise.resolve({ resourceType: 'Bundle', type: 'batch-response', entry: [] });
            }
        };
    }
}
else {
    // Mock for tests
    MedplumClient = class MockMedplumClient {
        constructor(options) { }
        async startClientLogin(clientId, clientSecret) { return Promise.resolve(); }
        async readResource(resourceType, id) {
            return Promise.resolve({ resourceType, id, active: true });
        }
        async createResource(resource) {
            return Promise.resolve({ ...resource, id: `mock-${Date.now()}` });
        }
        async updateResource(resource) {
            return Promise.resolve(resource);
        }
        async deleteResource(resourceType, id) {
            return Promise.resolve();
        }
        async searchResources(resourceType, params) {
            return Promise.resolve({ resourceType: 'Bundle', type: 'searchset', entry: [] });
        }
        async executeBatch(bundle) {
            return Promise.resolve({ resourceType: 'Bundle', type: 'batch-response', entry: [] });
        }
    };
}
const config_1 = __importDefault(require("../config"));
const logger_1 = __importDefault(require("../utils/logger"));
const error_utils_1 = require("../utils/error.utils");
/**
 * Medplum FHIR Server Integration Service
 * Handles all interactions with Medplum FHIR server including authentication,
 * resource management, search operations, and batch processing.
 */
class MedplumService {
    medplum;
    isInitialized = false;
    reconnectAttempts = 0;
    maxReconnectAttempts = 5;
    constructor() {
        this.medplum = new MedplumClient({
            baseUrl: config_1.default.medplum.selfHosted ? config_1.default.medplum.selfHostedUrl : config_1.default.medplum.baseUrl,
            clientId: config_1.default.medplum.clientId,
            fhirUrlPath: '/fhir/R4',
            tokenUrl: config_1.default.medplum.selfHosted ?
                `${config_1.default.medplum.selfHostedUrl}/oauth2/token` :
                `${config_1.default.medplum.baseUrl}oauth2/token`,
            authorizeUrl: config_1.default.medplum.selfHosted ?
                `${config_1.default.medplum.selfHostedUrl}/oauth2/authorize` :
                `${config_1.default.medplum.baseUrl}oauth2/authorize`,
        });
    }
    /**
     * Initialize Medplum connection with authentication
     */
    async initialize() {
        try {
            logger_1.default.info('Initializing Medplum FHIR server connection...');
            // Use client credentials flow for both self-hosted and SaaS
            await this.medplum.startClientLogin(config_1.default.medplum.clientId, config_1.default.medplum.clientSecret);
            // Note: Project ID is now handled via the OAuth scope or client configuration
            // The setActiveProject method has been removed in newer versions
            // Test connection with a simple query
            await this.testConnection();
            this.isInitialized = true;
            this.reconnectAttempts = 0;
            logger_1.default.info('Medplum FHIR server connection established successfully');
        }
        catch (error) {
            logger_1.default.error('Failed to initialize Medplum connection:', error);
            if (this.reconnectAttempts < this.maxReconnectAttempts) {
                this.reconnectAttempts++;
                logger_1.default.info(`Retrying connection... Attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
                // Exponential backoff
                const delay = Math.pow(2, this.reconnectAttempts) * 1000;
                setTimeout(() => this.initialize(), delay);
            }
            else {
                throw new Error(`Failed to establish Medplum connection after ${this.maxReconnectAttempts} attempts`);
            }
        }
    }
    /**
     * Test the connection to ensure it's working
     */
    async testConnection() {
        try {
            const response = await this.medplum.readResource('Patient', 'test-patient-id').catch(() => null);
            logger_1.default.debug('Connection test completed successfully');
        }
        catch (error) {
            logger_1.default.warn('Connection test failed, but proceeding...');
        }
    }
    /**
     * Ensure the service is initialized before making requests
     */
    ensureInitialized() {
        if (!this.isInitialized) {
            throw new Error('MedplumService not initialized. Call initialize() first.');
        }
    }
    /**
     * Create a new FHIR resource
     */
    async createResource(resource) {
        this.ensureInitialized();
        try {
            logger_1.default.debug(`Creating ${resource.resourceType} resource`);
            const result = await this.medplum.createResource(resource);
            logger_1.default.info(`Successfully created ${resource.resourceType} with ID: ${result.id}`);
            return result;
        }
        catch (error) {
            logger_1.default.error(`Failed to create ${resource.resourceType} resource:`, error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Read a FHIR resource by ID
     */
    async readResource(resourceType, id) {
        this.ensureInitialized();
        try {
            logger_1.default.debug(`Reading ${resourceType} resource with ID: ${id}`);
            const result = await this.medplum.readResource(resourceType, id);
            logger_1.default.debug(`Successfully retrieved ${resourceType} with ID: ${id}`);
            return result;
        }
        catch (error) {
            logger_1.default.error(`Failed to read ${resourceType} resource with ID ${id}:`, error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Update a FHIR resource
     */
    async updateResource(resource) {
        this.ensureInitialized();
        if (!resource.id) {
            throw new Error('Resource must have an ID to be updated');
        }
        try {
            logger_1.default.debug(`Updating ${resource.resourceType} resource with ID: ${resource.id}`);
            const result = await this.medplum.updateResource(resource);
            logger_1.default.info(`Successfully updated ${resource.resourceType} with ID: ${result.id}`);
            return result;
        }
        catch (error) {
            logger_1.default.error(`Failed to update ${resource.resourceType} resource:`, error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Delete a FHIR resource
     */
    async deleteResource(resourceType, id) {
        this.ensureInitialized();
        try {
            logger_1.default.debug(`Deleting ${resourceType} resource with ID: ${id}`);
            await this.medplum.deleteResource(resourceType, id);
            logger_1.default.info(`Successfully deleted ${resourceType} with ID: ${id}`);
        }
        catch (error) {
            logger_1.default.error(`Failed to delete ${resourceType} resource with ID ${id}:`, error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Search for FHIR resources with proper generic constraints
     */
    async searchResources(resourceType, searchParams = {}) {
        this.ensureInitialized();
        try {
            logger_1.default.debug(`Searching ${resourceType} resources with params:`, searchParams);
            // Convert search params to format expected by searchResources
            const convertedParams = {};
            // Handle standard search parameters
            Object.entries(searchParams).forEach(([key, value]) => {
                if (value !== undefined && value !== null) {
                    convertedParams[key] = value;
                }
            });
            // Use searchResources method which returns ResourceArray with bundle
            const resourceArray = await this.medplum.searchResources(resourceType, convertedParams);
            // Extract resources from the ResourceArray structure
            const resources = Array.isArray(resourceArray) ? resourceArray :
                resourceArray.bundle?.entry?.map((entry) => entry.resource) || [];
            // Create Bundle response
            const bundle = {
                resourceType: 'Bundle',
                type: 'searchset',
                total: resources.length,
                entry: resources.map((resource) => ({
                    resource: resource,
                    fullUrl: `${resource.resourceType}/${resource.id}`
                }))
            };
            logger_1.default.debug(`Search returned ${resources.length} results for ${resourceType}`);
            return bundle;
        }
        catch (error) {
            logger_1.default.error(`Failed to search ${resourceType} resources:`, error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Execute a batch or transaction bundle
     */
    async executeBatch(bundleRequest) {
        this.ensureInitialized();
        try {
            logger_1.default.debug(`Executing ${bundleRequest.type} bundle with ${bundleRequest.resources.length} resources`);
            const bundle = {
                resourceType: 'Bundle',
                type: bundleRequest.type,
                timestamp: bundleRequest.timestamp || new Date().toISOString(),
                entry: bundleRequest.resources.map((resource, index) => ({
                    request: {
                        method: resource.id ? 'PUT' : 'POST',
                        url: resource.id ? `${resource.resourceType}/${resource.id}` : resource.resourceType,
                    },
                    resource: resource,
                })),
            };
            const result = await this.medplum.executeBatch(bundle);
            logger_1.default.info(`Successfully executed ${bundleRequest.type} bundle`);
            return result;
        }
        catch (error) {
            logger_1.default.error(`Failed to execute batch bundle:`, error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Get FHIR capability statement
     */
    async getCapabilityStatement() {
        this.ensureInitialized();
        try {
            logger_1.default.debug('Retrieving FHIR capability statement');
            const result = await this.medplum.get('metadata');
            logger_1.default.debug('Successfully retrieved capability statement');
            return result;
        }
        catch (error) {
            logger_1.default.error('Failed to retrieve capability statement:', error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Execute GraphQL query
     */
    async graphql(query, variables) {
        this.ensureInitialized();
        try {
            logger_1.default.debug('Executing GraphQL query');
            const result = await this.medplum.graphql(query, variables ? JSON.stringify(variables) : undefined);
            logger_1.default.debug('GraphQL query executed successfully');
            return result;
        }
        catch (error) {
            logger_1.default.error('Failed to execute GraphQL query:', error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Subscribe to resource changes
     */
    async createSubscription(criteria, channelType, endpoint) {
        this.ensureInitialized();
        try {
            logger_1.default.debug(`Creating subscription for criteria: ${criteria}`);
            const subscription = {
                resourceType: 'Subscription',
                status: 'requested',
                reason: 'OmniCare EMR Integration',
                criteria,
                channel: {
                    type: channelType,
                    endpoint,
                    payload: 'application/fhir+json',
                    header: endpoint ? [`Authorization: Bearer ${config_1.default.medplum.clientSecret}`] : undefined
                },
            };
            const result = await this.medplum.createResource(subscription);
            logger_1.default.info(`Successfully created subscription with ID: ${result.id}`);
            return result;
        }
        catch (error) {
            logger_1.default.error('Failed to create subscription:', error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Validate a FHIR resource
     */
    async validateResource(resource) {
        this.ensureInitialized();
        try {
            logger_1.default.debug(`Validating ${resource.resourceType} resource`);
            const result = await this.medplum.validateResource(resource);
            logger_1.default.debug(`Validation completed for ${resource.resourceType}`);
            return result;
        }
        catch (error) {
            logger_1.default.error(`Failed to validate ${resource.resourceType} resource:`, error);
            throw this.handleFHIRError(error);
        }
    }
    /**
     * Handle FHIR errors and convert to standard format
     */
    handleFHIRError(error) {
        if ((0, error_utils_1.isFHIRError)(error)) {
            const message = (0, error_utils_1.getFHIRErrorMessage)(error);
            return new Error(`FHIR Error: ${message}`);
        }
        return (0, error_utils_1.isError)(error) ? error : new Error((0, error_utils_1.getErrorMessage)(error));
    }
    /**
     * Get health status of the Medplum service
     */
    async getHealthStatus() {
        try {
            if (!this.isInitialized) {
                return { status: 'DOWN', details: { reason: 'Not initialized' } };
            }
            // Test with a simple metadata call
            const start = Date.now();
            await this.medplum.get('metadata');
            const responseTime = Date.now() - start;
            return {
                status: 'UP',
                details: {
                    responseTime: `${responseTime}ms`,
                    baseUrl: config_1.default.medplum.baseUrl,
                    selfHosted: config_1.default.medplum.selfHosted,
                    initialized: this.isInitialized,
                },
            };
        }
        catch (error) {
            return {
                status: 'DOWN',
                details: {
                    error: (0, error_utils_1.getErrorMessage)(error),
                    reconnectAttempts: this.reconnectAttempts,
                },
            };
        }
    }
    /**
     * Cleanup and close connections
     */
    async shutdown() {
        logger_1.default.info('Shutting down Medplum service...');
        this.isInitialized = false;
        // Additional cleanup if needed
    }
}
exports.MedplumService = MedplumService;
// Export singleton instance
exports.medplumService = new MedplumService();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3JvZHJpZ28vY2xhdWRlLXByb2plY3RzL09tbmlDYXJlL2JhY2tlbmQvc3JjL3NlcnZpY2VzL21lZHBsdW0uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFVQSx1REFBdUQ7QUFDdkQsSUFBSSxhQUFrQixDQUFDO0FBRXZCLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssTUFBTSxFQUFFLENBQUM7SUFDcEMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzdDLGFBQWEsR0FBRyxXQUFXLENBQUMsYUFBYSxDQUFDO0lBQzVDLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2Ysb0VBQW9FO1FBQ3BFLGFBQWEsR0FBRyxNQUFNLGlCQUFpQjtZQUNyQyxZQUFZLE9BQVksSUFBRyxDQUFDO1lBQzVCLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFnQixFQUFFLFlBQW9CLElBQUksT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzVGLEtBQUssQ0FBQyxZQUFZLENBQUMsWUFBb0IsRUFBRSxFQUFVO2dCQUNqRCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQzdELENBQUM7WUFDRCxLQUFLLENBQUMsY0FBYyxDQUFDLFFBQWE7Z0JBQ2hDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUcsUUFBUSxFQUFFLEVBQUUsRUFBRSxRQUFRLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNwRSxDQUFDO1lBQ0QsS0FBSyxDQUFDLGNBQWMsQ0FBQyxRQUFhO2dCQUNoQyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkMsQ0FBQztZQUNELEtBQUssQ0FBQyxjQUFjLENBQUMsWUFBb0IsRUFBRSxF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QVksRUFBRSxHQUFHLFlBQVksSUFBSTtvQkFDakMsT0FBTyxFQUFFLGdCQUFNLENBQUMsT0FBTyxDQUFDLE9BQU87b0JBQy9CLFVBQVUsRUFBRSxnQkFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVO29CQUNyQyxXQUFXLEVBQUUsSUFBSSxDQUFDLGFBQWE7aUJBQ2hDO2FBQ0YsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTztnQkFDTCxNQUFNLEVBQUUsTUFBTTtnQkFDZCxPQUFPLEVBQUU7b0JBQ1AsS0FBSyxFQUFFLElBQUEsNkJBQWUsRUFBQyxLQUFLLENBQUM7b0JBQzdCLGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUI7aUJBQzFDO2FBQ0YsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUTtRQUNaLGdCQUFNLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7UUFDM0IsK0JBQStCO0lBQ2pDLENBQUM7Q0FDRjtBQXJYRCx3Q0FxWEM7QUFFRCw0QkFBNEI7QUFDZixRQUFBLGNBQWMsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9yb2RyaWdvL2NsYXVkZS1wcm9qZWN0cy9PbW5pQ2FyZS9iYWNrZW5kL3NyYy9zZXJ2aWNlcy9tZWRwbHVtLnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gSW1wb3J0IHR5cGVzIHByb3Blcmx5IGZvciBUeXBlU2NyaXB0XG5pbXBvcnQgeyBcbiAgQnVuZGxlLCBcbiAgUGF0aWVudCwgXG4gIFByYWN0aXRpb25lciwgXG4gIE9yZ2FuaXphdGlvbiwgXG4gIFJlc291cmNlLCBcbiAgUmVzb3VyY2VUeXBlIFxufSBmcm9tICdAbWVkcGx1bS9maGlydHlwZXMnO1xuXG4vLyBJbXBvcnQgTWVkcGx1bUNsaWVudCBvbmx5IGlmIG5vdCBpbiB0ZXN0IGVudmlyb25tZW50XG5sZXQgTWVkcGx1bUNsaWVudDogYW55O1xuXG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0Jykge1xuICB0cnkge1xuICAgIGNvbnN0IG1lZHBsdW1Db3JlID0gcmVxdWlyZSgnQG1lZHBsdW0vY29yZScpO1xuICAgIE1lZHBsdW1DbGllbnQgPSBtZWRwbHVtQ29yZS5NZWRwbHVtQ2xpZW50O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIC8vIE1vY2sgTWVkcGx1bUNsaWVudCBmb3IgZW52aXJvbm1lbnRzIHdoZXJlIE1lZHBsdW0gaXNuJ3QgYXZhaWxhYmxlXG4gICAgTWVkcGx1bUNsaWVudCA9IGNsYXNzIE1vY2tNZWRwbHVtQ2xpZW50IHtcbiAgICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IGFueSkge31cbiAgICAgIGFzeW5jIHN0YXJ0Q2xpZW50TG9naW4oY2xpZW50SWQ6IHN0cmluZywgY2xpZW50U2VjcmV0OiBzdHJpbmcpIHsgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOyB9XG4gICAgICBhc3luYyByZWFkUmVzb3VyY2UocmVzb3VyY2VUeXBlOiBzdHJpbmcsIGlkOiBzdHJpbmcpIHsgXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyByZXNvdXJjZVR5cGUsIGlkLCBhY3RpdmU6IHRydWUgfSk7IFxuICAgICAgfVxuICAgICAgYXN5bmMgY3JlYXRlUmVzb3VyY2UocmVzb3VyY2U6IGFueSkgeyBcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IC4uLnJlc291cmNlLCBpZDogYG1vY2stJHtEYXRlLm5vdygpfWAgfSk7IFxuICAgICAgfVxuICAgICAgYXN5bmMgdXBkYXRlUmVzb3VyY2UocmVzb3VyY2U6IGFueSkgeyBcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXNvdXJjZSk7IFxuICAgICAgfVxuICAgICAgYXN5bmMgZGVsZXRlUmVzb3VyY2UocmVzb3VyY2VUeXBlOiBzdHJpbmcsIGlkOiBzdHJpbmcpIHsgXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsgXG4gICAgICB9XG4gICAgICBhc3luYyBzZWFyY2hSZXNvdXJjZXMocmVzb3VyY2VUeXBlOiBzdHJpbmcsIHBhcmFtczogYW55KSB7IFxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcmVzb3VyY2VUeXBlOiAnQnVuZGxlJywgdHlwZTogJ3NlYXJjaHNldCcsIGVudHJ5OiBbXSB9KTsgXG4gICAgICB9XG4gICAgICBhc3luYyBleGVjdXRlQmF0Y2goYnVuZGxlOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJlc291cmNlVHlwZTogJ0J1bmRsZScsIHR5cGU6ICdiYXRjaC1yZXNwb25zZScsIGVudHJ5OiBbXSB9KTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG59IGVsc2Uge1xuICAvLyBNb2NrIGZvciB0ZXN0c1xuICBNZWRwbHVtQ2xpZW50ID0gY2xhc3MgTW9ja01lZHBsdW1DbGllbnQge1xuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IGFueSkge31cbiAgICBhc3luYyBzdGFydENsaWVudExvZ2luKGNsaWVudElkOiBzdHJpbmcsIGNsaWVudFNlY3JldDogc3RyaW5nKSB7IHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsgfVxuICAgIGFzeW5jIHJlYWRSZXNvdXJjZShyZXNvdXJjZVR5cGU6IHN0cmluZywgaWQ6IHN0cmluZykgeyBcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyByZXNvdXJjZVR5cGUsIGlkLCBhY3RpdmU6IHRydWUgfSk7IFxuICAgIH1cbiAgICBhc3luYyBjcmVhdGVSZXNvdXJjZShyZXNvdXJjZTogYW55KSB7IFxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IC4uLnJlc291cmNlLCBpZDogYG1vY2stJHtEYXRlLm5vdygpfWAgfSk7IFxuICAgIH1cbiAgICBhc3luYyB1cGRhdGVSZXNvdXJjZShyZXNvdXJjZTogYW55KSB7IFxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXNvdXJjZSk7IFxuICAgIH1cbiAgICBhc3luYyBkZWxldGVSZXNvdXJjZShyZXNvdXJjZVR5cGU6IHN0cmluZywgaWQ6IHN0cmluZykgeyBcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsgXG4gICAgfVxuICAgIGFzeW5jIHNlYXJjaFJlc291cmNlcyhyZXNvdXJjZVR5cGU6IHN0cmluZywgcGFyYW1zOiBhbnkpIHsgXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcmVzb3VyY2VUeXBlOiAnQnVuZGxlJywgdHlwZTogJ3NlYXJjaHNldCcsIGVudHJ5OiBbXSB9KTsgXG4gICAgfVxuICAgIGFzeW5jIGV4ZWN1dGVCYXRjaChidW5kbGU6IGFueSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJlc291cmNlVHlwZTogJ0J1bmRsZScsIHR5cGU6ICdiYXRjaC1yZXNwb25zZScsIGVudHJ5OiBbXSB9KTtcbiAgICB9XG4gIH07XG59XG5cbmltcG9ydCBjb25maWcgZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCB7IEZISVJTZWFyY2hQYXJhbXMsIEJ1bmRsZVJlcXVlc3QgfSBmcm9tICcuLi90eXBlcy9maGlyJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcbmltcG9ydCB7IGdldEVycm9yTWVzc2FnZSwgaXNGSElSRXJyb3IsIGdldEZISVJFcnJvck1lc3NhZ2UsIGlzRXJyb3IgfSBmcm9tICcuLi91dGlscy9lcnJvci51dGlscyc7XG5cbi8qKlxuICogTWVkcGx1bSBGSElSIFNlcnZlciBJbnRlZ3JhdGlvbiBTZXJ2aWNlXG4gKiBIYW5kbGVzIGFsbCBpbnRlcmFjdGlvbnMgd2l0aCBNZWRwbHVtIEZISVIgc2VydmVyIGluY2x1ZGluZyBhdXRoZW50aWNhdGlvbixcbiAqIHJlc291cmNlIG1hbmFnZW1lbnQsIHNlYXJjaCBvcGVyYXRpb25zLCBhbmQgYmF0Y2ggcHJvY2Vzc2luZy5cbiAqL1xuZXhwb3J0IGNsYXNzIE1lZHBsdW1TZXJ2aWNlIHtcbiAgcHJpdmF0ZSBtZWRwbHVtOiBhbnk7XG4gIHByaXZhdGUgaXNJbml0aWFsaXplZCA9IGZhbHNlO1xuICBwcml2YXRlIHJlY29ubmVjdEF0dGVtcHRzID0gMDtcbiAgcHJpdmF0ZSBtYXhSZWNvbm5lY3RBdHRlbXB0cyA9IDU7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5tZWRwbHVtID0gbmV3IE1lZHBsdW1DbGllbnQoe1xuICAgICAgYmFzZVVybDogY29uZmlnLm1lZHBsdW0uc2VsZkhvc3RlZCA/IGNvbmZpZy5tZWRwbHVtLnNlbGZIb3N0ZWRVcmwgOiBjb25maWcubWVkcGx1bS5iYXNlVXJsLFxuICAgICAgY2xpZW50SWQ6IGNvbmZpZy5tZWRwbHVtLmNsaWVudElkLFxuICAgICAgZmhpclVybFBhdGg6ICcvZmhpci9SNCcsXG4gICAgICB0b2tlblVybDogY29uZmlnLm1lZHBsdW0uc2VsZkhvc3RlZCA/IFxuICAgICAgICBgJHtjb25maWcubWVkcGx1bS5zZWxmSG9zdGVkVXJsfS9vYXV0aDIvdG9rZW5gIDogXG4gICAgICAgIGAke2NvbmZpZy5tZWRwbHVtLmJhc2VVcmx9b2F1dGgyL3Rva2VuYCxcbiAgICAgIGF1dGhvcml6ZVVybDogY29uZmlnLm1lZHBsdW0uc2VsZkhvc3RlZCA/IFxuICAgICAgICBgJHtjb25maWcubWVkcGx1bS5zZWxmSG9zdGVkVXJsfS9vYXV0aDIvYXV0aG9yaXplYCA6IFxuICAgICAgICBgJHtjb25maWcubWVkcGx1bS5iYXNlVXJsfW9hdXRoMi9hdXRob3JpemVgLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgTWVkcGx1bSBjb25uZWN0aW9uIHdpdGggYXV0aGVudGljYXRpb25cbiAgICovXG4gIGFzeW5jIGluaXRpYWxpemUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGxvZ2dlci5pbmZvKCdJbml0aWFsaXppbmcgTWVkcGx1bSBGSElSIHNlcnZlciBjb25uZWN0aW9uLi4uJyk7XG5cbiAgICAgIC8vIFVzZSBjbGllbnQgY3JlZGVudGlhbHMgZmxvdyBmb3IgYm90aCBzZWxmLWhvc3RlZCBhbmQgU2FhU1xuICAgICAgYXdhaXQgdGhpcy5tZWRwbHVtLnN0YXJ0Q2xpZW50TG9naW4oY29uZmlnLm1lZHBsdW0uY2xpZW50SWQsIGNvbmZpZy5tZWRwbHVtLmNsaWVudFNlY3JldCk7XG4gICAgICBcbiAgICAgIC8vIE5vdGU6IFByb2plY3QgSUQgaXMgbm93IGhhbmRsZWQgdmlhIHRoZSBPQXV0aCBzY29wZSBvciBjbGllbnQgY29uZmlndXJhdGlvblxuICAgICAgLy8gVGhlIHNldEFjdGl2ZVByb2plY3QgbWV0aG9kIGhhcyBiZWVuIHJlbW92ZWQgaW4gbmV3ZXIgdmVyc2lvbnNcblxuICAgICAgLy8gVGVzdCBjb25uZWN0aW9uIHdpdGggYSBzaW1wbGUgcXVlcnlcbiAgICAgIGF3YWl0IHRoaXMudGVzdENvbm5lY3Rpb24oKTtcbiAgICAgIFxuICAgICAgdGhpcy5pc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwO1xuICAgICAgXG4gICAgICBsb2dnZXIuaW5mbygnTWVkcGx1bSBGSElSIHNlcnZlciBjb25uZWN0aW9uIGVzdGFibGlzaGVkIHN1Y2Nlc3NmdWxseScpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBpbml0aWFsaXplIE1lZHBsdW0gY29ubmVjdGlvbjonLCBlcnJvcik7XG4gICAgICBcbiAgICAgIGlmICh0aGlzLnJlY29ubmVjdEF0dGVtcHRzIDwgdGhpcy5tYXhSZWNvbm5lY3RBdHRlbXB0cykge1xuICAgICAgICB0aGlzLnJlY29ubmVjdEF0dGVtcHRzKys7XG4gICAgICAgIGxvZ2dlci5pbmZvKGBSZXRyeWluZyBjb25uZWN0aW9uLi4uIEF0dGVtcHQgJHt0aGlzLnJlY29ubmVjdEF0dGVtcHRzfS8ke3RoaXMubWF4UmVjb25uZWN0QXR0ZW1wdHN9YCk7XG4gICAgICAgIFxuICAgICAgICAvLyBFeHBvbmVudGlhbCBiYWNrb2ZmXG4gICAgICAgIGNvbnN0IGRlbGF5ID0gTWF0aC5wb3coMiwgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cykgKiAxMDAwO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuaW5pdGlhbGl6ZSgpLCBkZWxheSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBlc3RhYmxpc2ggTWVkcGx1bSBjb25uZWN0aW9uIGFmdGVyICR7dGhpcy5tYXhSZWNvbm5lY3RBdHRlbXB0c30gYXR0ZW1wdHNgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGVzdCB0aGUgY29ubmVjdGlvbiB0byBlbnN1cmUgaXQncyB3b3JraW5nXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHRlc3RDb25uZWN0aW9uKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMubWVkcGx1bS5yZWFkUmVzb3VyY2UoJ1BhdGllbnQnLCAndGVzdC1wYXRpZW50LWlkJykuY2F0Y2goKCkgPT4gbnVsbCk7XG4gICAgICBsb2dnZXIuZGVidWcoJ0Nvbm5lY3Rpb24gdGVzdCBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci53YXJuKCdDb25uZWN0aW9uIHRlc3QgZmFpbGVkLCBidXQgcHJvY2VlZGluZy4uLicpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFbnN1cmUgdGhlIHNlcnZpY2UgaXMgaW5pdGlhbGl6ZWQgYmVmb3JlIG1ha2luZyByZXF1ZXN0c1xuICAgKi9cbiAgcHJpdmF0ZSBlbnN1cmVJbml0aWFsaXplZCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaXNJbml0aWFsaXplZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNZWRwbHVtU2VydmljZSBub3QgaW5pdGlhbGl6ZWQuIENhbGwgaW5pdGlhbGl6ZSgpIGZpcnN0LicpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgRkhJUiByZXNvdXJjZVxuICAgKi9cbiAgYXN5bmMgY3JlYXRlUmVzb3VyY2U8VCBleHRlbmRzIFJlc291cmNlPihyZXNvdXJjZTogVCk6IFByb21pc2U8VD4ge1xuICAgIHRoaXMuZW5zdXJlSW5pdGlhbGl6ZWQoKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBDcmVhdGluZyAke3Jlc291cmNlLnJlc291cmNlVHlwZX0gcmVzb3VyY2VgKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMubWVkcGx1bS5jcmVhdGVSZXNvdXJjZShyZXNvdXJjZSk7XG4gICAgICBcbiAgICAgIGxvZ2dlci5pbmZvKGBTdWNjZXNzZnVsbHkgY3JlYXRlZCAke3Jlc291cmNlLnJlc291cmNlVHlwZX0gd2l0aCBJRDogJHtyZXN1bHQuaWR9YCk7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBjcmVhdGUgJHtyZXNvdXJjZS5yZXNvdXJjZVR5cGV9IHJlc291cmNlOmAsIGVycm9yKTtcbiAgICAgIHRocm93IHRoaXMuaGFuZGxlRkhJUkVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVhZCBhIEZISVIgcmVzb3VyY2UgYnkgSURcbiAgICovXG4gIGFzeW5jIHJlYWRSZXNvdXJjZTxUIGV4dGVuZHMgUmVzb3VyY2U+KHJlc291cmNlVHlwZTogUmVzb3VyY2VUeXBlLCBpZDogc3RyaW5nKTogUHJvbWlzZTxUPiB7XG4gICAgdGhpcy5lbnN1cmVJbml0aWFsaXplZCgpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBsb2dnZXIuZGVidWcoYFJlYWRpbmcgJHtyZXNvdXJjZVR5cGV9IHJlc291cmNlIHdpdGggSUQ6ICR7aWR9YCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLm1lZHBsdW0ucmVhZFJlc291cmNlKHJlc291cmNlVHlwZSBhcyBhbnksIGlkKTtcbiAgICAgIFxuICAgICAgbG9nZ2VyLmRlYnVnKGBTdWNjZXNzZnVsbHkgcmV0cmlldmVkICR7cmVzb3VyY2VUeXBlfSB3aXRoIElEOiAke2lkfWApO1xuICAgICAgcmV0dXJuIHJlc3VsdCBhcyBUO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoYEZhaWxlZCB0byByZWFkICR7cmVzb3VyY2VUeXBlfSByZXNvdXJjZSB3aXRoIElEICR7aWR9OmAsIGVycm9yKTtcbiAgICAgIHRocm93IHRoaXMuaGFuZGxlRkhJUkVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIGEgRkhJUiByZXNvdXJjZVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlUmVzb3VyY2U8VCBleHRlbmRzIFJlc291cmNlPihyZXNvdXJjZTogVCk6IFByb21pc2U8VD4ge1xuICAgIHRoaXMuZW5zdXJlSW5pdGlhbGl6ZWQoKTtcbiAgICBcbiAgICBpZiAoIXJlc291cmNlLmlkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Jlc291cmNlIG11c3QgaGF2ZSBhbiBJRCB0byBiZSB1cGRhdGVkJyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgVXBkYXRpbmcgJHtyZXNvdXJjZS5yZXNvdXJjZVR5cGV9IHJlc291cmNlIHdpdGggSUQ6ICR7cmVzb3VyY2UuaWR9YCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLm1lZHBsdW0udXBkYXRlUmVzb3VyY2UocmVzb3VyY2UpO1xuICAgICAgXG4gICAgICBsb2dnZXIuaW5mbyhgU3VjY2Vzc2Z1bGx5IHVwZGF0ZWQgJHtyZXNvdXJjZS5yZXNvdXJjZVR5cGV9IHdpdGggSUQ6ICR7cmVzdWx0LmlkfWApO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gdXBkYXRlICR7cmVzb3VyY2UucmVzb3VyY2VUeXBlfSByZXNvdXJjZTpgLCBlcnJvcik7XG4gICAgICB0aHJvdyB0aGlzLmhhbmRsZUZISVJFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhIEZISVIgcmVzb3VyY2VcbiAgICovXG4gIGFzeW5jIGRlbGV0ZVJlc291cmNlKHJlc291cmNlVHlwZTogUmVzb3VyY2VUeXBlLCBpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5lbnN1cmVJbml0aWFsaXplZCgpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBsb2dnZXIuZGVidWcoYERlbGV0aW5nICR7cmVzb3VyY2VUeXBlfSByZXNvdXJjZSB3aXRoIElEOiAke2lkfWApO1xuICAgICAgYXdhaXQgdGhpcy5tZWRwbHVtLmRlbGV0ZVJlc291cmNlKHJlc291cmNlVHlwZSBhcyBhbnksIGlkKTtcbiAgICAgIFxuICAgICAgbG9nZ2VyLmluZm8oYFN1Y2Nlc3NmdWxseSBkZWxldGVkICR7cmVzb3VyY2VUeXBlfSB3aXRoIElEOiAke2lkfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBkZWxldGUgJHtyZXNvdXJjZVR5cGV9IHJlc291cmNlIHdpdGggSUQgJHtpZH06YCwgZXJyb3IpO1xuICAgICAgdGhyb3cgdGhpcy5oYW5kbGVGSElSRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZWFyY2ggZm9yIEZISVIgcmVzb3VyY2VzIHdpdGggcHJvcGVyIGdlbmVyaWMgY29uc3RyYWludHNcbiAgICovXG4gIGFzeW5jIHNlYXJjaFJlc291cmNlczxUIGV4dGVuZHMgUmVzb3VyY2UgJiB7IHJlc291cmNlVHlwZTogUmVzb3VyY2VUeXBlIH0+KFxuICAgIHJlc291cmNlVHlwZTogVFsncmVzb3VyY2VUeXBlJ10sIFxuICAgIHNlYXJjaFBhcmFtczogRkhJUlNlYXJjaFBhcmFtcyA9IHt9XG4gICk6IFByb21pc2U8QnVuZGxlPFQ+PiB7XG4gICAgdGhpcy5lbnN1cmVJbml0aWFsaXplZCgpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBsb2dnZXIuZGVidWcoYFNlYXJjaGluZyAke3Jlc291cmNlVHlwZX0gcmVzb3VyY2VzIHdpdGggcGFyYW1zOmAsIHNlYXJjaFBhcmFtcyk7XG4gICAgICBcbiAgICAgIC8vIENvbnZlcnQgc2VhcmNoIHBhcmFtcyB0byBmb3JtYXQgZXhwZWN0ZWQgYnkgc2VhcmNoUmVzb3VyY2VzXG4gICAgICBjb25zdCBjb252ZXJ0ZWRQYXJhbXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcbiAgICAgIFxuICAgICAgLy8gSGFuZGxlIHN0YW5kYXJkIHNlYXJjaCBwYXJhbWV0ZXJzXG4gICAgICBPYmplY3QuZW50cmllcyhzZWFyY2hQYXJhbXMpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICAgIGNvbnZlcnRlZFBhcmFtc1trZXldID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICAvLyBVc2Ugc2VhcmNoUmVzb3VyY2VzIG1ldGhvZCB3aGljaCByZXR1cm5zIFJlc291cmNlQXJyYXkgd2l0aCBidW5kbGVcbiAgICAgIGNvbnN0IHJlc291cmNlQXJyYXkgPSBhd2FpdCB0aGlzLm1lZHBsdW0uc2VhcmNoUmVzb3VyY2VzKHJlc291cmNlVHlwZSBhcyBhbnksIGNvbnZlcnRlZFBhcmFtcyk7XG4gICAgICBcbiAgICAgIC8vIEV4dHJhY3QgcmVzb3VyY2VzIGZyb20gdGhlIFJlc291cmNlQXJyYXkgc3RydWN0dXJlXG4gICAgICBjb25zdCByZXNvdXJjZXMgPSBBcnJheS5pc0FycmF5KHJlc291cmNlQXJyYXkpID8gcmVzb3VyY2VBcnJheSA6IFxuICAgICAgICAgICAgICAgICAgICAgICAocmVzb3VyY2VBcnJheSBhcyBhbnkpLmJ1bmRsZT8uZW50cnk/Lm1hcCgoZW50cnk6IGFueSkgPT4gZW50cnkucmVzb3VyY2UpIHx8IFtdO1xuICAgICAgXG4gICAgICAvLyBDcmVhdGUgQnVuZGxlIHJlc3BvbnNlXG4gICAgICBjb25zdCBidW5kbGU6IEJ1bmRsZTxUPiA9IHtcbiAgICAgICAgcmVzb3VyY2VUeXBlOiAnQnVuZGxlJyxcbiAgICAgICAgdHlwZTogJ3NlYXJjaHNldCcsXG4gICAgICAgIHRvdGFsOiByZXNvdXJjZXMubGVuZ3RoLFxuICAgICAgICBlbnRyeTogcmVzb3VyY2VzLm1hcCgocmVzb3VyY2U6IGFueSkgPT4gKHtcbiAgICAgICAgICByZXNvdXJjZTogcmVzb3VyY2UgYXMgVCxcbiAgICAgICAgICBmdWxsVXJsOiBgJHtyZXNvdXJjZS5yZXNvdXJjZVR5cGV9LyR7cmVzb3VyY2UuaWR9YFxuICAgICAgICB9KSlcbiAgICAgIH07XG4gICAgICBcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgU2VhcmNoIHJldHVybmVkICR7cmVzb3VyY2VzLmxlbmd0aH0gcmVzdWx0cyBmb3IgJHtyZXNvdXJjZVR5cGV9YCk7XG4gICAgICByZXR1cm4gYnVuZGxlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBzZWFyY2ggJHtyZXNvdXJjZVR5cGV9IHJlc291cmNlczpgLCBlcnJvcik7XG4gICAgICB0aHJvdyB0aGlzLmhhbmRsZUZISVJFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgYSBiYXRjaCBvciB0cmFuc2FjdGlvbiBidW5kbGVcbiAgICovXG4gIGFzeW5jIGV4ZWN1dGVCYXRjaChidW5kbGVSZXF1ZXN0OiBCdW5kbGVSZXF1ZXN0KTogUHJvbWlzZTxCdW5kbGU+IHtcbiAgICB0aGlzLmVuc3VyZUluaXRpYWxpemVkKCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nICR7YnVuZGxlUmVxdWVzdC50eXBlfSBidW5kbGUgd2l0aCAke2J1bmRsZVJlcXVlc3QucmVzb3VyY2VzLmxlbmd0aH0gcmVzb3VyY2VzYCk7XG4gICAgICBcbiAgICAgIGNvbnN0IGJ1bmRsZTogQnVuZGxlID0ge1xuICAgICAgICByZXNvdXJjZVR5cGU6ICdCdW5kbGUnLFxuICAgICAgICB0eXBlOiBidW5kbGVSZXF1ZXN0LnR5cGUsXG4gICAgICAgIHRpbWVzdGFtcDogYnVuZGxlUmVxdWVzdC50aW1lc3RhbXAgfHwgbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICBlbnRyeTogYnVuZGxlUmVxdWVzdC5yZXNvdXJjZXMubWFwKChyZXNvdXJjZSwgaW5kZXgpID0+ICh7XG4gICAgICAgICAgcmVxdWVzdDoge1xuICAgICAgICAgICAgbWV0aG9kOiByZXNvdXJjZS5pZCA/ICdQVVQnIDogJ1BPU1QnLFxuICAgICAgICAgICAgdXJsOiByZXNvdXJjZS5pZCA/IGAke3Jlc291cmNlLnJlc291cmNlVHlwZX0vJHtyZXNvdXJjZS5pZH1gIDogcmVzb3VyY2UucmVzb3VyY2VUeXBlLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcmVzb3VyY2U6IHJlc291cmNlLFxuICAgICAgICB9KSksXG4gICAgICB9O1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLm1lZHBsdW0uZXhlY3V0ZUJhdGNoKGJ1bmRsZSk7XG4gICAgICBcbiAgICAgIGxvZ2dlci5pbmZvKGBTdWNjZXNzZnVsbHkgZXhlY3V0ZWQgJHtidW5kbGVSZXF1ZXN0LnR5cGV9IGJ1bmRsZWApO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gZXhlY3V0ZSBiYXRjaCBidW5kbGU6YCwgZXJyb3IpO1xuICAgICAgdGhyb3cgdGhpcy5oYW5kbGVGSElSRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgRkhJUiBjYXBhYmlsaXR5IHN0YXRlbWVudFxuICAgKi9cbiAgYXN5bmMgZ2V0Q2FwYWJpbGl0eVN0YXRlbWVudCgpOiBQcm9taXNlPGFueT4ge1xuICAgIHRoaXMuZW5zdXJlSW5pdGlhbGl6ZWQoKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdSZXRyaWV2aW5nIEZISVIgY2FwYWJpbGl0eSBzdGF0ZW1lbnQnKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMubWVkcGx1bS5nZXQoJ21ldGFkYXRhJyk7XG4gICAgICBcbiAgICAgIGxvZ2dlci5kZWJ1ZygnU3VjY2Vzc2Z1bGx5IHJldHJpZXZlZCBjYXBhYmlsaXR5IHN0YXRlbWVudCcpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgY2FwYWJpbGl0eSBzdGF0ZW1lbnQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgdGhpcy5oYW5kbGVGSElSRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFeGVjdXRlIEdyYXBoUUwgcXVlcnlcbiAgICovXG4gIGFzeW5jIGdyYXBocWwocXVlcnk6IHN0cmluZywgdmFyaWFibGVzPzogUmVjb3JkPHN0cmluZywgYW55Pik6IFByb21pc2U8YW55PiB7XG4gICAgdGhpcy5lbnN1cmVJbml0aWFsaXplZCgpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0V4ZWN1dGluZyBHcmFwaFFMIHF1ZXJ5Jyk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLm1lZHBsdW0uZ3JhcGhxbChxdWVyeSwgdmFyaWFibGVzID8gSlNPTi5zdHJpbmdpZnkodmFyaWFibGVzKSA6IHVuZGVmaW5lZCk7XG4gICAgICBcbiAgICAgIGxvZ2dlci5kZWJ1ZygnR3JhcGhRTCBxdWVyeSBleGVjdXRlZCBzdWNjZXNzZnVsbHknKTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGV4ZWN1dGUgR3JhcGhRTCBxdWVyeTonLCBlcnJvcik7XG4gICAgICB0aHJvdyB0aGlzLmhhbmRsZUZISVJFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZSB0byByZXNvdXJjZSBjaGFuZ2VzXG4gICAqL1xuICBhc3luYyBjcmVhdGVTdWJzY3JpcHRpb24oY3JpdGVyaWE6IHN0cmluZywgY2hhbm5lbFR5cGU6IHN0cmluZywgZW5kcG9pbnQ/OiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHRoaXMuZW5zdXJlSW5pdGlhbGl6ZWQoKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBDcmVhdGluZyBzdWJzY3JpcHRpb24gZm9yIGNyaXRlcmlhOiAke2NyaXRlcmlhfWApO1xuICAgICAgXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB7XG4gICAgICAgIHJlc291cmNlVHlwZTogJ1N1YnNjcmlwdGlvbicgYXMgY29uc3QsXG4gICAgICAgIHN0YXR1czogJ3JlcXVlc3RlZCcgYXMgY29uc3QsXG4gICAgICAgIHJlYXNvbjogJ09tbmlDYXJlIEVNUiBJbnRlZ3JhdGlvbicsXG4gICAgICAgIGNyaXRlcmlhLFxuICAgICAgICBjaGFubmVsOiB7XG4gICAgICAgICAgdHlwZTogY2hhbm5lbFR5cGUgYXMgYW55LFxuICAgICAgICAgIGVuZHBvaW50LFxuICAgICAgICAgIHBheWxvYWQ6ICdhcHBsaWNhdGlvbi9maGlyK2pzb24nLFxuICAgICAgICAgIGhlYWRlcjogZW5kcG9pbnQgPyBbYEF1dGhvcml6YXRpb246IEJlYXJlciAke2NvbmZpZy5tZWRwbHVtLmNsaWVudFNlY3JldH1gXSA6IHVuZGVmaW5lZFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5tZWRwbHVtLmNyZWF0ZVJlc291cmNlKHN1YnNjcmlwdGlvbik7XG4gICAgICBcbiAgICAgIGxvZ2dlci5pbmZvKGBTdWNjZXNzZnVsbHkgY3JlYXRlZCBzdWJzY3JpcHRpb24gd2l0aCBJRDogJHtyZXN1bHQuaWR9YCk7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgc3Vic2NyaXB0aW9uOicsIGVycm9yKTtcbiAgICAgIHRocm93IHRoaXMuaGFuZGxlRkhJUkVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgYSBGSElSIHJlc291cmNlXG4gICAqL1xuICBhc3luYyB2YWxpZGF0ZVJlc291cmNlPFQgZXh0ZW5kcyBSZXNvdXJjZT4ocmVzb3VyY2U6IFQpOiBQcm9taXNlPGFueT4ge1xuICAgIHRoaXMuZW5zdXJlSW5pdGlhbGl6ZWQoKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBWYWxpZGF0aW5nICR7cmVzb3VyY2UucmVzb3VyY2VUeXBlfSByZXNvdXJjZWApO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5tZWRwbHVtLnZhbGlkYXRlUmVzb3VyY2UocmVzb3VyY2UpO1xuICAgICAgXG4gICAgICBsb2dnZXIuZGVidWcoYFZhbGlkYXRpb24gY29tcGxldGVkIGZvciAke3Jlc291cmNlLnJlc291cmNlVHlwZX1gKTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHZhbGlkYXRlICR7cmVzb3VyY2UucmVzb3VyY2VUeXBlfSByZXNvdXJjZTpgLCBlcnJvcik7XG4gICAgICB0aHJvdyB0aGlzLmhhbmRsZUZISVJFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cblxuICAvKipcbiAgICogSGFuZGxlIEZISVIgZXJyb3JzIGFuZCBjb252ZXJ0IHRvIHN0YW5kYXJkIGZvcm1hdFxuICAgKi9cbiAgcHJpdmF0ZSBoYW5kbGVGSElSRXJyb3IoZXJyb3I6IHVua25vd24pOiBFcnJvciB7XG4gICAgaWYgKGlzRkhJUkVycm9yKGVycm9yKSkge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGdldEZISVJFcnJvck1lc3NhZ2UoZXJyb3IpO1xuICAgICAgcmV0dXJuIG5ldyBFcnJvcihgRkhJUiBFcnJvcjogJHttZXNzYWdlfWApO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gaXNFcnJvcihlcnJvcikgPyBlcnJvciA6IG5ldyBFcnJvcihnZXRFcnJvck1lc3NhZ2UoZXJyb3IpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgaGVhbHRoIHN0YXR1cyBvZiB0aGUgTWVkcGx1bSBzZXJ2aWNlXG4gICAqL1xuICBhc3luYyBnZXRIZWFsdGhTdGF0dXMoKTogUHJvbWlzZTx7IHN0YXR1czogc3RyaW5nOyBkZXRhaWxzOiBhbnkgfT4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXRoaXMuaXNJbml0aWFsaXplZCkge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6ICdET1dOJywgZGV0YWlsczogeyByZWFzb246ICdOb3QgaW5pdGlhbGl6ZWQnIH0gfTtcbiAgICAgIH1cblxuICAgICAgLy8gVGVzdCB3aXRoIGEgc2ltcGxlIG1ldGFkYXRhIGNhbGxcbiAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICAgIGF3YWl0IHRoaXMubWVkcGx1bS5nZXQoJ21ldGFkYXRhJyk7XG4gICAgICBjb25zdCByZXNwb25zZVRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnQ7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1czogJ1VQJyxcbiAgICAgICAgZGV0YWlsczoge1xuICAgICAgICAgIHJlc3BvbnNlVGltZTogYCR7cmVzcG9uc2VUaW1lfW1zYCxcbiAgICAgICAgICBiYXNlVXJsOiBjb25maWcubWVkcGx1bS5iYXNlVXJsLFxuICAgICAgICAgIHNlbGZIb3N0ZWQ6IGNvbmZpZy5tZWRwbHVtLnNlbGZIb3N0ZWQsXG4gICAgICAgICAgaW5pdGlhbGl6ZWQ6IHRoaXMuaXNJbml0aWFsaXplZCxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1czogJ0RPV04nLFxuICAgICAgICBkZXRhaWxzOiB7XG4gICAgICAgICAgZXJyb3I6IGdldEVycm9yTWVzc2FnZShlcnJvciksXG4gICAgICAgICAgcmVjb25uZWN0QXR0ZW1wdHM6IHRoaXMucmVjb25uZWN0QXR0ZW1wdHMsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbnVwIGFuZCBjbG9zZSBjb25uZWN0aW9uc1xuICAgKi9cbiAgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgbG9nZ2VyLmluZm8oJ1NodXR0aW5nIGRvd24gTWVkcGx1bSBzZXJ2aWNlLi4uJyk7XG4gICAgdGhpcy5pc0luaXRpYWxpemVkID0gZmFsc2U7XG4gICAgLy8gQWRkaXRpb25hbCBjbGVhbnVwIGlmIG5lZWRlZFxuICB9XG59XG5cbi8vIEV4cG9ydCBzaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCBtZWRwbHVtU2VydmljZSA9IG5ldyBNZWRwbHVtU2VydmljZSgpOyJdLCJ2ZXJzaW9uIjozfQ==