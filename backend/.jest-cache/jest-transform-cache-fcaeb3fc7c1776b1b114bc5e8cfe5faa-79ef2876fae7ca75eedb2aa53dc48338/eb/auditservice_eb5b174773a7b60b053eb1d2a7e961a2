4a2bf154b0cd5a250dfd9aae9964938f
"use strict";
/**
 * OmniCare EMR Backend - Audit Logging Service
 * HIPAA-Compliant Audit Trail
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuditService = void 0;
const crypto_1 = __importDefault(require("crypto"));
const events_1 = require("events");
class AuditService extends events_1.EventEmitter {
    encryptionKey;
    auditEntries = [];
    constructor() {
        super();
        this.encryptionKey = process.env.AUDIT_ENCRYPTION_KEY || 'default-audit-key-change-in-production';
    }
    /**
     * Log a user action audit entry
     */
    async logUserAction(userId, action, resource, resourceId, ipAddress, userAgent, success = true, errorMessage, additionalData) {
        const entry = {
            id: this.generateAuditId(),
            userId,
            action,
            resource,
            resourceId,
            ipAddress,
            userAgent,
            timestamp: new Date(),
            success,
            errorMessage,
            additionalData: additionalData ? this.encryptSensitiveData(additionalData) : undefined
        };
        // Store in memory (in production, this would go to a database)
        this.auditEntries.push(entry);
        // Console log for development
        console.log('Audit Entry:', JSON.stringify(entry, null, 2));
        // Emit event for additional processing
        this.emit('auditEntry', entry);
        // Check if this action requires security monitoring
        if (this.isSecurityRelevantAction(action)) {
            const securityEvent = {
                type: this.mapActionToSecurityEventType(action),
                userId,
                severity: this.determineSeverity(action, success),
                description: `User action: ${action} on ${resource}`,
                metadata: { action, resource, resourceId, success, ipAddress }
            };
            await this.logSecurityEvent(securityEvent);
        }
    }
    /**
     * Log a security event
     */
    async logSecurityEvent(event) {
        const logEntry = {
            ...event,
            timestamp: new Date(),
            id: this.generateAuditId()
        };
        // Console log for development
        console.log('Security Event:', JSON.stringify(logEntry, null, 2));
        // Emit event for additional processing
        this.emit('securityEvent', event);
        // Handle critical events immediately
        if (event.severity === 'CRITICAL' || event.severity === 'HIGH') {
            await this.handleCriticalSecurityEvent(event);
        }
    }
    /**
     * Generate HIPAA compliance report
     */
    async generateHipaaComplianceReport(startDate, endDate, generatedBy) {
        const reportId = this.generateAuditId();
        // Filter audit entries by date range
        const data = this.auditEntries.filter(entry => entry.timestamp >= startDate && entry.timestamp <= endDate);
        const summary = {
            totalAccesses: data.length,
            uniqueUsers: new Set(data.map(entry => entry.userId)).size,
            failedAttempts: data.filter(entry => !entry.success).length,
            securityIncidents: data.filter(entry => this.isSecurityRelevantAction(entry.action) && !entry.success).length
        };
        const report = {
            reportId,
            reportType: 'HIPAA_ACCESS_LOG',
            generatedBy,
            dateRange: { start: startDate, end: endDate },
            data,
            summary,
            createdAt: new Date()
        };
        // Log report generation
        await this.logSecurityEvent({
            type: 'SYSTEM_CONFIGURATION_CHANGE',
            userId: generatedBy,
            severity: 'MEDIUM',
            description: `HIPAA compliance report generated for period ${startDate.toISOString()} to ${endDate.toISOString()}`,
            metadata: { reportId, reportType: 'HIPAA_ACCESS_LOG' }
        });
        return report;
    }
    /**
     * Search audit logs
     */
    async searchAuditLogs(query, filters) {
        let results = this.auditEntries;
        // Apply filters
        if (filters) {
            if (filters.userId) {
                results = results.filter(entry => entry.userId === filters.userId);
            }
            if (filters.action) {
                results = results.filter(entry => entry.action.includes(filters.action));
            }
            if (filters.resource) {
                results = results.filter(entry => entry.resource === filters.resource);
            }
            if (filters.startDate) {
                results = results.filter(entry => entry.timestamp >= filters.startDate);
            }
            if (filters.endDate) {
                results = results.filter(entry => entry.timestamp <= filters.endDate);
            }
            if (filters.success !== undefined) {
                results = results.filter(entry => entry.success === filters.success);
            }
            if (filters.ipAddress) {
                results = results.filter(entry => entry.ipAddress === filters.ipAddress);
            }
        }
        // Apply text search
        if (query) {
            results = results.filter(entry => JSON.stringify(entry).toLowerCase().includes(query.toLowerCase()));
        }
        // Apply pagination
        if (filters?.limit) {
            const offset = filters.offset || 0;
            results = results.slice(offset, offset + filters.limit);
        }
        return results;
    }
    /**
     * Get audit statistics
     */
    async getAuditStatistics(timeframe = 'daily') {
        const now = new Date();
        let startDate;
        switch (timeframe) {
            case 'daily':
                startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                break;
            case 'weekly':
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                break;
            case 'monthly':
                startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                break;
        }
        const relevantEntries = this.auditEntries.filter(entry => entry.timestamp >= startDate);
        const eventsByType = {};
        const eventsByUser = {};
        const resourceCounts = {};
        relevantEntries.forEach(entry => {
            eventsByType[entry.action] = (eventsByType[entry.action] || 0) + 1;
            eventsByUser[entry.userId] = (eventsByUser[entry.userId] || 0) + 1;
            resourceCounts[entry.resource] = (resourceCounts[entry.resource] || 0) + 1;
        });
        const topResources = Object.entries(resourceCounts)
            .map(([resource, count]) => ({ resource, count }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 10);
        return {
            totalEvents: relevantEntries.length,
            successfulEvents: relevantEntries.filter(entry => entry.success).length,
            failedEvents: relevantEntries.filter(entry => !entry.success).length,
            uniqueUsers: new Set(relevantEntries.map(entry => entry.userId)).size,
            eventsByType,
            eventsByUser,
            topResources,
            securityIncidents: relevantEntries.filter(entry => this.isSecurityRelevantAction(entry.action) && !entry.success).length
        };
    }
    /**
     * Handle critical security events
     */
    async handleCriticalSecurityEvent(event) {
        console.error(`CRITICAL SECURITY EVENT: ${event.type} - ${event.description}`);
        // Emit critical event for external handling
        this.emit('criticalSecurityEvent', event);
    }
    /**
     * Generate cryptographically secure audit ID
     */
    generateAuditId() {
        const timestamp = Date.now().toString(36);
        const random = crypto_1.default.randomBytes(8).toString('hex');
        return `audit_${timestamp}_${random}`;
    }
    /**
     * Encrypt sensitive data in audit logs
     */
    encryptSensitiveData(data) {
        const encrypted = {};
        for (const [key, value] of Object.entries(data)) {
            if (this.isSensitiveField(key)) {
                encrypted[key] = `encrypted:${crypto_1.default.createHash('sha256').update(JSON.stringify(value) + this.encryptionKey).digest('hex')}`;
            }
            else {
                encrypted[key] = value;
            }
        }
        return encrypted;
    }
    /**
     * Check if field contains sensitive data
     */
    isSensitiveField(fieldName) {
        const sensitiveFields = [
            'password', 'ssn', 'dob', 'phone', 'email',
            'address', 'medicalRecord', 'diagnosis',
            'treatment', 'medication', 'notes'
        ];
        return sensitiveFields.some(field => fieldName.toLowerCase().includes(field));
    }
    /**
     * Check if action is security relevant
     */
    isSecurityRelevantAction(action) {
        const securityActions = [
            'login', 'logout', 'password_change', 'mfa_setup',
            'user_creation', 'user_modification', 'permission_change',
            'data_access', 'data_modification', 'data_deletion',
            'system_configuration', 'backup', 'restore'
        ];
        return securityActions.some(secAction => action.toLowerCase().includes(secAction));
    }
    /**
     * Map action to security event type
     */
    mapActionToSecurityEventType(action) {
        const actionLower = action.toLowerCase();
        if (actionLower.includes('login'))
            return 'LOGIN_SUCCESS';
        if (actionLower.includes('logout'))
            return 'LOGOUT';
        if (actionLower.includes('password'))
            return 'PASSWORD_CHANGE';
        if (actionLower.includes('data_access'))
            return 'DATA_ACCESS';
        if (actionLower.includes('data_modification'))
            return 'DATA_MODIFICATION';
        if (actionLower.includes('unauthorized'))
            return 'UNAUTHORIZED_ACCESS';
        return 'DATA_ACCESS'; // Default
    }
    /**
     * Determine event severity
     */
    determineSeverity(action, success) {
        if (!success) {
            if (action.includes('login') || action.includes('unauthorized')) {
                return 'HIGH';
            }
            return 'MEDIUM';
        }
        if (action.includes('system_configuration') || action.includes('user_creation')) {
            return 'MEDIUM';
        }
        return 'LOW';
    }
    /**
     * Shutdown audit service
     */
    shutdown() {
        this.removeAllListeners();
    }
}
exports.AuditService = AuditService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3JvZHJpZ28vY2xhdWRlLXByb2plY3RzL09tbmlDYXJlL2JhY2tlbmQvc3JjL3NlcnZpY2VzL2F1ZGl0LnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7Ozs7O0FBRUgsb0RBQTRCO0FBQzVCLG1DQUFzQztBQTJCdEMsTUFBYSxZQUFhLFNBQVEscUJBQVk7SUFDcEMsYUFBYSxDQUFTO0lBQ3RCLFlBQVksR0FBb0IsRUFBRSxDQUFDO0lBRTNDO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLElBQUksd0NBQXdDLENBQUM7SUFDcEcsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FDakIsTUFBYyxFQUNkLE1BQWMsRUFDZCxRQUFnQixFQUNoQixVQUE4QixFQUM5QixTQUFpQixFQUNqQixTQUFpQixFQUNqQixVQUFtQixJQUFJLEVBQ3ZCLFlBQXFCLEVBQ3JCLGNBQW9DO1FBRXBDLE1BQU0sS0FBSyxHQUFrQjtZQUMzQixFQUFFLEVBQUUsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUMxQixNQUFNO1lBQ04sTUFBTTtZQUNOLFFBQVE7WUFDUixVQUFVO1lBQ1YsU0FBUztZQUNULFNBQVM7WUFDVCxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDckIsT0FBTztZQUNQLFlBQVk7WUFDWixjQUFjLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVM7U0FDdkYsQ0FBQztRQUVGLCtEQUErRDtRQUMvRCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU5Qiw4QkFBOEI7UUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7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a0IsRUFBRSxDQUFDO0lBQzVCLENBQUM7Q0FDRjtBQWpWRCxvQ0FpVkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3JvZHJpZ28vY2xhdWRlLXByb2plY3RzL09tbmlDYXJlL2JhY2tlbmQvc3JjL3NlcnZpY2VzL2F1ZGl0LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBPbW5pQ2FyZSBFTVIgQmFja2VuZCAtIEF1ZGl0IExvZ2dpbmcgU2VydmljZVxuICogSElQQUEtQ29tcGxpYW50IEF1ZGl0IFRyYWlsXG4gKi9cblxuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcblxuaW1wb3J0IHsgQXVkaXRMb2dFbnRyeSwgU2VjdXJpdHlFdmVudCwgQ29tcGxpYW5jZVJlcG9ydCB9IGZyb20gJ0AvdHlwZXMvYXV0aC50eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXVkaXRGaWx0ZXJzIHtcbiAgdXNlcklkPzogc3RyaW5nO1xuICBhY3Rpb24/OiBzdHJpbmc7XG4gIHJlc291cmNlPzogc3RyaW5nO1xuICBzdGFydERhdGU/OiBEYXRlO1xuICBlbmREYXRlPzogRGF0ZTtcbiAgc3VjY2Vzcz86IGJvb2xlYW47XG4gIGlwQWRkcmVzcz86IHN0cmluZztcbiAgbGltaXQ/OiBudW1iZXI7XG4gIG9mZnNldD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdWRpdFN0YXRpc3RpY3Mge1xuICB0b3RhbEV2ZW50czogbnVtYmVyO1xuICBzdWNjZXNzZnVsRXZlbnRzOiBudW1iZXI7XG4gIGZhaWxlZEV2ZW50czogbnVtYmVyO1xuICB1bmlxdWVVc2VyczogbnVtYmVyO1xuICBldmVudHNCeVR5cGU6IFJlY29yZDxzdHJpbmcsIG51bWJlcj47XG4gIGV2ZW50c0J5VXNlcjogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgdG9wUmVzb3VyY2VzOiBBcnJheTx7IHJlc291cmNlOiBzdHJpbmc7IGNvdW50OiBudW1iZXIgfT47XG4gIHNlY3VyaXR5SW5jaWRlbnRzOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBBdWRpdFNlcnZpY2UgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBwcml2YXRlIGVuY3J5cHRpb25LZXk6IHN0cmluZztcbiAgcHJpdmF0ZSBhdWRpdEVudHJpZXM6IEF1ZGl0TG9nRW50cnlbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5lbmNyeXB0aW9uS2V5ID0gcHJvY2Vzcy5lbnYuQVVESVRfRU5DUllQVElPTl9LRVkgfHwgJ2RlZmF1bHQtYXVkaXQta2V5LWNoYW5nZS1pbi1wcm9kdWN0aW9uJztcbiAgfVxuXG4gIC8qKlxuICAgKiBMb2cgYSB1c2VyIGFjdGlvbiBhdWRpdCBlbnRyeVxuICAgKi9cbiAgYXN5bmMgbG9nVXNlckFjdGlvbihcbiAgICB1c2VySWQ6IHN0cmluZyxcbiAgICBhY3Rpb246IHN0cmluZyxcbiAgICByZXNvdXJjZTogc3RyaW5nLFxuICAgIHJlc291cmNlSWQ6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICBpcEFkZHJlc3M6IHN0cmluZyxcbiAgICB1c2VyQWdlbnQ6IHN0cmluZyxcbiAgICBzdWNjZXNzOiBib29sZWFuID0gdHJ1ZSxcbiAgICBlcnJvck1lc3NhZ2U/OiBzdHJpbmcsXG4gICAgYWRkaXRpb25hbERhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGVudHJ5OiBBdWRpdExvZ0VudHJ5ID0ge1xuICAgICAgaWQ6IHRoaXMuZ2VuZXJhdGVBdWRpdElkKCksXG4gICAgICB1c2VySWQsXG4gICAgICBhY3Rpb24sXG4gICAgICByZXNvdXJjZSxcbiAgICAgIHJlc291cmNlSWQsXG4gICAgICBpcEFkZHJlc3MsXG4gICAgICB1c2VyQWdlbnQsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICBzdWNjZXNzLFxuICAgICAgZXJyb3JNZXNzYWdlLFxuICAgICAgYWRkaXRpb25hbERhdGE6IGFkZGl0aW9uYWxEYXRhID8gdGhpcy5lbmNyeXB0U2Vuc2l0aXZlRGF0YShhZGRpdGlvbmFsRGF0YSkgOiB1bmRlZmluZWRcbiAgICB9O1xuXG4gICAgLy8gU3RvcmUgaW4gbWVtb3J5IChpbiBwcm9kdWN0aW9uLCB0aGlzIHdvdWxkIGdvIHRvIGEgZGF0YWJhc2UpXG4gICAgdGhpcy5hdWRpdEVudHJpZXMucHVzaChlbnRyeSk7XG5cbiAgICAvLyBDb25zb2xlIGxvZyBmb3IgZGV2ZWxvcG1lbnRcbiAgICBjb25zb2xlLmxvZygnQXVkaXQgRW50cnk6JywgSlNPTi5zdHJpbmdpZnkoZW50cnksIG51bGwsIDIpKTtcblxuICAgIC8vIEVtaXQgZXZlbnQgZm9yIGFkZGl0aW9uYWwgcHJvY2Vzc2luZ1xuICAgIHRoaXMuZW1pdCgnYXVkaXRFbnRyeScsIGVudHJ5KTtcblxuICAgIC8vIENoZWNrIGlmIHRoaXMgYWN0aW9uIHJlcXVpcmVzIHNlY3VyaXR5IG1vbml0b3JpbmdcbiAgICBpZiAodGhpcy5pc1NlY3VyaXR5UmVsZXZhbnRBY3Rpb24oYWN0aW9uKSkge1xuICAgICAgY29uc3Qgc2VjdXJpdHlFdmVudDogU2VjdXJpdHlFdmVudCA9IHtcbiAgICAgICAgdHlwZTogdGhpcy5tYXBBY3Rpb25Ub1NlY3VyaXR5RXZlbnRUeXBlKGFjdGlvbiksXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgc2V2ZXJpdHk6IHRoaXMuZGV0ZXJtaW5lU2V2ZXJpdHkoYWN0aW9uLCBzdWNjZXNzKSxcbiAgICAgICAgZGVzY3JpcHRpb246IGBVc2VyIGFjdGlvbjogJHthY3Rpb259IG9uICR7cmVzb3VyY2V9YCxcbiAgICAgICAgbWV0YWRhdGE6IHsgYWN0aW9uLCByZXNvdXJjZSwgcmVzb3VyY2VJZCwgc3VjY2VzcywgaXBBZGRyZXNzIH1cbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IHRoaXMubG9nU2VjdXJpdHlFdmVudChzZWN1cml0eUV2ZW50KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTG9nIGEgc2VjdXJpdHkgZXZlbnRcbiAgICovXG4gIGFzeW5jIGxvZ1NlY3VyaXR5RXZlbnQoZXZlbnQ6IFNlY3VyaXR5RXZlbnQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBsb2dFbnRyeSA9IHtcbiAgICAgIC4uLmV2ZW50LFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgaWQ6IHRoaXMuZ2VuZXJhdGVBdWRpdElkKClcbiAgICB9O1xuXG4gICAgLy8gQ29uc29sZSBsb2cgZm9yIGRldmVsb3BtZW50XG4gICAgY29uc29sZS5sb2coJ1NlY3VyaXR5IEV2ZW50OicsIEpTT04uc3RyaW5naWZ5KGxvZ0VudHJ5LCBudWxsLCAyKSk7XG5cbiAgICAvLyBFbWl0IGV2ZW50IGZvciBhZGRpdGlvbmFsIHByb2Nlc3NpbmdcbiAgICB0aGlzLmVtaXQoJ3NlY3VyaXR5RXZlbnQnLCBldmVudCk7XG5cbiAgICAvLyBIYW5kbGUgY3JpdGljYWwgZXZlbnRzIGltbWVkaWF0ZWx5XG4gICAgaWYgKGV2ZW50LnNldmVyaXR5ID09PSAnQ1JJVElDQUwnIHx8IGV2ZW50LnNldmVyaXR5ID09PSAnSElHSCcpIHtcbiAgICAgIGF3YWl0IHRoaXMuaGFuZGxlQ3JpdGljYWxTZWN1cml0eUV2ZW50KGV2ZW50KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgSElQQUEgY29tcGxpYW5jZSByZXBvcnRcbiAgICovXG4gIGFzeW5jIGdlbmVyYXRlSGlwYWFDb21wbGlhbmNlUmVwb3J0KFxuICAgIHN0YXJ0RGF0ZTogRGF0ZSxcbiAgICBlbmREYXRlOiBEYXRlLFxuICAgIGdlbmVyYXRlZEJ5OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxDb21wbGlhbmNlUmVwb3J0PiB7XG4gICAgY29uc3QgcmVwb3J0SWQgPSB0aGlzLmdlbmVyYXRlQXVkaXRJZCgpO1xuICAgIFxuICAgIC8vIEZpbHRlciBhdWRpdCBlbnRyaWVzIGJ5IGRhdGUgcmFuZ2VcbiAgICBjb25zdCBkYXRhID0gdGhpcy5hdWRpdEVudHJpZXMuZmlsdGVyKGVudHJ5ID0+IFxuICAgICAgZW50cnkudGltZXN0YW1wID49IHN0YXJ0RGF0ZSAmJiBlbnRyeS50aW1lc3RhbXAgPD0gZW5kRGF0ZVxuICAgICk7XG5cbiAgICBjb25zdCBzdW1tYXJ5ID0ge1xuICAgICAgdG90YWxBY2Nlc3NlczogZGF0YS5sZW5ndGgsXG4gICAgICB1bmlxdWVVc2VyczogbmV3IFNldChkYXRhLm1hcChlbnRyeSA9PiBlbnRyeS51c2VySWQpKS5zaXplLFxuICAgICAgZmFpbGVkQXR0ZW1wdHM6IGRhdGEuZmlsdGVyKGVudHJ5ID0+ICFlbnRyeS5zdWNjZXNzKS5sZW5ndGgsXG4gICAgICBzZWN1cml0eUluY2lkZW50czogZGF0YS5maWx0ZXIoZW50cnkgPT4gXG4gICAgICAgIHRoaXMuaXNTZWN1cml0eVJlbGV2YW50QWN0aW9uKGVudHJ5LmFjdGlvbikgJiYgIWVudHJ5LnN1Y2Nlc3NcbiAgICAgICkubGVuZ3RoXG4gICAgfTtcblxuICAgIGNvbnN0IHJlcG9ydDogQ29tcGxpYW5jZVJlcG9ydCA9IHtcbiAgICAgIHJlcG9ydElkLFxuICAgICAgcmVwb3J0VHlwZTogJ0hJUEFBX0FDQ0VTU19MT0cnLFxuICAgICAgZ2VuZXJhdGVkQnksXG4gICAgICBkYXRlUmFuZ2U6IHsgc3RhcnQ6IHN0YXJ0RGF0ZSwgZW5kOiBlbmREYXRlIH0sXG4gICAgICBkYXRhLFxuICAgICAgc3VtbWFyeSxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKVxuICAgIH07XG5cbiAgICAvLyBMb2cgcmVwb3J0IGdlbmVyYXRpb25cbiAgICBhd2FpdCB0aGlzLmxvZ1NlY3VyaXR5RXZlbnQoe1xuICAgICAgdHlwZTogJ1NZU1RFTV9DT05GSUdVUkFUSU9OX0NIQU5HRScsXG4gICAgICB1c2VySWQ6IGdlbmVyYXRlZEJ5LFxuICAgICAgc2V2ZXJpdHk6ICdNRURJVU0nLFxuICAgICAgZGVzY3JpcHRpb246IGBISVBBQSBjb21wbGlhbmNlIHJlcG9ydCBnZW5lcmF0ZWQgZm9yIHBlcmlvZCAke3N0YXJ0RGF0ZS50b0lTT1N0cmluZygpfSB0byAke2VuZERhdGUudG9JU09TdHJpbmcoKX1gLFxuICAgICAgbWV0YWRhdGE6IHsgcmVwb3J0SWQsIHJlcG9ydFR5cGU6ICdISVBBQV9BQ0NFU1NfTE9HJyB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVwb3J0O1xuICB9XG5cbiAgLyoqXG4gICAqIFNlYXJjaCBhdWRpdCBsb2dzXG4gICAqL1xuICBhc3luYyBzZWFyY2hBdWRpdExvZ3MoXG4gICAgcXVlcnk6IHN0cmluZyxcbiAgICBmaWx0ZXJzPzogQXVkaXRGaWx0ZXJzXG4gICk6IFByb21pc2U8QXVkaXRMb2dFbnRyeVtdPiB7XG4gICAgbGV0IHJlc3VsdHMgPSB0aGlzLmF1ZGl0RW50cmllcztcblxuICAgIC8vIEFwcGx5IGZpbHRlcnNcbiAgICBpZiAoZmlsdGVycykge1xuICAgICAgaWYgKGZpbHRlcnMudXNlcklkKSB7XG4gICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihlbnRyeSA9PiBlbnRyeS51c2VySWQgPT09IGZpbHRlcnMudXNlcklkKTtcbiAgICAgIH1cbiAgICAgIGlmIChmaWx0ZXJzLmFjdGlvbikge1xuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoZW50cnkgPT4gZW50cnkuYWN0aW9uLmluY2x1ZGVzKGZpbHRlcnMuYWN0aW9uISkpO1xuICAgICAgfVxuICAgICAgaWYgKGZpbHRlcnMucmVzb3VyY2UpIHtcbiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKGVudHJ5ID0+IGVudHJ5LnJlc291cmNlID09PSBmaWx0ZXJzLnJlc291cmNlKTtcbiAgICAgIH1cbiAgICAgIGlmIChmaWx0ZXJzLnN0YXJ0RGF0ZSkge1xuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoZW50cnkgPT4gZW50cnkudGltZXN0YW1wID49IGZpbHRlcnMuc3RhcnREYXRlISk7XG4gICAgICB9XG4gICAgICBpZiAoZmlsdGVycy5lbmREYXRlKSB7XG4gICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihlbnRyeSA9PiBlbnRyeS50aW1lc3RhbXAgPD0gZmlsdGVycy5lbmREYXRlISk7XG4gICAgICB9XG4gICAgICBpZiAoZmlsdGVycy5zdWNjZXNzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKGVudHJ5ID0+IGVudHJ5LnN1Y2Nlc3MgPT09IGZpbHRlcnMuc3VjY2Vzcyk7XG4gICAgICB9XG4gICAgICBpZiAoZmlsdGVycy5pcEFkZHJlc3MpIHtcbiAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKGVudHJ5ID0+IGVudHJ5LmlwQWRkcmVzcyA9PT0gZmlsdGVycy5pcEFkZHJlc3MpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEFwcGx5IHRleHQgc2VhcmNoXG4gICAgaWYgKHF1ZXJ5KSB7XG4gICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoZW50cnkgPT4gXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KGVudHJ5KS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHF1ZXJ5LnRvTG93ZXJDYXNlKCkpXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEFwcGx5IHBhZ2luYXRpb25cbiAgICBpZiAoZmlsdGVycz8ubGltaXQpIHtcbiAgICAgIGNvbnN0IG9mZnNldCA9IGZpbHRlcnMub2Zmc2V0IHx8IDA7XG4gICAgICByZXN1bHRzID0gcmVzdWx0cy5zbGljZShvZmZzZXQsIG9mZnNldCArIGZpbHRlcnMubGltaXQpO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHRzO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhdWRpdCBzdGF0aXN0aWNzXG4gICAqL1xuICBhc3luYyBnZXRBdWRpdFN0YXRpc3RpY3MoXG4gICAgdGltZWZyYW1lOiAnZGFpbHknIHwgJ3dlZWtseScgfCAnbW9udGhseScgPSAnZGFpbHknXG4gICk6IFByb21pc2U8QXVkaXRTdGF0aXN0aWNzPiB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBsZXQgc3RhcnREYXRlOiBEYXRlO1xuXG4gICAgc3dpdGNoICh0aW1lZnJhbWUpIHtcbiAgICAgIGNhc2UgJ2RhaWx5JzpcbiAgICAgICAgc3RhcnREYXRlID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3dlZWtseSc6XG4gICAgICAgIHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgLSA3ICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnbW9udGhseSc6XG4gICAgICAgIHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgLSAzMCAqIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjb25zdCByZWxldmFudEVudHJpZXMgPSB0aGlzLmF1ZGl0RW50cmllcy5maWx0ZXIoZW50cnkgPT4gZW50cnkudGltZXN0YW1wID49IHN0YXJ0RGF0ZSk7XG5cbiAgICBjb25zdCBldmVudHNCeVR5cGU6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcbiAgICBjb25zdCBldmVudHNCeVVzZXI6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcbiAgICBjb25zdCByZXNvdXJjZUNvdW50czogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHt9O1xuXG4gICAgcmVsZXZhbnRFbnRyaWVzLmZvckVhY2goZW50cnkgPT4ge1xuICAgICAgZXZlbnRzQnlUeXBlW2VudHJ5LmFjdGlvbl0gPSAoZXZlbnRzQnlUeXBlW2VudHJ5LmFjdGlvbl0gfHwgMCkgKyAxO1xuICAgICAgZXZlbnRzQnlVc2VyW2VudHJ5LnVzZXJJZF0gPSAoZXZlbnRzQnlVc2VyW2VudHJ5LnVzZXJJZF0gfHwgMCkgKyAxO1xuICAgICAgcmVzb3VyY2VDb3VudHNbZW50cnkucmVzb3VyY2VdID0gKHJlc291cmNlQ291bnRzW2VudHJ5LnJlc291cmNlXSB8fCAwKSArIDE7XG4gICAgfSk7XG5cbiAgICBjb25zdCB0b3BSZXNvdXJjZXMgPSBPYmplY3QuZW50cmllcyhyZXNvdXJjZUNvdW50cylcbiAgICAgIC5tYXAoKFtyZXNvdXJjZSwgY291bnRdKSA9PiAoeyByZXNvdXJjZSwgY291bnQgfSkpXG4gICAgICAuc29ydCgoYSwgYikgPT4gYi5jb3VudCAtIGEuY291bnQpXG4gICAgICAuc2xpY2UoMCwgMTApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsRXZlbnRzOiByZWxldmFudEVudHJpZXMubGVuZ3RoLFxuICAgICAgc3VjY2Vzc2Z1bEV2ZW50czogcmVsZXZhbnRFbnRyaWVzLmZpbHRlcihlbnRyeSA9PiBlbnRyeS5zdWNjZXNzKS5sZW5ndGgsXG4gICAgICBmYWlsZWRFdmVudHM6IHJlbGV2YW50RW50cmllcy5maWx0ZXIoZW50cnkgPT4gIWVudHJ5LnN1Y2Nlc3MpLmxlbmd0aCxcbiAgICAgIHVuaXF1ZVVzZXJzOiBuZXcgU2V0KHJlbGV2YW50RW50cmllcy5tYXAoZW50cnkgPT4gZW50cnkudXNlcklkKSkuc2l6ZSxcbiAgICAgIGV2ZW50c0J5VHlwZSxcbiAgICAgIGV2ZW50c0J5VXNlcixcbiAgICAgIHRvcFJlc291cmNlcyxcbiAgICAgIHNlY3VyaXR5SW5jaWRlbnRzOiByZWxldmFudEVudHJpZXMuZmlsdGVyKGVudHJ5ID0+IFxuICAgICAgICB0aGlzLmlzU2VjdXJpdHlSZWxldmFudEFjdGlvbihlbnRyeS5hY3Rpb24pICYmICFlbnRyeS5zdWNjZXNzXG4gICAgICApLmxlbmd0aFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlIGNyaXRpY2FsIHNlY3VyaXR5IGV2ZW50c1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBoYW5kbGVDcml0aWNhbFNlY3VyaXR5RXZlbnQoZXZlbnQ6IFNlY3VyaXR5RXZlbnQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zb2xlLmVycm9yKGBDUklUSUNBTCBTRUNVUklUWSBFVkVOVDogJHtldmVudC50eXBlfSAtICR7ZXZlbnQuZGVzY3JpcHRpb259YCk7XG4gICAgXG4gICAgLy8gRW1pdCBjcml0aWNhbCBldmVudCBmb3IgZXh0ZXJuYWwgaGFuZGxpbmdcbiAgICB0aGlzLmVtaXQoJ2NyaXRpY2FsU2VjdXJpdHlFdmVudCcsIGV2ZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBjcnlwdG9ncmFwaGljYWxseSBzZWN1cmUgYXVkaXQgSURcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVBdWRpdElkKCk6IHN0cmluZyB7XG4gICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKS50b1N0cmluZygzNik7XG4gICAgY29uc3QgcmFuZG9tID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDgpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICByZXR1cm4gYGF1ZGl0XyR7dGltZXN0YW1wfV8ke3JhbmRvbX1gO1xuICB9XG5cbiAgLyoqXG4gICAqIEVuY3J5cHQgc2Vuc2l0aXZlIGRhdGEgaW4gYXVkaXQgbG9nc1xuICAgKi9cbiAgcHJpdmF0ZSBlbmNyeXB0U2Vuc2l0aXZlRGF0YShkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgY29uc3QgZW5jcnlwdGVkOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gICAgXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoZGF0YSkpIHtcbiAgICAgIGlmICh0aGlzLmlzU2Vuc2l0aXZlRmllbGQoa2V5KSkge1xuICAgICAgICBlbmNyeXB0ZWRba2V5XSA9IGBlbmNyeXB0ZWQ6JHtjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2JykudXBkYXRlKEpTT04uc3RyaW5naWZ5KHZhbHVlKSArIHRoaXMuZW5jcnlwdGlvbktleSkuZGlnZXN0KCdoZXgnKX1gO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZW5jcnlwdGVkW2tleV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGVuY3J5cHRlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBmaWVsZCBjb250YWlucyBzZW5zaXRpdmUgZGF0YVxuICAgKi9cbiAgcHJpdmF0ZSBpc1NlbnNpdGl2ZUZpZWxkKGZpZWxkTmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2Vuc2l0aXZlRmllbGRzID0gW1xuICAgICAgJ3Bhc3N3b3JkJywgJ3NzbicsICdkb2InLCAncGhvbmUnLCAnZW1haWwnLFxuICAgICAgJ2FkZHJlc3MnLCAnbWVkaWNhbFJlY29yZCcsICdkaWFnbm9zaXMnLFxuICAgICAgJ3RyZWF0bWVudCcsICdtZWRpY2F0aW9uJywgJ25vdGVzJ1xuICAgIF07XG4gICAgXG4gICAgcmV0dXJuIHNlbnNpdGl2ZUZpZWxkcy5zb21lKGZpZWxkID0+IFxuICAgICAgZmllbGROYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoZmllbGQpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBhY3Rpb24gaXMgc2VjdXJpdHkgcmVsZXZhbnRcbiAgICovXG4gIHByaXZhdGUgaXNTZWN1cml0eVJlbGV2YW50QWN0aW9uKGFjdGlvbjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2VjdXJpdHlBY3Rpb25zID0gW1xuICAgICAgJ2xvZ2luJywgJ2xvZ291dCcsICdwYXNzd29yZF9jaGFuZ2UnLCAnbWZhX3NldHVwJyxcbiAgICAgICd1c2VyX2NyZWF0aW9uJywgJ3VzZXJfbW9kaWZpY2F0aW9uJywgJ3Blcm1pc3Npb25fY2hhbmdlJyxcbiAgICAgICdkYXRhX2FjY2VzcycsICdkYXRhX21vZGlmaWNhdGlvbicsICdkYXRhX2RlbGV0aW9uJyxcbiAgICAgICdzeXN0ZW1fY29uZmlndXJhdGlvbicsICdiYWNrdXAnLCAncmVzdG9yZSdcbiAgICBdO1xuICAgIFxuICAgIHJldHVybiBzZWN1cml0eUFjdGlvbnMuc29tZShzZWNBY3Rpb24gPT4gXG4gICAgICBhY3Rpb24udG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhzZWNBY3Rpb24pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYXAgYWN0aW9uIHRvIHNlY3VyaXR5IGV2ZW50IHR5cGVcbiAgICovXG4gIHByaXZhdGUgbWFwQWN0aW9uVG9TZWN1cml0eUV2ZW50VHlwZShhY3Rpb246IHN0cmluZyk6IFNlY3VyaXR5RXZlbnRbJ3R5cGUnXSB7XG4gICAgY29uc3QgYWN0aW9uTG93ZXIgPSBhY3Rpb24udG9Mb3dlckNhc2UoKTtcbiAgICBcbiAgICBpZiAoYWN0aW9uTG93ZXIuaW5jbHVkZXMoJ2xvZ2luJykpIHJldHVybiAnTE9HSU5fU1VDQ0VTUyc7XG4gICAgaWYgKGFjdGlvbkxvd2VyLmluY2x1ZGVzKCdsb2dvdXQnKSkgcmV0dXJuICdMT0dPVVQnO1xuICAgIGlmIChhY3Rpb25Mb3dlci5pbmNsdWRlcygncGFzc3dvcmQnKSkgcmV0dXJuICdQQVNTV09SRF9DSEFOR0UnO1xuICAgIGlmIChhY3Rpb25Mb3dlci5pbmNsdWRlcygnZGF0YV9hY2Nlc3MnKSkgcmV0dXJuICdEQVRBX0FDQ0VTUyc7XG4gICAgaWYgKGFjdGlvbkxvd2VyLmluY2x1ZGVzKCdkYXRhX21vZGlmaWNhdGlvbicpKSByZXR1cm4gJ0RBVEFfTU9ESUZJQ0FUSU9OJztcbiAgICBpZiAoYWN0aW9uTG93ZXIuaW5jbHVkZXMoJ3VuYXV0aG9yaXplZCcpKSByZXR1cm4gJ1VOQVVUSE9SSVpFRF9BQ0NFU1MnO1xuICAgIFxuICAgIHJldHVybiAnREFUQV9BQ0NFU1MnOyAvLyBEZWZhdWx0XG4gIH1cblxuICAvKipcbiAgICogRGV0ZXJtaW5lIGV2ZW50IHNldmVyaXR5XG4gICAqL1xuICBwcml2YXRlIGRldGVybWluZVNldmVyaXR5KGFjdGlvbjogc3RyaW5nLCBzdWNjZXNzOiBib29sZWFuKTogU2VjdXJpdHlFdmVudFsnc2V2ZXJpdHknXSB7XG4gICAgaWYgKCFzdWNjZXNzKSB7XG4gICAgICBpZiAoYWN0aW9uLmluY2x1ZGVzKCdsb2dpbicpIHx8IGFjdGlvbi5pbmNsdWRlcygndW5hdXRob3JpemVkJykpIHtcbiAgICAgICAgcmV0dXJuICdISUdIJztcbiAgICAgIH1cbiAgICAgIHJldHVybiAnTUVESVVNJztcbiAgICB9XG4gICAgXG4gICAgaWYgKGFjdGlvbi5pbmNsdWRlcygnc3lzdGVtX2NvbmZpZ3VyYXRpb24nKSB8fCBhY3Rpb24uaW5jbHVkZXMoJ3VzZXJfY3JlYXRpb24nKSkge1xuICAgICAgcmV0dXJuICdNRURJVU0nO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gJ0xPVyc7XG4gIH1cblxuICAvKipcbiAgICogU2h1dGRvd24gYXVkaXQgc2VydmljZVxuICAgKi9cbiAgc2h1dGRvd24oKTogdm9pZCB7XG4gICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9